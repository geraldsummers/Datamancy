# Datamancy Service Registry
# Single source of truth for all services in the stack
#
# This registry defines:
# - Container images and versions
# - Service metadata (phase, health checks, dependencies)
# - Network configuration (subdomains, aliases)
# - Resource requirements
#
# Generate compose files from this registry using:
#   scripts/codegen/generate-compose-from-registry.main.kts
#
# Network Topology:
# Zero-trust infrastructure-specific networks. Services only join networks for
# infrastructure they directly need. No shared "backend" network - prevents lateral movement.
#
# Infrastructure networks (named after the service):
# - postgres, mariadb, clickhouse, qdrant: Database access
# - valkey, ldap, authelia, mailserver: Core infrastructure
# - litellm: AI gateway access
# - caddy: Reverse proxy access (for web-exposed services)
# - docker-proxy: Docker socket access (homepage)
#
# Special networks:
# - ai: ISOLATED AI/LLM services (untrusted external actor zone)
# - ai-gateway: Controlled bridge between AI and backend services
# - mastodon-internal: Mastodon multi-container communication
# - matrix-internal: Matrix/Element communication

# Network Definitions
networks:
  # Database networks
  postgres:
    subnet: 172.20.0.0/24
    description: PostgreSQL database access
  mariadb:
    subnet: 172.21.0.0/24
    description: MariaDB database access
  clickhouse:
    subnet: 172.22.0.0/24
    description: ClickHouse database access
  qdrant:
    subnet: 172.23.0.0/24
    description: Qdrant vector database access

  # Core infrastructure networks
  valkey:
    subnet: 172.24.0.0/24
    description: Valkey (Redis) access
  ldap:
    subnet: 172.25.0.0/24
    description: LDAP directory access
  authelia:
    subnet: 172.26.0.0/24
    description: Authelia SSO access
  mailserver:
    subnet: 172.27.0.0/24
    description: Mail server access
  memcached:
    subnet: 172.28.0.0/24
    description: Memcached access (Seafile)
  docker-proxy:
    subnet: 172.29.0.0/24
    description: Docker socket proxy access

  # Reverse proxy
  caddy:
    subnet: 172.30.0.0/24
    description: Caddy reverse proxy (web-exposed services)

  # AI networks (isolated)
  ai:
    subnet: 172.40.0.0/24
    description: ISOLATED AI/LLM services (external actor zone)
  ai-gateway:
    subnet: 172.41.0.0/24
    description: Controlled gateway between AI and backend
  litellm:
    subnet: 172.42.0.0/24
    description: LiteLLM AI gateway access

  # Monitoring network
  monitoring:
    subnet: 172.50.0.0/24
    description: Prometheus, Node Exporter, cAdvisor metrics collection

  # Application-specific networks
  mastodon-internal:
    subnet: 172.52.0.0/24
    description: Mastodon multi-container internal communication
  matrix-internal:
    subnet: 172.53.0.0/24
    description: Matrix Synapse and Element communication

# Core Infrastructure Services
core:
  caddy:
    image: caddy
    version: 2.10.2
    container_name: caddy
    subdomain: www  # Primary subdomain (www.${DOMAIN})
    additional_aliases:  # Other domains this service handles
      - grafana
      - open-webui
      - vaultwarden
      - app.vaultwarden
      - planka
      - bookstack
      - jupyterhub
      - homepage
      - seafile
      - api.seafile
      - onlyoffice
      - matrix
      - api.matrix
      - element
      - homeassistant
      - api.homeassistant
      - litellm
      - api.litellm
      - auth
      - kopia
      - mail
      - agent-tool-server
      - lam
      - forgejo
      - qbittorrent
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - caddy
      - authelia  # Needs to talk to authelia for forward auth
    environment:
      DOMAIN: "${DOMAIN}"
      STACK_ADMIN_EMAIL: "${STACK_ADMIN_EMAIL}"
      API_LITELLM_ALLOWLIST: "${API_LITELLM_ALLOWLIST}"
      MAIL_DOMAIN: "${MAIL_DOMAIN}"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ${DEPLOYMENT_ROOT}/configs/infrastructure/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/vaultwarden/index.html:/srv/vaultwarden/index.html:ro
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    phase: core
    phase_order: 1

  ldap:
    image: osixia/openldap
    version: 1.5.0
    container_name: ldap
    subdomain: null  # No direct subdomain exposure
    networks:
      - ldap
    environment:
      LDAP_ORGANISATION: "Datamancy"
      LDAP_DOMAIN: "stack.local"
      LDAP_BASE_DN: "dc=stack,dc=local"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_CONFIG_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_TLS: "false"
      LDAP_MEMBEROF_OVERLAY: "true"
      LDAP_MEMBEROF_GROUP_OC: "groupOfNames"
      LDAP_MEMBEROF_MEMBER_AD: "member"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ${DEPLOYMENT_ROOT}/configs/infrastructure/ldap/bootstrap_ldap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap_ldap.ldif:ro
    command: --copy-service --loglevel info
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: core
    phase_order: 1

  valkey:
    image: valkey/valkey
    version: 8.1.5
    container_name: valkey
    subdomain: null
    network_aliases:
      - redis
      - redis-synapse
    networks:
      - valkey
    volumes:
      - redis_data:/data
    command: valkey-server --appendonly yes --dir /data --databases 16
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  authelia:
    image: authelia/authelia
    version: 4.39.15
    container_name: authelia
    subdomain: auth
    networks:
      - authelia
      - caddy
      - ldap
      - postgres
      - valkey
    depends_on:
      - ldap
      - postgres
      - valkey
    environment:
      TZ: "UTC"
      DOMAIN: "${DOMAIN}"
      AUTHELIA_JWT_SECRET: "${AUTHELIA_JWT_SECRET}"
      AUTHELIA_SESSION_SECRET: "${AUTHELIA_SESSION_SECRET}"
      AUTHELIA_STORAGE_ENCRYPTION_KEY: "${AUTHELIA_STORAGE_ENCRYPTION_KEY}"
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: "${AUTHELIA_OIDC_HMAC_SECRET}"
      AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY: "${AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY}"
      AUTHELIA_STORAGE_POSTGRES_PASSWORD: "${AUTHELIA_DB_PASSWORD}"
      GRAFANA_OAUTH_SECRET: "${GRAFANA_OAUTH_SECRET}"
      PGADMIN_OAUTH_SECRET: "${PGADMIN_OAUTH_SECRET}"
      OPENWEBUI_OAUTH_SECRET: "${OPENWEBUI_OAUTH_SECRET}"
      NEXTCLOUD_OAUTH_SECRET: "${NEXTCLOUD_OAUTH_SECRET}"
      DIM_OAUTH_SECRET: "${DIM_OAUTH_SECRET}"
      PLANKA_OAUTH_SECRET: "${PLANKA_OAUTH_SECRET}"
      HOMEASSISTANT_OAUTH_SECRET: "${HOMEASSISTANT_OAUTH_SECRET}"
      JUPYTERHUB_OAUTH_SECRET: "${JUPYTERHUB_OAUTH_SECRET}"
      VAULTWARDEN_OAUTH_SECRET: "${VAULTWARDEN_OAUTH_SECRET}"
      MASTODON_OIDC_SECRET: "${MASTODON_OIDC_SECRET}"
      BOOKSTACK_OAUTH_SECRET: "${BOOKSTACK_OAUTH_SECRET}"
      FORGEJO_OAUTH_SECRET: "${FORGEJO_OAUTH_SECRET}"
      MATRIX_OAUTH_SECRET: "${MATRIX_OAUTH_SECRET}"
      SOGO_OAUTH_SECRET: "${SOGO_OAUTH_SECRET}"
    volumes:
      - ${VOLUMES_ROOT}/authelia:/config
      - ${DEPLOYMENT_ROOT}/configs/applications/authelia/configuration.yml:/config/configuration.yml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/authelia/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    command: ["--config", "/config/configuration.yml"]
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: auth
    phase_order: 3

  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver
    version: 14.0.0
    container_name: mailserver
    subdomain: mail
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
    networks:
      - mailserver
      - caddy
      - ldap
    depends_on:
      - ldap
      - caddy
    environment:
      ENABLE_RSPAMD: "1"
      ENABLE_CLAMAV: "1"
      ENABLE_FAIL2BAN: "1"
      ENABLE_POSTGREY: "0"
      ENABLE_SPAMASSASSIN: "0"
      SPOOF_PROTECTION: "0"
      ENABLE_SRS: "0"
      PERMIT_DOCKER: "network"
      SSL_TYPE: "manual"
      SSL_CERT_PATH: "${MAILSERVER_SSL_CERT_PATH:-/caddy-certs/caddy/certificates/acme.zerossl.com-v2-dv90/mail.${DOMAIN}/mail.${DOMAIN}.crt}"
      SSL_KEY_PATH: "${MAILSERVER_SSL_KEY_PATH:-/caddy-certs/caddy/certificates/acme.zerossl.com-v2-dv90/mail.${DOMAIN}/mail.${DOMAIN}.key}"
      OVERRIDE_HOSTNAME: "mail.${DOMAIN}"
      POSTMASTER_ADDRESS: "postmaster@${MAIL_DOMAIN}"
      ACCOUNT_PROVISIONER: "LDAP"
      LDAP_SERVER_HOST: "ldap://ldap:389"
      LDAP_BIND_DN: "cn=admin,dc=stack,dc=local"
      LDAP_BIND_PW: "${LDAP_ADMIN_PASSWORD}"
      LDAP_SEARCH_BASE: "ou=users,dc=stack,dc=local"
      LDAP_QUERY_FILTER_USER: "(&(objectClass=inetOrgPerson)(mail=%s))"
      LDAP_QUERY_FILTER_GROUP: "(&(objectClass=groupOfNames)(member=%s))"
      LDAP_QUERY_FILTER_ALIAS: "(&(objectClass=inetOrgPerson)(mail=%s))"
      DOVECOT_MAILBOX_FORMAT: "maildir"
      DOVECOT_USER_FILTER: "(&(objectClass=inetOrgPerson)(mail=%u))"
      DOVECOT_PASS_FILTER: "(&(objectClass=inetOrgPerson)(mail=%u))"
      DOVECOT_PASS_ATTRS: "mail=user,userPassword=password"
      DOVECOT_USER_ATTRS: "=home=/var/mail/%Ln,=mail=maildir:~/Maildir"
      ENABLE_QUOTAS: "1"
      POSTFIX_MESSAGE_SIZE_LIMIT: "50000000"
    volumes:
      - mailserver_data:/var/mail/
      - mailserver_state:/var/mail-state/
      - mailserver_logs:/var/log/mail/
      - mailserver_config:/tmp/docker-mailserver/
      - /etc/localtime:/etc/localtime:ro
      - caddy_data:/caddy-certs:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/mailserver/dovecot-master-users.conf:/tmp/docker-mailserver/dovecot-master-users.conf:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/mailserver/local.conf:/etc/dovecot/local.conf:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    phase: auth
    phase_order: 3

  ldap-account-manager:
    image: ghcr.io/ldapaccountmanager/lam
    version: "9.4"
    container_name: ldap-account-manager
    subdomain: lam
    networks:
      - caddy
      - ldap
    depends_on:
      - ldap
    environment:
      LDAP_DOMAIN: "stack.local"
      LDAP_BASE_DN: "dc=stack,dc=local"
      LDAP_USER: "cn=admin,dc=stack,dc=local"
      LDAP_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LAM_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LAM_LANG: "en_US"
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  memcached:
    image: memcached
    version: 1.6.40
    container_name: seafile-memcached
    subdomain: null
    networks:
      - memcached
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  docker-proxy:
    image: tecnativa/docker-socket-proxy
    version: v0.4.2
    container_name: docker-proxy
    subdomain: null
    networks:
      - docker-proxy
    environment:
      CONTAINERS: "1"
      IMAGES: "1"
      NETWORKS: "1"
      VOLUMES: "1"
      POST: "1"
      DELETE: "1"
      INFO: "1"
      VERSION: "1"
      BUILD: "0"
      COMMIT: "0"
      EXEC: "0"
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  kopia:
    image: kopia/kopia
    version: 0.22.3
    container_name: kopia
    subdomain: kopia
    networks:
      - caddy
    environment:
      KOPIA_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      KOPIA_REPO_PATH: "/repository"
      USER: "kopia"
    volumes:
      - kopia_data:/app/config
      - kopia_cache:/app/cache
      - postgres_data:/backup/postgres:ro
      - mariadb_data:/backup/mariadb:ro
      - kopia_repository:/repository
      - ${DEPLOYMENT_ROOT}/configs/applications/kopia/init-kopia.sh:/init-kopia.sh:ro
    entrypoint:
      - sh
      - /init-kopia.sh
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

# Database Services
databases:
  postgres:
    image: postgres
    version: "16.11"
    container_name: postgres
    subdomain: null
    network_aliases:
      - db
    networks:
      - postgres
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_ROOT_PASSWORD}"
      POSTGRES_USER: "${STACK_ADMIN_USER}"
      POSTGRES_DB: "postgres"
      POSTGRES_ROOT_PASSWORD: "${POSTGRES_ROOT_PASSWORD}"
      PLANKA_DB_PASSWORD: "${PLANKA_DB_PASSWORD}"
      SYNAPSE_DB_PASSWORD: "${SYNAPSE_DB_PASSWORD}"
      AUTHELIA_DB_PASSWORD: "${AUTHELIA_DB_PASSWORD}"
      GRAFANA_DB_PASSWORD: "${GRAFANA_DB_PASSWORD}"
      VAULTWARDEN_DB_PASSWORD: "${VAULTWARDEN_DB_PASSWORD}"
      OPENWEBUI_DB_PASSWORD: "${OPENWEBUI_DB_PASSWORD}"
      MASTODON_DB_PASSWORD: "${MASTODON_DB_PASSWORD}"
      FORGEJO_DB_PASSWORD: "${FORGEJO_DB_PASSWORD}"
      HOMEASSISTANT_DB_PASSWORD: "${HOMEASSISTANT_DB_PASSWORD}"
      STACK_ADMIN_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      AGENT_POSTGRES_OBSERVER_PASSWORD: "${AGENT_POSTGRES_OBSERVER_PASSWORD}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ${DEPLOYMENT_ROOT}/configs/databases/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    command: postgres -c 'max_connections=300' -c 'shared_buffers=1GB'
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: databases
    phase_order: 2
    resources:
      memory: 4G
      cpus: "2.0"

  postgres-init:
    image: postgres
    version: "16.11"
    container_name: postgres-init
    subdomain: null
    networks:
      - postgres
    depends_on:
      - postgres
    restart: no
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_ROOT_PASSWORD}"
      POSTGRES_USER: "${STACK_ADMIN_USER}"
      POSTGRES_DB: "postgres"
      POSTGRES_ROOT_PASSWORD: "${POSTGRES_ROOT_PASSWORD}"
      PLANKA_DB_PASSWORD: "${PLANKA_DB_PASSWORD}"
      SYNAPSE_DB_PASSWORD: "${SYNAPSE_DB_PASSWORD}"
      AUTHELIA_DB_PASSWORD: "${AUTHELIA_DB_PASSWORD}"
      GRAFANA_DB_PASSWORD: "${GRAFANA_DB_PASSWORD}"
      VAULTWARDEN_DB_PASSWORD: "${VAULTWARDEN_DB_PASSWORD}"
      OPENWEBUI_DB_PASSWORD: "${OPENWEBUI_DB_PASSWORD}"
      MASTODON_DB_PASSWORD: "${MASTODON_DB_PASSWORD}"
      FORGEJO_DB_PASSWORD: "${FORGEJO_DB_PASSWORD}"
      HOMEASSISTANT_DB_PASSWORD: "${HOMEASSISTANT_DB_PASSWORD}"
      STACK_ADMIN_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      AGENT_POSTGRES_OBSERVER_PASSWORD: "${AGENT_POSTGRES_OBSERVER_PASSWORD}"
      DATAMANCY_SERVICE_PASSWORD: "${STACK_ADMIN_PASSWORD}"
    volumes:
      - ${DEPLOYMENT_ROOT}/configs/databases/postgres/init-db.sh:/init-db.sh:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "Waiting for Postgres to be ready..."
        until pg_isready -h postgres -U ${STACK_ADMIN_USER}; do
          sleep 2
        done
        echo "Running idempotent database initialization..."
        export POSTGRES_USER=${STACK_ADMIN_USER}
        /init-db.sh
        echo "Database initialization complete"
    phase: databases
    phase_order: 3

  mariadb:
    image: mariadb
    version: 11.8.5
    container_name: mariadb
    subdomain: null
    network_aliases:
      - mysql
    networks:
      - mariadb
    environment:
      MYSQL_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      MYSQL_DATABASE: "datamancy"
      MYSQL_USER: "${STACK_ADMIN_USER}"
      MYSQL_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      BOOKSTACK_DB_PASSWORD: "${BOOKSTACK_DB_PASSWORD}"
      MARIADB_SEAFILE_PASSWORD: "${MARIADB_SEAFILE_PASSWORD}"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ${DEPLOYMENT_ROOT}/configs/databases/mariadb/init-template.sql:/docker-entrypoint-initdb.d/init-template.sql:ro
      - ${DEPLOYMENT_ROOT}/configs/databases/mariadb/init-wrapper.sh:/docker-entrypoint-initdb.d/01-init-wrapper.sh:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: databases
    phase_order: 2

  clickhouse:
    image: clickhouse/clickhouse-server
    version: "24.12"
    container_name: clickhouse
    subdomain: null
    networks:
      - clickhouse
    environment:
      CLICKHOUSE_DB: "default"
      CLICKHOUSE_USER: "${STACK_ADMIN_USER}"
      CLICKHOUSE_PASSWORD: "${CLICKHOUSE_ADMIN_PASSWORD}"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ${DEPLOYMENT_ROOT}/configs/databases/clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml:ro
      - ${DEPLOYMENT_ROOT}/configs/databases/clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: databases
    phase_order: 2
    resources:
      memory: 4G
      cpus: "2.0"

  qdrant:
    image: qdrant/qdrant
    version: v1.16.3
    container_name: qdrant
    subdomain: null
    networks:
      - qdrant
    environment:
      QDRANT__SERVICE__GRPC_PORT: "6334"
    volumes:
      - qdrant_data:/qdrant/storage
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: databases
    phase_order: 2
    resources:
      memory: 2G
      cpus: "2.0"

  vector-bootstrap:
    image: zenika/kotlin
    version: "latest"
    container_name: vector-bootstrap
    subdomain: null
    networks:
      - qdrant
    depends_on:
      - qdrant
    restart: "no"  # One-shot init job - should not restart
    environment:
      QDRANT_URL: "http://qdrant:6333"
      VECTOR_SIZE: "${VECTOR_EMBED_SIZE:-384}"
      QDRANT_API_KEY: "${QDRANT_API_KEY:-}"
    volumes:
      - ${DEPLOYMENT_ROOT}/configs/databases/vectors/collections.yaml:/configs/collections.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/databases/vectors/bootstrap_vectors.main.kts:/scripts/bootstrap_vectors.main.kts:ro
    command:
      - kotlin
      - /scripts/bootstrap_vectors.main.kts
      - /configs/collections.yaml
    phase: databases
    phase_order: 2

# Application Services
applications:
  grafana:
    image: grafana/grafana
    version: 11.6.9
    container_name: grafana
    subdomain: grafana
    networks:
      - caddy
      - postgres
      - authelia
      - monitoring  # Access to Prometheus metrics
    depends_on:
      - postgres
      - authelia
    environment:
      GF_DEFAULT_LOCALE: "en_US"
      GF_SERVER_ROOT_URL: "https://grafana.${DOMAIN}"
      GF_SERVER_DOMAIN: "grafana.${DOMAIN}"
      GF_DATABASE_TYPE: "postgres"
      GF_DATABASE_HOST: "postgres:5432"
      GF_DATABASE_NAME: "grafana"
      GF_DATABASE_USER: "grafana"
      GF_DATABASE_PASSWORD: "${GRAFANA_DB_PASSWORD}"
      GF_DATABASE_SSL_MODE: "disable"
      GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
      GF_AUTH_GENERIC_OAUTH_NAME: "Authelia"
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID: "grafana"
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: "${GRAFANA_OAUTH_SECRET}"
      GF_AUTH_GENERIC_OAUTH_SCOPES: "openid profile email groups"
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: "https://auth.${DOMAIN}/api/oidc/authorization"
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: "http://authelia:9091/api/oidc/token"
      GF_AUTH_GENERIC_OAUTH_API_URL: "http://authelia:9091/api/oidc/userinfo"
      GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH: "email"
      GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH: "email"
      GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH: "groups"
      GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH: "contains(groups, 'admins') && 'Admin' || 'Viewer'"
    volumes:
      - grafana_data:/var/lib/grafana
      - ${DEPLOYMENT_ROOT}/configs/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ${DEPLOYMENT_ROOT}/configs/monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  prompt-server:
    image: nginx
    version: alpine
    container_name: prompt-server
    subdomain: prompts
    networks:
      - caddy
    volumes:
      - ./configs/prompts:/usr/share/nginx/html:ro
    health_check:
      type: docker
    phase: applications
    phase_order: 3

  open-webui:
    image: ghcr.io/open-webui/open-webui
    version: 0.4.6
    container_name: open-webui
    subdomain: open-webui
    networks:
      - caddy
      - postgres
      - litellm
      - authelia
    depends_on:
      - postgres
      - litellm
      - authelia
    environment:
      WEBUI_URL: "${OPENWEBUI_WEBUI_URL:-https://open-webui.${DOMAIN}}"
      DATABASE_URL: "postgresql://openwebui:${OPENWEBUI_DB_PASSWORD}@postgres:5432/openwebui"
      ENABLE_OAUTH_SIGNUP: "${OPENWEBUI_ENABLE_OAUTH_SIGNUP:-true}"
      DEFAULT_USER_ROLE: "${OPENWEBUI_DEFAULT_USER_ROLE:-admin}"
      ENABLE_OPENAI_API: "true"
      OPENAI_API_BASE_URL: "${OPENWEBUI_OPENAI_API_BASE_URL:-http://litellm:4000/v1}"
      OPENAI_API_KEY: "${LITELLM_MASTER_KEY}"
      DEFAULT_MODELS: "qwen2.5-7b-instruct"
      OPENID_PROVIDER_URL: "https://auth.${DOMAIN}"
      OAUTH_CLIENT_ID: "open-webui"
      OAUTH_CLIENT_SECRET: "${OPENWEBUI_OAUTH_SECRET}"
      OAUTH_PROVIDER_NAME: "Authelia"
      OAUTH_SCOPES: "openid profile email groups"
      ENABLE_LOGIN_FORM: "false"
      WEBUI_AUTH: "false"
    volumes:
      - open_webui_data:/app/backend/data
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  vaultwarden:
    image: vaultwarden/server
    version: testing
    container_name: vaultwarden
    subdomain: vaultwarden
    additional_aliases:
      - app.vaultwarden
    networks:
      - caddy
      - postgres
      - mailserver
      - authelia
    depends_on:
      - postgres
      - mailserver
      - authelia
    environment:
      DOMAIN: "https://app.vaultwarden.${DOMAIN}"
      DATABASE_URL: "postgresql://vaultwarden:${VAULTWARDEN_DB_PASSWORD}@postgres:5432/vaultwarden"
      SIGNUPS_ALLOWED: "false"
      SIGNUPS_VERIFY: "true"
      SIGNUPS_DOMAINS_WHITELIST: "${MAIL_DOMAIN}"
      INVITATIONS_ALLOWED: "false"
      SHOW_PASSWORD_HINT: "false"
      SSO_ENABLED: "true"
      SSO_ONLY: "true"
      SSO_AUTHORITY: "https://auth.${DOMAIN}"
      SSO_CLIENT_ID: "vaultwarden"
      SSO_CLIENT_SECRET: "${VAULTWARDEN_OAUTH_SECRET}"
      SSO_SCOPES: "openid email profile"
      SSO_CALLBACK_PATH: "/identity/connect/oidc-signin"
      SSO_SIGNUPS_MATCH_EMAIL: "true"
      ADMIN_TOKEN: "${VAULTWARDEN_ADMIN_TOKEN}"
      SMTP_HOST: "mailserver"
      SMTP_FROM: "vaultwarden@${MAIL_DOMAIN}"
      SMTP_PORT: "587"
      SMTP_SECURITY: "starttls"
      SMTP_USERNAME: "vaultwarden@${MAIL_DOMAIN}"
      SMTP_PASSWORD: "${VAULTWARDEN_SMTP_PASSWORD}"
    volumes:
      - vaultwarden_data:/data
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  bookstack:
    image: lscr.io/linuxserver/bookstack
    version: version-v24.12.1
    container_name: bookstack
    subdomain: bookstack
    networks:
      - caddy
      - mariadb
    depends_on:
      - mariadb
    environment:
      PUID: "${DOCKER_USER_ID:-1000}"
      PGID: "${DOCKER_GROUP_ID:-1000}"
      TZ: "UTC"
      APP_URL: "https://bookstack.${DOMAIN}"
      APP_KEY: "${BOOKSTACK_APP_KEY}"
      DB_HOST: "mariadb"
      DB_PORT: "3306"
      DB_USER: "bookstack"
      DB_PASS: "${BOOKSTACK_DB_PASSWORD}"
      DB_DATABASE: "bookstack"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      BOOKSTACK_OAUTH_SECRET: "${BOOKSTACK_OAUTH_SECRET}"
    volumes:
      - bookstack_data:/config
      - ${DEPLOYMENT_ROOT}/configs/applications/bookstack/init:/custom-cont-init.d:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    phase: applications
    phase_order: 4

  planka:
    image: ghcr.io/plankanban/planka
    version: 1.26.3
    container_name: planka
    subdomain: planka
    networks:
      - caddy
      - postgres
      - authelia
    depends_on:
      - postgres
      - authelia
    environment:
      BASE_URL: "https://planka.${DOMAIN}"
      DATABASE_URL: "postgresql://planka:${PLANKA_DB_PASSWORD_ENCODED:-${PLANKA_DB_PASSWORD}}@postgres:5432/planka"
      SECRET_KEY: "${PLANKA_SECRET_KEY}"
      OIDC_ISSUER: "https://auth.${DOMAIN}"
      OIDC_CLIENT_ID: "planka"
      OIDC_CLIENT_SECRET: "${PLANKA_OAUTH_SECRET}"
      OIDC_SCOPES: "openid profile email groups"
      OIDC_ADMIN_ROLES: "admins"
      OIDC_EMAIL_ATTRIBUTE: "email"
      OIDC_NAME_ATTRIBUTE: "name"
      OIDC_USERNAME_ATTRIBUTE: "preferred_username"
      OIDC_REDIRECT_URI: "https://planka.${DOMAIN}/oidc-callback"
      OIDC_AUTHORIZATION_ENDPOINT: "https://auth.${DOMAIN}/api/oidc/authorization"
      OIDC_TOKEN_ENDPOINT: "http://authelia:9091/api/oidc/token"
      OIDC_USERINFO_ENDPOINT: "http://authelia:9091/api/oidc/userinfo"
      OIDC_TOKEN_ENDPOINT_AUTH_METHOD: "client_secret_post"
      OIDC_ENFORCED: "false"
      NODE_EXTRA_CA_CERTS: "/usr/local/share/ca-certificates/caddy-ca.crt"
    volumes:
      - planka_data:/app/public/user-avatars
      - ${DEPLOYMENT_ROOT}/configs/applications/planka/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  forgejo:
    image: codeberg.org/forgejo/forgejo
    version: "9.0"
    container_name: forgejo
    subdomain: forgejo
    networks:
      - caddy
      - postgres
    depends_on:
      - postgres
    environment:
      USER_UID: "${DOCKER_USER_ID:-1000}"
      USER_GID: "${DOCKER_GROUP_ID:-1000}"
      FORGEJO__database__DB_TYPE: "postgres"
      FORGEJO__database__HOST: "postgres:5432"
      FORGEJO__database__NAME: "forgejo"
      FORGEJO__database__USER: "forgejo"
      FORGEJO__database__PASSWD: "${FORGEJO_DB_PASSWORD}"
      FORGEJO__server__DOMAIN: "forgejo.${DOMAIN}"
      FORGEJO__server__SSH_DOMAIN: "forgejo.${DOMAIN}"
      FORGEJO__server__ROOT_URL: "https://forgejo.${DOMAIN}/"
      FORGEJO__security__INSTALL_LOCK: "true"
      FORGEJO__service__DISABLE_REGISTRATION: "true"
      FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: "true"
      FORGEJO__service__REQUIRE_SIGNIN_VIEW: "true"
      FORGEJO__oauth2_client__ENABLE_AUTO_REGISTRATION: "true"
      FORGEJO__openid__ENABLE_OPENID_SIGNIN: "true"
      FORGEJO__openid__ENABLE_OPENID_SIGNUP: "true"
      FORGEJO_OAUTH_SECRET: "${FORGEJO_OAUTH_SECRET}"
      DOMAIN: "${DOMAIN}"
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    phase: applications
    phase_order: 4

  homepage:
    image: ghcr.io/gethomepage/homepage
    version: v1.8.0
    container_name: homepage
    subdomain: homepage
    networks:
      - caddy
      - docker-proxy
    depends_on:
      - docker-proxy
    environment:
      PUID: "${DOCKER_USER_ID:-1000}"
      PGID: "${DOCKER_GROUP_ID:-1000}"
      HOMEPAGE_ALLOWED_HOSTS: "homepage.${DOMAIN}"
      DOCKER_HOST: "tcp://docker-proxy:2375"
    volumes:
      - ${DEPLOYMENT_ROOT}/configs/applications/homepage/services.yaml:/app/config/services.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homepage/settings.yaml:/app/config/settings.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homepage/docker.yaml:/app/config/docker.yaml:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  jupyterhub:
    image: datamancy-jupyterhub
    version: "5.4.3"
    container_name: jupyterhub
    subdomain: jupyterhub
    networks:
      - caddy
      - litellm
      - docker-proxy
    depends_on:
      - docker-proxy
    environment:
      DOCKER_HOST: "tcp://docker-proxy:2375"
      DOCKER_NETWORK_NAME: "datamancy-stack_litellm"
      LITELLM_API_KEY: "${LITELLM_MASTER_KEY}"
      JUPYTERHUB_CRYPT_KEY: "${JUPYTERHUB_CRYPT_KEY}"
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ${DEPLOYMENT_ROOT}/configs/applications/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    user: root
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4
    security_note: "Uses DockerSpawner - spawns isolated notebook containers per user"

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant
    version: "2026.1.0"
    container_name: homeassistant
    subdomain: homeassistant
    additional_aliases:
      - api.homeassistant
    networks:
      - caddy
      - postgres
      - ldap
    environment:
      TZ: "UTC"
      PUID: "${DOCKER_USER_ID:-1000}"
      PGID: "${DOCKER_GROUP_ID:-1000}"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "homeassistant"
      POSTGRES_USER: "homeassistant"
      POSTGRES_PASSWORD: "${HOMEASSISTANT_DB_PASSWORD}"
      LDAP_URL: "ldap://ldap:389"
      LDAP_BASE_DN: "dc=stack,dc=local"
      LDAP_USER_DN: "ou=users,dc=stack,dc=local"
      LDAP_BIND_DN: "cn=admin,dc=stack,dc=local"
      LDAP_BIND_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_USER_FILTER: "(uid={username})"
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/configuration.yaml:/config/configuration.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/automations.yaml:/config/automations.yaml:rw
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/scripts.yaml:/config/scripts.yaml:rw
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/scenes.yaml:/config/scenes.yaml:rw
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/init-homeassistant.sh:/init-homeassistant.sh:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/entrypoint.sh:/entrypoint-wrapper.sh:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/homeassistant/auth_ldap.py:/usr/src/homeassistant/homeassistant/auth/providers/auth_ldap.py:ro
    entrypoint:
      - /entrypoint-wrapper.sh
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    phase: applications
    phase_order: 4
    security_note: "ISOLATED - Only has access to caddy, postgres, and ldap. Cannot communicate with other apps."

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    version: "latest"
    container_name: qbittorrent
    subdomain: qbittorrent
    networks:
      - caddy
    environment:
      PUID: "${DOCKER_USER_ID:-1000}"
      PGID: "${DOCKER_GROUP_ID:-1000}"
      TZ: "UTC"
      WEBUI_PORT: "8080"
    volumes:
      - qbittorrent_config:/config
      - qbittorrent_data:/downloads
      - ${VOLUMES_ROOT}/qbittorrent_init:/custom-cont-init.d:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4
    security_note: "ISOLATED - Torrent client with minimal network access"

  synapse:
    image: matrixdotorg/synapse
    version: v1.144.0
    container_name: synapse
    subdomain: matrix
    additional_aliases:
      - api.matrix
    networks:
      - caddy
      - postgres
      - valkey
      - ldap
      - matrix-internal
    depends_on:
      - postgres
      - valkey
      - ldap
    user: "991:991"
    environment:
      DOMAIN: "${DOMAIN}"
      SYNAPSE_SERVER_NAME: "matrix.${DOMAIN}"
      SYNAPSE_REPORT_STATS: "yes"
      SYNAPSE_ENABLE_REGISTRATION: "${MATRIX_ENABLE_REGISTRATION:-false}"
      SYNAPSE_TRUSTED_PROXIES: "172.18.0.0/16,172.21.0.0/24"
      SYNAPSE_LOG_LEVEL: "WARNING"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "synapse"
      POSTGRES_USER: "synapse"
      POSTGRES_PASSWORD: "${SYNAPSE_DB_PASSWORD}"
      REDIS_HOST: "redis-synapse"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      UID: "991"
      GID: "991"
    volumes:
      - synapse_data:/data
      - ${DEPLOYMENT_ROOT}/configs/applications/synapse/homeserver.yaml:/data/homeserver.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/synapse/entrypoint.sh:/entrypoint.sh:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  element:
    image: vectorim/element-web
    version: v1.12.7
    container_name: element
    subdomain: element
    networks:
      - caddy
      - matrix-internal
    depends_on:
      - synapse
    volumes:
      - element_data:/app/config
      - ${DEPLOYMENT_ROOT}/configs/applications/element/config.json:/app/config.json:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  mastodon-web:
    image: ghcr.io/mastodon/mastodon
    version: v4.5.4
    container_name: mastodon-web
    subdomain: null
    command: bash -c "bundle exec rails db:migrate && bundle exec rails server -b 0.0.0.0"
    networks:
      - caddy
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    environment:
      LOCAL_DOMAIN: "${DOMAIN}"
      RAILS_ENV: "production"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_NAME: "mastodon"
      DB_USER: "mastodon"
      DB_PASS: "${MASTODON_DB_PASSWORD}"
      REDIS_HOST: "valkey"
      REDIS_PORT: "6379"
      SECRET_KEY_BASE: "${MASTODON_SECRET_KEY_BASE}"
      OTP_SECRET: "${MASTODON_OTP_SECRET}"
      VAPID_PRIVATE_KEY: "${MASTODON_VAPID_PRIVATE_KEY}"
      VAPID_PUBLIC_KEY: "${MASTODON_VAPID_PUBLIC_KEY}"
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}"
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}"
      SMTP_SERVER: "mailserver"
      SMTP_PORT: "587"
      SMTP_FROM_ADDRESS: "mastodon@${DOMAIN}"
      SMTP_AUTH_METHOD: "plain"
      SMTP_OPENSSL_VERIFY_MODE: "none"
      STREAMING_API_BASE_URL: "wss://mastodon.${DOMAIN}"
      WEB_CONCURRENCY: "2"
      MAX_THREADS: "5"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  mastodon-streaming:
    image: ghcr.io/mastodon/mastodon-streaming
    version: v4.5.4
    container_name: mastodon-streaming
    subdomain: null
    networks:
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    environment:
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_NAME: "mastodon"
      DB_USER: "mastodon"
      DB_PASS: "${MASTODON_DB_PASSWORD}"
      REDIS_HOST: "valkey"
      REDIS_PORT: "6379"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  mastodon-sidekiq:
    image: ghcr.io/mastodon/mastodon
    version: v4.5.4
    container_name: mastodon-sidekiq
    subdomain: null
    command: bundle exec sidekiq
    networks:
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    environment:
      LOCAL_DOMAIN: "${DOMAIN}"
      RAILS_ENV: "production"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_NAME: "mastodon"
      DB_USER: "mastodon"
      DB_PASS: "${MASTODON_DB_PASSWORD}"
      REDIS_HOST: "valkey"
      REDIS_PORT: "6379"
      SECRET_KEY_BASE: "${MASTODON_SECRET_KEY_BASE}"
      OTP_SECRET: "${MASTODON_OTP_SECRET}"
      VAPID_PRIVATE_KEY: "${MASTODON_VAPID_PRIVATE_KEY}"
      VAPID_PUBLIC_KEY: "${MASTODON_VAPID_PUBLIC_KEY}"
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}"
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}"
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: "${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}"
      SMTP_SERVER: "mailserver"
      SMTP_PORT: "587"
      SMTP_FROM_ADDRESS: "mastodon@${DOMAIN}"
      SMTP_AUTH_METHOD: "plain"
      SMTP_OPENSSL_VERIFY_MODE: "none"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  roundcube:
    image: roundcube/roundcubemail
    version: "latest"
    container_name: roundcube
    subdomain: null
    networks:
      - caddy
      - mailserver
      - postgres
    depends_on:
      - mailserver
      - postgres
    environment:
      ROUNDCUBEMAIL_DB_TYPE: "pgsql"
      ROUNDCUBEMAIL_DB_HOST: "postgres"
      ROUNDCUBEMAIL_DB_PORT: "5432"
      ROUNDCUBEMAIL_DB_USER: "roundcube"
      ROUNDCUBEMAIL_DB_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      ROUNDCUBEMAIL_DB_NAME: "roundcube"
      ROUNDCUBEMAIL_DEFAULT_HOST: "mailserver"
      ROUNDCUBEMAIL_DEFAULT_PORT: "143"
      ROUNDCUBEMAIL_SMTP_SERVER: "mailserver"
      ROUNDCUBEMAIL_SMTP_PORT: "587"
      ROUNDCUBEMAIL_UPLOAD_MAX_FILESIZE: "50M"
    volumes:
      - roundcube_data:/var/www/html
      - ${DEPLOYMENT_ROOT}/configs/applications/roundcube/config.inc.php:/var/www/html/config/config.inc.php:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  radicale:
    image: tomsquest/docker-radicale
    version: "latest"
    container_name: radicale
    subdomain: null
    networks:
      - caddy
    environment:
      TZ: "UTC"
    volumes:
      - radicale_data:/data
      - ${DEPLOYMENT_ROOT}/configs/applications/radicale/config:/config/config:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/radicale/users:/data/users
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  seafile:
    image: seafileltd/seafile-mc
    version: 13.0.15
    container_name: seafile
    subdomain: seafile
    additional_aliases:
      - api.seafile
    networks:
      - caddy
      - mariadb
      - memcached
    depends_on:
      - mariadb
      - memcached
    environment:
      TZ: "UTC"
      DB_HOST: "mysql"
      DB_ROOT_PASSWD: "${MARIADB_ROOT_PASSWORD}"
      SEAFILE_MYSQL_DB_HOST: "mysql"
      SEAFILE_MYSQL_DB_PORT: "3306"
      SEAFILE_MYSQL_DB_USER: "seafile"
      SEAFILE_MYSQL_DB_PASSWORD: "${MARIADB_SEAFILE_PASSWORD}"
      INIT_SEAFILE_MYSQL_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      SEAFILE_SERVER_HOSTNAME: "seafile.${DOMAIN}"
      SEAFILE_ADMIN_EMAIL: "${STACK_ADMIN_EMAIL}"
      SEAFILE_ADMIN_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      JWT_PRIVATE_KEY: "${SEAFILE_JWT_KEY}"
      TIME_ZONE: "UTC"
    volumes:
      - seafile_data:/shared
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    phase: applications
    phase_order: 4

  onlyoffice:
    image: onlyoffice/documentserver
    version: 8.3.3
    container_name: onlyoffice
    subdomain: onlyoffice
    networks:
      - caddy
    environment:
      JWT_ENABLED: "true"
      JWT_SECRET: "${ONLYOFFICE_JWT_SECRET}"
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_log:/var/log/onlyoffice
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    phase: applications
    phase_order: 4

# AI/ML Services
ai:
  vllm-7b:
    image: vllm/vllm-openai
    version: v0.13.0
    container_name: vllm-7b
    subdomain: null
    networks:
      - ai  # ISOLATED - AI network only, no backend access
    environment:
      HUGGINGFACEHUB_API_TOKEN: "${HUGGINGFACEHUB_API_TOKEN}"
      HF_HUB_ENABLE_HF_TRANSFER: "0"
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
    command:
      - "Qwen/Qwen2.5-7B-Instruct-AWQ"
      - "--quantization"
      - "awq"
      - "--served-model-name"
      - "qwen2.5-7b-instruct"
      - "--max-model-len"
      - "32768"
      - "--max-num-seqs"
      - "16"
      - "--dtype"
      - "auto"
      - "--enable-auto-tool-choice"
      - "--tool-call-parser"
      - "hermes"
      - "--gpu-memory-utilization"
      - "0.9"
      - "--tensor-parallel-size"
      - "1"
      - "--trust-remote-code"
    volumes:
      - ${VOLUMES_ROOT}/vllm/models:/root/.cache/huggingface
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    health_check:
      type: docker
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 3m
    phase: ai
    phase_order: 5
    resources:
      memory: 12G
      cpus: "8.0"
    gpu: true

  embedding-service:
    image: ghcr.io/huggingface/text-embeddings-inference
    version: "1.8.3"
    container_name: embedding-service
    subdomain: null
    networks:
      - ai  # ISOLATED - AI network only
      - ai-gateway  # Controlled access for unified-indexer
    environment:
      HF_HUB_ENABLE_HF_TRANSFER: "0"
      MODEL_ID: "BAAI/bge-base-en-v1.5"  # Must use env var to avoid log redaction bug
    command: --port 8080
    volumes:
      - ${VOLUMES_ROOT}/embeddings/models:/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    phase: ai
    phase_order: 5
    gpu: true

  litellm:
    image: ghcr.io/berriai/litellm
    version: v1.80.8-stable.1
    container_name: litellm
    subdomain: litellm
    additional_aliases:
      - api.litellm
    networks:
      - ai  # ISOLATED - AI network only
      - litellm  # Gateway for apps needing AI access
      - caddy  # Only for Caddy access (external API)
    depends_on:
      - vllm-7b
      - embedding-service
    environment:
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY}"
      UI_USERNAME: "${STACK_ADMIN_USER}"
      UI_PASSWORD: "${STACK_ADMIN_PASSWORD}"
    volumes:
      - litellm_config:/app/config
      - ${DEPLOYMENT_ROOT}/configs/infrastructure/litellm/config.yaml:/app/config.yaml:ro
    command: --config /app/config.yaml --port 4000 --num_workers 4
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    phase: ai
    phase_order: 5

# Datamancy Custom Services
datamancy:
  control-panel:
    image: datamancy/control-panel
    version: local-build
    container_name: control-panel
    subdomain: control
    networks:
      - caddy
      - postgres
    depends_on:
      - postgres
      - data-fetcher
      - unified-indexer
    ports:
      - "8097:8097"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  data-fetcher:
    image: datamancy/data-fetcher
    version: local-build
    container_name: data-fetcher
    subdomain: null
    networks:
      - postgres
      - clickhouse
      - mariadb  # Needs bookstack's DB
      - qdrant
    depends_on:
      - postgres
      - clickhouse
      - bookstack
    environment:
      DATAFETCHER_PORT: "8095"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "datamancy"
      POSTGRES_USER: "datamancer"
      POSTGRES_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      CLICKHOUSE_HOST: "clickhouse"
      CLICKHOUSE_PORT: "8123"
      CLICKHOUSE_USER: "${STACK_ADMIN_USER}"
      CLICKHOUSE_PASSWORD: "${CLICKHOUSE_ADMIN_PASSWORD}"
      QDRANT_HOST: "qdrant"
      QDRANT_PORT: "6333"
      OPENWEATHER_API_KEY: "${OPENWEATHER_API_KEY:-}"
      COINGECKO_API_KEY: "${COINGECKO_API_KEY:-}"
      SERP_API_KEY: "${SERP_API_KEY:-}"
      FRED_API_KEY: "${FRED_API_KEY:-}"
      BOOKSTACK_URL: "${BOOKSTACK_URL:-http://bookstack:80}"
      BOOKSTACK_API_TOKEN_ID: "${BOOKSTACK_API_TOKEN_ID:-}"
      BOOKSTACK_API_TOKEN_SECRET: "${BOOKSTACK_API_TOKEN_SECRET:-}"
      FETCH_SCHEDULES_PATH: "/app/config/schedules.yaml"
      FETCH_SOURCES_PATH: "/app/config/sources.yaml"
      DATAFETCHER_DATA_PATH: "/app/data"
    volumes:
      - ${DEPLOYMENT_ROOT}/configs/applications/data-fetcher/schedules.yaml:/app/config/schedules.yaml:ro
      - ${DEPLOYMENT_ROOT}/configs/applications/data-fetcher/sources.yaml:/app/config/sources.yaml:ro
      - ${APPLICATION_DATA_PATH:-${VOLUMES_ROOT:-./volumes}/applications}/data_fetcher:/app/data
    health_check:
      type: docker
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  unified-indexer:
    image: datamancy/unified-indexer
    version: local-build
    container_name: unified-indexer
    subdomain: null
    networks:
      - postgres
      - mariadb  # Needs bookstack's DB
      - qdrant
      - clickhouse
      - ai-gateway  # Access to embedding-service via gateway
    depends_on:
      - postgres
      - bookstack
      - qdrant
      - clickhouse
      - embedding-service
    environment:
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "datamancy"
      POSTGRES_USER: "datamancer"
      POSTGRES_PASSWORD: "${STACK_ADMIN_PASSWORD}"
      BOOKSTACK_URL: "${BOOKSTACK_URL:-http://bookstack:80}"
      BOOKSTACK_API_TOKEN_ID: "${BOOKSTACK_API_TOKEN_ID:-}"
      BOOKSTACK_API_TOKEN_SECRET: "${BOOKSTACK_API_TOKEN_SECRET:-}"
      QDRANT_URL: "http://qdrant:6334"
      CLICKHOUSE_URL: "http://clickhouse:8123"
      CLICKHOUSE_USER: "${STACK_ADMIN_USER}"
      CLICKHOUSE_PASSWORD: "${CLICKHOUSE_ADMIN_PASSWORD}"
      EMBEDDING_SERVICE_URL: "http://embedding-service:8080"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  search-service:
    image: datamancy/search-service
    version: local-build
    container_name: search-service
    subdomain: null
    networks:
      - qdrant
      - clickhouse
      - ai-gateway  # Access to embedding-service via gateway
    depends_on:
      - qdrant
      - clickhouse
      - embedding-service
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  agent-tool-server:
    image: datamancy/agent-tool-server
    version: local-build
    container_name: agent-tool-server
    subdomain: agent-tool-server
    networks:
      - ai  # ISOLATED - Lives in AI zone (untrusted external actors)
      - ai-gateway  # Controlled access to internal API gateway only
      - caddy  # Only for Caddy access (MCP protocol)
      - postgres
      - mariadb
      - clickhouse
      - qdrant
      - ldap
    depends_on:
      - litellm
    environment:
      LITELLM_API_KEY: "${LITELLM_MASTER_KEY}"
      LITELLM_BASE_URL: "http://litellm:4000/v1"
      POSTGRES_OBSERVER_USER: "agent_observer"
      POSTGRES_OBSERVER_PASSWORD: "${AGENT_POSTGRES_OBSERVER_PASSWORD}"
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      MARIADB_OBSERVER_USER: "agent_observer"
      MARIADB_OBSERVER_PASSWORD: "${AGENT_MARIADB_OBSERVER_PASSWORD}"
      MARIADB_HOST: "mariadb"
      MARIADB_PORT: "3306"
      CLICKHOUSE_OBSERVER_USER: "${STACK_ADMIN_USER}"
      CLICKHOUSE_OBSERVER_PASSWORD: "${AGENT_CLICKHOUSE_OBSERVER_PASSWORD}"
      CLICKHOUSE_HOST: "clickhouse"
      CLICKHOUSE_PORT: "8123"
      QDRANT_OBSERVER_API_KEY: "${AGENT_QDRANT_API_KEY}"
      QDRANT_HOST: "qdrant"
      QDRANT_PORT: "6333"
      LDAP_OBSERVER_DN: "cn=agent_observer,dc=stack,dc=local"
      LDAP_OBSERVER_PASSWORD: "${AGENT_LDAP_OBSERVER_PASSWORD}"
      LDAP_HOST: "ldap"
      LDAP_PORT: "389"
      LDAP_BASE_DN: "dc=stack,dc=local"
      SEARCH_SERVICE_URL: "http://search-service:8098"
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
      - ${VOLUMES_ROOT}/secrets/stackops_ed25519:/app/keys/stackops_ed25519:ro
      - ${VOLUMES_ROOT}/agent_tool_server/known_hosts:/app/known_hosts:ro
      - ${DEPLOYMENT_ROOT}/configs/infrastructure/ssh/bootstrap_known_hosts.sh:/app/scripts/bootstrap_known_hosts.sh:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: datamancy
    phase_order: 6
    security_note: "EXTERNAL ACTOR ZONE - This service proxies LLM requests. Network isolated from backend/database."

  # Monitoring Stack
  prometheus:
    image: prom/prometheus
    version: v3.9.1
    container_name: prometheus
    subdomain: null
    networks:
      - monitoring
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=30d"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    volumes:
      - prometheus_data:/prometheus
      - ${DEPLOYMENT_ROOT}/configs/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: monitoring
    phase_order: 2

  node-exporter:
    image: prom/node-exporter
    version: v1.10.2
    container_name: node-exporter
    subdomain: null
    networks:
      - monitoring
    command:
      - "--path.rootfs=/host"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    volumes:
      - /:/host:ro,rslave
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
    pid: host
    restart: unless-stopped
    phase: monitoring
    phase_order: 2

  cadvisor:
    image: gcr.io/cadvisor/cadvisor
    version: v0.55.1
    container_name: cadvisor
    subdomain: null
    networks:
      - monitoring
      - docker-proxy
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    devices:
      - /dev/kmsg
    privileged: true
    restart: unless-stopped
    phase: monitoring
    phase_order: 2

  watchtower:
    image: containrrr/watchtower
    version: 1.7.1
    container_name: watchtower
    subdomain: null
    networks:
      - docker-proxy
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_INCLUDE_RESTARTING: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"
      DOCKER_API_VERSION: "1.44"
      WATCHTOWER_NOTIFICATIONS: "shoutrrr"
      WATCHTOWER_NOTIFICATION_URL: ""
      TZ: "Australia/Sydney"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    phase: monitoring
    phase_order: 2

# Metadata about phases (for controller)
phases:
  core:
    order: 1
    description: Core infrastructure (networks, volumes, caddy, ldap, valkey)
    timeout_seconds: 90

  databases:
    order: 2
    description: Database services (postgres, mariadb, clickhouse, qdrant)
    timeout_seconds: 120

  auth:
    order: 3
    description: Authentication services (authelia, mailserver)
    timeout_seconds: 120

  applications:
    order: 4
    description: Web applications (bookstack, grafana, etc.)
    timeout_seconds: 180

  ai:
    order: 5
    description: AI/ML services (vllm, litellm, embedding)
    timeout_seconds: 300

  monitoring:
    order: 2
    description: Monitoring services (prometheus, node-exporter, cadvisor, watchtower)
    timeout_seconds: 60

  datamancy:
    order: 6
    description: Datamancy services (control-panel, search, indexer)
    timeout_seconds: 120
