# Datamancy Service Registry
# Single source of truth for all services in the stack
#
# This registry defines:
# - Container images and versions
# - Service metadata (phase, health checks, dependencies)
# - Network configuration (subdomains, aliases)
# - Resource requirements
#
# Generate compose files from this registry using:
#   scripts/codegen/generate-compose-from-registry.main.kts
#
# Network Topology:
# Zero-trust infrastructure-specific networks. Services only join networks for
# infrastructure they directly need. No shared "backend" network - prevents lateral movement.
#
# Infrastructure networks (named after the service):
# - postgres, mariadb, clickhouse, qdrant: Database access
# - valkey, ldap, authelia, mailserver: Core infrastructure
# - litellm: AI gateway access
# - caddy: Reverse proxy access (for web-exposed services)
# - docker-proxy: Docker socket access (homepage, jupyterhub)
#
# Special networks:
# - ai: ISOLATED AI/LLM services (untrusted external actor zone)
# - ai-gateway: Controlled bridge between AI and backend services
# - jupyterhub-notebooks: JupyterHub spawned notebook containers
# - mastodon-internal: Mastodon multi-container communication
# - matrix-internal: Matrix/Element communication

# Network Definitions
networks:
  # Database networks
  postgres:
    subnet: 172.20.0.0/24
    description: PostgreSQL database access
  mariadb:
    subnet: 172.21.0.0/24
    description: MariaDB database access
  clickhouse:
    subnet: 172.22.0.0/24
    description: ClickHouse database access
  qdrant:
    subnet: 172.23.0.0/24
    description: Qdrant vector database access

  # Core infrastructure networks
  valkey:
    subnet: 172.24.0.0/24
    description: Valkey (Redis) access
  ldap:
    subnet: 172.25.0.0/24
    description: LDAP directory access
  authelia:
    subnet: 172.26.0.0/24
    description: Authelia SSO access
  mailserver:
    subnet: 172.27.0.0/24
    description: Mail server access
  memcached:
    subnet: 172.28.0.0/24
    description: Memcached access (Seafile)
  docker-proxy:
    subnet: 172.29.0.0/24
    description: Docker socket proxy access

  # Reverse proxy
  caddy:
    subnet: 172.30.0.0/24
    description: Caddy reverse proxy (web-exposed services)

  # AI networks (isolated)
  ai:
    subnet: 172.40.0.0/24
    description: ISOLATED AI/LLM services (external actor zone)
  ai-gateway:
    subnet: 172.41.0.0/24
    description: Controlled gateway between AI and backend
  litellm:
    subnet: 172.42.0.0/24
    description: LiteLLM AI gateway access

  # Application-specific networks
  jupyterhub-dind:
    subnet: 172.50.0.0/24
    description: JupyterHub Docker-in-Docker isolated daemon
  jupyterhub-notebooks:
    subnet: 172.51.0.0/24
    description: JupyterHub spawned notebook containers
  mastodon-internal:
    subnet: 172.52.0.0/24
    description: Mastodon multi-container internal communication
  matrix-internal:
    subnet: 172.53.0.0/24
    description: Matrix Synapse and Element communication

# Core Infrastructure Services
core:
  caddy:
    image: caddy
    version: 2.8.4
    container_name: caddy
    subdomain: www  # Primary subdomain (www.${DOMAIN})
    additional_aliases:  # Other domains this service handles
      - grafana
      - open-webui
      - vaultwarden
      - app.vaultwarden
      - planka
      - bookstack
      - jupyterhub
      - homepage
      - seafile
      - api.seafile
      - onlyoffice
      - matrix
      - api.matrix
      - element
      - homeassistant
      - api.homeassistant
      - litellm
      - api.litellm
      - auth
      - kopia
      - mail
      - agent-tool-server
      - lam
      - forgejo
      - qbittorrent
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      - caddy
      - authelia  # Needs to talk to authelia for forward auth
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    phase: core
    phase_order: 1

  ldap:
    image: osixia/openldap
    version: 1.5.0
    container_name: ldap
    subdomain: null  # No direct subdomain exposure
    networks:
      - ldap
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: core
    phase_order: 1

  valkey:
    image: valkey/valkey
    version: 8.0.1
    container_name: valkey
    subdomain: null
    network_aliases:
      - redis
      - redis-synapse
    networks:
      - valkey
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  authelia:
    image: authelia/authelia
    version: 4.39.13
    container_name: authelia
    subdomain: auth
    networks:
      - authelia
      - caddy
      - ldap
      - postgres
      - valkey
    depends_on:
      - ldap
      - postgres
      - valkey
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: auth
    phase_order: 3

  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver
    version: 14.0.0
    container_name: mailserver
    subdomain: mail
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
    networks:
      - mailserver
      - caddy
      - ldap
    depends_on:
      - ldap
      - caddy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    phase: auth
    phase_order: 3

  ldap-account-manager:
    image: ghcr.io/ldapaccountmanager/lam
    version: "9.3"
    container_name: ldap-account-manager
    subdomain: lam
    networks:
      - caddy
      - ldap
    depends_on:
      - ldap
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  memcached:
    image: memcached
    version: 1.6.39
    container_name: seafile-memcached
    subdomain: null
    networks:
      - memcached
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  docker-proxy:
    image: tecnativa/docker-socket-proxy
    version: v0.4.1
    container_name: docker-proxy
    subdomain: null
    networks:
      - docker-proxy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

  kopia:
    image: kopia/kopia
    version: 0.18.2
    container_name: kopia
    subdomain: kopia
    networks:
      - caddy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: core
    phase_order: 1

# Database Services
databases:
  postgres:
    image: postgres
    version: "16.11"
    container_name: postgres
    subdomain: null
    network_aliases:
      - db
    networks:
      - postgres
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: databases
    phase_order: 2
    resources:
      memory: 4G
      cpus: "2.0"

  mariadb:
    image: mariadb
    version: 11.6.2
    container_name: mariadb
    subdomain: null
    network_aliases:
      - mysql
    networks:
      - mariadb
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    phase: databases
    phase_order: 2

  clickhouse:
    image: clickhouse/clickhouse-server
    version: "24.8"
    container_name: clickhouse
    subdomain: null
    networks:
      - clickhouse
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: databases
    phase_order: 2
    resources:
      memory: 4G
      cpus: "2.0"

  qdrant:
    image: qdrant/qdrant
    version: v1.12.5
    container_name: qdrant
    subdomain: null
    networks:
      - qdrant
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: databases
    phase_order: 2
    resources:
      memory: 2G
      cpus: "2.0"

  vector-bootstrap:
    image: zenika/kotlin
    version: latest
    container_name: vector-bootstrap
    subdomain: null
    networks:
      - qdrant
    depends_on:
      - qdrant
    phase: databases
    phase_order: 2

# Application Services
applications:
  grafana:
    image: grafana/grafana
    version: 11.6.7
    container_name: grafana
    subdomain: grafana
    networks:
      - caddy
      - postgres
      - authelia
    depends_on:
      - postgres
      - authelia
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  open-webui:
    image: ghcr.io/open-webui/open-webui
    version: 0.3.32
    container_name: open-webui
    subdomain: open-webui
    networks:
      - caddy
      - postgres
      - litellm
      - authelia
    depends_on:
      - postgres
      - litellm
      - authelia
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  vaultwarden:
    image: vaultwarden/server
    version: testing
    container_name: vaultwarden
    subdomain: vaultwarden
    additional_aliases:
      - app.vaultwarden
    networks:
      - caddy
      - postgres
      - mailserver
      - authelia
    depends_on:
      - postgres
      - mailserver
      - authelia
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  bookstack:
    image: lscr.io/linuxserver/bookstack
    version: 24.12.1
    container_name: bookstack
    subdomain: bookstack
    networks:
      - caddy
      - mariadb
    depends_on:
      - mariadb
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    phase: applications
    phase_order: 4

  planka:
    image: ghcr.io/plankanban/planka
    version: 1.26.3
    container_name: planka
    subdomain: planka
    networks:
      - caddy
      - postgres
      - authelia
    depends_on:
      - postgres
      - authelia
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  forgejo:
    image: codeberg.org/forgejo/forgejo
    version: "9"
    container_name: forgejo
    subdomain: forgejo
    networks:
      - caddy
      - postgres
    depends_on:
      - postgres
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    phase: applications
    phase_order: 4

  homepage:
    image: ghcr.io/gethomepage/homepage
    version: v1.7.0
    container_name: homepage
    subdomain: homepage
    networks:
      - caddy
      - docker-proxy
    depends_on:
      - docker-proxy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  jupyterhub-dind:
    image: docker
    version: dind
    container_name: jupyterhub-dind
    subdomain: null
    networks:
      - jupyterhub-dind
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4
    security_note: "Isolated Docker daemon for JupyterHub - prevents access to host containers"

  jupyterhub:
    image: datamancy-jupyter-notebook
    version: latest
    container_name: jupyterhub
    subdomain: jupyterhub
    networks:
      - caddy
      - jupyterhub-dind
      - litellm
      - jupyterhub-notebooks
    depends_on:
      - jupyterhub-dind
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4
    security_note: "Uses isolated DinD daemon - cannot control host containers"

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant
    version: stable
    container_name: homeassistant
    subdomain: homeassistant
    additional_aliases:
      - api.homeassistant
    networks:
      - caddy
      - postgres
      - ldap
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    phase: applications
    phase_order: 4
    security_note: "ISOLATED - Only has access to caddy, postgres, and ldap. Cannot communicate with other apps."

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent
    version: latest
    container_name: qbittorrent
    subdomain: qbittorrent
    networks:
      - caddy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4
    security_note: "ISOLATED - Torrent client with minimal network access"

  synapse:
    image: matrixdotorg/synapse
    version: latest
    container_name: synapse
    subdomain: matrix
    additional_aliases:
      - api.matrix
    networks:
      - caddy
      - postgres
      - valkey
      - matrix-internal
    depends_on:
      - postgres
      - valkey
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  element:
    image: vectorim/element-web
    version: v1.11.88
    container_name: element
    subdomain: element
    networks:
      - caddy
      - matrix-internal
    depends_on:
      - synapse
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  mastodon-web:
    image: ghcr.io/mastodon/mastodon
    version: v4.3.3
    container_name: mastodon-web
    subdomain: null
    networks:
      - caddy
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  mastodon-streaming:
    image: ghcr.io/mastodon/mastodon-streaming
    version: v4.3.3
    container_name: mastodon-streaming
    subdomain: null
    networks:
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  mastodon-sidekiq:
    image: ghcr.io/mastodon/mastodon
    version: v4.3.3
    container_name: mastodon-sidekiq
    subdomain: null
    networks:
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      - postgres
      - valkey
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  roundcube:
    image: roundcube/roundcubemail
    version: latest
    container_name: roundcube
    subdomain: null
    networks:
      - caddy
      - mailserver
    depends_on:
      - mailserver
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: applications
    phase_order: 4

  radicale:
    image: tomsquest/docker-radicale
    version: latest
    container_name: radicale
    subdomain: null
    networks:
      - caddy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: applications
    phase_order: 4

  seafile:
    image: seafileltd/seafile-mc
    version: 13.0.12
    container_name: seafile
    subdomain: seafile
    additional_aliases:
      - api.seafile
    networks:
      - caddy
      - mariadb
      - memcached
    depends_on:
      - mariadb
      - memcached
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    phase: applications
    phase_order: 4

  onlyoffice:
    image: onlyoffice/documentserver
    version: 8.2.2
    container_name: onlyoffice
    subdomain: onlyoffice
    networks:
      - caddy
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    phase: applications
    phase_order: 4

# AI/ML Services
ai:
  vllm:
    image: vllm/vllm-openai
    version: latest
    container_name: vllm
    subdomain: null
    networks:
      - ai  # ISOLATED - AI network only, no backend access
    health_check:
      type: docker
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 2m
    phase: ai
    phase_order: 5
    resources:
      memory: 16G
      cpus: "12.0"
    gpu: true

  embedding-service:
    image: ghcr.io/huggingface/text-embeddings-inference
    version: cpu-1.2
    container_name: embedding-service
    subdomain: null
    networks:
      - ai  # ISOLATED - AI network only
      - ai-gateway  # Controlled access for unified-indexer
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    phase: ai
    phase_order: 5

  litellm:
    image: ghcr.io/berriai/litellm
    version: v1.74.9-stable.patch.1
    container_name: litellm
    subdomain: litellm
    additional_aliases:
      - api.litellm
    networks:
      - ai  # ISOLATED - AI network only
      - litellm  # Gateway for apps needing AI access
      - caddy  # Only for Caddy access (external API)
    depends_on:
      - vllm
    health_check:
      type: docker
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    phase: ai
    phase_order: 5

# Datamancy Custom Services
datamancy:
  control-panel:
    image: datamancy/control-panel
    version: local-build
    container_name: control-panel
    subdomain: control
    networks:
      - caddy
      - postgres
    depends_on:
      - postgres
      - data-fetcher
      - unified-indexer
    ports:
      - "8097:8097"
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  data-fetcher:
    image: datamancy/data-fetcher
    version: local-build
    container_name: data-fetcher
    subdomain: null
    networks:
      - postgres
      - clickhouse
      - mariadb  # Needs bookstack's DB
    depends_on:
      - postgres
      - clickhouse
      - bookstack
    health_check:
      type: docker
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  unified-indexer:
    image: datamancy/unified-indexer
    version: local-build
    container_name: unified-indexer
    subdomain: null
    networks:
      - postgres
      - mariadb  # Needs bookstack's DB
      - qdrant
      - clickhouse
      - ai-gateway  # Access to embedding-service via gateway
    depends_on:
      - postgres
      - bookstack
      - qdrant
      - clickhouse
      - embedding-service
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  search-service:
    image: datamancy/search-service
    version: local-build
    container_name: search-service
    subdomain: null
    networks:
      - qdrant
      - clickhouse
      - ai-gateway  # Access to embedding-service via gateway
    depends_on:
      - qdrant
      - clickhouse
      - embedding-service
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    phase: datamancy
    phase_order: 6

  agent-tool-server:
    image: datamancy/agent-tool-server
    version: local-build
    container_name: agent-tool-server
    subdomain: agent-tool-server
    networks:
      - ai  # ISOLATED - Lives in AI zone (untrusted external actors)
      - ai-gateway  # Controlled access to internal API gateway only
      - caddy  # Only for Caddy access (MCP protocol)
    depends_on:
      - litellm
      - datamancy-api-gateway  # Must go through gateway, no direct DB access
    health_check:
      type: docker
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    phase: datamancy
    phase_order: 6
    security_note: "EXTERNAL ACTOR ZONE - This service proxies LLM requests. Network isolated from backend/database."

# Metadata about phases (for controller)
phases:
  core:
    order: 1
    description: Core infrastructure (networks, volumes, caddy, ldap, valkey)
    timeout_seconds: 90

  databases:
    order: 2
    description: Database services (postgres, mariadb, clickhouse, qdrant)
    timeout_seconds: 120

  auth:
    order: 3
    description: Authentication services (authelia, mailserver)
    timeout_seconds: 120

  applications:
    order: 4
    description: Web applications (bookstack, grafana, etc.)
    timeout_seconds: 180

  ai:
    order: 5
    description: AI/ML services (vllm, litellm, embedding)
    timeout_seconds: 300

  datamancy:
    order: 6
    description: Datamancy services (control-panel, search, indexer)
    timeout_seconds: 120
