# Provenance: Dex OIDC Provider Configuration
# Reference: https://dexidp.io/docs/
# Purpose: OIDC provider with LDAP backend for SSO

issuer: https://stack.local/dex

storage:
  type: memory

web:
  http: 0.0.0.0:5556

# Frontend theme
frontend:
  theme: "light"
  issuer: "Datamancy"
  logoURL: ""

# OIDC client configurations
staticClients:
  - id: grafana
    redirectURIs:
      - 'https://stack.local/grafana/login/generic_oauth'
    name: 'Grafana'
    secret: 'grafana-client-secret-change-me'

  - id: traefik-forward-auth
    redirectURIs:
      - 'https://stack.local/oauth2/callback'
    name: 'Traefik Forward Auth'
    secret: 'traefik-forward-auth-secret-change-me'

# Connectors - how Dex authenticates users
connectors:
  - type: ldap
    id: ldap
    name: LDAP
    config:
      host: openldap:389
      insecureNoSSL: true
      insecureSkipVerify: true

      # Bind credentials for Dex to search LDAP
      bindDN: cn=admin,dc=datamancy,dc=local
      bindPW: admin_password

      # User search configuration
      # Search across multiple OUs: people and service-accounts
      userSearch:
        baseDN: dc=datamancy,dc=local
        filter: "(&(objectClass=inetOrgPerson)(|(ou:dn:=people)(ou:dn:=service-accounts)))"
        username: uid
        idAttr: uid
        emailAttr: mail
        nameAttr: cn

      # Group search configuration
      groupSearch:
        baseDN: ou=groups,dc=datamancy,dc=local
        filter: "(objectClass=groupOfNames)"
        userMatchers:
          - userAttr: DN
            groupAttr: member
        nameAttr: cn

# OAuth2 configuration
oauth2:
  skipApprovalScreen: true
  responseTypes: ["code"]

# Enable the /metrics endpoint for Prometheus
telemetry:
  http: 0.0.0.0:5558

# Logging
logger:
  level: "debug"
  format: "json"
