###############################################
# Caddy config for Datamancy (testing/dev)
#
# - Uses self-signed certificates by default via Caddy's internal CA.
# - Official Caddy image + a static Caddyfile (no docker label proxy).
# - Most apps are protected with Authelia via forward_auth where labels
#   previously specified it.
#
# Env vars used inside this file (must be provided to the Caddy container):
# - DOMAIN                     (e.g. example.com)
# - API_LITELLM_ALLOWLIST     (space-separated CIDRs)
###############################################
{
    # Default to self-signed certificates (no external ACME in dev/test)
    local_certs
}

# ldap-account-manager
lam.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy ldap-account-manager:80
    }
}

# Authelia portal
auth.project-saturn.com {
    reverse_proxy authelia:9091
}

# CouchDB
couchdb.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy couchdb:5984
    }
}

# Mailu front (web UI only; mail ports handled by Mailu directly)
mail.project-saturn.com {
    reverse_proxy mailu-front:80
}

# SOGo (groupware UI)
sogo.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy sogo:20000
    }
}

# Dockge
dockge.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy dockge:5001
    }
}

# Kopia UI
kopia.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy kopia:51515
    }
}

# Portainer
portainer.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy portainer:9000
    }
}

# Grafana (uses OIDC within the app; no edge forward_auth)
grafana.project-saturn.com {
    reverse_proxy grafana:3000
}

# Open WebUI
open-webui.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy open-webui:8080
    }
}

# Vaultwarden
vaultwarden.project-saturn.com {
    reverse_proxy vaultwarden:80
}

# Planka
planka.project-saturn.com {
    reverse_proxy planka:1337
}

# Outline
outline.project-saturn.com {
    reverse_proxy outline:3000
}

# Seafile
seafile.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy seafile:80
    }
}

# OnlyOffice
onlyoffice.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy onlyoffice:80
    }
}

# Matrix (Synapse)
matrix.project-saturn.com {
    reverse_proxy synapse:8008
}

# Mastodon (web)
mastodon.project-saturn.com {
    reverse_proxy mastodon-web:3000
}

# Homepage
homepage.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}

# JupyterHub
jupyterhub.project-saturn.com {
    reverse_proxy jupyterhub:8000
}

# Home Assistant
homeassistant.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homeassistant:8123
    }
}

# LiteLLM (protected)
litellm.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy litellm:4000
    }
}

# LiteLLM (public API) â€” allowlist by IP, no forward_auth
api.litellm.project-saturn.com {
    @notallowed not remote_ip {$API_LITELLM_ALLOWLIST}
    respond @notallowed 403
    reverse_proxy litellm:4000
}

# agent-tool-server (protected)
agent-tool-server.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy agent-tool-server:8081
    }
}

# ClickHouse HTTP
clickhouse.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy clickhouse:8123
    }
}

# vLLM Router (protected)
vllm-router.project-saturn.com {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy vllm-router:8010
    }
}
