# Traefik Static Configuration
# Provenance: Based on Traefik v2.11 official documentation + Docker Compose best practices
# Sources:
#   - https://doc.traefik.io/traefik/reference/static-configuration/file/
#   - https://doc.traefik.io/traefik/providers/docker/
#   - https://doc.traefik.io/traefik/observability/metrics/prometheus/
#
# Purpose: Reverse proxy with TLS termination, Docker provider via socket proxy,
# correlation ID tracking, and Prometheus metrics for observability

global:
  checkNewVersion: false
  sendAnonymousUsage: false

# API and Dashboard - Exposed on :8080 (will be protected in Phase 3)
api:
  dashboard: true
  insecure: true

# Structured logging for Loki ingestion
log:
  level: INFO
  format: json

# Access logs with correlation ID header preservation
accessLog:
  format: json
  fields:
    defaultMode: keep
    headers:
      defaultMode: keep
      names:
        X-Test-Run: keep  # Correlation ID from test-runner
        X-Correlation-Id: keep

# EntryPoints - HTTP redirect to HTTPS
entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https

  websecure:
    address: ":443"
    http:
      tls:
        domains:
          - main: "test.local"
            sans:
              - "*.test.local"

# Providers
providers:
  # Docker provider via socket proxy (least-privilege access)
  docker:
    endpoint: "tcp://docker-socket-proxy:2375"
    exposedByDefault: false
    network: apps
    watch: true

  # File provider for dynamic config (forward-auth, middleware)
  file:
    directory: /etc/traefik/dynamic
    watch: true

# TLS certificates from self-contained CA
tls:
  certificates:
    - certFile: /certs/wildcard.test.local.crt
      keyFile: /certs/wildcard.test.local.key
  stores:
    default:
      defaultCertificate:
        certFile: /certs/wildcard.test.local.crt
        keyFile: /certs/wildcard.test.local.key

# Prometheus metrics endpoint (/metrics on :8080)
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
