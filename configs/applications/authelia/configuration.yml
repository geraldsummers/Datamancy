---
# ==============================================
# PRODUCTION DOMAIN: project-saturn.com
# All domains, session cookies, and redirect URIs
# use project-saturn.com for production deployment.
# ==============================================
theme: dark
server:
  host: 0.0.0.0
  port: 9091
  read_buffer_size: 8192
  write_buffer_size: 8192
  endpoints:
    authz:
      forward-auth:
        implementation: ForwardAuth
    enable_pprof: false
    enable_expvars: false
  timeouts:
    read: 30s
    write: 30s
    idle: 120s

log:
  level: info
  format: text

telemetry:
  metrics:
    enabled: true
    address: tcp://0.0.0.0:9959

totp:
  issuer: project-saturn.com
  period: 30
  skew: 1

authentication_backend:
  refresh_interval: 5m
  password_reset:
    disable: false
  ldap:
    implementation: custom
    url: ldap://ldap:389
    timeout: 5s
    start_tls: false
    base_dn: dc=stack,dc=local
    username_attribute: uid
    additional_users_dn: ou=users
    users_filter: (&({username_attribute}={input})(objectClass=inetOrgPerson))
    additional_groups_dn: ou=groups
    groups_filter: (&(member={dn})(objectClass=groupOfNames))
    group_name_attribute: cn
    mail_attribute: mail
    display_name_attribute: displayName
    user: cn=admin,dc=stack,dc=local

access_control:
  default_policy: deny
  rules:
    - domain: auth.project-saturn.com
      policy: bypass
    # Home Assistant webhooks need bypass
    - domain: homeassistant.project-saturn.com
      policy: bypass
      resources:
        - "^/api/webhook/.*$"
    # Container management requires admin access
    - domain: dockge.project-saturn.com
      policy: one_factor
      subject:
        - "group:admins"
    # All other services accessible to admins and users
    - domain: "*.project-saturn.com"
      policy: one_factor
      subject:
        - "group:admins"
        - "group:users"

session:
  cookies:
    - domain: project-saturn.com
      name: authelia_session
      authelia_url: https://auth.project-saturn.com
      default_redirection_url: https://homepage.project-saturn.com
      same_site: lax
      expiration: 1h
      inactivity: 5m
  remember_me: 1M
  redis:
    host: redis
    port: 6379
    database_index: 0

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

storage:
  encryption_key: a_very_important_secret # Will be overridden by env var
  local:
    path: /config/db.sqlite3

notifier:
  disable_startup_check: true
  filesystem:
    filename: /config/notification.txt

identity_providers:
  oidc:
    hmac_secret: another_very_important_secret # Will be overridden by env var
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    jwks:
      - key_id: 'main'
        algorithm: 'RS256'
        use: 'sig'
        key: |
          -----BEGIN PRIVATE KEY-----
          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
          MdqpM3AxJ0/S6yVTWJh+4Leiz+ku
          -----END PRIVATE KEY-----

    clients:
      # Grafana
      - client_id: grafana
        client_name: Grafana
        client_secret: '$pbkdf2-sha512$310000$sdc15.QdoAQO5WaI34.SIA$9/Rzr6h4VD1dfMgwcJ3oguW5CPXpieD8bpgoNTuL980Cwl1qRXmpXVpwNVU7T1e4IfebEO/bjG.FDTYy2evieA'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://grafana.project-saturn.com/login/generic_oauth
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # pgAdmin
      - client_id: pgadmin
        client_name: pgAdmin
        client_secret: '$pbkdf2-sha512$310000$hGULPsGTpdhUaJArnFQw1w$DTGHhG8IH1MKr/CBtF4SyfYz0ShKwYLHhmaplEkRoQjGlUS8w41j.8haBv4YFEnMkTMm9ssWRyHk.VqwN1hZ.A'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://pgadmin.project-saturn.com/oauth2/authorize
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code

      # Dockge (Container Management)
      - client_id: dockge
        client_name: Dockge
        client_secret: '$pbkdf2-sha512$310000$xjrtm1exLKsKtYqhd87hmw$k6Ovf7uY0UrNmqb2C2UdOuET9jQBgrSL3MSAxJmn.NrejoZC0fxEZBOTJaIvRkAO.QkVwAX09m1005DccL2DMA'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://dockge.project-saturn.com/
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Open WebUI
      - client_id: open-webui
        client_name: Open WebUI
        client_secret: '$pbkdf2-sha512$310000$l1hLi5YZi6aUcZrwt33IjA$hetxpKIsg4VcjN/yx7QgwMf5aAHu76WhirCGOTMJW4p4ePOx5OiTtqyM.39snwLcHE6cR4JAExVsnAkJR.n4Ng'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://open-webui.project-saturn.com/oauth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Nextcloud
      - client_id: nextcloud
        client_name: Nextcloud
        client_secret: '$pbkdf2-sha512$310000$rxb1/DG60ybksyZZBllrkQ$L/G5aC852AnxXBTGD3rVtqXT3QWYFvfeVKyWNLwmIFXb/Xkt.09CRbsjGdooX9qc7alqlrpqVweZqoanlVHfSw'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://nextcloud.project-saturn.com/apps/oidc_login/oidc
          - https://nextcloud.project-saturn.com/apps/user_oidc/code
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # Dim Media Server
      - client_id: dim
        client_name: Dim
        client_secret: '$pbkdf2-sha512$310000$mtRWWM6rKQX2xKHXjXZ7jA$3gIN6Y2Zlg5W9U1H50bvRrh6335PtoPKgepQkSVQ5vp7bnXbONPtycolpHtgGeXiH5UfhHHFQda0N3FkTI2eWw'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://dim.project-saturn.com/api/v1/auth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Planka
      - client_id: planka
        client_name: Planka
        client_secret: '$pbkdf2-sha512$310000$TGYuFojCMUJkeHtll1uIbA$6vo1/Tf4KclfPPHUMogBprbrV.9Wydb8i3yJwzovTYsuWPIPux083f1.SdJOLbTbwJMWUGPEEndUs3BN8Z04ow'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://planka.project-saturn.com/oidc-callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        response_modes:
          - query
          - fragment
          - form_post

      # BookStack (protected via Caddy forward_auth; no direct OIDC client required)
      # This section intentionally left without a client for BookStack because
      # access control is handled by Caddy's forward_auth to Authelia.

      # Home Assistant
      - client_id: home-assistant
        client_name: Home Assistant
        client_secret: '$pbkdf2-sha512$310000$nFwKGC1LCgUVzGjhK.769g$BQ83aKaFDJ5ljHjiWyVV2du/TS6yRanKPf0jYNpczttbZdpCg/56pLx1FtR.7Gqswti.SWHFnRi/cyR1pI5qBA'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://homeassistant.project-saturn.com/auth/external/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # JupyterHub
      - client_id: jupyterhub
        client_name: JupyterHub
        client_secret: '$pbkdf2-sha512$310000$TfK96.U2ZxeoDXe5txMcTw$MqxrLDShlt3/MXo5W.VNX4jVNv5GXVYOT5DTP/ZnRx6iocUeAeJFR5OV8Z8DsNTdWUqEnkAJIHg2XZLhJ54XCg'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://jupyterhub.project-saturn.com/hub/oauth_callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # Vaultwarden (Bitwarden-compatible)
      # NOTE: Set VAULTWARDEN_OAUTH_SECRET in your .env to a strong value and
      # update this hash to match (pbkdf2-sha512). Use Authelia's crypto tool to generate.
      - client_id: vaultwarden
        client_name: Vaultwarden
        client_secret: '$pbkdf2-sha512$310000$3Qj3G8rM7vV3qJg8LQ0T3A$dVJzAbg9y3gE0q0mQx0lJ4h7wQq9Vv8K6t7t1g9y1h2Yx4M8J9J4H8cY0f2Z6G7j5r1D2s3E5f6G7h8i9j0k' # TODO: replace with real hash
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://vaultwarden.project-saturn.com/identity/connect/oidc-signin
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
