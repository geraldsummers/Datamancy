{
	admin off
	local_certs
}

# Authentication endpoint (no SSO protection)
auth.stack.local {
	tls internal
	reverse_proxy authelia:9091
}

# Grafana (OAuth via application, not forward_auth)
grafana.stack.local {
	tls internal
	reverse_proxy grafana:3000
}

# Adminer with SSO
adminer.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://adminer.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy adminer:8080
}

# pgAdmin with SSO
pgadmin.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://pgadmin.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy pgadmin:80
}

# Portainer with SSO
portainer.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://portainer.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy portainer:9000
}

# LocalAI with SSO
localai.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://localai.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy localai:8080
}

# Open WebUI with native OIDC (no forward_auth needed)
open-webui.stack.local {
	tls internal
	reverse_proxy open-webui:8080
}

# Kopia with SSO
kopia.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://kopia.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy kopia:51515
}

# Nextcloud with native OIDC (no forward_auth needed)
nextcloud.stack.local {
	tls internal
	reverse_proxy nextcloud:80 {
		# Increase timeouts for large file uploads
		transport http {
			read_timeout 3600s
			write_timeout 3600s
		}
	}

	# Nextcloud specific headers
	header {
		Strict-Transport-Security "max-age=15552000;"
	}
}

# Vaultwarden with native OIDC (no forward_auth needed)
vaultwarden.stack.local {
	tls internal
	reverse_proxy vaultwarden:80

	# Security headers for password manager
	header {
		Strict-Transport-Security "max-age=31536000;"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
	}
}

# Benthos with SSO
benthos.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://benthos.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy benthos:4195
}

# Jellyfin with native OIDC (no forward_auth needed)
jellyfin.stack.local {
	tls internal
	reverse_proxy jellyfin:8096
}

# Home Assistant with native OIDC (no forward_auth needed)
homeassistant.stack.local {
	tls internal
	reverse_proxy homeassistant:8123
}

# Planka with native OIDC (no forward_auth needed)
planka.stack.local {
	tls internal
	reverse_proxy planka:1337
}

# Outline with native OIDC (no forward_auth needed)
outline.stack.local {
	tls internal
	reverse_proxy outline:3000
}

# Browserless with SSO
browserless.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://browserless.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy browserless:3000
}

# CouchDB with SSO
couchdb.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://couchdb.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy couchdb:5984
}

# ClickHouse with SSO
clickhouse.stack.local {
	tls internal
	forward_auth authelia:9091 {
		uri /api/verify?rd=https://auth.stack.local/?rd=https://clickhouse.stack.local
		copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
	}
	reverse_proxy clickhouse:8123
}
