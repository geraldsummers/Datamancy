# Prometheus Alert Rules
# Provenance: Phase 6 - Security hardening
# Purpose: Basic infrastructure health alerts

groups:
  - name: infrastructure
    interval: 30s
    rules:
      # Service availability alerts
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} on {{ $labels.instance }} has been down for more than 2 minutes."

      # Prometheus self-monitoring
      - alert: PrometheusConfigReloadFailed
        expr: prometheus_config_last_reload_successful == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus configuration reload failed"
          description: "Prometheus {{ $labels.instance }} configuration reload has failed."

      - alert: PrometheusTSDBCompactionsFailed
        expr: increase(prometheus_tsdb_compactions_failed_total[1h]) > 0
        labels:
          severity: warning
        annotations:
          summary: "Prometheus TSDB compactions failed"
          description: "Prometheus {{ $labels.instance }} has failed compactions in the last hour."

      # Storage alerts
      - alert: PrometheusStorageNearFull
        expr: prometheus_tsdb_storage_blocks_bytes / prometheus_tsdb_storage_blocks_bytes{quantile="1.0"} > 0.85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus storage is filling up"
          description: "Prometheus {{ $labels.instance }} storage is {{ $value | humanizePercentage }} full."

      # Alertmanager connectivity
      - alert: AlertmanagerDown
        expr: up{job="alertmanager"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Alertmanager is down"
          description: "Alertmanager {{ $labels.instance }} is down for more than 5 minutes."

      # Scrape failures
      - alert: PrometheusScrapeFailures
        expr: increase(prometheus_target_scrapes_exceeded_sample_limit_total[5m]) > 0
        labels:
          severity: warning
        annotations:
          summary: "Prometheus scrape failures detected"
          description: "Prometheus {{ $labels.instance }} has scrape failures for target {{ $labels.job }}."
