name: Test JupyterLab Web3 Wallet Extension

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Python backend tests
  python-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -r tests/requirements.txt

    - name: Run Python tests
      run: |
        pytest tests/ -v --cov=datamancy_jupyterlab_web3_wallet --cov-report=xml

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: python

  # TypeScript/JavaScript tests
  typescript-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install -g yarn
        jlpm install

    - name: Build extension
      run: jlpm build

    - name: Lint TypeScript
      run: jlpm lint || true  # Don't fail on lint errors for now

  # Playwright UI tests
  playwright-tests:
    runs-on: ubuntu-latest

    services:
      jupyterlab:
        image: jupyter/minimal-notebook:latest
        ports:
          - 8888:8888

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium

    - name: Install extension in JupyterLab
      run: |
        pip install -e .
        jlpm install
        jlpm build
        jupyter labextension develop . --overwrite

    - name: Run Playwright tests
      run: |
        npx playwright test
      env:
        JUPYTER_URL: http://localhost:8888

    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: playwright-report
        path: ui-tests/playwright-report/

  # Integration tests (requires full Datamancy stack)
  integration-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build test-runner
      run: |
        cd kotlin.src/test-runner
        ./gradlew shadowJar

    - name: Run Web3 wallet integration tests
      run: |
        # This would require the full stack to be running
        # For now, just verify the test suite compiles
        echo "Integration tests require full stack deployment"
        echo "Run manually with: ./test-runner --suite=web3-wallet"

  # Build verification
  build-check:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Build Python package
      run: |
        pip install build
        python -m build

    - name: Build JupyterLab extension
      run: |
        jlpm install
        jlpm build
        jupyter labextension build .

    - name: Verify package contents
      run: |
        pip install check-manifest
        check-manifest || true  # Don't fail on missing files

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: extension-packages
        path: |
          dist/*.whl
          dist/*.tar.gz
