---
# ==============================================
# PRODUCTION DOMAIN: datamancy.net
# All domains, session cookies, and redirect URIs
# use datamancy.net for production deployment.
# ==============================================
theme: dark
server:
  address: tcp://0.0.0.0:9091/
  buffers:
    read: 8192
    write: 8192
  endpoints:
    authz:
      forward-auth:
        implementation: ForwardAuth
    enable_pprof: false
    enable_expvars: false
  timeouts:
    read: 30s
    write: 30s
    idle: 120s

log:
  level: info
  format: text

telemetry:
  metrics:
    enabled: true
    address: tcp://0.0.0.0:9959

totp:
  issuer: datamancy.net
  period: 30
  skew: 1

authentication_backend:
  refresh_interval: 5m
  password_reset:
    disable: false
  ldap:
    implementation: custom
    address: ldap://ldap:389
    timeout: 5s
    start_tls: false
    base_dn: dc=stack,dc=local
    additional_users_dn: ou=users
    users_filter: (&({username_attribute}={input})(objectClass=inetOrgPerson))
    additional_groups_dn: ou=groups
    groups_filter: (&(member={dn})(objectClass=groupOfNames))
    attributes:
      username: uid
      group_name: cn
      mail: mail
      display_name: displayName
    user: cn=admin,dc=stack,dc=local

access_control:
  default_policy: deny
  rules:
    - domain: auth.datamancy.net
      policy: bypass
    # Home Assistant webhooks need bypass
    - domain: homeassistant.datamancy.net
      policy: bypass
      resources:
        - "^/api/webhook/.*$"
    # qBittorrent - one_factor for all authenticated users (admins, operators, users)
    - domain: qbittorrent.datamancy.net
      policy: one_factor
    # Apex domain - homepage
    - domain: datamancy.net
      policy: one_factor
      subject:
        - "group:admins"
        - "group:operators"
        - "group:users"
    # All other services accessible to admins, operators, and users
    - domain: "*.datamancy.net"
      policy: one_factor
      subject:
        - "group:admins"
        - "group:operators"
        - "group:users"

session:
  cookies:
    - domain: datamancy.net
      name: authelia_session
      authelia_url: https://auth.datamancy.net
#      default_redirection_url: https://homepage.datamancy.net
      same_site: lax
      expiration: 8h
      inactivity: 1h
  # Security: 7 days is safer than 1 month for production
  # If stolen, "remember me" cookie is only valid for 1 week
  remember_me: 7d
  redis:
    host: valkey
    port: 6379
    database_index: 0

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

identity_validation:
  reset_password:
    jwt_secret: a_very_important_secret # Will be overridden by env var

storage:
  encryption_key: a_very_important_secret # Will be overridden by env var
  postgres:
    address: tcp://postgres:5432
    database: authelia
    schema: public
    username: authelia
    # Password is provided via AUTHELIA_STORAGE_POSTGRES_PASSWORD env var
    timeout: 5s

notifier:
  disable_startup_check: true
  filesystem:
    filename: /config/notification.txt

identity_providers:
  oidc:
    hmac_secret: another_very_important_secret # Will be overridden by env var
    lifespans:
      access_token: 1h
      authorize_code: 1m
      id_token: 1h
      refresh_token: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    # OIDC signing key loaded from environment variable AUTHELIA_IDENTITY_PROVIDERS_OIDC_JWKS (base64-encoded)
    jwks: []

    clients:
      # pgAdmin
      - client_id: pgadmin
        client_name: pgAdmin
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$6cN7D0+yWAN45+I3vqO0kg$XCsO8Az2a3AImApahlYNGURyYcPKhsgZLVuxpBXf0o0'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://pgadmin.datamancy.net/oauth2/authorize
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code


      # Open WebUI
      - client_id: open-webui
        client_name: Open WebUI
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$FA+s/I2scPOyDTLPaUdjjQ$/pCIzN3UID8WlaPOBOrwOHBGBXSFQf9aY8mtvwFeYoY'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://open-webui.datamancy.net/oauth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Nextcloud
      - client_id: nextcloud
        client_name: Nextcloud
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$w9d1IYriVRGKU/bhd6GEIQ$spmallic2G3Z7Y6c5uWvVtUAfqmaAJTdCjH69r8y8w4'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://nextcloud.datamancy.net/apps/oidc_login/oidc
          - https://nextcloud.datamancy.net/apps/user_oidc/code
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # Dim Media Server
      - client_id: dim
        client_name: Dim
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$jsPEQRCU0aQA3i+iB//YfA$uGDkxs6YXvcPQ44jhuFC7nQIPwTLz4Zd3+/HjwbZu7Y'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://dim.datamancy.net/api/v1/auth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Planka
      - client_id: planka
        client_name: Planka
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$Hwt24mNbQXDeHa2Iw+Fz6A$NkOY/yoCSUoXSee78qpQ2UH3TYIUrUemaRLbkCpkSWQ'
        public: false
        authorization_policy: one_factor
        token_endpoint_auth_method: client_secret_basic
        redirect_uris:
          - https://planka.datamancy.net/oidc-callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        response_modes:
          - query
          - fragment
          - form_post

      # Vaultwarden (Bitwarden-compatible)
      # NOTE: Set VAULTWARDEN_OAUTH_SECRET in your .env to a strong value and
      # update this hash to match (pbkdf2-sha512). Use Authelia's crypto tool to generate.
      - client_id: vaultwarden
        client_name: Vaultwarden
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$ar+C0OanTR+gfjwyg6f9dw$nDj278TRmJ/2C4UgRZ6m2wJxv0HAMuCpoD9fhfJoIUw'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://app.vaultwarden.datamancy.net/identity/connect/oidc-signin
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Mastodon
      - client_id: mastodon
        client_name: Mastodon
        client_secret: '${MASTODON_OIDC_SECRET}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://mastodon.datamancy.net/auth/auth/openid_connect/callback
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code

      # Bookstack (Wiki/Documentation) - Seamless OIDC SSO
      - client_id: bookstack
        client_name: Bookstack
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$fXZY8z5zpqBlJRbhg1lQTA$DrXLTZ2xMEi3c4N4aN16WZ58vPLr3Om4f3oPbcAOJe8'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://bookstack.datamancy.net/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Forgejo (Git Forge)
      - client_id: forgejo
        client_name: Forgejo
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$/yNXalMZq56tcuhcXoc21Q$BlRsdu+FMvp9JzEDQXDVkMjZtKhTFFrZ+wrAYyd7Svg'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://forgejo.datamancy.net/user/oauth2/Authelia/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Matrix Synapse (Element SSO)
      - client_id: matrix
        client_name: Matrix Synapse
        client_secret: '$argon2id$v=19$m=65536,t=3,p=4$wc7HHv9p2r7u9qUZ3fGJnA$kidQlqePil3p5WNrb9EoE2FK1bM/+ifUZVYGBz9BOEo'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://matrix.datamancy.net/_synapse/client/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

