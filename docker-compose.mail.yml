# Mail Services
# Mailu stack (front, admin, SMTP, IMAP, webmail, redis, antispam, antivirus) + SOGo

services:

  # ======================
  # Mail - Mailu stack
  # ======================
  # Auth: ‚úÖ OIDC HEADER AUTH (ADMIN UI) + üîì SELF-CONTAINED (MAIL PROTOCOLS)
  #       Admin UI: OIDC via reverse proxy header authentication (Mailu 2024.06+)
  #         Configure Caddy to inject authentication headers from Authelia
  #         Mailu reads X-Remote-User header for SSO authentication
  #       SMTP/IMAP/POP3: Direct username+password authentication (no SSO possible)
  #       Webmail (Roundcube): Authenticates against Mailu IMAP backend
  #       Redis: Internal cache for Mailu services
  #
  # Mailu Header Auth Configuration (mailu.env):
  #   PROXY_AUTH_HEADER=X-Remote-User
  #   PROXY_AUTH_CREATE=True
  #   PROXY_AUTH_WHITELIST=172.18.0.0/16
  #
  # Caddy Configuration (add forward_auth to mail.${DOMAIN} route):
  #   forward_auth authelia:9091 {
  #     uri /api/verify?rd=https://auth.${DOMAIN}
  #     copy_headers Remote-User Remote-Email
  #   }
  #
  # Note: Mail protocols (SMTP/IMAP) CANNOT use SSO due to protocol limitations
  #       Users must use traditional email+password for mail clients
  #       SSO only applies to web admin UI and webmail via browser
  #
  # Authelia ACL Policy Required:
  #   - domain: mail.${DOMAIN}
  #     policy: two_factor
  #     subject: group:admins
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - Mailu-redis: Backend cache, no user interface
  #   - Mailu-antivirus, antispam: Mail processing, no direct access
  mailu-front:
    image: ghcr.io/mailu/nginx:2024.06.45
    container_name: mailu-front
    restart: unless-stopped
    labels:
      caddy: mail.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    env_file:
      - configs/mailu/mailu.env
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
    volumes:
      - mailu_cert:/certs
      - mailu_dkim:/dkim
    networks:
      - mail
      - test
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-redis:
    image: redis:7.4.7-alpine
    container_name: mailu-redis
    restart: unless-stopped
    networks:
      mail:
        aliases:
          - redis
          - mailu-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  mailu-antispam:
    image: ghcr.io/mailu/rspamd:2024.06.45
    container_name: mailu-antispam
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_filter:/var/lib/rspamd
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rspamc", "stat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-antivirus:
    image: ghcr.io/mailu/clamav:2.0.43
    container_name: mailu-antivirus
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    networks:
      - mail
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "1"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 5m

  mailu-imap:
    image: ghcr.io/mailu/dovecot:2024.06.45
    container_name: mailu-imap
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "doveadm", "director", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-smtp:
    image: ghcr.io/mailu/postfix:2024.06.45
    container_name: mailu-smtp
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
      - mailu_dkim:/dkim
    networks:
      - mail
      - backend
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "postfix", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-admin:
    image: ghcr.io/mailu/admin:2024.06.45
    container_name: mailu-admin
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
    networks:
      - mail
    depends_on:
      postgres:
        condition: service_healthy
      mailu-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "-L", "http://localhost:8080/admin/ui"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  mailu-webmail:
    image: ghcr.io/mailu/webmail:2024.06.45
    container_name: mailu-webmail
    restart: unless-stopped
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - ./configs/mailu/nginx-override.conf:/overrides/nginx/roundcube.conf:ro
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
      mailu-imap:
        condition: service_healthy
      mailu-front:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Groupware - SOGo
  # ======================
  # Auth: üîì SELF-CONTAINED (IMAP/SMTP AUTH) - ‚ö†Ô∏è NO OIDC SUPPORT
  #       SOGo: Authenticates users against Mailu IMAP backend
  #       SOGO_MAIL_SERVER: mailu-imap (SOGo proxies login to mail server)
  #       No separate user database - uses Mailu user accounts
  #       SAML: SOGo supports SAML SSO (not OIDC), but complex config required
  #       Why not OIDC: SOGo does NOT support OpenID Connect (SAML only)
  #       User management: Create users in Mailu, SOGo recognizes them automatically
  #
  # Alternative: Could configure SOGo SAML with Authelia (requires authelia SAML support)
  #   But SAML config is complex and provides minimal benefit for groupware use case
  #   Prefer: Protect SOGo route with Caddy forward-auth for extra security layer
  #
  # Recommended Caddy Config (optional extra auth):
  #   forward_auth authelia:9091 {
  #     uri /api/verify?rd=https://auth.${DOMAIN}
  #   }
  #   Then SOGo still requires IMAP credentials after SSO gate
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - SOGo data volume: File storage, no interface
  sogo:
    image: pmietlicki/sogo:v5
    container_name: sogo
    restart: unless-stopped
    labels:
      caddy: sogo.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 20000}}"
    environment:
      - SOGO_WORKERS=1
      - SOGO_SIEVE_SCRIPTS_ENABLED=YES
      - SOGO_DOMAIN=${MAIL_DOMAIN}
      - SOGO_WEB_LOGIN_ENABLE_EMAIL_LOGIN=YES
      - SOGO_MAIL_SERVER=mailu-imap
      - SOGO_SOGOIMAPSERVERS=mailu-imap:143
      - SOGO_SOGOSMTPSERVERS=mailu-smtp:587
      - SOGO_SOGoSMTPAuthenticationType=PLAIN
      - SOGO_SOGoIMAPServer=imap
      - TZ=UTC
    volumes:
      - sogo_data:/var/lib/sogo
    depends_on:
      mailu-imap:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    networks:
      - backend
      - mail
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:20000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
