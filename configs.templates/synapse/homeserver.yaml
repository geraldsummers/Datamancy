server_name: "matrix.{{DOMAIN}}"
pid_file: /data/homeserver.pid
public_baseurl: "https://matrix.{{DOMAIN}}/"
serve_server_wellknown: true

listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation]
        compress: false

database:
  name: psycopg2
  allow_unsafe_locale: true
  args:
    user: synapse
    password: "{{SYNAPSE_DB_PASSWORD}}"
    database: synapse
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 10

redis:
  enabled: true
  host: valkey
  port: 6379


media_store_path: /data/media_store
uploads_path: /data/uploads

max_upload_size: 50M

registration_shared_secret: "{{SYNAPSE_REGISTRATION_SECRET}}"
macaroon_secret_key: "{{SYNAPSE_MACAROON_SECRET}}"
form_secret: "{{SYNAPSE_FORM_SECRET}}"

signing_key_path: "/data/matrix.{{DOMAIN}}.signing.key"

trusted_key_servers:
  - server_name: "matrix.org"

report_stats: true

enable_registration: false
enable_registration_without_verification: false

password_providers:
  - module: "ldap_auth_provider.LdapAuthProvider"
    config:
      enabled: true
      uri: "ldap://ldap:389"
      start_tls: false
      base: "ou=users,{{LDAP_BASE_DN}}"
      bind_dn: "cn=admin,{{LDAP_BASE_DN}}"
      bind_password: "{{LDAP_ADMIN_PASSWORD}}"
      attributes:
        uid: "uid"
        mail: "mail"
        name: "displayName"
      filter: "(&(objectClass=inetOrgPerson)(uid={uid}))"

oidc_providers:
  - idp_id: authelia
    idp_name: "Authelia SSO"
    idp_brand: "authelia"
    discover: true
    skip_verification: true
    issuer: "http://authelia:9091"
    client_id: "matrix"
    client_secret: "{{MATRIX_OAUTH_SECRET}}"
    client_auth_method: "client_secret_post"
    scopes:
      - "openid"
      - "profile"
      - "email"
      - "groups"
    authorization_endpoint: "https://auth.{{DOMAIN}}/api/oidc/authorization"
    token_endpoint: "https://auth.{{DOMAIN}}/api/oidc/token"
    userinfo_endpoint: "https://auth.{{DOMAIN}}/api/oidc/userinfo"
    user_mapping_provider:
      config:
        localpart_template: '{{ user.preferred_username|lower }}'
        display_name_template: '{{ user.name }}'
        email_template: '{{ user.email }}'
    allow_existing_users: true
    backchannel_logout_enabled: false

url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - '::1/128'
  - 'fe80::/64'
  - 'fc00::/7'

trusted_key_servers:
  - server_name: "matrix.org"

federation_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
