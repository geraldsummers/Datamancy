###############################################
# Caddy config for Datamancy
#
# - Official Caddy image + a static Caddyfile (no docker label proxy).
# - Most apps are protected with Authelia via forward_auth where labels
#   previously specified it.
#
# Env vars used inside this file (must be provided to the Caddy container):
# - DOMAIN                     (e.g. example.com)
# - API_LITELLM_ALLOWLIST     (space-separated CIDRs)
#
# TLS Configuration:
# - Development/Testing: Uses self-signed certs via Caddy's internal CA (local_certs)
# - Production: Comment out local_certs below and uncomment the email line for Let's Encrypt
###############################################
{
    # DEVELOPMENT/TESTING: Self-signed certificates (no external ACME)
    # local_certs

    # PRODUCTION: Uncomment the line below and comment out local_certs above
    # Replace with your actual admin email for Let's Encrypt notifications
    email {{STACK_ADMIN_EMAIL}}

    # Optional: Customize ACME CA (default is Let's Encrypt production)
    # For testing Let's Encrypt without rate limits, use staging:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# ldap-account-manager
lam.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy ldap-account-manager:80
    }
}

# Authelia portal
auth.{{DOMAIN}} {
    reverse_proxy authelia:9091
}

# CouchDB
couchdb.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy couchdb:5984
    }
}

# Mailu front (web UI with Authelia forward_auth for admin/webmail)
mail.{{DOMAIN}} {
    # Admin interface - protected by Authelia
    @admin path /admin /admin/*
    handle @admin {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy mailu-admin:8080 {
            header_up Remote-User {header.Remote-User}
            header_up Remote-Email {header.Remote-Email}
        }
    }


    # SSO endpoints and other paths - no auth required
    reverse_proxy mailu-front:80
}

# SOGo (groupware UI)
sogo.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }

        # SOGo serves at /SOGo path, redirect root to it
        @root path /
        redir @root /SOGo

        reverse_proxy sogo:80
    }
}

# Dockge
dockge.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy dockge:5001
    }
}

# Kopia UI (protected with forward_auth)
kopia.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy kopia:51515
    }
}

# Grafana (protected with forward_auth)
grafana.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy grafana:3000
    }
}

# Open WebUI
open-webui.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy open-webui:8080
    }
}

# Vaultwarden (uses OIDC via SSO_ONLY mode)
vaultwarden.{{DOMAIN}} {
    reverse_proxy vaultwarden:80
}

# Planka (uses OIDC)
planka.{{DOMAIN}} {
    reverse_proxy planka:1337
}

# BookStack (uses Authelia forward_auth)
bookstack.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy bookstack:80
    }
}

# Seafile
seafile.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy seafile:80
    }
}

# OnlyOffice Document Server (internal API only - accessed via Seafile/Nextcloud)
# Not exposed publicly - only accessible on backend network
# onlyoffice.{{DOMAIN}} {
#     route {
#         forward_auth authelia:9091 {
#             uri /api/authz/forward-auth
#             copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
#         }
#         reverse_proxy onlyoffice:80
#     }
# }

# Matrix (Synapse)
matrix.{{DOMAIN}} {
    reverse_proxy synapse:8008
}

# Mastodon (web)
# With OMNIAUTH_ONLY=true, Mastodon auto-redirects unauthenticated users to OIDC
mastodon.{{DOMAIN}} {
    reverse_proxy mastodon-web:3000
}

# Homepage
homepage.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# Homepage
www.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# Homepage
{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# JupyterHub
jupyterhub.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy jupyterhub:8000 {
            header_up Remote-User {header.Remote-User}
            header_up Remote-Email {header.Remote-Email}
            header_up Remote-Name {header.Remote-Name}
        }
    }
}

# Home Assistant
homeassistant.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homeassistant:8123
    }
}

# LiteLLM (protected)
litellm.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy litellm:4000
    }
}

# LiteLLM (public API) â€” allowlist by IP, no forward_auth
api.litellm.{{DOMAIN}} {
    @notallowed not remote_ip {$API_LITELLM_ALLOWLIST}
    respond @notallowed 403
    reverse_proxy litellm:4000
}

# agent-tool-server (protected)
agent-tool-server.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy agent-tool-server:8081
    }
}

# ClickHouse HTTP
clickhouse.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy clickhouse:8123
    }
}

# vLLM Router (protected)
vllm-router.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy vllm-router:8010
    }
}

# Forgejo (Git Forge) - with Authelia forward_auth for seamless SSO
forgejo.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }

        # Redirect root to user login page for auto-authentication
        @root path /
        redir @root /user/login

        reverse_proxy forgejo:3000 {
            header_up Remote-User {header.Remote-User}
            header_up Remote-Email {header.Remote-Email}
            header_up Remote-Name {header.Remote-Name}
        }
    }
}

# qBittorrent (protected)
qbittorrent.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy qbittorrent:8080 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
}
