###############################################
# Caddy config for Datamancy
#
# - Official Caddy image + a static Caddyfile (no docker label proxy).
# - Most apps are protected with Authelia via forward_auth where labels
#   previously specified it.
#
# Env vars used inside this file (must be provided to the Caddy container):
# - DOMAIN                     (e.g. example.com)
# - API_LITELLM_ALLOWLIST     (space-separated CIDRs)
#
# TLS Configuration:
# - Development/Testing: Uses self-signed certs via Caddy's internal CA (local_certs)
# - Production: Comment out local_certs below and uncomment the email line for Let's Encrypt
###############################################
{
    # DEVELOPMENT/TESTING: Self-signed certificates (no external ACME)
    # local_certs

    # PRODUCTION: Uncomment the line below and comment out local_certs above
    # Replace with your actual admin email for Let's Encrypt notifications
    email {{STACK_ADMIN_EMAIL}}

    # Optional: Customize ACME CA (default is Let's Encrypt production)
    # For testing Let's Encrypt without rate limits, use staging:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# ldap-account-manager
lam.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy ldap-account-manager:80
    }
}

# Authelia portal
auth.{{DOMAIN}} {
    reverse_proxy authelia:9091
}

# CouchDB
couchdb.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy couchdb:5984
    }
}

# Roundcube Webmail - Proxy auth with Dovecot master user
# Also generates certificate for docker-mailserver SMTP/IMAP
mail.{{DOMAIN}} {
    forward_auth authelia:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }

    reverse_proxy roundcube:80 {
        # Pass authentication headers to Roundcube
        header_up Remote-User {header.Remote-User}
        header_up Remote-Email {header.Remote-Email}
        header_up Remote-Name {header.Remote-Name}
    }
}

# Radicale CalDAV/CardDAV Server
calendar.{{DOMAIN}} {
    forward_auth authelia:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }

    reverse_proxy radicale:5232 {
        # Pass authentication headers to Radicale
        header_up X-Remote-User {header.Remote-User}
        header_up X-Remote-Email {header.Remote-Email}
    }
}

# SOGo (groupware UI) - Alternative calendar/contacts interface
sogo.{{DOMAIN}} {
    # SOGo serves at /SOGo path, redirect root to it
    @root path /
    redir @root /SOGo

    forward_auth authelia:9091 {
        uri /api/authz/forward-auth
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }

    reverse_proxy sogo:80 {
        # Pass authentication headers to SOGo
        header_up Remote-User {header.Remote-User}
        header_up Remote-Email {header.Remote-Email}
        header_up Remote-Name {header.Remote-Name}
    }
}


# Kopia UI (protected with forward_auth)
kopia.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy kopia:51515
    }
}

# Grafana (protected with forward_auth)
grafana.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy grafana:3000
    }
}

# Open WebUI
open-webui.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy open-webui:8080
    }
}

# Vaultwarden - Protocol-based routing
vaultwarden.{{DOMAIN}} {
    # API requests (JSON Accept header) -> app subdomain
    @api header Accept *application/json*
    reverse_proxy @api vaultwarden:80

    # Browser requests -> redirect to app with SSO params
    redir https://app.vaultwarden.{{DOMAIN}}/#/sso?identifier={{MAIL_DOMAIN}} temporary
}

# Vaultwarden app (OIDC SSO endpoint)
app.vaultwarden.{{DOMAIN}} {
    reverse_proxy vaultwarden:80
}

# Planka (uses OIDC)
planka.{{DOMAIN}} {
    reverse_proxy planka:1337
}

# BookStack (uses OIDC)
bookstack.{{DOMAIN}} {
    reverse_proxy bookstack:80
}

# BookStack API (internal network only - for data-fetcher and search services)
# Bypasses auth for API token authentication
api.bookstack.{{DOMAIN}} {
    # Only allow from internal Docker networks
    @notinternal not remote_ip 172.20.0.0/24 172.21.0.0/24 172.22.0.0/24
    respond @notinternal "Access denied: Internal API only" 403

    reverse_proxy bookstack:80
}

# Seafile - Uses remote user authentication with forward_auth
seafile.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy seafile:80
    }
}

# OnlyOffice Document Server (internal API only - accessed via Seafile/Nextcloud)
# Not exposed publicly - only accessible on backend network
# onlyoffice.{{DOMAIN}} {
#     route {
#         forward_auth authelia:9091 {
#             uri /api/authz/forward-auth
#             copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
#         }
#         reverse_proxy onlyoffice:80
#     }
# }

# Matrix (Synapse)
matrix.{{DOMAIN}} {
    reverse_proxy synapse:8008
}

# Element (Matrix Web Client)
element.{{DOMAIN}} {
    reverse_proxy element:80
}

# Mastodon (web)
# With OMNIAUTH_ONLY=true, Mastodon auto-redirects unauthenticated users to OIDC
mastodon.{{DOMAIN}} {
    reverse_proxy mastodon-web:3000
}

# Homepage
homepage.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# Homepage
www.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# Homepage
{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}
# JupyterHub - Uses RemoteUserAuthenticator with forward_auth
jupyterhub.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy jupyterhub:8000
    }
}

# Home Assistant - Uses trusted_networks + LDAP auth
# Webhooks must bypass auth
homeassistant.{{DOMAIN}} {
    # Webhook paths bypass forward_auth
    @webhooks path /api/webhook/*
    handle @webhooks {
        reverse_proxy homeassistant:8123
    }

    # All other paths use forward_auth
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homeassistant:8123 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
}

# LiteLLM (protected)
litellm.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy litellm:4000
    }
}

# LiteLLM (public API) â€” allowlist by IP, no forward_auth
api.litellm.{{DOMAIN}} {
    @notallowed not remote_ip {$API_LITELLM_ALLOWLIST}
    respond @notallowed 403
    reverse_proxy litellm:4000
}

# agent-tool-server (protected)
agent-tool-server.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy agent-tool-server:8081
    }
}

# ClickHouse HTTP
clickhouse.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy clickhouse:8123
    }
}

# vLLM Router (protected)
vllm-router.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy vllm-router:8010
    }
}

# Forgejo (Git Forge) - with OIDC authentication via Authelia
forgejo.{{DOMAIN}} {
    reverse_proxy forgejo:3000
}

# qBittorrent (protected)
qbittorrent.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy qbittorrent:8080 {
            header_up X-Forwarded-For {remote_host}
            header_up X-Real-IP {remote_host}
        }
    }
}

# Data Fetcher (protected - admin only)
data-fetcher.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy data-fetcher:8095
    }
}

# Search Indexer (protected - admin only)
search-indexer.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy search-indexer:8096
    }
}

# Search Gateway (protected - all authenticated users)
search.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy search-gateway:8097
    }
}
