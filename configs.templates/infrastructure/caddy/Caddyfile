###############################################
# Caddy config for Datamancy
#
# - Official Caddy image + a static Caddyfile (no docker label proxy).
# - Most apps are protected with Authelia via forward_auth where labels
#   previously specified it.
#
# Env vars used inside this file (must be provided to the Caddy container):
# - DOMAIN                     (e.g. example.com)
# - API_LITELLM_ALLOWLIST     (space-separated CIDRs)
#
# TLS Configuration:
# - Development/Testing: Uses self-signed certs via Caddy's internal CA (local_certs)
# - Production: Comment out local_certs below and uncomment the email line for Let's Encrypt
###############################################
{
    # DEVELOPMENT/TESTING: Self-signed certificates (no external ACME)
    local_certs

    # PRODUCTION: Uncomment the line below and comment out local_certs above
    # Replace with your actual admin email for Let's Encrypt notifications
    # email {{STACK_ADMIN_EMAIL}}

    # Optional: Customize ACME CA (default is Let's Encrypt production)
    # For testing Let's Encrypt without rate limits, use staging:
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# ldap-account-manager
lam.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy ldap-account-manager:80
    }
}

# Authelia portal
auth.{{DOMAIN}} {
    reverse_proxy authelia:9091
}

# CouchDB
couchdb.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy couchdb:5984
    }
}

# Mailu front (web UI only; mail ports handled by Mailu directly)
mail.{{DOMAIN}} {
    reverse_proxy mailu-front:80
}

# SOGo (groupware UI)
sogo.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy sogo:20000
    }
}

# Dockge
dockge.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy dockge:5001
    }
}

# Kopia UI
kopia.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy kopia:51515
    }
}

# Portainer
portainer.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy portainer:9000
    }
}

# Grafana (uses OIDC within the app; no edge forward_auth)
grafana.{{DOMAIN}} {
    reverse_proxy grafana:3000
}

# Open WebUI
open-webui.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy open-webui:8080
    }
}

# Vaultwarden
vaultwarden.{{DOMAIN}} {
    reverse_proxy vaultwarden:80
}

# Planka
planka.{{DOMAIN}} {
    reverse_proxy planka:1337
}

# BookStack
bookstack.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy bookstack:80
    }
}

# Seafile
seafile.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy seafile:80
    }
}

# OnlyOffice
onlyoffice.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy onlyoffice:80
    }
}

# Matrix (Synapse)
matrix.{{DOMAIN}} {
    reverse_proxy synapse:8008
}

# Mastodon (web)
mastodon.{{DOMAIN}} {
    reverse_proxy mastodon-web:3000
}

# Homepage
homepage.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homepage:3000
    }
}

# JupyterHub
jupyterhub.{{DOMAIN}} {
    reverse_proxy jupyterhub:8000
}

# Home Assistant
homeassistant.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy homeassistant:8123
    }
}

# LiteLLM (protected)
litellm.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy litellm:4000
    }
}

# LiteLLM (public API) â€” allowlist by IP, no forward_auth
api.litellm.{{DOMAIN}} {
    @notallowed not remote_ip {$API_LITELLM_ALLOWLIST}
    respond @notallowed 403
    reverse_proxy litellm:4000
}

# agent-tool-server (protected)
agent-tool-server.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy agent-tool-server:8081
    }
}

# ClickHouse HTTP
clickhouse.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy clickhouse:8123
    }
}

# vLLM Router (protected)
vllm-router.{{DOMAIN}} {
    route {
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
        }
        reverse_proxy vllm-router:8010
    }
}
