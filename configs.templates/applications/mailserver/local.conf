# Dovecot local.conf - Master user configuration for SOGo
# This file is included last by dovecot.conf

# Enable master users with * separator
auth_master_user_separator = *

# Master user passdb - checked BEFORE regular LDAP authentication
passdb {
  driver = passwd-file
  master = yes
  args = /tmp/docker-mailserver/dovecot-master-users.conf
  pass = yes
  # Skip password verification for master users
  skip = authenticated
}

# Override SSL requirement - allow plaintext on port 143 for internal SOGo connection
# External IMAP on 993 still requires SSL
ssl = yes
disable_plaintext_auth = no

# Trust SOGo IP - allow it to use master authentication
# AND allow connections from trusted network without password (for proxy auth)
login_trusted_networks = 172.21.0.0/24
auth_allow_cleartext = yes

# Service-specific settings: keep IMAPS (993) secure
service imap-login {
  inet_listener imaps {
    ssl = yes
  }

  # Allow IMAP connections from SOGo network without password when using master user
  inet_listener imap {
    port = 143
  }
}
