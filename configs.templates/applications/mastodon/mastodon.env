# -------------------------
# Mastodon Core Configuration
# -------------------------
LOCAL_DOMAIN=mastodon.${DOMAIN}
WEB_DOMAIN=mastodon.${DOMAIN}
SINGLE_USER_MODE=false

# -------------------------
# Database Configuration
# -------------------------
DB_HOST=postgres
DB_PORT=5432
DB_NAME=mastodon
DB_USER=mastodon
DB_PASS=${MASTODON_DB_PASSWORD}

# -------------------------
# Redis Configuration
# -------------------------
REDIS_HOST=redis
REDIS_PORT=6379

# -------------------------
# Secrets (generate with: docker run --rm -it ghcr.io/mastodon/mastodon:v4.3.3 bundle exec rake secret)
# -------------------------
SECRET_KEY_BASE=${MASTODON_SECRET_KEY_BASE}
OTP_SECRET=${MASTODON_OTP_SECRET}

# Active Record Encryption (Rails 7+ requirement)
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=${MASTODON_ENCRYPTION_DETERMINISTIC_KEY}
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=${MASTODON_ENCRYPTION_KEY_DERIVATION_SALT}
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=${MASTODON_ENCRYPTION_PRIMARY_KEY}

# -------------------------
# Email Configuration (via docker-mailserver)
# -------------------------
SMTP_SERVER=mailserver
SMTP_PORT=587
SMTP_LOGIN=${MASTODON_SMTP_USER}
SMTP_PASSWORD=${MASTODON_SMTP_PASSWORD}
SMTP_FROM_ADDRESS=mastodon@${MAIL_DOMAIN}
SMTP_AUTH_METHOD=plain
SMTP_OPENSSL_VERIFY_MODE=none
SMTP_ENABLE_STARTTLS=auto

# -------------------------
# File Storage
# -------------------------
LOCAL_HTTPS=true

# -------------------------
# OIDC Authentication (Authelia)
# -------------------------
OIDC_ENABLED=true
OIDC_DISPLAY_NAME=Authelia
OIDC_ISSUER=https://auth.${DOMAIN}
OIDC_DISCOVERY=true
OIDC_SCOPE=openid profile email
OIDC_UID_FIELD=preferred_username
OIDC_CLIENT_ID=mastodon
OIDC_CLIENT_SECRET=${MASTODON_OIDC_SECRET}
OIDC_REDIRECT_URI=https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
OIDC_SECURITY_ASSUME_EMAIL_IS_VERIFIED=true
OMNIAUTH_ONLY=true
# Use displayName for user's full name
OIDC_ACCOUNT_USERNAME_FIELD=preferred_username
OIDC_ACCOUNT_DISPLAY_NAME_FIELD=name

# -------------------------
# Streaming Configuration
# -------------------------
STREAMING_API_BASE_URL=wss://mastodon.${DOMAIN}

# -------------------------
# Web Push Notifications (generated by init-mastodon.sh)
# -------------------------
VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY}
VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY}

# -------------------------
# Performance Tuning
# -------------------------
WEB_CONCURRENCY=2
MAX_THREADS=5
STREAMING_CLUSTER_NUM=1

# -------------------------
# Federation & Moderation
# -------------------------
AUTHORIZED_FETCH=false
LIMITED_FEDERATION_MODE=false

# -------------------------
# Misc
# -------------------------
DEFAULT_LOCALE=en
RAILS_ENV=production
NODE_ENV=production
