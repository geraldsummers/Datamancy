---
# ==============================================
# PRODUCTION DOMAIN: {{DOMAIN}}
# All domains, session cookies, and redirect URIs
# use {{DOMAIN}} for production deployment.
# ==============================================
theme: dark
server:
  host: 0.0.0.0
  port: 9091
  read_buffer_size: 8192
  write_buffer_size: 8192
  endpoints:
    authz:
      forward-auth:
        implementation: ForwardAuth
    enable_pprof: false
    enable_expvars: false
  timeouts:
    read: 30s
    write: 30s
    idle: 120s

log:
  level: info
  format: text

telemetry:
  metrics:
    enabled: true
    address: tcp://0.0.0.0:9959

totp:
  issuer: {{DOMAIN}}
  period: 30
  skew: 1

authentication_backend:
  refresh_interval: 5m
  password_reset:
    disable: false
  ldap:
    implementation: custom
    url: ldap://ldap:389
    timeout: 5s
    start_tls: false
    base_dn: dc=stack,dc=local
    username_attribute: uid
    additional_users_dn: ou=users
    users_filter: (&({username_attribute}={input})(objectClass=inetOrgPerson))
    additional_groups_dn: ou=groups
    groups_filter: (&(member={dn})(objectClass=groupOfNames))
    group_name_attribute: cn
    mail_attribute: mail
    display_name_attribute: displayName
    user: cn=admin,dc=stack,dc=local

access_control:
  default_policy: deny
  rules:
    - domain: auth.{{DOMAIN}}
      policy: bypass
    # Home Assistant webhooks need bypass
    - domain: homeassistant.{{DOMAIN}}
      policy: bypass
      resources:
        - "^/api/webhook/.*$"
    # qBittorrent - one_factor for all authenticated users (admins, operators, users)
    - domain: qbittorrent.{{DOMAIN}}
      policy: one_factor
    # All other services accessible to admins, operators, and users
    - domain: "*.{{DOMAIN}}"
      policy: one_factor
      subject:
        - "group:admins"
        - "group:operators"
        - "group:users"

session:
  cookies:
    - domain: {{DOMAIN}}
      name: authelia_session
      authelia_url: https://auth.{{DOMAIN}}
#      default_redirection_url: https://homepage.{{DOMAIN}}
      same_site: lax
      expiration: 8h
      inactivity: 1h
  # Security: 7 days is safer than 1 month for production
  # If stolen, "remember me" cookie is only valid for 1 week
  remember_me: 7d
  redis:
    host: redis
    port: 6379
    database_index: 0

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

storage:
  encryption_key: a_very_important_secret # Will be overridden by env var
  postgres:
    host: postgres
    port: 5432
    database: authelia
    schema: public
    username: authelia
    # Password is provided via AUTHELIA_STORAGE_POSTGRES_PASSWORD env var
    timeout: 5s

notifier:
  disable_startup_check: true
  filesystem:
    filename: /config/notification.txt

identity_providers:
  oidc:
    hmac_secret: another_very_important_secret # Will be overridden by env var
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    # OIDC signing key loaded from environment variable AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY (base64-encoded)
    issuer_private_key: ""

    clients:
      # Grafana
      - client_id: grafana
        client_name: Grafana
        client_secret: '{{GRAFANA_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://grafana.{{DOMAIN}}/login/generic_oauth
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # pgAdmin
      - client_id: pgadmin
        client_name: pgAdmin
        client_secret: '{{PGADMIN_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://pgadmin.{{DOMAIN}}/oauth2/authorize
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code


      # Open WebUI
      - client_id: open-webui
        client_name: Open WebUI
        client_secret: '{{OPENWEBUI_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://open-webui.{{DOMAIN}}/oauth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Nextcloud
      - client_id: nextcloud
        client_name: Nextcloud
        client_secret: '{{NEXTCLOUD_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://nextcloud.{{DOMAIN}}/apps/oidc_login/oidc
          - https://nextcloud.{{DOMAIN}}/apps/user_oidc/code
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # Dim Media Server
      - client_id: dim
        client_name: Dim
        client_secret: '{{DIM_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://dim.{{DOMAIN}}/api/v1/auth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Planka
      - client_id: planka
        client_name: Planka
        client_secret: '{{PLANKA_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        token_endpoint_auth_method: client_secret_basic
        redirect_uris:
          - https://planka.{{DOMAIN}}/oidc-callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        response_modes:
          - query
          - fragment
          - form_post

      # Home Assistant
      - client_id: home-assistant
        client_name: Home Assistant
        client_secret: '{{HOMEASSISTANT_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://homeassistant.{{DOMAIN}}/auth/external/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # JupyterHub
      - client_id: jupyterhub
        client_name: JupyterHub
        client_secret: '{{JUPYTERHUB_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://jupyterhub.{{DOMAIN}}/hub/oauth_callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

      # Vaultwarden (Bitwarden-compatible)
      # NOTE: Set VAULTWARDEN_OAUTH_SECRET in your .env to a strong value and
      # update this hash to match (pbkdf2-sha512). Use Authelia's crypto tool to generate.
      - client_id: vaultwarden
        client_name: Vaultwarden
        client_secret: '{{VAULTWARDEN_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://app.vaultwarden.{{DOMAIN}}/identity/connect/oidc-signin
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Mastodon
      - client_id: mastodon
        client_name: Mastodon
        client_secret: '{{MASTODON_OIDC_SECRET}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://mastodon.{{DOMAIN}}/auth/auth/openid_connect/callback
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code

      # Bookstack (Wiki/Documentation) - Seamless OIDC SSO
      - client_id: bookstack
        client_name: Bookstack
        client_secret: '{{BOOKSTACK_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://bookstack.{{DOMAIN}}/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Forgejo (Git Forge)
      - client_id: forgejo
        client_name: Forgejo
        client_secret: '{{FORGEJO_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://forgejo.{{DOMAIN}}/user/oauth2/Authelia/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post
