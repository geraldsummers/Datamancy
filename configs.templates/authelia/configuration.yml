---
# ==============================================
# PRODUCTION DOMAIN: {{DOMAIN}}
# All domains, session cookies, and redirect URIs
# use {{DOMAIN}} for production deployment.
# ==============================================
theme: dark
server:
  address: tcp://0.0.0.0:9091/
  buffers:
    read: 8192
    write: 8192
  endpoints:
    authz:
      forward-auth:
        implementation: ForwardAuth
    enable_pprof: false
    enable_expvars: false
  timeouts:
    read: 30s
    write: 30s
    idle: 120s

log:
  level: info
  format: text

telemetry:
  metrics:
    enabled: true
    address: tcp://0.0.0.0:9959

totp:
  issuer: {{DOMAIN}}
  period: 30
  skew: 1

authentication_backend:
  refresh_interval: 5m
  password_reset:
    disable: false
  ldap:
    implementation: custom
    address: ldap://ldap:389
    timeout: 5s
    start_tls: false
    base_dn: {{LDAP_BASE_DN}}
    additional_users_dn: ou=users
    users_filter: (&({username_attribute}={input})(objectClass=inetOrgPerson))
    additional_groups_dn: ou=groups
    groups_filter: (&(member={dn})(objectClass=groupOfNames))
    attributes:
      username: uid
      group_name: cn
      mail: mail
      display_name: displayName
    user: cn=admin,{{LDAP_BASE_DN}}

access_control:
  default_policy: deny
  rules:
    - domain: auth.{{DOMAIN}}
      policy: bypass
    # Allow all internal Docker network calls (test runner, service-to-service)
    - domain_regex: '^(authelia|authelia:[0-9]+)$'
      policy: bypass
    # Home Assistant webhooks need bypass
    - domain: homeassistant.{{DOMAIN}}
      policy: bypass
      resources:
        - "^/api/webhook/.*$"
    # qBittorrent - one_factor for all authenticated users (admins, operators, users)
    - domain: qbittorrent.{{DOMAIN}}
      policy: one_factor
    # Apex domain - homepage
    - domain: {{DOMAIN}}
      policy: one_factor
      subject:
        - "group:admins"
        - "group:operators"
        - "group:users"
    # All other services accessible to admins, operators, and users
    - domain: "*.{{DOMAIN}}"
      policy: one_factor
      subject:
        - "group:admins"
        - "group:operators"
        - "group:users"

session:
  cookies:
    - domain: {{DOMAIN}}
      name: authelia_session
      authelia_url: https://auth.{{DOMAIN}}
#      default_redirection_url: https://homepage.{{DOMAIN}}
      same_site: lax
      expiration: 8h
      inactivity: 1h
    # Internal Docker network session cookie removed - Authelia v4.39+ validation:
    # - Cookie domain must contain a period or be an IP (single-label domains like "authelia" are rejected)
    # - authelia_url must use https:// scheme (http:// is rejected)
    # For internal service-to-service calls that fail with session errors,
    # services should route through Caddy proxy (https://auth.{{DOMAIN}}) instead of direct http://authelia:9091
  # Security: 7 days is safer than 1 month for production
  # If stolen, "remember me" cookie is only valid for 1 week
  remember_me: 7d
  redis:
    host: valkey
    port: 6379
    database_index: 0

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

identity_validation:
  reset_password:
    # jwt_secret is provided via AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET env var

storage:
  encryption_key: a_very_important_secret # Will be overridden by env var
  postgres:
    address: tcp://postgres:5432
    database: authelia
    schema: public
    username: authelia
    # Password is provided via AUTHELIA_STORAGE_POSTGRES_PASSWORD env var
    timeout: 5s

notifier:
  disable_startup_check: true
  filesystem:
    filename: /config/notification.txt

identity_providers:
  oidc:
    hmac_secret: another_very_important_secret # Will be overridden by env var
    lifespans:
      access_token: 1h
      authorize_code: 1m
      id_token: 1h
      refresh_token: 90m
    enable_client_debug_messages: false
    enforce_pkce: public_clients_only
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    # OIDC signing keys - using file storage for key
    jwks:
      - key_id: main
        algorithm: RS256
        use: sig
        key: |
          {{AUTHELIA_OIDC_PRIVATE_KEY}}

    clients:
      # pgAdmin
      - client_id: pgadmin
        client_name: pgAdmin
        client_secret: '{{PGADMIN_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://pgadmin.{{DOMAIN}}/oauth2/authorize
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code


      # Open WebUI
      - client_id: open-webui
        client_name: Open WebUI
        client_secret: '{{OPENWEBUI_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://open-webui.{{DOMAIN}}/oauth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Dim Media Server
      - client_id: dim
        client_name: Dim
        client_secret: '{{DIM_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://dim.{{DOMAIN}}/api/v1/auth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code

      # Planka
      - client_id: planka
        client_name: Planka
        client_secret: '{{PLANKA_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        token_endpoint_auth_method: client_secret_basic
        redirect_uris:
          - https://planka.{{DOMAIN}}/oidc-callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        response_modes:
          - query
          - fragment
          - form_post

      # Vaultwarden (Bitwarden-compatible)
      # NOTE: Set VAULTWARDEN_OAUTH_SECRET in your .env to a strong value and
      # update this hash to match (pbkdf2-sha512). Use Authelia's crypto tool to generate.
      - client_id: vaultwarden
        client_name: Vaultwarden
        client_secret: '{{VAULTWARDEN_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://app.vaultwarden.{{DOMAIN}}/identity/connect/oidc-signin
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Mastodon
      - client_id: mastodon
        client_name: Mastodon
        client_secret: '{{MASTODON_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://mastodon.{{DOMAIN}}/auth/auth/openid_connect/callback
        scopes:
          - openid
          - profile
          - email
        grant_types:
          - authorization_code
        response_types:
          - code

      # Bookstack (Wiki/Documentation) - Seamless OIDC SSO
      - client_id: bookstack
        client_name: Bookstack
        client_secret: '{{BOOKSTACK_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://bookstack.{{DOMAIN}}/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Forgejo (Git Forge)
      - client_id: forgejo
        client_name: Forgejo
        client_secret: '{{FORGEJO_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - https://forgejo.{{DOMAIN}}/user/oauth2/Authelia/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_basic

      # Matrix Synapse (Element SSO)
      - client_id: matrix
        client_name: Matrix Synapse
        client_secret: '{{MATRIX_OAUTH_SECRET_HASH}}'
        public: false
        authorization_policy: one_factor
        consent_mode: implicit
        redirect_uris:
          - https://matrix.{{DOMAIN}}/_synapse/client/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        grant_types:
          - authorization_code
        response_types:
          - code
        token_endpoint_auth_method: client_secret_post

