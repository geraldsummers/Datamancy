#!/usr/bin/env bash
# bootstrap-stack.sh â€” Manage Datamancy bootstrap and switch to full stack
#
# Keeps the ISO generic: you run this script after cloning the repo on a host
# where Docker is installed (see scripts/setup-host.sh).
#
# Commands:
#   init           Ensure repo env for bootstrap (.env.bootstrap)
#   up-bootstrap   Start bootstrap profile from docker-compose.yml
#   down-bootstrap Stop bootstrap stack
#   switch-to-full Stop bootstrap and start docker-compose.yml (requires .env)
#   status         Show docker ps summary
#
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
repo_root="$(cd "$script_dir/.." && pwd)"

compose_bootstrap() {
  docker compose -f "$repo_root/docker-compose.yml" --env-file "$repo_root/.env.bootstrap" --profile bootstrap "$@"
}

compose_full() {
  # Include bootstrap profile so core AI services (localai, litellm, open-webui, kfuncdb)
  # are also started in full mode without duplication.
  docker compose -f "$repo_root/docker-compose.yml" --env-file "$repo_root/.env" --profile bootstrap "$@"
}

compose_vectors() {
  # Vector DB bootstrap-only profile now lives in main docker-compose.yml
  docker compose -f "$repo_root/docker-compose.yml" --env-file "$repo_root/.env.bootstrap" --profile bootstrap_vector_dbs "$@"
}

random_hex() {
  # 16 bytes -> 32 hex chars
  openssl rand -hex 16
}

ensure_env_bootstrap() {
  if [[ ! -f "$repo_root/.env.bootstrap" ]]; then
    local key llm_key ldap_admin ldap_config authelia_jwt authelia_sess authelia_store
    llm_key=$(random_hex)
    ldap_admin=$(random_hex)
    ldap_config=$(random_hex)
    authelia_jwt=$(random_hex)
    authelia_sess=$(random_hex)
    authelia_store=$(random_hex)
    cat > "$repo_root/.env.bootstrap" <<EOF
# Autogenerated minimal bootstrap env
# Do NOT share this file; it may contain secrets.
LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY:-$llm_key}
# LDAP bootstrap admin secrets (required by ldap + authelia)
LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD:-$ldap_admin}
LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD:-$ldap_config}
# Authelia required secrets
AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET:-$authelia_jwt}
AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET:-$authelia_sess}
AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY:-$authelia_store}
# Domain used for routing and certificates (REQUIRED).
# Set this to your real domain and ensure DNS A records exist for required subdomains.
DOMAIN=${DOMAIN:-project-saturn.com}
# Optional: if you have a HuggingFace token, uncomment and set it
# HUGGINGFACEHUB_API_TOKEN=

# Open WebUI bootstrap behavior
# Note: UI is served via Caddy behind SSO at https://open-webui.
# Use service DNS for intra-network calls (litellm:4000), not localhost
OPENWEBUI_ENABLE_OAUTH_SIGNUP=false
OPENWEBUI_DEFAULT_USER_ROLE=admin
OPENWEBUI_OPENAI_API_BASE_URL=http://litellm:4000
EOF
    chmod 0640 "$repo_root/.env.bootstrap" || true
  fi
}

  usage() {
    cat <<USAGE
Usage: $(basename "$0") <command>
Commands:
  init            Create .env.bootstrap if missing
  up-bootstrap    Start bootstrap stack (UIs via Caddy behind SSO at https://<service>.${DOMAIN})
  down-bootstrap  Stop bootstrap stack and remove containers (volumes preserved)
  switch-to-full  Stop bootstrap and start full stack (requires .env)
  bootstrap-vectors  Start Qdrant and initialize vector DB collections
  up-benthos      Start Qdrant, ClickHouse and Benthos (vector profile)
  status          Show container status summary
USAGE
  }

case "${1:-}" in
  init)
    ensure_env_bootstrap
    ;;
  up-bootstrap)
    ensure_env_bootstrap
    # Ensure authelia volume directory exists
    mkdir -p "$repo_root/volumes/authelia"
    # Ensure LocalAI models dir exists for initial model YAMLs
    mkdir -p "$repo_root/volumes/localai/models"
    mkdir -p "$repo_root/screenshots"
    # Start only bootstrap services explicitly to avoid bringing up default stack
    # which would require full secrets (.env). Dependencies (e.g., localai-init)
    # are started automatically by Compose.
    # Start order: Caddy -> LDAP -> Redis -> Authelia -> AI services -> Admin tools -> Test runner
    compose_bootstrap up -d --pull=missing \
      caddy-docker-proxy \
      ldap redis authelia \
      localai litellm open-webui kfuncdb ldap-account-manager \
      portainer-agent portainer \
      test-runner
    ;;
  bootstrap-vectors)
    ensure_env_bootstrap
    # Bring up Qdrant and run the one-shot bootstrap container
    compose_vectors up -d qdrant
    compose_vectors up --no-deps vector-bootstrap || true
    ;;
  up-benthos)
    ensure_env_bootstrap
    # Bring up Qdrant, ClickHouse and Benthos in the vector profile
    compose_vectors up -d qdrant clickhouse
    compose_vectors up --no-deps vector-bootstrap || true
    compose_vectors up -d benthos
    ;;
  down-bootstrap)
    # Stop and remove only bootstrap services to avoid impacting full stack
    ensure_env_bootstrap
    bs_services=(test-runner portainer portainer-agent open-webui litellm localai kfuncdb ldap-account-manager authelia redis ldap caddy-docker-proxy)
    docker compose -f "$repo_root/docker-compose.yml" --env-file "$repo_root/.env.bootstrap" stop "${bs_services[@]}" || true
    docker compose -f "$repo_root/docker-compose.yml" --env-file "$repo_root/.env.bootstrap" rm -f "${bs_services[@]}" || true
    ;;
  switch-to-full)
    # Bring down bootstrap services first, then start full stack
    "$0" down-bootstrap || true
    if [[ ! -f "$repo_root/.env" ]]; then
      echo "ERROR: $repo_root/.env not found. Create it first, then re-run." >&2
      exit 1
    fi
    # Ensure Authelia uses the full OIDC-enabled configuration for the full stack
    export AUTHELIA_CONFIG_FILE="./configs/authelia/configuration.yml"
    compose_full up -d --pull=missing
    ;;
  status)
    docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'
    ;;
  *)
    usage
    exit 1
    ;;
esac
