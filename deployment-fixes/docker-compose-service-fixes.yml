# Service-specific fixes for docker-compose.yml
# Merge these sections into your existing services

# ===== MASTODON HOST AUTHORIZATION FIX =====
mastodon-web:
  # ... existing config ...
  environment:
    # Add these to existing environment variables
    - RAILS_ENV=production
    - ALLOWED_HOSTS=mastodon-web,mastodon-web:3000,latium.local
    - TRUSTED_PROXY_IP=172.19.0.0/16  # Allow internal Docker network

mastodon-sidekiq:
  # ... existing config ...
  environment:
    # Add these to existing environment variables
    - RAILS_ENV=production
    - ALLOWED_HOSTS=mastodon-sidekiq,mastodon-sidekiq:3000,latium.local

# ===== HOMEPAGE HOST VALIDATION FIX =====
homepage:
  # ... existing config ...
  environment:
    # Add these to existing environment variables
    - HOMEPAGE_ALLOWED_HOSTS=homepage:3000,homepage,latium.local,*
    # OR disable host validation entirely for internal network:
    - HOMEPAGE_VAR_DISABLE_HOST_CHECK=true

# ===== DOCKER HEALTH EXPORTER TIMEOUT FIX =====
docker-health-exporter:
  image: fviolence/docker-health-exporter:latest
  container_name: docker-health-exporter
  restart: unless-stopped
  environment:
    - TIMEOUT=120  # Increased from default 60 seconds
    - DOCKER_HOST=unix:///var/run/docker.sock
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
  networks:
    - datamancy
  healthcheck:
    test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9066/metrics"]
    interval: 30s
    timeout: 15s  # Increased timeout
    retries: 3
    start_period: 30s
