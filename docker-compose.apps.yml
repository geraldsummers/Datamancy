# User-Facing Applications
# Grafana, Open-WebUI, Vaultwarden, Planka, Outline, Seafile, OnlyOffice,
# Synapse (Matrix), Mastodon, Homepage, JupyterHub, Home Assistant

services:

  # ========================================
  # AUTHENTICATION & AUTHORIZATION GUIDE
  # ========================================
  #
  # ARCHITECTURE:
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ  User   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Caddy  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Authelia ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  LDAP   ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #                     ‚îÇ               ‚îÇ
  #                     ‚ñº               ‚ñº
  #              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  #              ‚îÇ   Apps     ‚îÇ   ‚îÇ  OIDC    ‚îÇ
  #              ‚îÇ (Forward   ‚îÇ   ‚îÇ  Clients ‚îÇ
  #              ‚îÇ   Auth)    ‚îÇ   ‚îÇ (Native) ‚îÇ
  #              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #
  # COMPONENTS:
  # - LDAP (OpenLDAP): Centralized user directory (users, groups, passwords)
  # - Authelia: OIDC Provider + SSO gateway + MFA enforcement + Forward-auth endpoint
  # - Caddy: Reverse proxy with forward_auth middleware
  # - Redis: Session storage for Authelia
  #
  # AUTHENTICATION METHODS (Priority Order):
  #
  # 1. ‚úÖ NATIVE OIDC/OAuth2 (PREFERRED)
  #    When: App has built-in OIDC/OAuth2 support
  #    How: Configure OIDC client in Authelia configuration.yml
  #    Pros: Native integration, role/group mapping, proper logout, token refresh
  #    Apps: Grafana, Open-WebUI, Planka, Outline, JupyterHub, Vaultwarden
  #          Seafile, Synapse, Home Assistant
  #
  # 2. üîí FORWARD AUTH (Caddy ‚Üí Authelia)
  #    When: App lacks OIDC but trusts reverse proxy headers (X-Remote-User, X-Email)
  #    How: Caddy forward_auth block ‚Üí Authelia validates ‚Üí passes headers to app
  #    Pros: Simple setup, works with legacy apps, centralized policy enforcement
  #    Cons: App must trust proxy headers, no native role mapping, logout requires Authelia
  #    Apps: Homepage
  #
  # 3. üîê LDAP DIRECT (DEPRECATED)
  #    When: Legacy apps with LDAP auth module but no OIDC
  #    How: App binds directly to OpenLDAP for authentication
  #    Cons: No SSO, credentials sent to each app, no MFA enforcement, harder to audit
  #    Note: Prefer OIDC or forward-auth even for LDAP-capable apps
  #
  # 4. üîì SELF-CONTAINED AUTH (No SSO)
  #    When: App requires independent identity for federation/protocol reasons
  #    Why: Federation protocols (ActivityPub, Matrix), mail protocols (SMTP/IMAP)
  #    Apps: Synapse (Matrix - uses OIDC for web but maintains Matrix identity)
  #    Note: Some support OIDC for web UI login but maintain separate identity layer
  #
  # OIDC-ENABLED SERVICES (Register these in Authelia):
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ Service          ‚îÇ Callback URL                           ‚îÇ Scopes                  ‚îÇ
  # ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  # ‚îÇ Grafana          ‚îÇ /login/generic_oauth                   ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Open-WebUI       ‚îÇ /oauth/oidc/callback                   ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Planka           ‚îÇ /oidc-callback                         ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Outline          ‚îÇ /auth/oidc.callback                    ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ JupyterHub       ‚îÇ /hub/oauth_callback                    ‚îÇ openid email groups     ‚îÇ
  # ‚îÇ Vaultwarden      ‚îÇ /identity/connect/oidc-signin          ‚îÇ openid email profile    ‚îÇ
  # ‚îÇ Seafile          ‚îÇ /oauth/callback/                       ‚îÇ openid email profile    ‚îÇ
  # ‚îÇ Synapse          ‚îÇ /_synapse/client/oidc/callback         ‚îÇ openid                  ‚îÇ
  # ‚îÇ Home Assistant   ‚îÇ /auth/external/callback                ‚îÇ openid email profile    ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #
  # FORWARD-AUTH SERVICES (Protect in Caddyfile):
  # - Homepage: Dashboard, allow 'users' + 'admins'
  #
  # SECURITY BEST PRACTICES:
  # ‚úÖ Enable MFA in Authelia for all users (especially admins)
  # ‚úÖ Use unique OIDC client secrets per app (generated, stored in .env)
  # ‚úÖ Configure Authelia ACL policies to restrict admin routes
  # ‚úÖ Never expose internal services (databases, redis) to Caddy
  # ‚úÖ Use PKCE for OIDC flows where supported
  # ‚úÖ Enable HTTPS-only cookies in Authelia session config
  # ‚úÖ Rotate OIDC secrets periodically
  # ‚úÖ Review Authelia audit logs for suspicious activity
  # ‚úÖ Use strong LDAP admin password
  # ‚úÖ Implement rate limiting in Authelia to prevent brute force

  # ======================
  # Monitoring - Grafana
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia via Generic OAuth (GF_AUTH_GENERIC_OAUTH_*)
  #       Callback: https://grafana.${DOMAIN}/login/generic_oauth
  #       Scopes: openid email profile groups
  #       Role Mapping: groups claim ‚Üí Admin/Editor/Viewer based on LDAP groups
  #         - admins group ‚Üí Grafana Admin
  #         - users group ‚Üí Grafana Editor
  #         - Others ‚Üí Grafana Viewer
  #
  # Authelia Client Config Required:
  #   client_id: grafana
  #   client_secret: ${GRAFANA_OAUTH_SECRET}
  #   redirect_uris: https://grafana.${DOMAIN}/login/generic_oauth
  #   scopes: openid profile email groups
  grafana:
    image: grafana/grafana:11.6.7
    container_name: grafana
    restart: unless-stopped
    networks:
      - backend
      - database
    user: "472:472"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: grafana.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      authelia:
        condition: service_healthy
    environment:
      - GF_DEFAULT_LOCALE=en_US
      - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN}
      - GF_SERVER_DOMAIN=grafana.${DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${GRAFANA_OAUTH_SECRET}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.${DOMAIN}/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authelia:9091/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authelia:9091/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'users') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.${DOMAIN}/logout
      - GF_AUTH_GENERIC_OAUTH_SKIP_ORG_ROLE_SYNC=false
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # AI Services
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OAUTH_CLIENT_ID, OPENID_PROVIDER_URL)
  #       Callback: https://open-webui.${DOMAIN}/oauth/oidc/callback
  #       Scopes: openid email profile groups
  #       Role Mapping: OAUTH_ADMIN_ROLES + OAUTH_ALLOWED_ROLES
  #         - admins, openwebui-admin ‚Üí Admin access
  #         - users ‚Üí User access
  #
  # Authelia Client Config Required:
  #   client_id: open-webui
  #   client_secret: ${OPENWEBUI_OAUTH_SECRET}
  #   redirect_uris: https://open-webui.${DOMAIN}/oauth/oidc/callback
  #   scopes: openid email profile groups
  open-webui:
    image: ghcr.io/open-webui/open-webui:0.3.32
    container_name: open-webui
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    dns:
      - 8.8.8.8
      - 1.1.1.1
    labels:
      caddy: open-webui.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
    depends_on:
      authelia:
        condition: service_healthy
    environment:
      - WEBUI_URL=https://open-webui.${DOMAIN}
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - OAUTH_CLIENT_ID=open-webui
      - OAUTH_CLIENT_SECRET=${OPENWEBUI_OAUTH_SECRET}
      - OPENID_PROVIDER_URL=https://auth.${DOMAIN}/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=Authelia
      - OAUTH_SCOPES=openid email profile groups
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_GROUPS_CLAIM=groups
      - OAUTH_ADMIN_ROLES=admins,openwebui-admin
      - OAUTH_ALLOWED_ROLES=admins,users,openwebui-admin
      - DEFAULT_USER_ROLE=user
      # LiteLLM now runs on separate AI VM - access via public HTTPS endpoint
      - OLLAMA_BASE_URL=https://litellm.${DOMAIN}
      - ENABLE_OPENAI_API=true
      - OPENAI_API_BASE_URL=https://litellm.${DOMAIN}
      - OPENAI_API_KEY=${LITELLM_MASTER_KEY}
    volumes:
      - open_webui_data:/app/backend/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s


  # ======================
  # Password Manager - Vaultwarden
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (SSO_AUTHORITY, SSO_CLIENT_ID, SSO_CLIENT_SECRET)
  #       Callback: https://vaultwarden.${DOMAIN}/identity/connect/oidc-signin
  #       Scopes: openid email profile
  #       Role Mapping: N/A (Vaultwarden manages vault access internally)
  #
  # IMPORTANT: Master password still required for vault encryption (E2E security)
  #            SSO only handles authentication, not vault decryption
  #            SSO_ONLY=false allows local accounts as backup
  #
  # Authelia Client Config Required:
  #   client_id: vaultwarden
  #   client_secret: ${VAULTWARDEN_OAUTH_SECRET}
  #   redirect_uris: https://vaultwarden.${DOMAIN}/identity/connect/oidc-signin
  #   scopes: openid email profile
  vaultwarden:
    image: vaultwarden/server:1.34.3
    container_name: vaultwarden
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: vaultwarden.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    depends_on:
      authelia:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    environment:
      - DOMAIN=https://vaultwarden.${DOMAIN}
      - SIGNUPS_ALLOWED=false
      - SIGNUPS_VERIFY=true
      - SIGNUPS_DOMAINS_WHITELIST=${MAIL_DOMAIN}
      - INVITATIONS_ALLOWED=true
      - SHOW_PASSWORD_HINT=false
      - SSO_ENABLED=true
      - SSO_ONLY=false
      - SSO_SIGNUPS_MATCH_EMAIL=true
      - SSO_AUTHORITY=https://auth.${DOMAIN}
      - SSO_ISSUER=https://auth.${DOMAIN}
      - SSO_CLIENT_ID=vaultwarden
      - SSO_CLIENT_SECRET=${VAULTWARDEN_OAUTH_SECRET}
      - SSO_SCOPES=openid email profile
      - SSO_CALLBACK_PATH=/identity/connect/oidc-signin
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      - SMTP_HOST=mailu-smtp
      - SMTP_FROM=vaultwarden@${MAIL_DOMAIN}
      - SMTP_PORT=587
      - SMTP_SECURITY=starttls
      - SMTP_USERNAME=vaultwarden@${MAIL_DOMAIN}
      - SMTP_PASSWORD=${VAULTWARDEN_SMTP_PASSWORD}
    volumes:
      - vaultwarden_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Project Management
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OIDC_* envs)
  #       Callback: https://planka.${DOMAIN}/oidc-callback
  #       Scopes: openid profile email groups
  #       Role Mapping: OIDC_ADMIN_ROLES='planka-admin' ‚Üí Admin access
  #
  # Authelia Client Config Required:
  #   client_id: planka
  #   client_secret: ${PLANKA_OAUTH_SECRET}
  #   redirect_uris: https://planka.${DOMAIN}/oidc-callback
  #   scopes: openid profile email groups
  planka:
    image: ghcr.io/plankanban/planka:1.26.3
    container_name: planka
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: planka.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 1337}}"
    depends_on:
      postgres:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - BASE_URL=https://planka.${DOMAIN}
      - DATABASE_URL=postgresql://planka:${PLANKA_DB_PASSWORD}@postgres:5432/planka
      - SECRET_KEY=${PLANKA_SECRET_KEY}
      - OIDC_ISSUER=https://auth.${DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=${PLANKA_OAUTH_SECRET}
      - OIDC_SCOPES=openid profile email groups
      - OIDC_ADMIN_ROLES=planka-admin
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    volumes:
      - planka_data:/app/public/user-avatars
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1337/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Wiki / Docs - Outline
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OIDC_CLIENT_ID, OIDC_*_URI)
  #       Callback: https://outline.${DOMAIN}/auth/oidc.callback
  #       Scopes: openid profile email offline_access
  #       Role Mapping: First user becomes admin, subsequent users need invite/permission
  #
  # Authelia Client Config Required:
  #   client_id: outline
  #   client_secret: ${OUTLINE_OAUTH_SECRET}
  #   redirect_uris: https://outline.${DOMAIN}/auth/oidc.callback
  #   scopes: openid offline_access profile email
  outline:
    image: outlinewiki/outline:0.87.3
    container_name: outline
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: outline.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - SECRET_KEY=${OUTLINE_SECRET_KEY}
      - UTILS_SECRET=${OUTLINE_UTILS_SECRET}
      - DATABASE_URL=postgres://outline:${OUTLINE_DB_PASSWORD}@postgres:5432/outline
      - PGSSLMODE=disable
      - REDIS_URL=redis://redis:6379
      - URL=https://outline.${DOMAIN}
      - PORT=3000
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=${OUTLINE_OAUTH_SECRET}
      - OIDC_AUTH_URI=https://auth.${DOMAIN}/api/oidc/authorization
      - OIDC_TOKEN_URI=http://authelia:9091/api/oidc/token
      - OIDC_USERINFO_URI=http://authelia:9091/api/oidc/userinfo
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Authelia
      - OIDC_SCOPES=openid offline_access profile email
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
    volumes:
      - outline_data:/var/lib/outline/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Files - Seafile + OnlyOffice
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (SEAFILE) + JWT (ONLYOFFICE)
  #       Seafile OIDC: Configured via seahub_settings.py (OAUTH_* envs)
  #         Provider: Authelia
  #         Callback: https://seafile.${DOMAIN}/oauth/callback/
  #         Scopes: openid email profile
  #         Note: Mount seahub_settings.py with OAUTH config or use env vars
  #       OnlyOffice: JWT-based integration with Seafile, no direct user login
  #
  # Authelia Client Config Required:
  #   client_id: seafile
  #   client_secret: ${SEAFILE_OAUTH_SECRET}
  #   redirect_uris: https://seafile.${DOMAIN}/oauth/callback/
  #   scopes: openid email profile
  seafile:
    image: seafileltd/seafile-mc:13.0.12
    container_name: seafile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: seafile.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    depends_on:
      memcached:
        condition: service_healthy
      mariadb-seafile:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - TZ=UTC
      - DB_HOST=mariadb-seafile
      - DB_ROOT_PASSWD=${MARIADB_SEAFILE_ROOT_PASSWORD}
      - SEAFILE_SERVER_HOSTNAME=seafile.${DOMAIN}
      - SEAFILE_ADMIN_EMAIL=${SEAFILE_ADMIN_EMAIL}
      - SEAFILE_ADMIN_PASSWORD=${SEAFILE_ADMIN_PASSWORD}
      - TIME_ZONE=UTC
    volumes:
      - seafile_data:/shared
      - ./configs/seafile/seahub_settings.py:/opt/seafile/conf/seahub_settings.py:ro
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  onlyoffice:
    image: onlyoffice/documentserver:8.2.2
    container_name: onlyoffice
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    labels:
      caddy: onlyoffice.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    environment:
      - TZ=UTC
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET}
      - JWT_HEADER=Authorization
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/healthcheck"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 2m

  # ======================
  # Matrix (Synapse)
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (WEB LOGIN) + üîì SELF-CONTAINED (FEDERATION)
  #       OIDC: Optional for web/Element login via Authelia (oidc_providers in homeserver.yaml)
  #       Callback: https://matrix.${DOMAIN}/_synapse/client/oidc/callback
  #       Scopes: openid
  #       Federation: Matrix protocol requires local user accounts (@user:matrix.${DOMAIN})
  #       Note: OIDC authenticates web access, but Matrix ID remains on local server
  #
  # Authelia Client Config Required:
  #   client_id: synapse
  #   client_secret: ${SYNAPSE_OAUTH_SECRET}
  #   redirect_uris: https://matrix.${DOMAIN}/_synapse/client/oidc/callback
  #   scopes: openid
  synapse:
    image: matrixdotorg/synapse:v1.141.0
    container_name: synapse
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: matrix.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8008}}"
    depends_on:
      redis-synapse:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - SYNAPSE_SERVER_NAME=matrix.${DOMAIN}
      - SYNAPSE_REPORT_STATS=yes
      - SYNAPSE_ENABLE_REGISTRATION=${MATRIX_ENABLE_REGISTRATION:-false}
      - SYNAPSE_TRUSTED_PROXIES=172.18.0.0/16,172.21.0.0/24
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=synapse
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=${SYNAPSE_DB_PASSWORD}
      - REDIS_HOST=redis-synapse
    volumes:
      - synapse_data:/data
      - ./configs/synapse/homeserver.yaml:/data/homeserver.yaml:ro
      - ./configs/synapse/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ======================
  # Microblog - Mastodon
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD) + üîì SELF-CONTAINED (FEDERATION)
  #       OIDC Provider: Authelia via OmniAuth OpenID Connect
  #       Callback: https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
  #       Scopes: openid profile email
  #       Federation: ActivityPub requires local user accounts (@user@mastodon.${DOMAIN})
  #       Note: OIDC authenticates web access, but Mastodon ID remains on local server
  #
  # Authelia Client Config Required:
  #   client_id: mastodon
  #   client_secret: ${MASTODON_OIDC_SECRET}
  #   redirect_uris: https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
  #   scopes: openid profile email
  #
  # Architecture: 3-container stack (web, streaming, sidekiq)
  #   - mastodon-web: Rails web server (port 3000)
  #   - mastodon-streaming: Node.js WebSocket server
  #   - mastodon-sidekiq: Background job processor
  mastodon-web:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-web
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - backend
      - test
    labels:
      caddy: mastodon.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      authelia:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: bash -c "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000 -b 0.0.0.0"
    volumes:
      - mastodon_data:/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --proxy=off localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mastodon-streaming:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-streaming
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - backend
      - test
    depends_on:
      mastodon-web:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: node ./streaming
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --proxy=off localhost:4000/api/v1/streaming/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mastodon-sidekiq:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-sidekiq
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      - backend
    depends_on:
      mastodon-web:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: bundle exec sidekiq
    volumes:
      - mastodon_data:/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[s]idekiq 6' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Mastodon Init - Auto-setup database and generate keys
  # ======================
  mastodon-init:
    image: docker:27-cli
    container_name: mastodon-init
    networks:
      - backend
    depends_on:
      mastodon-web:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts/init-mastodon.sh:/init-mastodon.sh:ro
    command: sh /init-mastodon.sh
    restart: "no"



  # ======================
  # Dashboard - Homepage
  # ======================
  # Auth: üîí FORWARD AUTH (NO NATIVE OIDC)
  #       Homepage: Does NOT support native OIDC (feature requested but not implemented)
  #       Solution: Caddy forward_auth ‚Üí Authelia protects entire route
  #       Access Control: Configure Authelia ACL policy to allow 'users' + 'admins' groups
  #
  # Authelia ACL Policy Required:
  #   - domain: homepage.${DOMAIN}
  #     policy: one_factor
  #     subject:
  #       - group:users
  #       - group:admins
  #
  # Note: Homepage has no concept of logged-in user, it's a dashboard
  #       Forward-auth simply gates access, doesn't provide personalization
  homepage:
    image: ghcr.io/gethomepage/homepage:v1.7.0
    container_name: homepage
    restart: unless-stopped
    networks:
      - backend
      - admin
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      caddy: homepage.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 3000}}"
    environment:
      - PUID=1000
      - PGID=1000
      - HOMEPAGE_ALLOWED_HOSTS=homepage.${DOMAIN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/homepage/services.yaml:/app/config/services.yaml:ro
      - ./configs/homepage/settings.yaml:/app/config/settings.yaml:ro
      - ./configs/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - ./configs/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ./configs/homepage/docker.yaml:/app/config/docker.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ======================
  # JupyterHub
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia via GenericOAuthenticator
  #       Callback: https://jupyterhub.${DOMAIN}/hub/oauth_callback
  #       Scopes: openid email groups
  #       Role Mapping: groups claim ‚Üí admin_users list in jupyterhub_config.py
  #         - admins group ‚Üí JupyterHub admin access
  #
  # Authelia Client Config Required:
  #   client_id: jupyterhub
  #   client_secret: ${JUPYTERHUB_OAUTH_SECRET}
  #   redirect_uris: https://jupyterhub.${DOMAIN}/hub/oauth_callback
  #   scopes: openid email groups
  jupyterhub:
    build:
      context: configs/jupyterhub
      dockerfile: configs/jupyterhub/Dockerfile
    container_name: jupyterhub
    restart: unless-stopped
    networks:
      - backend
      - admin
      - admin-jupyterhub
    labels:
      caddy: jupyterhub.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8000}}"
    depends_on:
      authelia:
        condition: service_healthy
      docker-proxy:
        condition: service_started
    environment:
      - DOMAIN=${DOMAIN}
      - JUPYTERHUB_OAUTH_SECRET=${JUPYTERHUB_OAUTH_SECRET}
      - DOCKER_HOST=tcp://docker-proxy:2375
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./configs/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/hub/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Home Automation - Home Assistant
  # ======================
  # Auth: ‚úÖ NATIVE OIDC via hass-oidc-auth + Authelia (PREFERRED)
  #       Identity source: LDAP (via Authelia backend)
  #
  # Why this pattern (2025 best practice):
  #   - Home Assistant has no native OIDC, so we use the community
  #     "OpenID Connect for Home Assistant" integration (hass-oidc-auth, via HACS).
  #   - Authelia acts as OIDC provider backed by OpenLDAP, so HA logins
  #     inherit LDAP users, groups and MFA from Authelia.
  #   - No Caddy forward_auth here: HA talks OIDC directly to Authelia.
  #     This keeps mobile apps and WebSockets happy.
  #
  # OIDC callback URL (hass-oidc-auth):
  #   https://homeassistant.${DOMAIN}/auth/oidc/callback
  #
  # Authelia Client Config Required:
  #   client_id: home-assistant
  #   client_secret: ${HOMEASSISTANT_OAUTH_SECRET}
  #   redirect_uris: https://homeassistant.${DOMAIN}/auth/oidc/callback
  #   scopes: openid profile groups
  #
  # Security notes:
  #   - Admin access controlled by Authelia group mapping (admins/users).
  #   - Keep at least one local HA owner account as break-glass login.
  #   - Rely on Authelia for MFA; you can still enable HA's own 2FA if you like.
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    labels:
      caddy: homeassistant.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 8123}}"
    depends_on:
      authelia:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - TZ=UTC        # or your local TZ, e.g. Australia/Hobart
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
