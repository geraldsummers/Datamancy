FROM eclipse-temurin:21-jdk

WORKDIR /workspace

# Install required tools
RUN apt-get update && apt-get install -y \
    git \
    && rm -rf /var/lib/apt/lists/*

# Copy gradle wrapper and build files
COPY gradlew .
COPY gradle gradle
COPY build.gradle.kts .
COPY settings.gradle.kts .

# Copy source code
COPY src src

# Make gradlew executable
RUN chmod +x gradlew

# Create writable gradle home directory for any user
RUN mkdir -p /tmp/gradle-integration-test && chmod 777 /tmp/gradle-integration-test

# Download dependencies (cache this layer) using the custom gradle home
ENV GRADLE_USER_HOME=/tmp/gradle-integration-test
RUN ./gradlew dependencies --no-daemon || true

# Make all gradle directories writable for any user
RUN chmod -R 777 /tmp/gradle-integration-test /workspace/.gradle 2>/dev/null || true

# Default command runs integration tests only for modules that have them
CMD ["./gradlew", ":data-fetcher:test", ":control-panel:test", "--tests", "*RealIntegrationTest", "--tests", "*IntegrationTest", "--no-daemon", "--stacktrace"]
