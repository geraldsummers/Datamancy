###############################################
# Datamancy â€” Secrets Manager
#
# This file defines the secrets management infrastructure
# Secrets are generated at runtime and never exposed to logs or human eyes
###############################################

services:
  secrets-manager:
    image: alpine:latest
    container_name: secrets-manager
    restart: "no"
    profiles:
      - bootstrap
      - infrastructure
    volumes:
      - secrets_data:/run/secrets
      - ./scripts/init-secrets.sh:/scripts/init-secrets.sh:ro
    environment:
      - SECRETS_DIR=/run/secrets
      - STACK_ADMIN_EMAIL=${STACK_ADMIN_EMAIL:-admin@localhost}
      - HUGGINGFACEHUB_API_TOKEN=${HUGGINGFACEHUB_API_TOKEN:-}
    entrypoint: ["/bin/sh"]
    command:
      - -c
      - |
        apk add --no-cache openssl bash
        cp /scripts/init-secrets.sh /tmp/init-secrets.sh
        chmod +x /tmp/init-secrets.sh
        if [ ! -f /run/secrets/stack_secrets.enc ]; then
          echo "Initializing secrets for the first time..."
          /tmp/init-secrets.sh init
        else
          echo "Secrets already initialized."
        fi
        echo "Secrets are ready. Use 'docker compose run --rm secrets-manager bash -c \"cp /scripts/init-secrets.sh /tmp/init-secrets.sh && chmod +x /tmp/init-secrets.sh && /tmp/init-secrets.sh export\" to view."
    healthcheck:
      test: ["CMD", "test", "-f", "/run/secrets/stack_secrets.enc"]
      interval: 5s
      timeout: 3s
      retries: 1
      start_period: 5s

  # Helper service to export secrets to .env file for docker-compose
  # This should only be run manually when needed
  secrets-exporter:
    image: alpine:latest
    container_name: secrets-exporter
    profiles:
      - never  # Only run manually
    volumes:
      - secrets_data:/run/secrets:ro
      - ./scripts/init-secrets.sh:/scripts/init-secrets.sh:ro
      - ./.env.runtime:/output/.env.runtime
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache openssl bash
        /scripts/init-secrets.sh export > /output/.env.runtime
        echo "Secrets exported to .env.runtime"
        echo "Load with: export \$(cat .env.runtime | xargs)"

volumes:
  secrets_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${VOLUMES_ROOT}/secrets
