# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver:14.0.0
    container_name: mailserver
    restart: unless-stopped
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
    networks:
      mailserver:
        aliases:
          - mail.${DOMAIN}
      caddy:
        aliases:
          - mail.${DOMAIN}
      ldap:
        aliases:
          - mail.${DOMAIN}
    depends_on:
      ldap:
        condition: service_healthy
      caddy:
        condition: service_healthy
    environment:
      ENABLE_RSPAMD: 1
      ENABLE_CLAMAV: 1
      ENABLE_FAIL2BAN: 1
      ENABLE_POSTGREY: 0
      ENABLE_SPAMASSASSIN: 0
      SPOOF_PROTECTION: 0
      ENABLE_SRS: 0
      # Disable redundant services since Rspamd handles DKIM/DMARC/SPF
      ENABLE_OPENDKIM: 0
      ENABLE_OPENDMARC: 0
      ENABLE_POLICYD_SPF: 0
      PERMIT_DOCKER: network
      SSL_TYPE: manual
      OVERRIDE_HOSTNAME: mail.${DOMAIN}
      DOMAIN: ${DOMAIN}
      POSTMASTER_ADDRESS: postmaster@${MAIL_DOMAIN}
      ACCOUNT_PROVISIONER: LDAP
      LDAP_SERVER_HOST: ldap://ldap:389
      LDAP_BIND_DN: cn=admin,${LDAP_BASE_DN}
      LDAP_BIND_PW: ${LDAP_ADMIN_PASSWORD}
      LDAP_SEARCH_BASE: ou=users,${LDAP_BASE_DN}
      LDAP_QUERY_FILTER_USER: (&(objectClass=inetOrgPerson)(|(mail=%s)(uid=%s)))
      LDAP_QUERY_FILTER_GROUP: (&(objectClass=groupOfNames)(member=%s))
      LDAP_QUERY_FILTER_ALIAS: (&(objectClass=inetOrgPerson)(|(mail=%s)(uid=%s)))
      DOVECOT_MAILBOX_FORMAT: maildir
      DOVECOT_USER_FILTER: (&(objectClass=inetOrgPerson)(mail=%u))
      DOVECOT_PASS_FILTER: (&(objectClass=inetOrgPerson)(mail=%u))
      DOVECOT_PASS_ATTRS: mail=user,userPassword=password
      DOVECOT_USER_ATTRS: =home=/var/mail/%Ln,=mail=maildir:~/Maildir,=uid=5000,=gid=5000
      ENABLE_QUOTAS: 1
      # Disable Amavis by default (unstable) - can be enabled if needed
      ENABLE_AMAVIS: 0
      POSTFIX_MESSAGE_SIZE_LIMIT: 50000000
      # SSL paths will be auto-detected by find-certs.sh entrypoint
      # Supports both local_certs (dev) and Let's Encrypt (prod)
    dns:
      - 8.8.8.8
      - 8.8.4.4
    entrypoint: ["/bin/bash", "/tmp/docker-mailserver/entrypoint-wrapper.sh"]
    volumes:
      - mailserver_data:/var/mail/
      - /etc/localtime:/etc/localtime:ro
      - caddy_data:/caddy-certs:ro
      - ./configs/applications/mailserver/find-certs.sh:/tmp/docker-mailserver/find-certs.sh:ro
      - ./configs/infrastructure/mailserver/setup-dkim.sh:/tmp/docker-mailserver/setup-dkim.sh:ro
      - ./configs/infrastructure/mailserver/entrypoint-wrapper.sh:/tmp/docker-mailserver/entrypoint-wrapper.sh:ro
      - ./configs/infrastructure/mailserver/dovecot-ldap.conf.ext:/etc/dovecot/dovecot-ldap.conf.ext.template:ro
      - ./configs/infrastructure/mailserver/ldap-domains.cf:/etc/postfix/ldap-domains.cf:ro
    healthcheck:
      test: ["CMD-SHELL", "ss -ltn | grep -E ':25|:587|:993|:143' && supervisorctl status | grep -E 'postfix.*RUNNING' && supervisorctl status | grep -E 'dovecot.*RUNNING'"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 180s
