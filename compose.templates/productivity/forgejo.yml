# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  forgejo:
    image: codeberg.org/forgejo/forgejo:9.0
    container_name: forgejo
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - forgejo.${DOMAIN}
      postgres:
        aliases:
          - forgejo.${DOMAIN}
      internet:  # For cloning/pushing to external Git repos, Actions downloads
    depends_on:
      postgres:
        condition: service_started
    environment:
      USER_UID: ${DOCKER_USER_ID:-1000}
      USER_GID: ${DOCKER_GROUP_ID:-1000}
      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: postgres:5432
      FORGEJO__database__NAME: forgejo
      FORGEJO__database__USER: forgejo
      FORGEJO__database__PASSWD: ${FORGEJO_DB_PASSWORD}
      FORGEJO__server__DOMAIN: forgejo.${DOMAIN}
      FORGEJO__server__SSH_DOMAIN: forgejo.${DOMAIN}
      FORGEJO__server__ROOT_URL: https://forgejo.${DOMAIN}/
      FORGEJO__security__INSTALL_LOCK: true
      FORGEJO__service__DISABLE_REGISTRATION: true
      FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION: true
      FORGEJO__service__REQUIRE_SIGNIN_VIEW: true
      FORGEJO__oauth2_client__ENABLE_AUTO_REGISTRATION: true
      FORGEJO__openid__ENABLE_OPENID_SIGNIN: true
      FORGEJO__openid__ENABLE_OPENID_SIGNUP: true
      # Enable Forgejo Actions (CI/CD)
      FORGEJO__actions__ENABLED: true
      FORGEJO__actions__DEFAULT_ACTIONS_URL: https://code.forgejo.org
      FORGEJO_OAUTH_SECRET: ${FORGEJO_OAUTH_SECRET}
      DOMAIN: ${DOMAIN}
      STACK_ADMIN_PASSWORD: ${STACK_ADMIN_PASSWORD}
      STACK_ADMIN_EMAIL: ${STACK_ADMIN_EMAIL}
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 300s
