# Auto-generated by build-datamancy.main.kts
# Forgejo Actions Runner - executes CI/CD workflows
# NOTE: Uses labware Docker socket at /run/labware-docker.sock (virtualized/isolated Docker daemon)

services:
  forgejo-runner:
    build:
      context: .
      dockerfile: src/forgejo-runner/Dockerfile
    image: datamancy/forgejo-runner:3.5.1
    container_name: forgejo-runner
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - forgejo-runner.${DOMAIN}
      docker-proxy:
        aliases:
          - forgejo-runner.${DOMAIN}
    depends_on:
      forgejo:
        condition: service_healthy
      registry:
        condition: service_healthy
    environment:
      FORGEJO_INSTANCE_URL: http://forgejo:3000
      FORGEJO_RUNNER_NAME: datamancy-runner-1
      FORGEJO_RUNNER_LABELS: ubuntu-latest,ubuntu-22.04,linux
      FORGEJO_RUNNER_TOKEN: ${FORGEJO_RUNNER_TOKEN}
      # Access labware Docker socket (virtualized/isolated Docker daemon)
      DOCKER_HOST: unix:///run/labware-docker.sock
    volumes:
      - forgejo_runner_data:/data
      - forgejo_runner_token:/runner-token:ro
      # Mount labware Docker socket (host must have labware VM socket at /run/labware-docker.sock)
      - /run/labware-docker.sock:/run/labware-docker.sock
      - ./configs/applications/forgejo-runner:/etc/forgejo-runner:ro
    command: >
      sh -c "
        # Wait for Forgejo to be ready
        until nc -z forgejo 3000; do
          echo 'Waiting for Forgejo...'
          sleep 5
        done

        # Register runner if not already registered
        if [ ! -f /data/.runner ]; then
          # Try to read token from shared volume first (auto-generated by Forgejo)
          if [ -f /runner-token/token ]; then
            RUNNER_TOKEN=\$(cat /runner-token/token)
          elif [ -n \"$$FORGEJO_RUNNER_TOKEN\" ]; then
            RUNNER_TOKEN=\"$$FORGEJO_RUNNER_TOKEN\"
          else
            echo '❌ No runner token available'
            echo '   Waiting for Forgejo to generate token...'
            for i in \$(seq 1 30); do
              if [ -f /runner-token/token ]; then
                RUNNER_TOKEN=\$(cat /runner-token/token)
                break
              fi
              sleep 2
            done
          fi

          if [ -z \"$$RUNNER_TOKEN\" ]; then
            echo '❌ Failed to obtain runner token'
            echo '   Manual: docker exec forgejo forgejo actions generate-runner-token'
            sleep 60
            exit 1
          fi

          echo 'Registering runner with Forgejo...'
          forgejo-runner register --no-interactive --instance \"$$FORGEJO_INSTANCE_URL\" --token \"$$RUNNER_TOKEN\" --name \"$$FORGEJO_RUNNER_NAME\" --labels \"$$FORGEJO_RUNNER_LABELS\"
        else
          echo 'Runner already registered'
        fi

        # Start runner daemon
        echo 'Starting runner...'
        exec forgejo-runner daemon --config /etc/forgejo-runner/config.yaml
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f forgejo-runner || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
