# Auto-generated by build-datamancy.main.kts
# Forgejo Actions Runner - executes CI/CD workflows
# NOTE: Uses labware Docker socket at /run/labware-docker.sock (virtualized/isolated Docker daemon)

services:
  forgejo-runner:
    image: code.forgejo.org/forgejo/runner:3.5.1
    container_name: forgejo-runner
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - forgejo-runner.${DOMAIN}
      docker-proxy:
        aliases:
          - forgejo-runner.${DOMAIN}
    depends_on:
      forgejo:
        condition: service_healthy
      registry:
        condition: service_healthy
    environment:
      FORGEJO_INSTANCE_URL: http://forgejo:3000
      FORGEJO_RUNNER_REGISTRATION_TOKEN: ${FORGEJO_RUNNER_TOKEN}
      FORGEJO_RUNNER_NAME: datamancy-runner-1
      FORGEJO_RUNNER_LABELS: ubuntu-latest,ubuntu-22.04,linux
      # Access labware Docker socket (virtualized/isolated Docker daemon)
      DOCKER_HOST: unix:///run/labware-docker.sock
    volumes:
      - forgejo_runner_data:/data
      # Mount labware Docker socket (host must have labware VM socket at /run/labware-docker.sock)
      - /run/labware-docker.sock:/run/labware-docker.sock
      - ./configs/applications/forgejo-runner:/etc/forgejo-runner:ro
    command: >
      bash -c "
        # Wait for Forgejo to be ready
        until curl -sf http://forgejo:3000/api/healthz > /dev/null; do
          echo 'Waiting for Forgejo...'
          sleep 5
        done

        # Register runner if not already registered
        if [ ! -f /data/.runner ]; then
          echo 'Registering runner with Forgejo...'
          forgejo-runner register \
            --no-interactive \
            --instance http://forgejo:3000 \
            --token \$FORGEJO_RUNNER_REGISTRATION_TOKEN \
            --name \$FORGEJO_RUNNER_NAME \
            --labels \$FORGEJO_RUNNER_LABELS
        else
          echo 'Runner already registered'
        fi

        # Start runner daemon
        echo 'Starting runner...'
        exec forgejo-runner daemon --config /etc/forgejo-runner/config.yaml
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f forgejo-runner || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
