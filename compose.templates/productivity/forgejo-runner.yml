# Auto-generated by build-datamancy.main.kts
# Forgejo Actions Runner - executes CI/CD workflows
# NOTE: Uses labware Docker socket at /run/labware-docker.sock (virtualized/isolated Docker daemon)

services:
  forgejo-runner:
    build:
      context: .
      dockerfile: src/forgejo-runner/Dockerfile
    image: datamancy/forgejo-runner:3.5.1
    container_name: forgejo-runner
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - forgejo-runner.${DOMAIN}
      docker-proxy:
        aliases:
          - forgejo-runner.${DOMAIN}
    depends_on:
      forgejo:
        condition: service_healthy
      registry:
        condition: service_healthy
    environment:
      FORGEJO_INSTANCE_URL: http://forgejo:3000
      FORGEJO_RUNNER_NAME: datamancy-runner-1
      FORGEJO_RUNNER_LABELS: ubuntu-latest,ubuntu-22.04,linux
      # Access labware Docker socket (virtualized/isolated Docker daemon)
      DOCKER_HOST: unix:///run/labware-docker.sock
      # Mount Forgejo data directory to access forgejo binary
      FORGEJO_WORK_PATH: /forgejo-data
    volumes:
      - forgejo_runner_data:/data
      # Mount labware Docker socket (host must have labware VM socket at /run/labware-docker.sock)
      - /run/labware-docker.sock:/run/labware-docker.sock
      - ./configs/applications/forgejo-runner:/etc/forgejo-runner:ro
      # Mount Forgejo data directory to access forgejo binary and generate tokens
      - forgejo_data:/forgejo-data:ro
    command: >
      sh -c "
        # Wait for Forgejo to be ready (dependencies pre-installed in custom image)
        until nc -z forgejo 3000; do
          echo 'Waiting for Forgejo...'
          sleep 5
        done

        # Register runner if not already registered
        if [ ! -f /data/.runner ]; then
          echo 'üîß Auto-generating runner registration token...'

          # Generate token using Forgejo binary from mounted volume
          # Note: Forgejo binary is at /forgejo-data/gitea/gitea (Forgejo uses Gitea's binary name)
          if [ -x /forgejo-data/gitea/gitea ]; then
            RUNNER_TOKEN=\$(/forgejo-data/gitea/gitea --work-path /forgejo-data actions generate-runner-token 2>&1 | grep -v '^level=' | grep -v '^$$' | tail -1)
          else
            echo '‚ùå Forgejo binary not found at /forgejo-data/gitea/gitea'
            echo '   Using Forgejo API to generate token...'
            # Fallback: use Forgejo API (requires admin token, but better than nothing)
            RUNNER_TOKEN=\$$(curl -s -X POST http://forgejo:3000/api/v1/admin/runners/registration-token | jq -r .token)
          fi

          if [ -z \"\$$RUNNER_TOKEN\" ]; then
            echo '‚ùå Failed to generate token automatically'
            echo '   Please run manually on host:'
            echo '   docker exec forgejo forgejo actions generate-runner-token'
            sleep 60
            exit 1
          fi

          echo '‚úÖ Generated token'

          echo 'Registering runner with Forgejo...'
          forgejo-runner register \
            --no-interactive \
            --instance "http://forgejo:3000" \
            --token "$RUNNER_TOKEN" \
            --name "$FORGEJO_RUNNER_NAME" \
            --labels "$FORGEJO_RUNNER_LABELS"
        else
          echo 'Runner already registered'
        fi

        # Start runner daemon
        echo 'Starting runner...'
        exec forgejo-runner daemon --config /etc/forgejo-runner/config.yaml
      "
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f forgejo-runner || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
