# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  control-panel:
    image: datamancy/control-panel:local-build
    build:
      context: ./src/control-panel
      dockerfile: Dockerfile
    container_name: control-panel
    restart: unless-stopped
    ports:
      - "8097:8097"
    networks:
      caddy:
        aliases:
          - control.${DOMAIN}
      postgres:
        aliases:
          - control.${DOMAIN}
    depends_on:
      postgres:
        condition: service_started
      data-fetcher:
        condition: service_started
      data-transformer:
        condition: service_started
    environment:
      CONTROL_PANEL_PORT: 8097
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: datamancy
      POSTGRES_USER: datamancer
      POSTGRES_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
      DATA_FETCHER_URL: http://data-fetcher:8095
      DATA_TRANSFORMER_URL: http://data-transformer:8096
      SEARCH_SERVICE_URL: http://search-service:8098
    healthcheck:
      test: ["CMD", "wget", "-O", "/dev/null", "--quiet", "--tries=1", "--timeout=15", "http://localhost:8097/"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s

  data-fetcher:
    image: datamancy/data-fetcher:local-build
    build:
      context: ./src/data-fetcher
      dockerfile: Dockerfile
    container_name: data-fetcher
    restart: unless-stopped
    networks:
      - postgres
      - clickhouse
      - mariadb
      - qdrant
    depends_on:
      postgres:
        condition: service_started
      clickhouse:
        condition: service_started
      bookstack:
        condition: service_started
    environment:
      DATAFETCHER_PORT: 8095
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: datamancy
      POSTGRES_USER: datamancer
      POSTGRES_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_ADMIN_PASSWORD}
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6334
      OPENWEATHER_API_KEY: ${OPENWEATHER_API_KEY:-}
      COINGECKO_API_KEY: ${COINGECKO_API_KEY:-}
      SERP_API_KEY: ${SERP_API_KEY:-}
      FRED_API_KEY: ${FRED_API_KEY:-}
      BOOKSTACK_URL: ${BOOKSTACK_URL:-http://bookstack:80}
      BOOKSTACK_API_TOKEN_ID: ${BOOKSTACK_API_TOKEN_ID:-}
      BOOKSTACK_API_TOKEN_SECRET: ${BOOKSTACK_API_TOKEN_SECRET:-}
      FETCH_SCHEDULES_PATH: /app/config/schedules.yaml
      FETCH_SOURCES_PATH: /app/config/sources.yaml
      DATAFETCHER_DATA_PATH: /app/data
    volumes:
      - ./configs/applications/data-fetcher/schedules.yaml:/app/config/schedules.yaml:ro
      - ./configs/applications/data-fetcher/sources.yaml:/app/config/sources.yaml:ro
      - ./volumes/data/data-fetcher:/app/data
    healthcheck:
      test: ["CMD", "wget", "-O", "/dev/null", "--quiet", "--tries=1", "--timeout=15", "http://localhost:8095/"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s

  data-transformer:
    image: datamancy/data-transformer:local-build
    build:
      context: ./src/data-transformer
      dockerfile: Dockerfile
    container_name: data-transformer
    restart: unless-stopped
    networks:
      - postgres
      - mariadb
      - qdrant
      - clickhouse
      - ai-gateway
    depends_on:
      postgres:
        condition: service_started
      bookstack:
        condition: service_started
      qdrant:
        condition: service_started
      clickhouse:
        condition: service_started
      embedding-service:
        condition: service_started
    environment:
      DATA_TRANSFORMER_PORT: 8096
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: datamancy
      POSTGRES_USER: datamancer
      POSTGRES_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
      BOOKSTACK_URL: ${BOOKSTACK_URL:-http://bookstack:80}
      BOOKSTACK_API_TOKEN_ID: ${BOOKSTACK_API_TOKEN_ID:-}
      BOOKSTACK_API_TOKEN_SECRET: ${BOOKSTACK_API_TOKEN_SECRET:-}
      QDRANT_URL: http://qdrant:6334
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_ADMIN_PASSWORD}
      EMBEDDING_SERVICE_URL: http://embedding-service:8080
    healthcheck:
      test: ["CMD", "wget", "-O", "/dev/null", "--quiet", "--tries=1", "--timeout=15", "http://localhost:8096/"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s

  search-service:
    image: datamancy/search-service:local-build
    build:
      context: ./src/search-service
      dockerfile: Dockerfile
    container_name: search-service
    restart: unless-stopped
    networks:
      - qdrant
      - clickhouse
      - ai-gateway
    depends_on:
      qdrant:
        condition: service_started
      clickhouse:
        condition: service_started
      embedding-service:
        condition: service_started
    environment:
      SEARCH_SERVICE_PORT: 8098
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6334
      QDRANT_API_KEY: ${QDRANT_API_KEY}
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      CLICKHOUSE_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_ADMIN_PASSWORD}
      EMBEDDING_SERVICE_URL: http://embedding-service:8080
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 wget --quiet --tries=1 -O /dev/null http://127.0.0.1:8098/ || exit 1"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s

  agent-tool-server:
    image: datamancy/agent-tool-server:local-build
    build:
      context: ./src/agent-tool-server
      dockerfile: Dockerfile
    container_name: agent-tool-server
    restart: unless-stopped
    networks:
      # INTERNAL ONLY - not exposed to external network (no caddy network)
      ai:
        aliases:
          - agent-tool-server.${DOMAIN}
      ai-gateway:
        aliases:
          - agent-tool-server.${DOMAIN}
      # caddy: REMOVED - no external access
      postgres:
        aliases:
          - agent-tool-server.${DOMAIN}
      mariadb:
        aliases:
          - agent-tool-server.${DOMAIN}
      clickhouse:
        aliases:
          - agent-tool-server.${DOMAIN}
      qdrant:
        aliases:
          - agent-tool-server.${DOMAIN}
      ldap:
        aliases:
          - agent-tool-server.${DOMAIN}
      docker-proxy:
        aliases:
          - agent-tool-server.${DOMAIN}
    depends_on:
      litellm:
        condition: service_started
      dind:
        condition: service_healthy
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      LITELLM_BASE_URL: http://litellm:4000
      POSTGRES_OBSERVER_USER: agent_observer
      POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      MARIADB_OBSERVER_USER: agent_observer
      MARIADB_OBSERVER_PASSWORD: ${AGENT_MARIADB_OBSERVER_PASSWORD}
      MARIADB_HOST: mariadb
      MARIADB_PORT: 3306
      CLICKHOUSE_OBSERVER_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_OBSERVER_PASSWORD: ${AGENT_CLICKHOUSE_OBSERVER_PASSWORD}
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      QDRANT_OBSERVER_API_KEY: ${AGENT_QDRANT_API_KEY}
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6334
      LDAP_OBSERVER_DN: cn=agent_observer,${LDAP_BASE_DN}
      LDAP_OBSERVER_PASSWORD: ${AGENT_LDAP_OBSERVER_PASSWORD}
      LDAP_HOST: ldap
      LDAP_PORT: 389
      LDAP_BASE_DN: ${LDAP_BASE_DN}
      SEARCH_SERVICE_URL: http://search-service:8098
      MCP_GRANT_HOST_NETWORK_HTTP: "true"
      MCP_GRANT_HOST_NETWORK_SSH: "true"
      DOCKER_HOST: tcp://dind:2375
      DIND_NETWORK: datamancy-stack_docker-proxy
      # SSH configuration for ops plugin
      TOOLSERVER_SSH_HOST: ${STACK_SSH_HOST:-latium.local}
      TOOLSERVER_SSH_USER: ${STACK_SSH_USER:-stackops}
      TOOLSERVER_SSH_KEY_PATH: /app/keys/stackops_ed25519
      TOOLSERVER_SSH_KNOWN_HOSTS: /app/known_hosts
      # Timeout for tool execution (5 minutes for Docker operations)
      TOOLSERVER_TOOL_EXEC_TIMEOUT_MS: 300000
      # Grant capabilities for all plugins
      TOOLSERVER_ALLOW_CAPS: "host.network.http,host.network.ssh,host.shell.read,host.docker.inspect,host.docker.write,docker.container.create,docker.container.manage,ssh.keymanagement"
    volumes:
      - ./secrets/stackops_ed25519:/app/keys/stackops_ed25519:ro
      - ./agent_tool_server/known_hosts:/app/known_hosts:ro
      - ./configs/infrastructure/ssh/bootstrap_known_hosts.sh:/app/scripts/bootstrap_known_hosts.sh:ro
      # Mount host Docker socket for stack operations (rw for docker commands)
      - /var/run/docker.sock:/var/run/docker.sock.host:rw
    group_add:
      - "988"  # docker group on host
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --timeout=15 --spider http://localhost:8081/tools"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s

  prometheus:
    image: prom/prometheus:v3.9.1
    container_name: prometheus
    restart: unless-stopped
    networks:
      - monitoring
    volumes:
      - prometheus_data:/prometheus
      - ./configs/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=30d
      - --web.console.libraries=/usr/share/prometheus/console_libraries
      - --web.console.templates=/usr/share/prometheus/consoles
      - --web.read-timeout=30s
      - --web.max-connections=512
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  node-exporter:
    image: prom/node-exporter:v1.10.2
    container_name: node-exporter
    restart: unless-stopped
    networks:
      - monitoring
    volumes:
      - /:/host:ro,rslave
      - /sys:/host/sys:ro
      - /proc:/host/proc:ro
    command:
      - --path.rootfs=/host
      - --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "-O", "/dev/null", "http://localhost:9100/metrics"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.55.1
    container_name: cadvisor
    restart: unless-stopped
    networks:
      - monitoring
      - docker-proxy
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 20s

  watchtower:
    image: containrrr/watchtower:1.7.1
    container_name: watchtower
    restart: unless-stopped
    networks:
      - docker-proxy
    environment:
      WATCHTOWER_CLEANUP: true
      WATCHTOWER_INCLUDE_RESTARTING: true
      WATCHTOWER_SCHEDULE: 0 0 4 * * *
      DOCKER_API_VERSION: 1.44
      WATCHTOWER_NOTIFICATIONS: shoutrrr
      WATCHTOWER_NOTIFICATION_URL: 
      TZ: Australia/Sydney
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # Healthcheck disabled - distroless image without /bin/sh
    # Service runs as scheduled cron, doesn't need healthcheck

