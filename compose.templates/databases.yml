# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  postgres:
    image: postgres:16.11
    container_name: postgres
    restart: unless-stopped
    networks:
      - postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_USER: ${STACK_ADMIN_USER}
      POSTGRES_DB: postgres
      POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      PLANKA_DB_PASSWORD: ${PLANKA_DB_PASSWORD}
      SYNAPSE_DB_PASSWORD: ${SYNAPSE_DB_PASSWORD}
      AUTHELIA_DB_PASSWORD: ${AUTHELIA_DB_PASSWORD}
      GRAFANA_DB_PASSWORD: ${GRAFANA_DB_PASSWORD}
      VAULTWARDEN_DB_PASSWORD: ${VAULTWARDEN_DB_PASSWORD}
      OPENWEBUI_DB_PASSWORD: ${OPENWEBUI_DB_PASSWORD}
      MASTODON_DB_PASSWORD: ${MASTODON_DB_PASSWORD}
      FORGEJO_DB_PASSWORD: ${FORGEJO_DB_PASSWORD}
      HOMEASSISTANT_DB_PASSWORD: ${HOMEASSISTANT_DB_PASSWORD}
      ROUNDCUBE_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      AGENT_POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      DATAMANCY_SERVICE_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # init-db.sh removed - handled by postgres-init container instead to avoid stop/restart cycle
    command: postgres -c 'max_connections=300' -c 'shared_buffers=1GB'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${STACK_ADMIN_USER} && psql -U ${STACK_ADMIN_USER} -d postgres -c 'SELECT 1' > /dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'

  postgres-init:
    image: postgres:16.11
    container_name: postgres-init
    restart: no
    networks:
      - postgres
    depends_on:
      postgres:
        condition: service_started
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      PGHOST: postgres
      PGPORT: 5432
      POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      STACK_ADMIN_USER: ${STACK_ADMIN_USER}
      PLANKA_DB_PASSWORD: ${PLANKA_DB_PASSWORD}
      SYNAPSE_DB_PASSWORD: ${SYNAPSE_DB_PASSWORD}
      AUTHELIA_DB_PASSWORD: ${AUTHELIA_DB_PASSWORD}
      GRAFANA_DB_PASSWORD: ${GRAFANA_DB_PASSWORD}
      VAULTWARDEN_DB_PASSWORD: ${VAULTWARDEN_DB_PASSWORD}
      OPENWEBUI_DB_PASSWORD: ${OPENWEBUI_DB_PASSWORD}
      MASTODON_DB_PASSWORD: ${MASTODON_DB_PASSWORD}
      FORGEJO_DB_PASSWORD: ${FORGEJO_DB_PASSWORD}
      HOMEASSISTANT_DB_PASSWORD: ${HOMEASSISTANT_DB_PASSWORD}
      ROUNDCUBE_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      AGENT_POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      DATAMANCY_SERVICE_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
    volumes:
      - ./configs/databases/postgres/init-db.sh:/init-db.sh:ro
      - ./configs/databases/postgres/roundcube-schema.sql:/docker-entrypoint-initdb.d/roundcube-schema.sql:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "Waiting for Postgres to be ready..."
        until pg_isready -h postgres -U postgres; do
          sleep 2
        done
        echo "Running idempotent database initialization..."
        export POSTGRES_USER=${STACK_ADMIN_USER}
        /init-db.sh
        touch /tmp/init_complete
        echo "Database initialization complete"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/init_complete"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
        

  mariadb:
    image: mariadb:11.8.5
    container_name: mariadb
    restart: unless-stopped
    networks:
      - mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MYSQL_DATABASE: datamancy
      MYSQL_USER: ${STACK_ADMIN_USER}
      MYSQL_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      BOOKSTACK_DB_PASSWORD: ${BOOKSTACK_DB_PASSWORD}
      MARIADB_SEAFILE_PASSWORD: ${MARIADB_SEAFILE_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/databases/mariadb/init-template.sql:/docker-entrypoint-initdb.d/init-template.sql:ro
      - ./configs/databases/mariadb/init-wrapper.sh:/docker-entrypoint-initdb.d/01-init-wrapper.sh:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh --connect --innodb_initialized && test -f /var/lib/mysql/.init_complete"]
      interval: 60s
      timeout: 5s
      retries: 10

  mariadb-init:
    image: mariadb:11.8.5
    container_name: mariadb-init
    restart: no
    networks:
      - mariadb
    depends_on:
      mariadb:
        condition: service_started
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      BOOKSTACK_DB_PASSWORD: ${BOOKSTACK_DB_PASSWORD}
      MARIADB_SEAFILE_PASSWORD: ${MARIADB_SEAFILE_PASSWORD}
      STACK_ADMIN_PASSWORD: ${STACK_ADMIN_PASSWORD}
    volumes:
      - ./configs/databases/mariadb/init-db.sh:/init-db.sh:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "Waiting for MariaDB to be ready..."
        until mariadb -h mariadb -u root -p$$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT 1" >/dev/null 2>&1; do
          sleep 2
        done
        echo "Running idempotent database initialization..."
        /init-db.sh
        touch /tmp/init_complete
        echo "Database initialization complete"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/init_complete"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
        

  clickhouse:
    image: clickhouse/clickhouse-server:24.12
    container_name: clickhouse
    restart: unless-stopped
    networks:
      - clickhouse
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_ADMIN_PASSWORD}
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./configs/databases/clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'

  qdrant:
    image: qdrant/qdrant:v1.16.3
    container_name: qdrant
    restart: unless-stopped
    networks:
      - qdrant
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "test -d /qdrant/storage || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'

  vector-bootstrap:
    image: zenika/kotlin:latest
    container_name: vector-bootstrap
    restart: no
    networks:
      - qdrant
    depends_on:
      qdrant:
        condition: service_started
    environment:
      QDRANT_URL: http://qdrant:6333
      VECTOR_SIZE: ${VECTOR_EMBED_SIZE:-384}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
    volumes:
      - ./configs/databases/vectors/collections.yaml:/configs/collections.yaml:ro
      - ./configs/databases/vectors/bootstrap_vectors.main.kts:/scripts/bootstrap_vectors.main.kts:ro
    command:
      - kotlin
      - /scripts/bootstrap_vectors.main.kts
      - /configs/collections.yaml

