# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  mariadb:
    image: mariadb:11.8.5
    container_name: mariadb
    restart: unless-stopped
    networks:
      - mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MYSQL_DATABASE: datamancy
      MYSQL_USER: ${STACK_ADMIN_USER}
      MYSQL_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      BOOKSTACK_DB_PASSWORD: ${BOOKSTACK_DB_PASSWORD}
      MARIADB_SEAFILE_PASSWORD: ${MARIADB_SEAFILE_PASSWORD}
      AGENT_MARIADB_OBSERVER_PASSWORD: ${AGENT_MARIADB_OBSERVER_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/databases/mariadb/init-template.sql:/docker-entrypoint-initdb.d/init-template.sql:ro
      - ./configs/databases/mariadb/init-wrapper.sh:/docker-entrypoint-initdb.d/01-init-wrapper.sh:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD-SHELL", "healthcheck.sh --connect --innodb_initialized"]
      interval: 60s
      timeout: 5s
      retries: 10

  mariadb-init:
    image: mariadb:11.8.5
    container_name: mariadb-init
    restart: no
    networks:
      - mariadb
    depends_on:
      mariadb:
        condition: service_started
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      BOOKSTACK_DB_PASSWORD: ${BOOKSTACK_DB_PASSWORD}
      MARIADB_SEAFILE_PASSWORD: ${MARIADB_SEAFILE_PASSWORD}
      STACK_ADMIN_PASSWORD: ${STACK_ADMIN_PASSWORD}
      AGENT_MARIADB_OBSERVER_PASSWORD: ${AGENT_MARIADB_OBSERVER_PASSWORD}
    volumes:
      - ./configs/databases/mariadb/init-db.sh:/init-db.sh:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "Waiting for MariaDB to be ready..."
        until mariadb -h mariadb -u root -p$$MYSQL_ROOT_PASSWORD --ssl=0 -e "SELECT 1" >/dev/null 2>&1; do
          sleep 2
        done
        echo "Running idempotent database initialization..."
        /init-db.sh
        touch /tmp/init_complete
        echo "Database initialization complete"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/init_complete"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
