# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  postgres:
    image: postgres:16.11
    container_name: postgres
    restart: unless-stopped
    networks:
      - postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_USER: ${STACK_ADMIN_USER}
      POSTGRES_DB: postgres
      POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      PLANKA_DB_PASSWORD: ${PLANKA_DB_PASSWORD}
      SYNAPSE_DB_PASSWORD: ${SYNAPSE_DB_PASSWORD}
      AUTHELIA_DB_PASSWORD: ${AUTHELIA_DB_PASSWORD}
      GRAFANA_DB_PASSWORD: ${GRAFANA_DB_PASSWORD}
      VAULTWARDEN_DB_PASSWORD: ${VAULTWARDEN_DB_PASSWORD}
      OPENWEBUI_DB_PASSWORD: ${OPENWEBUI_DB_PASSWORD}
      MASTODON_DB_PASSWORD: ${MASTODON_DB_PASSWORD}
      FORGEJO_DB_PASSWORD: ${FORGEJO_DB_PASSWORD}
      HOMEASSISTANT_DB_PASSWORD: ${HOMEASSISTANT_DB_PASSWORD}
      ROUNDCUBE_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      AGENT_POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      DATAMANCY_SERVICE_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # init-db.sh removed - handled by postgres-init container instead to avoid stop/restart cycle
    command: postgres -c 'max_connections=300' -c 'shared_buffers=1GB'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${STACK_ADMIN_USER} && psql -U ${STACK_ADMIN_USER} -d postgres -c 'SELECT 1' > /dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'

  postgres-init:
    image: postgres:16.11
    container_name: postgres-init
    restart: no
    networks:
      - postgres
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      PGHOST: postgres
      PGPORT: 5432
      POSTGRES_ROOT_PASSWORD: ${POSTGRES_ROOT_PASSWORD}
      STACK_ADMIN_USER: ${STACK_ADMIN_USER}
      PLANKA_DB_PASSWORD: ${PLANKA_DB_PASSWORD}
      SYNAPSE_DB_PASSWORD: ${SYNAPSE_DB_PASSWORD}
      AUTHELIA_DB_PASSWORD: ${AUTHELIA_DB_PASSWORD}
      GRAFANA_DB_PASSWORD: ${GRAFANA_DB_PASSWORD}
      VAULTWARDEN_DB_PASSWORD: ${VAULTWARDEN_DB_PASSWORD}
      OPENWEBUI_DB_PASSWORD: ${OPENWEBUI_DB_PASSWORD}
      MASTODON_DB_PASSWORD: ${MASTODON_DB_PASSWORD}
      FORGEJO_DB_PASSWORD: ${FORGEJO_DB_PASSWORD}
      HOMEASSISTANT_DB_PASSWORD: ${HOMEASSISTANT_DB_PASSWORD}
      ROUNDCUBE_DB_PASSWORD: ${ROUNDCUBE_DB_PASSWORD}
      AGENT_POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      DATAMANCY_SERVICE_PASSWORD: ${DATAMANCY_SERVICE_PASSWORD}
    volumes:
      - ./configs/databases/postgres/init-db.sh:/init-db.sh:ro
      - ./configs/databases/postgres/roundcube-schema.sql:/docker-entrypoint-initdb.d/roundcube-schema.sql:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        echo "Waiting for Postgres to be ready..."
        until pg_isready -h postgres -U postgres; do
          sleep 2
        done
        echo "Running idempotent database initialization..."
        export POSTGRES_USER=${STACK_ADMIN_USER}
        /init-db.sh
        touch /tmp/init_complete
        echo "Database initialization complete"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/init_complete"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
