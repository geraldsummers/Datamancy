services:
  postgres:
    image: postgres:16.11
    container_name: postgres
    restart: unless-stopped
    networks:
      - postgres
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_ADMIN_PASSWORD}
      POSTGRES_USER: ${POSTGRES_ADMIN_USER}
      POSTGRES_DB: postgres
      POSTGRES_AUTHELIA_PASSWORD: ${POSTGRES_AUTHELIA_PASSWORD}
      POSTGRES_GRAFANA_PASSWORD: ${POSTGRES_GRAFANA_PASSWORD}
      POSTGRES_PLANKA_PASSWORD: ${POSTGRES_PLANKA_PASSWORD}
      POSTGRES_SYNAPSE_PASSWORD: ${POSTGRES_SYNAPSE_PASSWORD}
      POSTGRES_VAULTWARDEN_PASSWORD: ${POSTGRES_VAULTWARDEN_PASSWORD}
      POSTGRES_OPENWEBUI_PASSWORD: ${POSTGRES_OPENWEBUI_PASSWORD}
      POSTGRES_MASTODON_PASSWORD: ${POSTGRES_MASTODON_PASSWORD}
      POSTGRES_FORGEJO_PASSWORD: ${POSTGRES_FORGEJO_PASSWORD}
      POSTGRES_HOMEASSISTANT_PASSWORD: ${POSTGRES_HOMEASSISTANT_PASSWORD}
      POSTGRES_ROUNDCUBE_PASSWORD: ${POSTGRES_ROUNDCUBE_PASSWORD}
      POSTGRES_DATAMANCY_PASSWORD: ${POSTGRES_DATAMANCY_PASSWORD}
      POSTGRES_AGENT_PASSWORD: ${POSTGRES_AGENT_PASSWORD}
      POSTGRES_TXGATEWAY_PASSWORD: ${POSTGRES_TXGATEWAY_PASSWORD}
    volumes:
      - ${NOCOW_DB_DIR}/postgres:/var/lib/postgresql/data
      - ./configs/postgres/init-db.sh:/docker-entrypoint-initdb.d/01-init-db.sh:ro
      - ./configs/postgres/roundcube-schema.sql:/docker-entrypoint-initdb.d/02-roundcube-schema.sql:ro
    command: postgres -c 'max_connections=300' -c 'shared_buffers=1GB'
    healthcheck:
      test:
        - CMD-SHELL
        - |
          pg_isready -U ${POSTGRES_ADMIN_USER} -t 1 && \
          psql -U ${POSTGRES_ADMIN_USER} -d postgres -t -c 'SELECT 1' > /dev/null
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'

  postgres-observer-views:
    image: postgres:16.11
    container_name: postgres-observer-views
    restart: "no"
    networks:
      - postgres
    depends_on:
      postgres:
        condition: service_healthy
      grafana:
        condition: service_started
      planka:
        condition: service_started
      mastodon-init:
        condition: service_completed_successfully
      forgejo:
        condition: service_started
    environment:
      POSTGRES_USER: ${POSTGRES_ADMIN_USER}
      PGHOST: postgres
      PGPORT: 5432
      PGPASSWORD: ${POSTGRES_ADMIN_PASSWORD}
    volumes:
      - ./configs/postgres/create-observer-views.sql:/create-observer-views.sql:ro
    entrypoint:
      - /bin/bash
      - -c
      - |
        set -e
        echo "Creating agent_observer views in safe databases..."
        until pg_isready -h postgres -U "${POSTGRES_ADMIN_USER}"; do
          echo "Waiting for postgres..."
          sleep 2
        done
        echo "Running observer views script..."
        psql -U "${POSTGRES_ADMIN_USER}" -f /create-observer-views.sql || true
        touch /tmp/views_created
        echo "Observer views creation complete"
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/views_created"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
