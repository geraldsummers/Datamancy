services:
  mariadb:
    image: mariadb:11.8.5
    container_name: mariadb
    restart: unless-stopped
    networks:
      - mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ADMIN_PASSWORD}
      MYSQL_DATABASE: datamancy
      MARIADB_BOOKSTACK_PASSWORD: ${MARIADB_BOOKSTACK_PASSWORD}
      MARIADB_SEAFILE_PASSWORD: ${MARIADB_SEAFILE_PASSWORD}
      MARIADB_AGENT_PASSWORD: ${MARIADB_AGENT_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/mariadb/init-template.sql:/docker-entrypoint-initdb.d/init-template.sql:ro
      - ./configs/mariadb/init-wrapper.sh:/docker-entrypoint-initdb.d/01-init-wrapper.sh:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test:
        - CMD-SHELL
        - |
          healthcheck.sh --connect --innodb_initialized && \
          mariadb -u root -p"${MYSQL_ROOT_PASSWORD}" -e "SELECT COUNT(*) FROM information_schema.SCHEMATA WHERE SCHEMA_NAME IN ('bookstack', 'seafile')" | grep -q 2 && \
          mariadb -u root -p"${MYSQL_ROOT_PASSWORD}" -e "SELECT COUNT(*) FROM information_schema.PROCESSLIST" >/dev/null
      interval: 5s
      timeout: 4s
      retries: 5
      start_period: 20s

