# Auto-generated by build-datamancy.main.kts
# Integration Testing Service
# Provides a single test container with access to all networks
#
# Usage:
#   docker compose --profile testing run --rm integration-test-runner
#
# Run specific suite:
#   docker compose --profile testing run --rm integration-test-runner foundation
#   docker compose --profile testing run --rm integration-test-runner docker
#   docker compose --profile testing run --rm integration-test-runner data-pipeline
#
# Interactive debugging:
#   docker compose --profile testing run --rm integration-test-runner bash

services:
  integration-test-runner:
    build:
      context: .
      dockerfile: ./containers.src/test-runner/Dockerfile
    image: datamancy/test-runner:local-build
    container_name: integration-test-runner

    # ALL networks for integration testing (violates zero-trust, but essential for tests)
    networks:
      - ai
      - postgres
      - mariadb
      - clickhouse
      - qdrant
      - ldap
      - valkey
      - monitoring
      - caddy
      - docker-proxy

    environment:
      # Service endpoints (Docker network hostnames)
      AGENT_TOOL_SERVER_URL: "http://agent-tool-server:8081"
      SEARCH_SERVICE_URL: "http://search-service:8098"
      EMBEDDING_SERVICE_URL: "http://embedding-service:8080"

      # Infrastructure services
      LITELLM_URL: "http://litellm:4000"
      LITELLM_MASTER_KEY: "${LITELLM_MASTER_KEY}"
      CADDY_URL: "http://caddy:80"
      BOOKSTACK_URL: "http://bookstack:80"

      # Database connections - PostgreSQL
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "datamancy"
      POSTGRES_USER: "datamancer"
      POSTGRES_PASSWORD: "${DATAMANCY_SERVICE_PASSWORD}"
      POSTGRES_ROOT_PASSWORD: "${POSTGRES_ROOT_PASSWORD}"

      # Database connections - ClickHouse
      CLICKHOUSE_HOST: "clickhouse"
      CLICKHOUSE_PORT: "8123"
      CLICKHOUSE_USER: "${STACK_ADMIN_USER}"
      CLICKHOUSE_PASSWORD: "${CLICKHOUSE_ADMIN_PASSWORD}"
      DATAMANCY_SERVICE_PASSWORD: "${DATAMANCY_SERVICE_PASSWORD}"

      # Database connections - MariaDB
      MARIADB_HOST: "mariadb"
      MARIADB_PORT: "3306"
      MARIADB_USER: "bookstack"
      MARIADB_PASSWORD: "${BOOKSTACK_DB_PASSWORD}"
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"

      # Vector/cache services
      QDRANT_URL: "http://qdrant:6333"
      QDRANT_API_KEY: "${AGENT_QDRANT_API_KEY}"
      VALKEY_URL: "valkey:6379"

      # Auth services
      LDAP_URL: "ldap://ldap:389"
      LDAP_BASE_DN: "${LDAP_BASE_DN}"
      LDAP_ADMIN_DN: "cn=admin,${LDAP_BASE_DN}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"

      # Test configuration
      TEST_ENV: "container"
      TEST_USER_CONTEXT: "test-agent-user"
      STACK_ADMIN_USER: "${STACK_ADMIN_USER}"
      STACK_ADMIN_PASSWORD: "${STACK_ADMIN_PASSWORD}"

      # BookStack API credentials (optional - for data pipeline tests)
      BOOKSTACK_API_TOKEN_ID: "${BOOKSTACK_API_TOKEN_ID:-}"
      BOOKSTACK_API_TOKEN_SECRET: "${BOOKSTACK_API_TOKEN_SECRET:-}"

    # Only run when explicitly requested
    profiles:
      - testing

    # Don't restart automatically (tests are one-shot)
    restart: "no"

    # Labware Docker socket for CI/CD testing
    # NOTE: Uses isolated labware socket (/run/labware-docker.sock) intentionally
    #       This socket must be set up separately for labware tests to pass
    #       Provides isolation from main Docker daemon for security
    volumes:
      - /run/labware-docker.sock:/run/labware-docker.sock

    # No persistent volumes needed (tests are ephemeral)
    tmpfs:
      - /tmp
