# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  caddy:
    image: caddy:2.10.2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    networks:
      caddy:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      authelia:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      postgres:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      mariadb:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      clickhouse:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      qdrant:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      ldap:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      litellm:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      ai:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      ai-gateway:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      mailserver:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      memcached:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      matrix-internal:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      mastodon-internal:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
      monitoring:
        aliases:
          - www.${DOMAIN}
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - app.vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - bookstack.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - api.seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - api.matrix.${DOMAIN}
          - element.${DOMAIN}
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
          - litellm.${DOMAIN}
          - api.litellm.${DOMAIN}
          - auth.${DOMAIN}
          - kopia.${DOMAIN}
          - mail.${DOMAIN}
          - agent-tool-server.${DOMAIN}
          - lam.${DOMAIN}
          - forgejo.${DOMAIN}
          - qbittorrent.${DOMAIN}
    environment:
      DOMAIN: ${DOMAIN}
      STACK_ADMIN_EMAIL: ${STACK_ADMIN_EMAIL}
      API_LITELLM_ALLOWLIST: ${API_LITELLM_ALLOWLIST}
      MAIL_DOMAIN: ${MAIL_DOMAIN}
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./configs/infrastructure/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./configs/applications/vaultwarden/index.html:/srv/vaultwarden/index.html:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:2019/config/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    restart: unless-stopped
    networks:
      - ldap
    environment:
      LDAP_ORGANISATION: Datamancy
      LDAP_DOMAIN: stack.local
      LDAP_BASE_DN: dc=stack,dc=local
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_CONFIG_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_TLS: false
      LDAP_MEMBEROF_OVERLAY: true
      LDAP_MEMBEROF_GROUP_OC: groupOfNames
      LDAP_MEMBEROF_MEMBER_AD: member
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./configs/infrastructure/ldap/bootstrap_ldap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap_ldap.ldif:ro
    command: --copy-service --loglevel info
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -H ldap://localhost:389 -b '' -s base '(objectclass=*)' namingContexts >/dev/null 2>&1"]
      interval: 15s
      timeout: 10s
      retries: 8
      start_period: 180s

  valkey:
    image: valkey/valkey:8.1.5
    container_name: valkey
    restart: unless-stopped
    networks:
      - valkey
    volumes:
      - redis_data:/data
    command: valkey-server --appendonly yes --dir /data --databases 16
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  authelia:
    image: authelia/authelia:4.39.15
    container_name: authelia
    restart: unless-stopped
    networks:
      authelia:
        aliases:
          - auth.${DOMAIN}
      caddy:
        aliases:
          - auth.${DOMAIN}
      ldap:
        aliases:
          - auth.${DOMAIN}
      postgres:
        aliases:
          - auth.${DOMAIN}
      valkey:
        aliases:
          - auth.${DOMAIN}
    depends_on:
      ldap:
        condition: service_started
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      TZ: UTC
      DOMAIN: ${DOMAIN}
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: ${AUTHELIA_JWT_SECRET}
      AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_SECRET}
      AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: ${AUTHELIA_OIDC_HMAC_SECRET}
      AUTHELIA_STORAGE_POSTGRES_PASSWORD: ${AUTHELIA_DB_PASSWORD}
      # OIDC client secrets (Grafana, HomeAssistant, JupyterHub use forward_auth - no OIDC)
      PGADMIN_OAUTH_SECRET: ${PGADMIN_OAUTH_SECRET}
      OPENWEBUI_OAUTH_SECRET: ${OPENWEBUI_OAUTH_SECRET}
      NEXTCLOUD_OAUTH_SECRET: ${NEXTCLOUD_OAUTH_SECRET}
      DIM_OAUTH_SECRET: ${DIM_OAUTH_SECRET}
      PLANKA_OAUTH_SECRET: ${PLANKA_OAUTH_SECRET}
      VAULTWARDEN_OAUTH_SECRET: ${VAULTWARDEN_OAUTH_SECRET}
      MASTODON_OIDC_SECRET: ${MASTODON_OIDC_SECRET}
      BOOKSTACK_OAUTH_SECRET: ${BOOKSTACK_OAUTH_SECRET}
      FORGEJO_OAUTH_SECRET: ${FORGEJO_OAUTH_SECRET}
      MATRIX_OAUTH_SECRET: ${MATRIX_OAUTH_SECRET}
    volumes:
      - authelia_data:/config
      - ./configs/applications/authelia/configuration.yml:/config/configuration.yml:ro
      - ./configs/applications/authelia/oidc_rsa.pem:/config/oidc_rsa.pem:ro
      - ./configs/applications/authelia/entrypoint.sh:/entrypoint.sh:ro
    command:
      - --config
      - /config/configuration.yml
    entrypoint:
      - /entrypoint.sh
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 90s

  mailserver:
    image: ghcr.io/docker-mailserver/docker-mailserver:14.0.0
    container_name: mailserver
    restart: unless-stopped
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "143:143"
      - "993:993"
    networks:
      mailserver:
        aliases:
          - mail.${DOMAIN}
      caddy:
        aliases:
          - mail.${DOMAIN}
      ldap:
        aliases:
          - mail.${DOMAIN}
    depends_on:
      ldap:
        condition: service_healthy
      caddy:
        condition: service_healthy
    environment:
      ENABLE_RSPAMD: 1
      ENABLE_CLAMAV: 1
      ENABLE_FAIL2BAN: 1
      ENABLE_POSTGREY: 0
      ENABLE_SPAMASSASSIN: 0
      SPOOF_PROTECTION: 0
      ENABLE_SRS: 0
      # Disable redundant services since Rspamd handles DKIM/DMARC/SPF
      ENABLE_OPENDKIM: 0
      ENABLE_OPENDMARC: 0
      ENABLE_POLICYD_SPF: 0
      PERMIT_DOCKER: network
      SSL_TYPE: manual
      OVERRIDE_HOSTNAME: mail.${DOMAIN}
      DOMAIN: ${DOMAIN}
      POSTMASTER_ADDRESS: postmaster@${MAIL_DOMAIN}
      ACCOUNT_PROVISIONER: LDAP
      LDAP_SERVER_HOST: ldap://ldap:389
      LDAP_BIND_DN: cn=admin,dc=stack,dc=local
      LDAP_BIND_PW: ${LDAP_ADMIN_PASSWORD}
      LDAP_SEARCH_BASE: ou=users,dc=stack,dc=local
      LDAP_QUERY_FILTER_USER: (&(objectClass=inetOrgPerson)(|(mail=%s)(uid=%s)))
      LDAP_QUERY_FILTER_GROUP: (&(objectClass=groupOfNames)(member=%s))
      LDAP_QUERY_FILTER_ALIAS: (&(objectClass=inetOrgPerson)(|(mail=%s)(uid=%s)))
      DOVECOT_MAILBOX_FORMAT: maildir
      DOVECOT_USER_FILTER: (&(objectClass=inetOrgPerson)(mail=%u))
      DOVECOT_PASS_FILTER: (&(objectClass=inetOrgPerson)(mail=%u))
      DOVECOT_PASS_ATTRS: mail=user,userPassword=password
      DOVECOT_USER_ATTRS: =home=/var/mail/%Ln,=mail=maildir:~/Maildir,=uid=5000,=gid=5000
      ENABLE_QUOTAS: 1
      # Disable Amavis by default (unstable) - can be enabled if needed
      ENABLE_AMAVIS: 0
      POSTFIX_MESSAGE_SIZE_LIMIT: 50000000
      # SSL paths will be auto-detected by find-certs.sh entrypoint
      # Supports both local_certs (dev) and Let's Encrypt (prod)
    dns:
      - 8.8.8.8
      - 8.8.4.4
    entrypoint: ["/bin/bash", "/tmp/docker-mailserver/entrypoint-wrapper.sh"]
    volumes:
      - mailserver_data:/var/mail/
      - /etc/localtime:/etc/localtime:ro
      - caddy_data:/caddy-certs:ro
      - ./configs/applications/mailserver/find-certs.sh:/tmp/docker-mailserver/find-certs.sh:ro
      - ./configs/infrastructure/mailserver/setup-dkim.sh:/tmp/docker-mailserver/setup-dkim.sh:ro
      - ./configs/infrastructure/mailserver/entrypoint-wrapper.sh:/tmp/docker-mailserver/entrypoint-wrapper.sh:ro
      - ./configs/infrastructure/mailserver/dovecot-ldap.conf.ext:/etc/dovecot/dovecot-ldap.conf.ext.template:ro
      - ./configs/infrastructure/mailserver/ldap-domains.cf:/etc/postfix/ldap-domains.cf:ro
    healthcheck:
      test: ["CMD-SHELL", "ss -ltn | grep -E ':25|:587|:993|:143' && supervisorctl status | grep -E 'postfix.*RUNNING' && supervisorctl status | grep -E 'dovecot.*RUNNING'"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 180s

  ldap-account-manager:
    image: ghcr.io/ldapaccountmanager/lam:9.4
    container_name: ldap-account-manager
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - lam.${DOMAIN}
      ldap:
        aliases:
          - lam.${DOMAIN}
    depends_on:
      ldap:
        condition: service_started
    environment:
      LDAP_DOMAIN: stack.local
      LDAP_BASE_DN: dc=stack,dc=local
      LDAP_USER: cn=admin,dc=stack,dc=local
      LDAP_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LAM_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LAM_LANG: en_US
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/lam/templates/login.php"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  seafile-memcached:
    image: memcached:1.6.40
    container_name: seafile-memcached
    restart: unless-stopped
    networks:
      - memcached
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/127.0.0.1/11211' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  docker-proxy:
    image: tecnativa/docker-socket-proxy:v0.4.2
    container_name: docker-proxy
    restart: unless-stopped
    networks:
      - docker-proxy
    environment:
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
      POST: 1
      DELETE: 1
      INFO: 1
      VERSION: 1
      BUILD: 0
      COMMIT: 0
      EXEC: 0
    volumes:
      - ${DOCKER_SOCKET:-/var/run/docker.sock}:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2375/version"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  dind:
    image: docker:27-dind
    container_name: dind
    restart: unless-stopped
    privileged: true
    networks:
      - docker-proxy
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - dind-storage:/var/lib/docker
      - dind-certs:/certs
    command:
      - --storage-driver=overlay2
      - --host=tcp://0.0.0.0:2375
      - --host=unix:///var/run/docker.sock
      - --tls=false
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  kopia:
    image: kopia/kopia:0.22.3
    container_name: kopia
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - kopia.${DOMAIN}
    environment:
      KOPIA_PASSWORD: ${STACK_ADMIN_PASSWORD}
      KOPIA_REPO_PATH: /app/repository
      USER: kopia
    volumes:
      - kopia_data:/app
      - postgres_data:/backup/postgres:ro
      - mariadb_data:/backup/mariadb:ro
      - ./configs/applications/kopia/init-kopia.sh:/init-kopia.sh:ro
    entrypoint:
      - sh
      - /init-kopia.sh
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:51515/ || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

