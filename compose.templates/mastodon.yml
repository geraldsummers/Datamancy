# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  mastodon-init:
    image: ghcr.io/mastodon/mastodon:v4.5.4
    container_name: mastodon-init
    restart: no
    networks:
      - postgres
      - valkey
    depends_on:
      postgres-init:
        condition: service_completed_successfully
      valkey:
        condition: service_healthy
    environment:
      LOCAL_DOMAIN: ${DOMAIN}
      RAILS_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: ${MASTODON_DB_PASSWORD}
      REDIS_HOST: valkey
      REDIS_PORT: 6379
      SECRET_KEY_BASE: ${MASTODON_SECRET_KEY_BASE}
      OTP_SECRET: ${MASTODON_OTP_SECRET}
      VAPID_PRIVATE_KEY: ${MASTODON_VAPID_PRIVATE_KEY}
      VAPID_PUBLIC_KEY: ${MASTODON_VAPID_PUBLIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}
    command:
      - bash
      - -c
      - |
        echo "Running Mastodon database migrations..."
        bundle exec rails db:migrate
        echo "Mastodon database migrations complete"


  mastodon-web:
    image: ghcr.io/mastodon/mastodon:v4.5.4
    container_name: mastodon-web
    restart: unless-stopped
    networks:
      - caddy
      - postgres
      - valkey
      - mastodon-internal
      - internet  # For federation with other Mastodon instances
    depends_on:
      mastodon-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      LOCAL_DOMAIN: ${DOMAIN}
      WEB_DOMAIN: mastodon.${DOMAIN}
      RAILS_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: ${MASTODON_DB_PASSWORD}
      REDIS_HOST: valkey
      REDIS_PORT: 6379
      SECRET_KEY_BASE: ${MASTODON_SECRET_KEY_BASE}
      OTP_SECRET: ${MASTODON_OTP_SECRET}
      VAPID_PRIVATE_KEY: ${MASTODON_VAPID_PRIVATE_KEY}
      VAPID_PUBLIC_KEY: ${MASTODON_VAPID_PUBLIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}
      SMTP_SERVER: mailserver
      SMTP_PORT: 587
      SMTP_FROM_ADDRESS: mastodon@${DOMAIN}
      SMTP_AUTH_METHOD: plain
      SMTP_OPENSSL_VERIFY_MODE: none
      STREAMING_API_BASE_URL: wss://mastodon.${DOMAIN}
      WEB_CONCURRENCY: 2
      MAX_THREADS: 5
      # Rails configuration
      RAILS_MAX_THREADS: 5
      DB_POOL: 10  # Should be >= MAX_THREADS for connection pooling
      # Trust all Docker bridge networks for X-Forwarded-* headers
      TRUSTED_PROXY_IP: 172.16.0.0/12  # Docker default bridge range (172.16-31.x.x)
      # Allow internal container hostnames for health checks and test runner
      RAILS_DEVELOPMENT_HOSTS: mastodon-web,mastodon-web:3000,mastodon.${DOMAIN},mastodon-sidekiq,localhost,.${DOMAIN}
      # Disable host authorization checks for Docker network communication
      DISABLE_HOST_CHECK: "true"
      DANGEROUSLY_DISABLE_HOST_FILTERING: "true"
    command: bash -c "bundle exec rails server -b 0.0.0.0"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

  mastodon-streaming:
    image: ghcr.io/mastodon/mastodon-streaming:v4.5.4
    container_name: mastodon-streaming
    restart: unless-stopped
    networks:
      - postgres
      - valkey
      - mastodon-internal
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: ${MASTODON_DB_PASSWORD}
      REDIS_HOST: valkey
      REDIS_PORT: 6379
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:4000/api/v1/streaming/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  mastodon-sidekiq:
    image: ghcr.io/mastodon/mastodon:v4.5.4
    container_name: mastodon-sidekiq
    restart: unless-stopped
    networks:
      - postgres
      - valkey
      - mastodon-internal
      - internet  # For federation background jobs
    depends_on:
      mastodon-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
    environment:
      LOCAL_DOMAIN: ${DOMAIN}
      WEB_DOMAIN: mastodon.${DOMAIN}
      RAILS_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: mastodon
      DB_USER: mastodon
      DB_PASS: ${MASTODON_DB_PASSWORD}
      REDIS_HOST: valkey
      REDIS_PORT: 6379
      SECRET_KEY_BASE: ${MASTODON_SECRET_KEY_BASE}
      OTP_SECRET: ${MASTODON_OTP_SECRET}
      VAPID_PRIVATE_KEY: ${MASTODON_VAPID_PRIVATE_KEY}
      VAPID_PUBLIC_KEY: ${MASTODON_VAPID_PUBLIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY}
      ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT}
      ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: ${MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY}
      SMTP_SERVER: mailserver
      SMTP_PORT: 587
      SMTP_FROM_ADDRESS: mastodon@${DOMAIN}
      SMTP_AUTH_METHOD: plain
      SMTP_OPENSSL_VERIFY_MODE: none
    command: bundle exec sidekiq
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep 'sidekiq'"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
