# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  agent-tool-server:
    image: datamancy/agent-tool-server:local-build
    build:
      context: ./src/agent-tool-server
      dockerfile: Dockerfile
    container_name: agent-tool-server
    restart: unless-stopped
    networks:
      # INTERNAL ONLY - not exposed to external network (no caddy network)
      ai:
        aliases:
          - agent-tool-server.${DOMAIN}
      ai-gateway:
        aliases:
          - agent-tool-server.${DOMAIN}
      # caddy: REMOVED - no external access
      postgres:
        aliases:
          - agent-tool-server.${DOMAIN}
      mariadb:
        aliases:
          - agent-tool-server.${DOMAIN}
      clickhouse:
        aliases:
          - agent-tool-server.${DOMAIN}
      qdrant:
        aliases:
          - agent-tool-server.${DOMAIN}
      ldap:
        aliases:
          - agent-tool-server.${DOMAIN}
      docker-proxy:
        aliases:
          - agent-tool-server.${DOMAIN}
    depends_on:
      litellm:
        condition: service_started
      # dind: REMOVED - docker_container_create tool disabled
      # dind:
      #   condition: service_healthy
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY}
      LITELLM_BASE_URL: http://litellm:4000
      POSTGRES_OBSERVER_USER: agent_observer
      POSTGRES_OBSERVER_PASSWORD: ${AGENT_POSTGRES_OBSERVER_PASSWORD}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      MARIADB_OBSERVER_USER: agent_observer
      MARIADB_OBSERVER_PASSWORD: ${AGENT_MARIADB_OBSERVER_PASSWORD}
      MARIADB_HOST: mariadb
      MARIADB_PORT: 3306
      CLICKHOUSE_OBSERVER_USER: ${STACK_ADMIN_USER}
      CLICKHOUSE_OBSERVER_PASSWORD: ${AGENT_CLICKHOUSE_OBSERVER_PASSWORD}
      CLICKHOUSE_HOST: clickhouse
      CLICKHOUSE_PORT: 8123
      QDRANT_OBSERVER_API_KEY: ${AGENT_QDRANT_API_KEY}
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6334
      LDAP_OBSERVER_DN: cn=agent_observer,${LDAP_BASE_DN}
      LDAP_OBSERVER_PASSWORD: ${AGENT_LDAP_OBSERVER_PASSWORD}
      LDAP_HOST: ldap
      LDAP_PORT: 389
      LDAP_BASE_DN: ${LDAP_BASE_DN}
      SEARCH_SERVICE_URL: http://search-service:8098
      MCP_GRANT_HOST_NETWORK_HTTP: "true"
      MCP_GRANT_HOST_NETWORK_SSH: "true"
      # DinD removed - docker_container_create tool disabled
      # DOCKER_HOST: tcp://dind:2375
      # DIND_NETWORK: datamancy-stack_docker-proxy
      # SSH configuration for ops plugin
      TOOLSERVER_SSH_HOST: ${STACK_SSH_HOST:-latium.local}
      TOOLSERVER_SSH_USER: ${STACK_SSH_USER:-stackops}
      TOOLSERVER_SSH_KEY_PATH: /app/keys/stackops_ed25519
      TOOLSERVER_SSH_KNOWN_HOSTS: /app/known_hosts
      # Timeout for tool execution (5 minutes for Docker operations)
      TOOLSERVER_TOOL_EXEC_TIMEOUT_MS: 300000
      # Grant capabilities for all plugins
      TOOLSERVER_ALLOW_CAPS: "host.network.http,host.network.ssh,host.shell.read,host.docker.inspect,host.docker.write,docker.container.create,docker.container.manage,ssh.keymanagement"
    volumes:
      - ./secrets/stackops_ed25519:/app/keys/stackops_ed25519:ro
      - ./agent_tool_server/known_hosts:/app/known_hosts:ro
      - ./configs/infrastructure/ssh/bootstrap_known_hosts.sh:/app/scripts/bootstrap_known_hosts.sh:ro
      # Mount host Docker socket for stack operations (rw for docker commands)
      - /var/run/docker.sock:/var/run/docker.sock.host:rw
    group_add:
      - "988"  # docker group on host
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --timeout=15 --spider http://localhost:8081/tools"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 180s
