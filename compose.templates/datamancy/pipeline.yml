# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  pipeline:
    image: datamancy/pipeline:local-build
    build:
      context: ./src/pipeline
      dockerfile: Dockerfile
    container_name: pipeline
    restart: unless-stopped
    networks:
      - qdrant
      - clickhouse
      - ai-gateway
    depends_on:
      qdrant:
        condition: service_started
      clickhouse:
        condition: service_started
      embedding-service:
        condition: service_started
    environment:
      # RSS Feed (enabled by default)
      RSS_ENABLED: "true"
      RSS_SCHEDULE_MINUTES: "60"  # Hourly

      # CVE (disabled by default - needs API key)
      CVE_ENABLED: "false"
      CVE_API_KEY: "${CVE_API_KEY:-}"

      # Torrents (disabled by default - needs data file)
      TORRENTS_ENABLED: "false"

      # Wikipedia (disabled by default - needs dump file)
      WIKIPEDIA_ENABLED: "false"

      # Australian Laws (disabled by default)
      AUSTRALIAN_LAWS_ENABLED: "false"

      # Linux Docs (disabled by default)
      LINUX_DOCS_ENABLED: "false"

      # Services
      EMBEDDING_SERVICE_URL: http://embedding-service:8080
      QDRANT_URL: http://qdrant:6334
      CLICKHOUSE_URL: http://clickhouse:8123

      # Collection names
      QDRANT_RSS_COLLECTION: rss_feeds
      QDRANT_CVE_COLLECTION: cve
      QDRANT_TORRENTS_COLLECTION: torrents
      QDRANT_MARKET_COLLECTION: market_data
      QDRANT_WIKIPEDIA_COLLECTION: wikipedia
      QDRANT_AUSTRALIAN_LAWS_COLLECTION: australian_laws
      QDRANT_LINUX_DOCS_COLLECTION: linux_docs
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 wget --quiet --tries=1 -O /dev/null http://127.0.0.1:8090/health || exit 1"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 60s
