# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  pipeline:
    image: datamancy/pipeline:local-build
    build:
      context: ./src/pipeline
      dockerfile: Dockerfile
    container_name: pipeline
    restart: unless-stopped
    networks:
      - qdrant
      - clickhouse
      - ai-gateway
      - internet  # For fetching external data (RSS, CVE, Wikipedia, torrents)
    depends_on:
      qdrant:
        condition: service_started
      clickhouse:
        condition: service_started
      embedding-service:
        condition: service_started
    environment:
      # RSS Feed - ENABLED BY DEFAULT
      RSS_SCHEDULE_MINUTES: "60"  # Hourly
      RSS_FEED_URLS: "https://hnrss.org/frontpage,https://arxiv.org/rss/cs.AI,https://www.reddit.com/r/programming/.rss,https://feeds.arstechnica.com/arstechnica/index"
      # RSS_ENABLED: "false"  # Uncomment to disable

      # CVE - ENABLED BY DEFAULT (no API key = 5 req/30s, with key = 50 req/30s)
      CVE_API_KEY: "${CVE_API_KEY:-}"  # Optional - works without key but slower
      CVE_SCHEDULE_MINUTES: "1440"  # Daily
      CVE_MAX_RESULTS: "2147483647"  # Pull ALL CVEs
      # CVE_ENABLED: "false"  # Uncomment to disable

      # Torrents - ENABLED BY DEFAULT
      TORRENTS_DATA_PATH: "https://codeberg.org/heretic/torrents-csv-data/raw/branch/main/torrents.csv"
      TORRENTS_SCHEDULE_MINUTES: "10080"  # Weekly
      TORRENTS_MAX_RESULTS: "2147483647"  # ALL torrents
      # TORRENTS_ENABLED: "false"  # Uncomment to disable

      # Wikipedia - ENABLED BY DEFAULT
      # Simple EN: https://dumps.wikimedia.org/simplewiki/latest/simplewiki-latest-pages-articles.xml.bz2 (200MB)
      # Full EN: https://dumps.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles.xml.bz2 (20GB!)
      WIKIPEDIA_DUMP_PATH: "https://dumps.wikimedia.org/enwiki/latest/enwiki-latest-pages-articles.xml.bz2"
      WIKIPEDIA_SCHEDULE_MINUTES: "43200"  # Twice daily
      WIKIPEDIA_MAX_ARTICLES: "2147483647"  # ALL articles
      # WIKIPEDIA_ENABLED: "false"  # Uncomment to disable

      # Australian Laws - ENABLED BY DEFAULT (ALL 9 jurisdictions via AustLII web scraping)
      AUSTRALIAN_LAWS_JURISDICTIONS: "commonwealth,nsw,vic,qld,wa,sa,tas,act,nt"
      AUSTRALIAN_LAWS_MAX_PER_JURISDICTION: "100"
      AUSTRALIAN_LAWS_START_YEAR: "2020"
      AUSTRALIAN_LAWS_SCHEDULE_MINUTES: "1440"  # Daily
      # AUSTRALIAN_LAWS_ENABLED: "false"  # Uncomment to disable

      # Linux Docs - ENABLED BY DEFAULT (Man pages + Debian package docs from Debian base image)
      LINUX_DOCS_SOURCES: "MAN_PAGES,DEBIAN_DOCS"
      LINUX_DOCS_SCHEDULE_MINUTES: "10080"  # Weekly
      LINUX_DOCS_MAX: "2147483647"  # ALL docs
      # LINUX_DOCS_ENABLED: "false"  # Uncomment to disable

      # Wiki - ENABLED BY DEFAULT (Debian Wiki + Arch Wiki via web scraping)
      WIKI_TYPES: "DEBIAN,ARCH"
      WIKI_MAX_PAGES_PER_WIKI: "500"
      WIKI_SCHEDULE_MINUTES: "10080"  # Weekly
      # WIKI_ENABLED: "false"  # Uncomment to disable

      # Services
      EMBEDDING_SERVICE_URL: http://embedding-service:8080
      QDRANT_URL: http://qdrant:6334
      CLICKHOUSE_URL: http://clickhouse:8123

      # BookStack integration - ENABLED BY DEFAULT (for wiki presentation)
      BOOKSTACK_ENABLED: "${BOOKSTACK_ENABLED:-true}"
      BOOKSTACK_URL: "http://bookstack:80"
      BOOKSTACK_TOKEN_ID: "${BOOKSTACK_API_TOKEN_ID:-}"
      BOOKSTACK_TOKEN_SECRET: "${BOOKSTACK_API_TOKEN_SECRET:-}"

      # Collection names
      QDRANT_RSS_COLLECTION: rss_feeds
      QDRANT_CVE_COLLECTION: cve
      QDRANT_TORRENTS_COLLECTION: torrents
      QDRANT_MARKET_COLLECTION: market_data
      QDRANT_WIKIPEDIA_COLLECTION: wikipedia
      QDRANT_AUSTRALIAN_LAWS_COLLECTION: australian_laws
      QDRANT_LINUX_DOCS_COLLECTION: linux_docs
      QDRANT_DEBIAN_WIKI_COLLECTION: debian_wiki
      QDRANT_ARCH_WIKI_COLLECTION: arch_wiki
    volumes:
      - pipeline_data:/data
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 wget --quiet --tries=1 -O /dev/null http://127.0.0.1:8090/health || exit 1"]
      interval: 60s
      timeout: 20s
      retries: 3
      start_period: 60s
