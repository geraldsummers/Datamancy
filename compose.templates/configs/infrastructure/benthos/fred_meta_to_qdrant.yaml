http:
  address: 0.0.0.0:4200
  enabled: true

resources:
  caches:
    dedupe_mem:
      memory: {}
  rate_limits:
    api_rl:
      local:
        count: 5
        interval: 1s

input:
  generate:
    count: 1
    interval: 24h
    mapping: |
      root = env("FRED_SERIES_LIST", "GDP,UNRATE,CPIAUCSL").split(",").map_each(x -> x.trim())

pipeline:
  processors:
    - unarchive:
        format: json_array
    - mapping: |
        root.series_id = this
        root = if env("FRED_API_KEY").length() == 0 { deleted() } else { root }
    - branch:
        processors:
          - http:
              url: https://api.stlouisfed.org/fred/series?series_id=${! this.series_id }&api_key=${FRED_API_KEY}&file_type=json
              verb: GET
              rate_limit: api_rl
        result_map: |
          root.series = this
    - mapping: |
        let meta = this.series.seriess.0
        root.collection = env("TARGET_COLLECTION", "macro_series_meta")
        root.id = ("fred:" + this.series_id)
        root.text = ("Series: " + meta.title + " (" + meta.id + ")\nUnits: " + meta.units + "\nFreq: " + meta.frequency + "\nNotes: " + meta.notes).string().trim()
        root.payload = {
          provider: "FRED",
          dataset: "fred",
          series_id: meta.id,
          title: meta.title,
          units: meta.units,
          frequency: meta.frequency,
          last_updated: meta.last_updated
        }
        root.payload.text = root.text
        root.payload.content = root.text
    - dedupe:
        cache: dedupe_mem
        hash: "${! this.id }"
    - branch:
        processors:
          - http:
              url: ${LITELLM_URL:http://litellm:4000/v1}/embeddings
              verb: POST
              headers:
                Content-Type: application/json
              body: 'root = {"input":[ this.text ],"model": env("EMBED_MODEL","embed-small") }'
          - mapping: 'root = {"vector": this.data.0.embedding }'
        result_map: 'root.vector = this.vector'

output:
  http_client:
    url: ${QDRANT_URL:http://qdrant:6333}/collections/${TARGET_COLLECTION:macro_series_meta}/points?wait=true
    verb: PUT
    headers:
      Content-Type: application/json
      api-key: ${QDRANT_API_KEY:}
    body: 'root = {"points":[{"id": this.id, "vector": this.vector, "payload": this.payload}]}'

logger:
  level: INFO
  format: json
