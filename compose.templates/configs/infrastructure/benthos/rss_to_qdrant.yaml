http:
  address: 0.0.0.0:4198
  enabled: true

resources:
  caches:
    dedupe_mem:
      memory: {}
  rate_limits:
    api_rl:
      local:
        count: 5
        interval: 1s

input:
  broker:
    inputs:
      # Fetch a single RSS/Atom feed per instance. To scrape multiple feeds, run multiple instances
      # or set RSS_FEED to a comma-separated list and use multiple services.
      - label: rss_feed
        http_client:
          url: ${RSS_FEED:https://hnrss.org/frontpage}
          verb: GET
          rate_limit: api_rl
        processors:
          - xml:
              operator: to_json
          - mapping: |
              root = this.rss.channel.item.map_each(item -> {
                "id": (item.link.or(item.title + item.pubDate)).string().hash("sha1"),
                "text": (item.title + "\n\n" + item.description).string().trim(),
                "payload": {
                  "source": env("RSS_FEED"),
                  "title": item.title,
                  "summary": item.description,
                  "link": item.link,
                  "published": item.pubDate
                }
              })
          - unarchive:
              format: json_array
          - mapping: |
              root.collection = env("TARGET_COLLECTION", "rss_aggregation")
              root.id = this.id
              root.text = this.text
              root.payload = this.payload
              root.payload.text = this.text
              root.payload.content = this.text
          - dedupe:
              cache: dedupe_mem
              hash: "${! this.id }"
          - branch:
              processors:
                - http:
                    url: ${LITELLM_URL:http://litellm:4000/v1}/embeddings
                    verb: POST
                    headers:
                      Content-Type: application/json
                    body: |
                      root = { "input": [ this.text ], "model": env("EMBED_MODEL", "embed-small") }
                - mapping: 'root = {"vector": this.data.0.embedding }'
              result_map: 'root.vector = this.vector'

output:
  http_client:
    url: ${QDRANT_URL:http://qdrant:6333}/collections/${TARGET_COLLECTION:rss_aggregation}/points?wait=true
    verb: PUT
    headers:
      Content-Type: application/json
      api-key: ${QDRANT_API_KEY:}
    body: |
      root = {"points": [ {"id": this.id, "vector": this.vector, "payload": this.payload } ]}

logger:
  level: INFO
  format: json
