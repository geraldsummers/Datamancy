# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  grafana:
    image: grafana/grafana:11.6.9
    container_name: grafana
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - grafana.${DOMAIN}
      postgres:
        aliases:
          - grafana.${DOMAIN}
      authelia:
        aliases:
          - grafana.${DOMAIN}
      monitoring:
        aliases:
          - grafana.${DOMAIN}
    depends_on:
      postgres:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      GF_DEFAULT_LOCALE: en_US
      GF_SERVER_ROOT_URL: https://grafana.${DOMAIN}
      GF_SERVER_DOMAIN: grafana.${DOMAIN}
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: grafana
      GF_DATABASE_PASSWORD: ${GRAFANA_DB_PASSWORD}
      GF_DATABASE_SSL_MODE: disable
      # Using Caddy forward_auth with Authelia (not OIDC)
      GF_AUTH_PROXY_ENABLED: true
      GF_AUTH_PROXY_HEADER_NAME: Remote-User
      GF_AUTH_PROXY_HEADER_PROPERTY: username
      GF_AUTH_PROXY_AUTO_SIGN_UP: true
      GF_AUTH_PROXY_HEADERS: "Email:Remote-Email Name:Remote-Name"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./configs/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 180s
