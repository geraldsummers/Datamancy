# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:2026.1.0
    container_name: homeassistant
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      ldap:
        condition: service_healthy
    networks:
      caddy:
        aliases:
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
      postgres:
        aliases:
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
      ldap:
        aliases:
          - homeassistant.${DOMAIN}
          - api.homeassistant.${DOMAIN}
      internet:  # For IoT device communication, cloud integrations
    environment:
      TZ: UTC
      PUID: ${DOCKER_USER_ID:-1000}
      PGID: ${DOCKER_GROUP_ID:-1000}
      HOMEASSISTANT_DB_URL: postgresql://homeassistant:${HOMEASSISTANT_DB_PASSWORD}@postgres:5432/homeassistant
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: homeassistant
      POSTGRES_USER: homeassistant
      POSTGRES_PASSWORD: ${HOMEASSISTANT_DB_PASSWORD}
      LDAP_URL: ldap://ldap:389
      STACK_ADMIN_USER: ${STACK_ADMIN_USER}
      STACK_ADMIN_PASSWORD: ${STACK_ADMIN_PASSWORD}
      STACK_ADMIN_EMAIL: ${STACK_ADMIN_EMAIL}
      LDAP_BASE_DN: ${LDAP_BASE_DN}
      LDAP_USER_DN: ou=users,${LDAP_BASE_DN}
      LDAP_BIND_DN: cn=admin,${LDAP_BASE_DN}
      LDAP_BIND_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_USER_FILTER: (uid={username})
    volumes:
      - ./volumes/data/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
      - ./configs/homeassistant/configuration.yaml:/config/configuration.yaml:ro
      - ./configs/homeassistant/automations.yaml:/config/automations.yaml:rw
      - ./configs/homeassistant/scripts.yaml:/config/scripts.yaml:rw
      - ./configs/homeassistant/scenes.yaml:/config/scenes.yaml:rw
      - ./configs/homeassistant/init-homeassistant.sh:/init-homeassistant.sh:ro
      - ./configs/homeassistant/entrypoint.sh:/entrypoint-wrapper.sh:ro
      - ./configs/homeassistant/auth_ldap.py:/usr/src/homeassistant/homeassistant/auth/providers/auth_ldap.py:ro
    entrypoint:
      - /entrypoint-wrapper.sh
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8123/manifest.json || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
