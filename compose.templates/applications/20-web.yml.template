# Web applications and productivity tools
# Grafana, Open WebUI, Vaultwarden, Planka, BookStack, Homepage, JupyterHub, Home Assistant, Forgejo, qBittorrent

services:
  grafana:
    image: grafana/grafana:{{IMAGE_GRAFANA}}}}
    container_name: grafana
    restart: unless-stopped
    networks:
      - backend
      - database
    depends_on:
      - postgres
      - authelia
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - GF_DEFAULT_LOCALE=en_US
      - GF_SERVER_ROOT_URL=https://grafana.{{DOMAIN}}
      - GF_SERVER_DOMAIN=grafana.{{DOMAIN}}
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=postgres:5432
      - GF_DATABASE_NAME=grafana
      - GF_DATABASE_USER=grafana
      - GF_DATABASE_PASSWORD={{GRAFANA_DB_PASSWORD}}
      - GF_DATABASE_SSL_MODE=disable
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET={{GRAFANA_OAUTH_SECRET}}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.{{DOMAIN}}/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authelia:9091/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authelia:9091/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'users') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_GENERIC_OAUTH_AUTH_STYLE=2
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.{{DOMAIN}}/logout
      - GF_AUTH_GENERIC_OAUTH_SKIP_ORG_ROLE_SYNC=false
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER={{STACK_ADMIN_USER}}
      - GF_SECURITY_ADMIN_PASSWORD={{STACK_ADMIN_PASSWORD}}
    volumes:
      - grafana_data:/var/lib/grafana
      - {{HOME}}/.datamancy/configs/applications/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  open-webui:
     image: ghcr.io/open-webui/open-webui:{{IMAGE_OPEN_WEBUI}}}}
     container_name: open-webui
     restart: unless-stopped
     networks:
       - backend
       - frontend
       - database
     depends_on:
       - postgres
       - litellm
       - authelia
     dns:
       - 8.8.8.8
       - 1.1.1.1
     environment:
       - WEBUI_URL={{OPENWEBUI_WEBUI_URL:-https://open-webui.{{DOMAIN}}}}
       - DATABASE_URL=postgresql://openwebui:{{OPENWEBUI_DB_PASSWORD_ENCODED}}@postgres:5432/openwebui
       - ENABLE_OAUTH_SIGNUP={{OPENWEBUI_ENABLE_OAUTH_SIGNUP:-true}}
       - DEFAULT_USER_ROLE={{OPENWEBUI_DEFAULT_USER_ROLE:-admin}}
       - ENABLE_OPENAI_API=true
       - OPENAI_API_BASE_URL={{OPENWEBUI_OPENAI_API_BASE_URL:-http://litellm:4000/v1}}
       - OPENAI_API_KEY={{LITELLM_MASTER_KEY}}
       - OPENID_PROVIDER_URL=https://auth.{{DOMAIN}}
       - OAUTH_CLIENT_ID=open-webui
       - OAUTH_CLIENT_SECRET={{OPENWEBUI_OAUTH_SECRET}}
       - OAUTH_PROVIDER_NAME=Authelia
       - OAUTH_SCOPES=openid profile email groups
       - ENABLE_LOGIN_FORM=false
       - WEBUI_AUTH=false
     volumes:
       - open_webui_data:/app/backend/data
     healthcheck:
       test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
       interval: 30s
       timeout: 10s
       retries: 3
       start_period: 30s

  vaultwarden:
    image: vaultwarden/server:{{IMAGE_VAULTWARDEN}}}}
    container_name: vaultwarden
    restart: unless-stopped
    networks:
      - backend
      - database
    depends_on:
      - postgres
      - mailserver
      - authelia
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - DOMAIN=https://app.vaultwarden.{{DOMAIN}}
      - DATABASE_URL=postgresql://vaultwarden:{{VAULTWARDEN_DB_PASSWORD}}@postgres:5432/vaultwarden
      - SIGNUPS_ALLOWED=false
      - SIGNUPS_VERIFY=true
      - SIGNUPS_DOMAINS_WHITELIST={{MAIL_DOMAIN}}
      - INVITATIONS_ALLOWED=false
      - SHOW_PASSWORD_HINT=false
      - SSO_ENABLED=true
      - SSO_ONLY=true
      - SSO_AUTHORITY=https://auth.{{DOMAIN}}
      - SSO_CLIENT_ID=vaultwarden
      - SSO_CLIENT_SECRET={{VAULTWARDEN_OAUTH_SECRET}}
      - SSO_SCOPES=openid email profile
      - SSO_CALLBACK_PATH=/identity/connect/oidc-signin
      - SSO_SIGNUPS_MATCH_EMAIL=true
      - ADMIN_TOKEN={{VAULTWARDEN_ADMIN_TOKEN}}
      - SMTP_HOST=mailserver
      - SMTP_FROM=vaultwarden@{{MAIL_DOMAIN}}
      - SMTP_PORT=587
      - SMTP_SECURITY=starttls
      - SMTP_USERNAME=vaultwarden@{{MAIL_DOMAIN}}
      - SMTP_PASSWORD={{VAULTWARDEN_SMTP_PASSWORD}}
    volumes:
      - vaultwarden_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  planka:
    image: ghcr.io/plankanban/planka:{{IMAGE_PLANKA}}}}
    container_name: planka
    restart: unless-stopped
    networks:
      - backend
    depends_on:
      - postgres
      - authelia
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      - BASE_URL=https://planka.{{DOMAIN}}
      - DATABASE_URL=postgresql://planka:{{PLANKA_DB_PASSWORD_ENCODED:-{{PLANKA_DB_PASSWORD}}}}@postgres:5432/planka
      - SECRET_KEY={{PLANKA_SECRET_KEY}}
      - OIDC_ISSUER=https://auth.{{DOMAIN}}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET={{PLANKA_OAUTH_SECRET}}
      - OIDC_SCOPES=openid profile email groups
      - OIDC_ADMIN_ROLES=admins
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - OIDC_REDIRECT_URI=https://planka.{{DOMAIN}}/oidc-callback
      - OIDC_AUTHORIZATION_ENDPOINT=https://auth.{{DOMAIN}}/api/oidc/authorization
      - OIDC_TOKEN_ENDPOINT=http://authelia:9091/api/oidc/token
      - OIDC_USERINFO_ENDPOINT=http://authelia:9091/api/oidc/userinfo
      - OIDC_TOKEN_ENDPOINT_AUTH_METHOD=client_secret_post
      - OIDC_ENFORCED=false
      - NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/caddy-ca.crt
    volumes:
      - planka_data:/app/public/user-avatars
      - {{HOME}}/.datamancy/configs/applications/planka/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:1337/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  bookstack:
    image: lscr.io/linuxserver/bookstack:{{IMAGE_BOOKSTACK}}}}
    container_name: bookstack
    hostname: bookstack
    restart: unless-stopped
    networks:
      - backend
    depends_on:
      - mariadb
    links:
      - mariadb:mariadb
    environment:
      - PUID={{DOCKER_USER_ID:-1000}}
      - PGID={{DOCKER_GROUP_ID:-1000}}
      - TZ=UTC
      - APP_URL=https://bookstack.{{DOMAIN}}
      - APP_KEY={{BOOKSTACK_APP_KEY}}
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_USER=bookstack
      - DB_PASS={{BOOKSTACK_DB_PASSWORD}}
      - DB_DATABASE=bookstack
      - LDAP_ADMIN_PASSWORD={{LDAP_ADMIN_PASSWORD}}
      - BOOKSTACK_OAUTH_SECRET={{BOOKSTACK_OAUTH_SECRET}}
    volumes:
      - bookstack_data:/config
      - {{VOLUMES_ROOT}}/bookstack_init:/custom-cont-init.d:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  homepage:
    image: ghcr.io/gethomepage/homepage:{{IMAGE_HOMEPAGE}}}}
    container_name: homepage
    restart: unless-stopped
    networks:
      - backend
    depends_on:
      - docker-proxy
    environment:
      - PUID={{DOCKER_USER_ID:-1000}}
      - PGID={{DOCKER_GROUP_ID:-1000}}
      - HOMEPAGE_ALLOWED_HOSTS=homepage.{{DOMAIN}}
      - DOCKER_HOST=tcp://docker-proxy:2375
    volumes:
      - {{HOME}}/.datamancy/configs/applications/homepage/services.yaml:/app/config/services.yaml:ro
      - {{HOME}}/.datamancy/configs/applications/homepage/settings.yaml:/app/config/settings.yaml:ro
      - {{HOME}}/.datamancy/configs/applications/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - {{HOME}}/.datamancy/configs/applications/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - {{HOME}}/.datamancy/configs/applications/homepage/docker.yaml:/app/config/docker.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  jupyter-notebook-builder:
    build:
      dockerfile: ./src/jupyter-notebook/Dockerfile.ai-ide
      context: .
      tags:
        - datamancy-jupyter-notebook:{{IMAGE_JUPYTERHUB}}}}
    image: datamancy-jupyter-notebook:{{IMAGE_JUPYTERHUB}}}}
    container_name: jupyter-notebook-builder
    command: ["echo", "AI-powered Jupyter IDE image built successfully"]
    restart: "no"

  jupyterhub:
    build:
      dockerfile: ./src/jupyterhub/Dockerfile
      context: .
    container_name: jupyterhub
    restart: unless-stopped
    networks:
      - backend
    depends_on:
      jupyter-notebook-builder:
        condition: service_completed_successfully
      docker-proxy:
        condition: service_started
      litellm:
        condition: service_started
      authelia:
        condition: service_started
    environment:
      - DOMAIN={{DOMAIN}}
      - JUPYTERHUB_OAUTH_SECRET={{JUPYTERHUB_OAUTH_SECRET}}
      - DOCKER_HOST=tcp://docker-proxy:2375
      - LITELLM_API_KEY={{LITELLM_MASTER_KEY}}
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./src/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/hub/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:{{IMAGE_HOMEASSISTANT}}}}
    container_name: homeassistant
    restart: unless-stopped
    networks:
      - backend
      - database
    depends_on:
      - postgres
      - ldap
    environment:
      - TZ=UTC
      - HOMEASSISTANT_DB_URL=postgresql://{{STACK_ADMIN_USER}}:{{POSTGRES_ROOT_PASSWORD}}@postgres:5432/homeassistant
      - STACK_ADMIN_USER={{STACK_ADMIN_USER}}
      - STACK_ADMIN_PASSWORD={{STACK_ADMIN_PASSWORD}}
      - STACK_ADMIN_EMAIL={{STACK_ADMIN_EMAIL}}
      - LDAP_HOST=ldap
      - LDAP_PORT=389
      - LDAP_BASE_DN=dc=stack,dc=local
      - LDAP_BIND_DN=cn=admin,dc=stack,dc=local
      - LDAP_BIND_PASSWORD={{LDAP_ADMIN_PASSWORD}}
      - LDAP_USER_FILTER=(uid={username}})
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
      - {{HOME}}/.datamancy/configs/applications/homeassistant/configuration.yaml:/config/configuration.yaml:ro
      - {{HOME}}/.datamancy/configs/applications/homeassistant/automations.yaml:/config/automations.yaml:rw
      - {{HOME}}/.datamancy/configs/applications/homeassistant/scripts.yaml:/config/scripts.yaml:rw
      - {{HOME}}/.datamancy/configs/applications/homeassistant/scenes.yaml:/config/scenes.yaml:rw
      - {{HOME}}/.datamancy/configs/applications/homeassistant/init-homeassistant.sh:/init-homeassistant.sh:ro
      - {{HOME}}/.datamancy/configs/applications/homeassistant/entrypoint.sh:/entrypoint-wrapper.sh:ro
      - {{HOME}}/.datamancy/configs/applications/homeassistant/auth_ldap.py:/usr/src/homeassistant/homeassistant/auth/providers/auth_ldap.py:ro
    entrypoint: ["/entrypoint-wrapper.sh"]
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  forgejo:
    image: codeberg.org/forgejo/forgejo:{{IMAGE_FORGEJO}}}}
    container_name: forgejo
    restart: unless-stopped
    networks:
      - backend
      - database
    depends_on:
      - postgres
    environment:
      - USER_UID={{DOCKER_USER_ID:-1000}}
      - USER_GID={{DOCKER_GROUP_ID:-1000}}
      - FORGEJO__database__DB_TYPE=postgres
      - FORGEJO__database__HOST=postgres:5432
      - FORGEJO__database__NAME=forgejo
      - FORGEJO__database__USER=forgejo
      - FORGEJO__database__PASSWD={{FORGEJO_DB_PASSWORD}}
      - FORGEJO__server__DOMAIN=forgejo.{{DOMAIN}}
      - FORGEJO__server__SSH_DOMAIN=forgejo.{{DOMAIN}}
      - FORGEJO__server__ROOT_URL=https://forgejo.{{DOMAIN}}/
      - FORGEJO__security__INSTALL_LOCK=true
      - FORGEJO__service__DISABLE_REGISTRATION=true
      - FORGEJO__service__ALLOW_ONLY_EXTERNAL_REGISTRATION=true
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=true
      - FORGEJO__oauth2_client__ENABLE_AUTO_REGISTRATION=true
      - FORGEJO__openid__ENABLE_OPENID_SIGNIN=true
      - FORGEJO__openid__ENABLE_OPENID_SIGNUP=true
      - FORGEJO_OAUTH_SECRET={{FORGEJO_OAUTH_SECRET}}
      - DOMAIN={{DOMAIN}}
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  forgejo-init:
    image: codeberg.org/forgejo/forgejo:{{IMAGE_FORGEJO}}}}
    container_name: forgejo-init
    restart: "no"
    user: "{{DOCKER_USER_ID:-1000}}:{{DOCKER_GROUP_ID:-1000}}"
    networks:
      - backend
    depends_on:
      forgejo:
        condition: service_healthy
    environment:
      - FORGEJO_OAUTH_SECRET={{FORGEJO_OAUTH_SECRET}}
      - DOMAIN={{DOMAIN}}
    volumes:
      - forgejo_data:/data
      - {{HOME}}/.datamancy/configs/applications/forgejo/init-forgejo.sh:/init-forgejo.sh:ro
    command: ["bash", "/init-forgejo.sh"]

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:{{IMAGE_QBITTORRENT}}}}
    container_name: qbittorrent
    restart: unless-stopped
    networks:
      - backend
    environment:
      - PUID={{DOCKER_USER_ID:-1000}}
      - PGID={{DOCKER_GROUP_ID:-1000}}
      - TZ=UTC
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent_config:/config
      - qbittorrent_data:/downloads
      - {{VOLUMES_ROOT}}/qbittorrent_init:/custom-cont-init.d:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
