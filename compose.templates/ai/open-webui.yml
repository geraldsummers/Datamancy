# Auto-generated by build-datamancy.main.kts
# Image versions are HARDCODED at build time
# Only secrets and deployment paths use runtime ${VARS}

services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:0.4.6
    container_name: open-webui
    restart: unless-stopped
    networks:
      caddy:
        aliases:
          - open-webui.${DOMAIN}
      postgres:
        aliases:
          - open-webui.${DOMAIN}
      litellm:
        aliases:
          - open-webui.${DOMAIN}
      authelia:
        aliases:
          - open-webui.${DOMAIN}
    depends_on:
      postgres:
        condition: service_healthy
      litellm:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      WEBUI_URL: ${OPENWEBUI_WEBUI_URL:-https://open-webui.${DOMAIN}}
      DATABASE_URL: postgresql://openwebui:${OPENWEBUI_DB_PASSWORD}@postgres:5432/openwebui
      ENABLE_OAUTH_SIGNUP: ${OPENWEBUI_ENABLE_OAUTH_SIGNUP:-true}
      DEFAULT_USER_ROLE: ${OPENWEBUI_DEFAULT_USER_ROLE:-admin}
      ENABLE_OPENAI_API: true
      OPENAI_API_BASE_URL: ${OPENWEBUI_OPENAI_API_BASE_URL:-http://litellm:4000/v1}
      OPENAI_API_KEY: ${LITELLM_MASTER_KEY}
      DEFAULT_MODELS: qwen2.5-7b-instruct
      # Smooth streaming for better UX
      STREAMING_CHUNK_SIZE: 1
      # Disable auto-downloading models from HuggingFace
      ENABLE_RAG_WEB_LOADER_SSL_VERIFICATION: false
      RAG_EMBEDDING_ENGINE: ollama
      RAG_RERANKING_MODEL: ""
      OPENID_PROVIDER_URL: https://auth.${DOMAIN}
      OAUTH_CLIENT_ID: open-webui
      OAUTH_CLIENT_SECRET: ${OPENWEBUI_OAUTH_SECRET}
      OAUTH_PROVIDER_NAME: Authelia
      OAUTH_SCOPES: openid profile email groups
      ENABLE_LOGIN_FORM: false
      WEBUI_AUTH: false
    volumes:
      - open_webui_data:/app/backend/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 90s
