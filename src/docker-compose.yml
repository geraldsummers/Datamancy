
## DON'T HARDCODE IPS!!
## System should be URL agnostic
## OIDC is currently working in grafana, jupyterhub, librechat, planka, check them for examples
## Using network aliases to manage OIDC/docker/dns nuance
## ALL configuration must be baked into this compose or supporting files.
networks:
  app_net:
    name: app_net

services:
  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      # Allow caddy-docker-proxy (read-only) and JupyterHub (read-write)
      - CONTAINERS=1
      - NETWORKS=1
      - EVENTS=1
      - INFO=1
      - IMAGES=1
      - POST=1
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=1
      - GRPC=0
      - NODES=0
      - PLUGINS=0
      - SECRETS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=1
    volumes:
      # rootless socket path
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    networks: [app_net]

  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    user: "0:0"
    ports: ["80:80", "443:443"]
    environment:
      - CADDY_INGRESS_NETWORKS=app_net
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    # ðŸ”’ No direct /var/run/docker.sock mount here
    networks:
      app_net:
        aliases:
          - id.lab.localhost
          - tasks.lab.localhost
          - grafana.lab.localhost
          - nextcloud.lab.localhost
          - jupyter.lab.localhost
          - chat.lab.localhost

  caddy-config:
    image: traefik/whoami:latest
    container_name: caddy-config
    restart: unless-stopped
    labels:
      caddy: (auth)
      caddy.forward_auth: authentik-server:9000
      caddy.forward_auth.uri: /outpost.goauthentik.io/auth/caddy
      caddy.forward_auth.copy_headers: X-authentik-username X-authentik-groups X-authentik-email X-authentik-name X-authentik-uid
    networks: [app_net]

  topology-api:
    build: ./topology-api
    container_name: topology-api
    restart: unless-stopped
    expose: ["3100"]
    environment:
      - DOCKER_HOST=http://docker-socket-proxy:2375
      - PORT=3100
    depends_on:
      - docker-socket-proxy
    labels:
      caddy: topology-api.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3100}}"
      caddy.reverse_proxy.header_up: "Connection {http.request.header.Connection}"
      caddy.reverse_proxy.header_up_1: "Upgrade {http.request.header.Upgrade}"
      caddy.import: auth
    networks: [app_net]

  landing:
    image: nginx:alpine
    container_name: landing
    restart: unless-stopped
    expose: ["80"]
    volumes:
      - ./landing:/usr/share/nginx/html:ro
    labels:
      caddy: ${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    expose: ["9090"]
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    labels:
      caddy: prometheus.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9090}}"
      caddy.import: auth
    networks: [app_net]

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    expose: ["9093"]
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    labels:
      caddy: alertmanager.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9093}}"
      caddy.import: auth
    networks: [app_net]

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    expose: ["3100"]
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    labels:
      caddy: loki.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3100}}"
      caddy.import: auth
    networks: [app_net]

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
    networks: [app_net]

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    restart: unless-stopped
    expose: ["9115"]
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    networks: [app_net]

  prometheus-script-exporter:
    image: ghcr.io/ricoberger/script_exporter:latest
    container_name: prometheus-script-exporter
    restart: unless-stopped
    expose: ["9469"]
    volumes:
      - ./script-exporter/config.yml:/config.yaml:ro
      - ./script-exporter/scripts:/scripts:ro
    networks: [app_net]

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    expose: ["3000"]
    environment:
      # Disabled to avoid conflict with OAuth users
      # - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}  # TODO: abstract
      # - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}  # TODO: abstract
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_SERVER_ROOT_URL=https://grafana.${BASE_DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authentik
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${OIDC_GRAFANA_CLIENT_SECRET}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://id.${BASE_DOMAIN}/application/o/authorize/
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authentik-server:9000/application/o/token/
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authentik-server:9000/application/o/userinfo/
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://id.${BASE_DOMAIN}/application/o/grafana/end-session/
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_GENERIC_OAUTH_USE_REFRESH_TOKEN=true
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_USERNAME_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_GENERIC_OAUTH_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_LOG_LEVEL=debug
      - GF_LOG_FILTERS=oauth.generic_oauth:debug,user.sync:debug,sqlstore:debug,login:debug
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    labels:
      caddy: grafana.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    networks: [app_net]

  mariadb:
    image: mariadb:latest
    container_name: mariadb
    restart: unless-stopped
    expose: ["3306"]
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass123  # TODO: abstract (plaintext: rootpass123)
      - MYSQL_DATABASE=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_USER=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
    volumes:
      - mariadb_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    networks: [app_net]

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    expose: ["8123", "9000"]
    environment:
      - CLICKHOUSE_DB=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_USER=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_PASSWORD=clickhousepass123  # TODO: abstract (plaintext: clickhousepass123)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks: [app_net]

  localai:
    image: quay.io/go-skynet/local-ai:latest
    container_name: localai
    restart: unless-stopped
    expose: ["8080"]
    environment:
      - THREADS=4  # TODO: abstract (CPU cores)
      - CONTEXT_SIZE=2048  # TODO: abstract
      - MODELS_PATH=/models
    volumes:
      - localai_models:/models
      - localai_data:/tmp/localai
    labels:
      caddy: ai.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.import: auth
    networks: [app_net]

  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    expose: ["3080"]
    environment:
      - HOST=0.0.0.0
      - MONGO_URI=mongodb://librechat-mongo:27017/LibreChat
      - OPENAI_API_KEY=not_needed
      - ENDPOINTS=openAI
      - OPENAI_REVERSE_PROXY=http://localai:8080/v1
      - DOMAIN_SERVER=https://chat.${BASE_DOMAIN}
      - DOMAIN_CLIENT=https://chat.${BASE_DOMAIN}
      # OIDC Authentication via Authentik
      - ALLOW_EMAIL_LOGIN=false
      - ALLOW_REGISTRATION=false
      - ALLOW_SOCIAL_LOGIN=true
      - ALLOW_SOCIAL_REGISTRATION=true
      - OPENID_ISSUER=https://id.${BASE_DOMAIN}/application/o/librechat
      - OPENID_CLIENT_ID=librechat
      - OPENID_CLIENT_SECRET=${OIDC_LIBRECHAT_CLIENT_SECRET}
      - OPENID_CALLBACK_URL=/oauth/openid/callback
      - OPENID_SCOPE=openid profile email groups
      - OPENID_LOGOUT_URL=https://id.${BASE_DOMAIN}/application/o/librechat/end-session/
      - OPENID_SESSION_SECRET=librechat_oidc_session_secret_changeme
      - OPENID_BUTTON_LABEL=Login with Authentik
      - OPENID_REQUIRED_ROLE=
      - OPENID_REQUIRED_ROLE_TOKEN_KIND=
      - OPENID_REQUIRED_ROLE_PARAMETER_PATH=
      - NODE_EXTRA_CA_CERTS=/app/caddy-root-ca.crt
      - JWT_SECRET=librechat_jwt_secret_changeme123
      - JWT_REFRESH_SECRET=librechat_jwt_refresh_secret_changeme789
      - CREDS_KEY=librechat_creds_key_changeme456
      - CREDS_IV=librechat_creds_iv_changeme78
    depends_on:
      - librechat-mongo
      - localai
    volumes:
      - librechat_data:/app/client/public/images
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./caddy-root-ca.crt:/app/caddy-root-ca.crt:ro
    labels:
      caddy: chat.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3080}}"
      # Remove forward auth - LibreChat handles its own auth via OIDC
    networks: [app_net]

  librechat-mongo:
    image: mongo:latest
    container_name: librechat-mongo
    restart: unless-stopped
    volumes:
      - librechat_mongo_data:/data/db
    networks: [app_net]

  benthos:
    image: jeffail/benthos:latest
    container_name: benthos
    restart: unless-stopped
    expose: ["4195"]
    volumes:
      - ./benthos/config.yaml:/benthos.yaml:ro
      - ./benthos/pipelines:/pipelines:ro
    command: -c /benthos.yaml
    labels:
      caddy: benthos.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 4195}}"
      caddy.import: auth
    networks: [app_net]

  browserless:
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - MAX_CONCURRENT_SESSIONS=3  # TODO: abstract
      - CONNECTION_TIMEOUT=60000  # TODO: abstract
      - TOKEN=  # Disabled - using Authentik for auth
    labels:
      caddy: browser.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
      caddy.import: auth
    networks: [app_net]

  nextcloud:
    build: ./nextcloud
    container_name: nextcloud
    restart: unless-stopped
    expose: ["80"]
    environment:
      - MYSQL_HOST=mariadb
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
      - NEXTCLOUD_ADMIN_USER=admin  # TODO: abstract (plaintext: admin)
      - NEXTCLOUD_ADMIN_PASSWORD=adminpass123  # TODO: abstract (plaintext: adminpass123)
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${BASE_DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.${BASE_DOMAIN}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_NEXTCLOUD_CLIENT_SECRET=${OIDC_NEXTCLOUD_CLIENT_SECRET}
    depends_on:
      - mariadb
    volumes:
      - nextcloud_data:/var/www/html
      - ./nextcloud/hooks:/docker-entrypoint-hooks.d/post-installation:ro
    labels:
      caddy: nextcloud.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    networks: [app_net]

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    expose: ["80"]
    environment:
      - SIGNUPS_ALLOWED=false
      - ADMIN_TOKEN=vaultwardentokenadmin123  # TODO: abstract (plaintext: vaultwardentokenadmin123)
      - DOMAIN=https://vault.${BASE_DOMAIN}
    volumes:
      - vaultwarden_data:/data
    labels:
      caddy: vault.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]

  jupyterhub:
    build: ./jupyterhub
    container_name: jupyterhub
    restart: unless-stopped
    expose: ["8000"]
    environment:
      - DOCKER_NETWORK_NAME=app_net
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_JUPYTERHUB_CLIENT_SECRET=${OIDC_JUPYTERHUB_CLIENT_SECRET}
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    labels:
      caddy: jupyter.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8000}}"
    networks: [app_net]

  planka-db:
    image: postgres:16-alpine
    container_name: planka-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_USER=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_PASSWORD=plankapass123  # TODO: abstract (plaintext: plankapass123)
    volumes:
      - planka_db_data:/var/lib/postgresql/data
    networks: [app_net]

  planka:
    image: ghcr.io/plankanban/planka:latest
    container_name: planka
    restart: unless-stopped
    expose: ["1337"]
    environment:
      - BASE_URL=https://tasks.${BASE_DOMAIN}
      - DATABASE_URL=postgresql://planka:plankapass123@planka-db/planka  # TODO: abstract (plaintext: planka:plankapass123)
      - SECRET_KEY=plankaSecretKeyChangeMe123456  # TODO: abstract (plaintext: plankaSecretKeyChangeMe123456)
      - TRUST_PROXY=true
      - OIDC_ISSUER=https://id.${BASE_DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=${OIDC_PLANKA_CLIENT_SECRET}
      - OIDC_SCOPES=openid email profile groups
      - OIDC_ADMIN_ROLES=admins
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - OIDC_ROLES_ATTRIBUTE=groups
      - NODE_EXTRA_CA_CERTS=/app/caddy-root-ca.crt
    depends_on:
      - planka-db
    volumes:
      - planka_data:/app/public/user-avatars
      - planka_attachments:/app/private/attachments
      - ./caddy-root-ca.crt:/app/caddy-root-ca.crt:ro
    labels:
      caddy: tasks.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 1337}}"
      caddy.reverse_proxy.transport: http
      caddy.reverse_proxy.transport.versions: 1.1
    networks: [app_net]

  jellyfin:
    build: ./jellyfin
    container_name: jellyfin
    restart: unless-stopped
    expose: ["8096"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_JELLYFIN_CLIENT_SECRET=${OIDC_JELLYFIN_CLIENT_SECRET}
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${BASE_DOMAIN}
    volumes:
      - jellyfin_config:/config
    labels:
      caddy: jellyfin.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8096}}"
    networks: [app_net]

  homeassistant:
    build: ./homeassistant
    container_name: homeassistant
    restart: unless-stopped
    expose: ["8123"]
    environment:
      - TZ=${TZ}
    volumes:
      - homeassistant_config:/config
    labels:
      caddy: homeassistant.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8123}}"
      caddy.reverse_proxy.header_up: "Connection {http.request.header.Connection}"
      caddy.reverse_proxy.header_up_1: "Upgrade {http.request.header.Upgrade}"
      caddy.import: auth
    networks: [app_net]

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    expose: ["8080"]
    environment:
      - WATCHTOWER_HTTP_API_TOKEN=watchtower_api_token_change_me  # TODO: abstract
      - WATCHTOWER_HTTP_API_METRICS=true
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - TZ=${TZ}
    volumes:
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    labels:
      caddy: watchtower.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.import: auth
    networks: [app_net]

  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    restart: unless-stopped
    expose: ["8200"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - duplicati_config:/config
      - duplicati_backups:/backups
      - duplicati_source:/source:ro
    labels:
      caddy: duplicati.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8200}}"
      caddy.import: auth
    networks: [app_net]

  dockge:
    image: louislam/dockge:latest
    container_name: dockge
    restart: unless-stopped
    expose: ["5001"]
    environment:
      - TZ=${TZ}
      - DOCKGE_STACKS_DIR=/stacks
    volumes:
      - dockge_data:/app/data
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
      - ./dockge/stacks:/stacks
    labels:
      caddy: dockge.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 5001}}"
      caddy.import: auth
    networks: [app_net]

  authentik-postgres:
    image: postgres:16-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=authentik
      - POSTGRES_USER=authentik
      - POSTGRES_PASSWORD=authentik_db_pass_change_me  # TODO: abstract
    volumes:
      - authentik_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 5s
    networks: [app_net]

  authentik-redis:
    image: redis:7-alpine
    container_name: authentik-redis
    restart: unless-stopped
    command: --save 60 1 --loglevel warning
    volumes:
      - authentik_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      start_period: 20s
      interval: 30s
      retries: 5
      timeout: 3s
    networks: [app_net]

  authentik-server:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-server
    restart: unless-stopped
    expose: ["9000", "9443"]
    command: server
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=authentik_db_pass_change_me
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_LOG_LEVEL=info
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD:-admin}
      - AUTHENTIK_BOOTSTRAP_TOKEN=${AUTHENTIK_BOOTSTRAP_TOKEN:-bootstrap-token-changeme}
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates
      - ./authentik/blueprints:/blueprints/custom:ro
    depends_on:
      - authentik-postgres
      - authentik-redis
    labels:
      caddy: id.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9000}}"
    networks: [app_net]

  authentik-worker:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__NAME=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=authentik_db_pass_change_me
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_LOG_LEVEL=info
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates
      - ./authentik/blueprints:/blueprints/custom:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - authentik-postgres
      - authentik-redis
    networks: [app_net]

  outline-postgres:
    image: postgres:16-alpine
    container_name: outline-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=outline  # TODO: abstract
      - POSTGRES_USER=outline  # TODO: abstract
      - POSTGRES_PASSWORD=outline_db_pass_change_me  # TODO: abstract
    volumes:
      - outline_postgres_data:/var/lib/postgresql/data
    networks: [app_net]

  outline-redis:
    image: redis:7-alpine
    container_name: outline-redis
    restart: unless-stopped
    volumes:
      - outline_redis_data:/data
    networks: [app_net]

  outline:
    image: outlinewiki/outline:latest
    container_name: outline
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - NODE_ENV=production
      - SECRET_KEY=outline_secret_key_change_me_min_32_chars  # TODO: abstract
      - UTILS_SECRET=outline_utils_secret_change_me_min_32  # TODO: abstract
      - DATABASE_URL=postgres://outline:outline_db_pass_change_me@outline-postgres:5432/outline  # TODO: abstract
      - PGSSLMODE=disable
      - REDIS_URL=redis://outline-redis:6379
      - URL=https://outline.${BASE_DOMAIN}
      - PORT=3000
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
      - FILE_STORAGE_UPLOAD_MAX_SIZE=26214400
      # OIDC Configuration
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=${OIDC_OUTLINE_CLIENT_SECRET}
      - OIDC_AUTH_URI=https://id.${BASE_DOMAIN}/application/o/authorize/
      - OIDC_TOKEN_URI=http://authentik-server:9000/application/o/token/
      - OIDC_USERINFO_URI=http://authentik-server:9000/application/o/userinfo/
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Authentik
      - OIDC_SCOPES=openid profile email
    depends_on:
      - outline-postgres
      - outline-redis
    volumes:
      - outline_data:/var/lib/outline/data
    labels:
      caddy: outline.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    networks: [app_net]



volumes:
  caddy_data:
  caddy_config:
  authentik_postgres_data:
  authentik_redis_data:
  authentik_media:
  authentik_templates:
  prometheus_data:
  alertmanager_data:
  loki_data:
  grafana_data:
  mariadb_data:
  clickhouse_data:
  localai_models:
  localai_data:
  librechat_data:
  librechat_mongo_data:
  nextcloud_data:
  vaultwarden_data:
  jupyterhub_data:
  planka_db_data:
  planka_data:
  planka_attachments:
  jellyfin_config:
  homeassistant_config:
  duplicati_config:
  duplicati_backups:
  duplicati_source:
  dockge_data:
  outline_postgres_data:
  outline_redis_data:
  outline_data:


