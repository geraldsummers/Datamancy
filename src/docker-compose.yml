
## DON'T HARDCODE IPS!!
## System should be URL agnostic
## OIDC is currently working in grafana, jupyterhub, librechat, planka, check them for examples
## Using network aliases to manage OIDC/docker/dns nuance
## ALL configuration must be baked into this compose or supporting files.

# Common DNS configuration for all services
x-dns: &dns-config
  dns:
    - 172.18.0.53  # CoreDNS
    - 8.8.8.8      # Fallback
networks:
  app_net:
    name: app_net
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1

services:
  coredns:
    image: coredns/coredns:latest
    container_name: coredns
    restart: unless-stopped
    expose: ["53/udp", "53/tcp"]
    volumes:
      - ./coredns/Corefile:/Corefile:ro
    command: -conf /Corefile
    networks:
      app_net:
        ipv4_address: 172.18.0.53

  docker-socket-proxy:
    <<: *dns-config
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      # Allow caddy-docker-proxy (read-only) and JupyterHub (read-write)
      - CONTAINERS=1
      - NETWORKS=1
      - EVENTS=1
      - INFO=1
      - IMAGES=1
      - POST=1
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=1
      - GRPC=0
      - NODES=0
      - PLUGINS=0
      - SECRETS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=1
    volumes:
      # rootless socket path
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    networks: [app_net]

  traefik:
    <<: *dns-config
    image: traefik:v3.3
    container_name: traefik
    restart: unless-stopped
    ports: ["80:80", "443:443"]
    environment:
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - traefik_certs:/letsencrypt
    networks:
      app_net:
        ipv4_address: 172.18.0.2
    labels:
      # Traefik dashboard protected by ForwardAuth
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${BASE_DOMAIN}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls=true"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=auth-forward@docker"

  topology-api:
    <<: *dns-config
    build: ./topology-api
    container_name: topology-api
    restart: unless-stopped
    expose: ["3100"]
    environment:
      - DOCKER_HOST=http://docker-socket-proxy:2375
      - PORT=3100
    depends_on:
      - docker-socket-proxy
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.topology-api.rule=Host(`topology-api.${BASE_DOMAIN}`)"
      - "traefik.http.routers.topology-api.entrypoints=websecure"
      - "traefik.http.routers.topology-api.tls=true"
      - "traefik.http.routers.topology-api.middlewares=auth-forward@docker"
      - "traefik.http.services.topology-api.loadbalancer.server.port=3100"
    networks: [app_net]

  landing:
    <<: *dns-config
    image: nginx:alpine
    container_name: landing
    restart: unless-stopped
    expose: ["80"]
    volumes:
      - ./landing:/usr/share/nginx/html:ro
    labels:
      # Public landing page (no auth)
      - "traefik.enable=true"
      - "traefik.http.routers.landing.rule=Host(`${BASE_DOMAIN}`)"
      - "traefik.http.routers.landing.entrypoints=websecure"
      - "traefik.http.routers.landing.tls=true"
      - "traefik.http.services.landing.loadbalancer.server.port=80"
    networks: [app_net]

  prometheus:
    <<: *dns-config
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    expose: ["9090"]
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    labels:
      # ForwardAuth-protected (admin only)
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${BASE_DOMAIN}`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls=true"
      - "traefik.http.routers.prometheus.middlewares=auth-admin@docker"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
    networks: [app_net]

  alertmanager:
    <<: *dns-config
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    expose: ["9093"]
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    labels:
      # ForwardAuth-protected (admin only)
      - "traefik.enable=true"
      - "traefik.http.routers.alertmanager.rule=Host(`alertmanager.${BASE_DOMAIN}`)"
      - "traefik.http.routers.alertmanager.entrypoints=websecure"
      - "traefik.http.routers.alertmanager.tls=true"
      - "traefik.http.routers.alertmanager.middlewares=auth-admin@docker"
      - "traefik.http.services.alertmanager.loadbalancer.server.port=9093"
    networks: [app_net]

  loki:
    <<: *dns-config
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    expose: ["3100"]
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    labels:
      # ForwardAuth-protected (admin only)
      - "traefik.enable=true"
      - "traefik.http.routers.loki.rule=Host(`loki.${BASE_DOMAIN}`)"
      - "traefik.http.routers.loki.entrypoints=websecure"
      - "traefik.http.routers.loki.tls=true"
      - "traefik.http.routers.loki.middlewares=auth-admin@docker"
      - "traefik.http.services.loki.loadbalancer.server.port=3100"
    networks: [app_net]

  promtail:
    <<: *dns-config
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
    networks: [app_net]

  blackbox-exporter:
    <<: *dns-config
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    restart: unless-stopped
    expose: ["9115"]
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    networks: [app_net]

  prometheus-script-exporter:
    <<: *dns-config
    image: ghcr.io/ricoberger/script_exporter:latest
    container_name: prometheus-script-exporter
    restart: unless-stopped
    expose: ["9469"]
    volumes:
      - ./script-exporter/config.yml:/config.yaml:ro
      - ./script-exporter/scripts:/scripts:ro
    networks: [app_net]

  grafana:
    <<: *dns-config
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    expose: ["3000"]
    environment:
      # Disabled to avoid conflict with OAuth users
      # - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}  # TODO: abstract
      # - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}  # TODO: abstract
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_SERVER_ROOT_URL=https://grafana.${BASE_DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Dex
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=grafana_secret_change_me
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://dex.${BASE_DOMAIN}/auth
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://dex.${BASE_DOMAIN}/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://dex.${BASE_DOMAIN}/userinfo
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://dex.${BASE_DOMAIN}/
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=false
      - GF_AUTH_GENERIC_OAUTH_USE_REFRESH_TOKEN=true
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_USERNAME_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_GENERIC_OAUTH_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_LOG_LEVEL=debug
      - GF_LOG_FILTERS=oauth.generic_oauth:debug,user.sync:debug,sqlstore:debug,login:debug
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    labels:
      # OIDC-native: no ForwardAuth needed
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${BASE_DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    networks: [app_net]

  mariadb:
    <<: *dns-config
    image: mariadb:latest
    container_name: mariadb
    restart: unless-stopped
    expose: ["3306"]
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass123  # TODO: abstract (plaintext: rootpass123)
      - MYSQL_DATABASE=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_USER=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
    volumes:
      - mariadb_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    networks: [app_net]

  clickhouse:
    <<: *dns-config
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    expose: ["8123", "9000"]
    environment:
      - CLICKHOUSE_DB=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_USER=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_PASSWORD=clickhousepass123  # TODO: abstract (plaintext: clickhousepass123)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks: [app_net]

  localai:
    <<: *dns-config
    image: quay.io/go-skynet/local-ai:latest
    container_name: localai
    restart: unless-stopped
    expose: ["8080"]
    environment:
      - THREADS=4  # TODO: abstract (CPU cores)
      - CONTEXT_SIZE=2048  # TODO: abstract
      - MODELS_PATH=/models
    volumes:
      - localai_models:/models
      - localai_data:/tmp/localai
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.localai.rule=Host(`ai.${BASE_DOMAIN}`)"
      - "traefik.http.routers.localai.entrypoints=websecure"
      - "traefik.http.routers.localai.tls=true"
      - "traefik.http.routers.localai.middlewares=auth-forward@docker"
      - "traefik.http.services.localai.loadbalancer.server.port=8080"
    networks: [app_net]

  librechat:
    <<: *dns-config
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    expose: ["3080"]
    environment:
      - HOST=0.0.0.0
      - MONGO_URI=mongodb://librechat-mongo:27017/LibreChat
      - OPENAI_API_KEY=not_needed
      - ENDPOINTS=openAI
      - OPENAI_REVERSE_PROXY=http://localai:8080/v1
      - DOMAIN_SERVER=https://chat.${BASE_DOMAIN}
      - DOMAIN_CLIENT=https://chat.${BASE_DOMAIN}
      # OIDC Authentication via Dex
      - ALLOW_EMAIL_LOGIN=false
      - ALLOW_REGISTRATION=false
      - ALLOW_SOCIAL_LOGIN=true
      - ALLOW_SOCIAL_REGISTRATION=false
      - OPENID_ISSUER=https://dex.${BASE_DOMAIN}
      - OPENID_CLIENT_ID=librechat
      - OPENID_CLIENT_SECRET=librechat_secret_change_me
      - OPENID_CALLBACK_URL=/oauth/openid/callback
      - OPENID_SCOPE=openid profile email groups
      - OPENID_LOGOUT_URL=https://dex.${BASE_DOMAIN}/
      - OPENID_SESSION_SECRET=librechat_oidc_session_secret_changeme
      - OPENID_BUTTON_LABEL=Login with Dex
      - OPENID_REQUIRED_ROLE=
      - OPENID_REQUIRED_ROLE_TOKEN_KIND=
      - OPENID_REQUIRED_ROLE_PARAMETER_PATH=
      - JWT_SECRET=librechat_jwt_secret_changeme123
      - JWT_REFRESH_SECRET=librechat_jwt_refresh_secret_changeme789
      - CREDS_KEY=librechat_creds_key_changeme456
      - CREDS_IV=librechat_creds_iv_changeme78
    depends_on:
      - librechat-mongo
      - localai
    volumes:
      - librechat_data:/app/client/public/images
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
    labels:
      # OIDC-native: no ForwardAuth needed
      - "traefik.enable=true"
      - "traefik.http.routers.librechat.rule=Host(`chat.${BASE_DOMAIN}`)"
      - "traefik.http.routers.librechat.entrypoints=websecure"
      - "traefik.http.routers.librechat.tls=true"
      - "traefik.http.services.librechat.loadbalancer.server.port=3080"
    networks: [app_net]

  librechat-mongo:
    <<: *dns-config
    image: mongo:latest
    container_name: librechat-mongo
    restart: unless-stopped
    volumes:
      - librechat_mongo_data:/data/db
    networks: [app_net]

  benthos:
    <<: *dns-config
    image: jeffail/benthos:latest
    container_name: benthos
    restart: unless-stopped
    expose: ["4195"]
    volumes:
      - ./benthos/config.yaml:/benthos.yaml:ro
      - ./benthos/pipelines:/pipelines:ro
    command: -c /benthos.yaml
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.benthos.rule=Host(`benthos.${BASE_DOMAIN}`)"
      - "traefik.http.routers.benthos.entrypoints=websecure"
      - "traefik.http.routers.benthos.tls=true"
      - "traefik.http.routers.benthos.middlewares=auth-forward@docker"
      - "traefik.http.services.benthos.loadbalancer.server.port=4195"
    networks: [app_net]

  browserless:
    <<: *dns-config
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - MAX_CONCURRENT_SESSIONS=3  # TODO: abstract
      - CONNECTION_TIMEOUT=60000  # TODO: abstract
      - TOKEN=  # Disabled - no auth needed for internal use
      - CHROME_ARGS=--ignore-certificate-errors
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.browserless.rule=Host(`browser.${BASE_DOMAIN}`)"
      - "traefik.http.routers.browserless.entrypoints=websecure"
      - "traefik.http.routers.browserless.tls=true"
      - "traefik.http.routers.browserless.middlewares=auth-forward@docker"
      - "traefik.http.services.browserless.loadbalancer.server.port=3000"
    networks: [app_net]

  nextcloud:
    <<: *dns-config
    build: ./nextcloud
    container_name: nextcloud
    restart: unless-stopped
    expose: ["80"]
    environment:
      - MYSQL_HOST=mariadb
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
      - NEXTCLOUD_ADMIN_USER=admin  # TODO: abstract (plaintext: admin)
      - NEXTCLOUD_ADMIN_PASSWORD=adminpass123  # TODO: abstract (plaintext: adminpass123)
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${BASE_DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.${BASE_DOMAIN}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_NEXTCLOUD_CLIENT_SECRET=${OIDC_NEXTCLOUD_CLIENT_SECRET}
    depends_on:
      - mariadb
    volumes:
      - nextcloud_data:/var/www/html
      - ./nextcloud/hooks:/docker-entrypoint-hooks.d/post-installation:ro
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.${BASE_DOMAIN}`)"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.routers.nextcloud.middlewares=auth-forward@docker"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
    networks: [app_net]

  vaultwarden:
    <<: *dns-config
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    expose: ["80"]
    environment:
      - SIGNUPS_ALLOWED=false
      - ADMIN_TOKEN=vaultwardentokenadmin123  # TODO: abstract (plaintext: vaultwardentokenadmin123)
      - DOMAIN=https://vault.${BASE_DOMAIN}
    volumes:
      - vaultwarden_data:/data
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`vault.${BASE_DOMAIN}`)"
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls=true"
      - "traefik.http.routers.vaultwarden.middlewares=auth-forward@docker"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
    networks: [app_net]

  jupyterhub:
    <<: *dns-config
    build: ./jupyterhub
    container_name: jupyterhub
    restart: unless-stopped
    expose: ["8000"]
    environment:
      - DOCKER_NETWORK_NAME=app_net
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_JUPYTERHUB_CLIENT_SECRET=${OIDC_JUPYTERHUB_CLIENT_SECRET}
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    labels:
      # OIDC-native: no ForwardAuth needed
      - "traefik.enable=true"
      - "traefik.http.routers.jupyterhub.rule=Host(`jupyter.${BASE_DOMAIN}`)"
      - "traefik.http.routers.jupyterhub.entrypoints=websecure"
      - "traefik.http.routers.jupyterhub.tls=true"
      - "traefik.http.services.jupyterhub.loadbalancer.server.port=8000"
    networks: [app_net]

  planka-db:
    <<: *dns-config
    image: postgres:16-alpine
    container_name: planka-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_USER=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_PASSWORD=plankapass123  # TODO: abstract (plaintext: plankapass123)
    volumes:
      - planka_db_data:/var/lib/postgresql/data
    networks: [app_net]

  planka:
    <<: *dns-config
    image: ghcr.io/plankanban/planka:latest
    container_name: planka
    restart: unless-stopped
    expose: ["1337"]
    environment:
      - BASE_URL=https://tasks.${BASE_DOMAIN}
      - DATABASE_URL=postgresql://planka:plankapass123@planka-db/planka  # TODO: abstract (plaintext: planka:plankapass123)
      - SECRET_KEY=plankaSecretKeyChangeMe123456  # TODO: abstract (plaintext: plankaSecretKeyChangeMe123456)
      - TRUST_PROXY=true
      - OIDC_ISSUER=https://dex.${BASE_DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=planka_secret_change_me
      - OIDC_SCOPES=openid email profile groups
      - OIDC_ADMIN_ROLES=admins
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - OIDC_ROLES_ATTRIBUTE=groups
    depends_on:
      - planka-db
    volumes:
      - planka_data:/app/public/user-avatars
      - planka_attachments:/app/private/attachments
    labels:
      # OIDC-native: no ForwardAuth needed
      - "traefik.enable=true"
      - "traefik.http.routers.planka.rule=Host(`tasks.${BASE_DOMAIN}`)"
      - "traefik.http.routers.planka.entrypoints=websecure"
      - "traefik.http.routers.planka.tls=true"
      - "traefik.http.services.planka.loadbalancer.server.port=1337"
    networks: [app_net]

  jellyfin:
    <<: *dns-config
    build: ./jellyfin
    container_name: jellyfin
    restart: unless-stopped
    expose: ["8096"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - BASE_DOMAIN=${BASE_DOMAIN}
      - OIDC_JELLYFIN_CLIENT_SECRET=${OIDC_JELLYFIN_CLIENT_SECRET}
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${BASE_DOMAIN}
    volumes:
      - jellyfin_config:/config
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${BASE_DOMAIN}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.middlewares=auth-forward@docker"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
    networks: [app_net]

  homeassistant:
    <<: *dns-config
    build: ./homeassistant
    container_name: homeassistant
    restart: unless-stopped
    expose: ["8123"]
    environment:
      - TZ=${TZ}
    volumes:
      - homeassistant_config:/config
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.homeassistant.rule=Host(`homeassistant.${BASE_DOMAIN}`)"
      - "traefik.http.routers.homeassistant.entrypoints=websecure"
      - "traefik.http.routers.homeassistant.tls=true"
      - "traefik.http.routers.homeassistant.middlewares=homeassistant-ws,auth-forward@docker"
      - "traefik.http.services.homeassistant.loadbalancer.server.port=8123"
      # WebSocket support
      - "traefik.http.middlewares.homeassistant-ws.headers.customrequestheaders.Connection=Upgrade"
      - "traefik.http.middlewares.homeassistant-ws.headers.customrequestheaders.Upgrade=websocket"
    networks: [app_net]

  watchtower:
    <<: *dns-config
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    expose: ["8080"]
    environment:
      - WATCHTOWER_HTTP_API_TOKEN=watchtower_api_token_change_me  # TODO: abstract
      - WATCHTOWER_HTTP_API_METRICS=true
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - TZ=${TZ}
    volumes:
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.watchtower.rule=Host(`watchtower.${BASE_DOMAIN}`)"
      - "traefik.http.routers.watchtower.entrypoints=websecure"
      - "traefik.http.routers.watchtower.tls=true"
      - "traefik.http.routers.watchtower.middlewares=auth-forward@docker"
      - "traefik.http.services.watchtower.loadbalancer.server.port=8080"
    networks: [app_net]

  duplicati:
    <<: *dns-config
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    restart: unless-stopped
    expose: ["8200"]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - duplicati_config:/config
      - duplicati_backups:/backups
      - duplicati_source:/source:ro
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.duplicati.rule=Host(`duplicati.${BASE_DOMAIN}`)"
      - "traefik.http.routers.duplicati.entrypoints=websecure"
      - "traefik.http.routers.duplicati.tls=true"
      - "traefik.http.routers.duplicati.middlewares=auth-forward@docker"
      - "traefik.http.services.duplicati.loadbalancer.server.port=8200"
    networks: [app_net]

  dockge:
    <<: *dns-config
    image: louislam/dockge:latest
    container_name: dockge
    restart: unless-stopped
    expose: ["5001"]
    environment:
      - TZ=${TZ}
      - DOCKGE_STACKS_DIR=/stacks
    volumes:
      - dockge_data:/app/data
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
      - ./dockge/stacks:/stacks
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.dockge.rule=Host(`dockge.${BASE_DOMAIN}`)"
      - "traefik.http.routers.dockge.entrypoints=websecure"
      - "traefik.http.routers.dockge.tls=true"
      - "traefik.http.routers.dockge.middlewares=auth-forward@docker"
      - "traefik.http.services.dockge.loadbalancer.server.port=5001"
    networks: [app_net]

  # OpenLDAP - User Directory
  openldap:
    <<: *dns-config
    image: osixia/openldap:latest
    container_name: openldap
    restart: unless-stopped
    expose: ["389", "636"]
    environment:
      - LDAP_ORGANISATION=Lab
      - LDAP_DOMAIN=lab.localhost
      - LDAP_ADMIN_PASSWORD=adminpass123
      - LDAP_CONFIG_PASSWORD=configpass123
      - LDAP_RFC2307BIS_SCHEMA=true
      - LDAP_REMOVE_CONFIG_AFTER_SETUP=true
      - LDAP_TLS=false
    volumes:
      - openldap_data:/var/lib/ldap
      - openldap_config:/etc/ldap/slapd.d
    networks: [app_net]

  # LDAP Bootstrap - Adds test users
  openldap-bootstrap:
    <<: *dns-config
    image: osixia/openldap:latest
    container_name: openldap-bootstrap
    restart: "no"
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        sleep 15
        ldapadd -x -H ldap://openldap:389 -D "cn=admin,dc=lab,dc=localhost" -w adminpass123 -f /bootstrap.ldif || echo "Bootstrap entries may already exist"
    volumes:
      - ./openldap/bootstrap.ldif:/bootstrap.ldif:ro
    depends_on:
      - openldap
    networks: [app_net]

  # Dex - OIDC Provider
  dex:
    <<: *dns-config
    image: ghcr.io/dexidp/dex:latest
    container_name: dex
    restart: unless-stopped
    expose: ["5556", "5558"]
    entrypoint: ["/entrypoint.sh"]
    environment:
      - BASE_DOMAIN=${BASE_DOMAIN}
    volumes:
      - ./dex/config.template.yaml:/etc/dex/config.template.yaml:ro
      - ./dex/entrypoint.sh:/entrypoint.sh:ro
      - dex_data:/var/dex
    depends_on:
      - openldap
    labels:
      # Dex is public (no auth required for OIDC issuer)
      - "traefik.enable=true"
      - "traefik.http.routers.dex.rule=Host(`dex.${BASE_DOMAIN}`)"
      - "traefik.http.routers.dex.entrypoints=websecure"
      - "traefik.http.routers.dex.tls=true"
      - "traefik.http.services.dex.loadbalancer.server.port=5556"
    networks: [app_net]

  outline-postgres:
    <<: *dns-config
    image: postgres:16-alpine
    container_name: outline-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=outline  # TODO: abstract
      - POSTGRES_USER=outline  # TODO: abstract
      - POSTGRES_PASSWORD=outline_db_pass_change_me  # TODO: abstract
    volumes:
      - outline_postgres_data:/var/lib/postgresql/data
    networks: [app_net]

  outline-redis:
    <<: *dns-config
    image: redis:7-alpine
    container_name: outline-redis
    restart: unless-stopped
    volumes:
      - outline_redis_data:/data
    networks: [app_net]

  outline:
    <<: *dns-config
    image: outlinewiki/outline:latest
    container_name: outline
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - NODE_ENV=production
      - SECRET_KEY=outline_secret_key_change_me_min_32_chars  # TODO: abstract
      - UTILS_SECRET=outline_utils_secret_change_me_min_32  # TODO: abstract
      - DATABASE_URL=postgres://outline:outline_db_pass_change_me@outline-postgres:5432/outline  # TODO: abstract
      - PGSSLMODE=disable
      - REDIS_URL=redis://outline-redis:6379
      - URL=https://outline.${BASE_DOMAIN}
      - PORT=3000
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
      - FILE_STORAGE_UPLOAD_MAX_SIZE=26214400
      # OIDC Configuration (Dex)
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=outline_secret_change_me
      - OIDC_AUTH_URI=https://dex.${BASE_DOMAIN}/auth
      - OIDC_TOKEN_URI=https://dex.${BASE_DOMAIN}/token
      - OIDC_USERINFO_URI=https://dex.${BASE_DOMAIN}/userinfo
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Dex
      - OIDC_SCOPES=openid profile email
    depends_on:
      - outline-postgres
      - outline-redis
    volumes:
      - outline_data:/var/lib/outline/data
    labels:
      # OIDC-native: no ForwardAuth needed
      - "traefik.enable=true"
      - "traefik.http.routers.outline.rule=Host(`outline.${BASE_DOMAIN}`)"
      - "traefik.http.routers.outline.entrypoints=websecure"
      - "traefik.http.routers.outline.tls=true"
      - "traefik.http.services.outline.loadbalancer.server.port=3000"
    networks: [app_net]

  forward-auth:
    <<: *dns-config
    build: ./forward-auth
    container_name: forward-auth
    restart: unless-stopped
    expose: ["4180"]
    environment:
      - PORT=4180
      - BASE_DOMAIN=${BASE_DOMAIN}
      - DEX_ISSUER=https://dex.${BASE_DOMAIN}
      - CLIENT_ID=forward-auth
      - CLIENT_SECRET=forward_auth_secret_change_me
      - CALLBACK_URL=https://auth.${BASE_DOMAIN}/callback
      - SESSION_SECRET=forward_auth_session_secret_change_me_min_32_chars
    depends_on:
      - dex
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      # Router for auth.${BASE_DOMAIN}
      - "traefik.http.routers.forward-auth.rule=Host(`auth.${BASE_DOMAIN}`)"
      - "traefik.http.routers.forward-auth.entrypoints=websecure"
      - "traefik.http.routers.forward-auth.tls=true"
      - "traefik.http.services.forward-auth.loadbalancer.server.port=4180"
      # Define ForwardAuth middleware (used by other services)
      - "traefik.http.middlewares.auth-forward.forwardauth.address=http://forward-auth:4180/validate"
      - "traefik.http.middlewares.auth-forward.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.auth-forward.forwardauth.authResponseHeaders=Remote-User,Remote-Email,Remote-Name,Remote-Groups"
      # Admin-only middleware (requires admins group)
      - "traefik.http.middlewares.auth-admin.forwardauth.address=http://forward-auth:4180/validate?required_groups=admins"
      - "traefik.http.middlewares.auth-admin.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.auth-admin.forwardauth.authResponseHeaders=Remote-User,Remote-Email,Remote-Name,Remote-Groups"
    networks: [app_net]

  auth-status-dashboard:
    <<: *dns-config
    build: ./auth-status
    container_name: auth-status-dashboard
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - PORT=3000
      - BASE_DOMAIN=${BASE_DOMAIN}
      - DEX_URL=https://dex.${BASE_DOMAIN}
      - TEST_INTERVAL=30000  # 30 seconds
      - BROWSERLESS_URL=http://browserless:3000
      - TEST_USERNAME=authtest
      - TEST_PASSWORD=TestAuth123!
    depends_on:
      - dex
      - browserless
    labels:
      # ForwardAuth-protected (no native OIDC)
      - "traefik.enable=true"
      - "traefik.http.routers.auth-status-dashboard.rule=Host(`auth-status.${BASE_DOMAIN}`)"
      - "traefik.http.routers.auth-status-dashboard.entrypoints=websecure"
      - "traefik.http.routers.auth-status-dashboard.tls=true"
      - "traefik.http.routers.auth-status-dashboard.middlewares=auth-status-dashboard-ws,auth-forward@docker"
      - "traefik.http.services.auth-status-dashboard.loadbalancer.server.port=3000"
      # WebSocket support
      - "traefik.http.middlewares.auth-status-dashboard-ws.headers.customrequestheaders.Connection=Upgrade"
      - "traefik.http.middlewares.auth-status-dashboard-ws.headers.customrequestheaders.Upgrade=websocket"
    networks: [app_net]

volumes:
  traefik_certs:
  openldap_data:
  openldap_config:
  dex_data:
  prometheus_data:
  alertmanager_data:
  loki_data:
  grafana_data:
  mariadb_data:
  clickhouse_data:
  localai_models:
  localai_data:
  librechat_data:
  librechat_mongo_data:
  nextcloud_data:
  vaultwarden_data:
  jupyterhub_data:
  planka_db_data:
  planka_data:
  planka_attachments:
  jellyfin_config:
  homeassistant_config:
  duplicati_config:
  duplicati_backups:
  duplicati_source:
  dockge_data:
  outline_postgres_data:
  outline_redis_data:
  outline_data:


