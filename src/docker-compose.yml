networks:
  app_net:
    name: app_net

services:
  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      # Allow caddy-docker-proxy (read-only) and JupyterHub (read-write)
      - CONTAINERS=1
      - NETWORKS=1
      - EVENTS=1
      - INFO=1
      - IMAGES=1
      - POST=1
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=1
      - GRPC=0
      - NODES=0
      - PLUGINS=0
      - SECRETS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=1
    volumes:
      # rootless socket path
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    networks: [app_net]

  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    user: "0:0"
    ports: ["80:80", "443:443"]
    environment:
      - CADDY_INGRESS_NETWORKS=app_net
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    # ðŸ”’ No direct /var/run/docker.sock mount here
    networks:
      app_net:
        aliases:
          - id.lab.localhost
          - tasks.lab.localhost
          - grafana.lab.localhost
          - nextcloud.lab.localhost
          - jupyter.lab.localhost
          - chat.lab.localhost
  whoami:
    image: traefik/whoami:latest
    container_name: whoami
    restart: unless-stopped
    labels:
      caddy: whoami.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]

  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    expose: ["9091"]
    environment:
      - TZ=${TZ}
    command: ["authelia", "--config", "/config/configuration.yml"]
    volumes:
      - ./authelia/configuration.yml:/config/configuration.yml:ro
      - ./authelia/users.yml:/config/users.yml:ro
      - authelia_data:/data
    labels:
      caddy: id.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9091}}"
    networks: [app_net]

  caddy-config:
    image: traefik/whoami:latest
    container_name: caddy-config
    restart: unless-stopped
    labels:
      caddy: (auth)
      caddy.forward_auth: authelia:9091
      caddy.forward_auth.uri: /api/authz/forward-auth
      caddy.forward_auth.copy_headers: Remote-User Remote-Groups Remote-Name Remote-Email
    networks: [app_net]

  landing:
    image: nginx:alpine
    container_name: landing
    restart: unless-stopped
    expose: ["80"]
    volumes:
      - ./landing:/usr/share/nginx/html:ro
    labels:
      caddy: ${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    expose: ["9090"]
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    labels:
      caddy: prometheus.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9090}}"
      caddy.import: auth
    networks: [app_net]

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    expose: ["9093"]
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    labels:
      caddy: alertmanager.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9093}}"
      caddy.import: auth
    networks: [app_net]

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    expose: ["3100"]
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki_data:/loki
    labels:
      caddy: loki.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3100}}"
      caddy.import: auth
    networks: [app_net]

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
    networks: [app_net]

  blackbox-exporter:
    image: prom/blackbox-exporter:latest
    container_name: blackbox-exporter
    restart: unless-stopped
    expose: ["9115"]
    command:
      - '--config.file=/etc/blackbox/blackbox.yml'
    volumes:
      - ./blackbox/blackbox.yml:/etc/blackbox/blackbox.yml:ro
    networks: [app_net]

  prometheus-script-exporter:
    image: ghcr.io/ricoberger/script_exporter:latest
    container_name: prometheus-script-exporter
    restart: unless-stopped
    expose: ["9469"]
    volumes:
      - ./script-exporter/config.yml:/config.yaml:ro
      - ./script-exporter/scripts:/scripts:ro
    networks: [app_net]

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    expose: ["3000"]
    environment:
      # Disabled to avoid conflict with OAuth users
      # - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}  # TODO: abstract
      # - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}  # TODO: abstract
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_SERVER_ROOT_URL=https://grafana.${BASE_DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=grafana_oidc_secret_change_me
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://id.${BASE_DOMAIN}/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authelia:9091/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authelia:9091/api/oidc/userinfo
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://id.${BASE_DOMAIN}/logout
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_GENERIC_OAUTH_USE_REFRESH_TOKEN=true
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_USERNAME_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_AUTH_GENERIC_OAUTH_AUTO_ASSIGN_ORG_ROLE=Admin
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_LOG_LEVEL=debug
      - GF_LOG_FILTERS=oauth.generic_oauth:debug,user.sync:debug,sqlstore:debug,login:debug
    volumes:
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    extra_hosts:
      - "id.lab.localhost:host-gateway"
    labels:
      caddy: grafana.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    networks: [app_net]

  mariadb:
    image: mariadb:latest
    container_name: mariadb
    restart: unless-stopped
    expose: ["3306"]
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass123  # TODO: abstract (plaintext: rootpass123)
      - MYSQL_DATABASE=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_USER=nextcloud  # TODO: abstract (plaintext: nextcloud)
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
    volumes:
      - mariadb_data:/var/lib/mysql
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    networks: [app_net]

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    expose: ["8123", "9000"]
    environment:
      - CLICKHOUSE_DB=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_USER=default  # TODO: abstract (plaintext: default)
      - CLICKHOUSE_PASSWORD=clickhousepass123  # TODO: abstract (plaintext: clickhousepass123)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks: [app_net]

  localai:
    image: quay.io/go-skynet/local-ai:latest
    container_name: localai
    restart: unless-stopped
    expose: ["8080"]
    environment:
      - THREADS=4  # TODO: abstract (CPU cores)
      - CONTEXT_SIZE=2048  # TODO: abstract
      - MODELS_PATH=/models
    volumes:
      - localai_models:/models
      - localai_data:/tmp/localai
    labels:
      caddy: how .${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.import: auth
    networks: [app_net]

  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    expose: ["3080"]
    environment:
      - HOST=0.0.0.0
      - MONGO_URI=mongodb://librechat-mongo:27017/LibreChat
      - OPENAI_API_KEY=not_needed
      - ENDPOINTS=openAI
      - OPENAI_REVERSE_PROXY=http://localai:8080/v1
      - DOMAIN_SERVER=https://chat.lab.localhost
      - DOMAIN_CLIENT=https://chat.lab.localhost
      # OIDC Authentication via Authelia
      - ALLOW_EMAIL_LOGIN=false
      - ALLOW_REGISTRATION=false
      - ALLOW_SOCIAL_LOGIN=true
      - ALLOW_SOCIAL_REGISTRATION=true
      - OPENID_ISSUER=https://id.${BASE_DOMAIN}
      - OPENID_CLIENT_ID=librechat
      - OPENID_CLIENT_SECRET=${OIDC_LIBRECHAT_CLIENT_SECRET}
      - OPENID_CALLBACK_URL=/oauth/openid/callback
      - OPENID_SCOPE=openid profile email groups
      - OPENID_SESSION_SECRET=librechat_oidc_session_secret_changeme
      - OPENID_BUTTON_LABEL=Login with Authelia
      - OPENID_REQUIRED_ROLE=
      - OPENID_REQUIRED_ROLE_TOKEN_KIND=
      - OPENID_REQUIRED_ROLE_PARAMETER_PATH=
      - NODE_EXTRA_CA_CERTS=/app/caddy-root-ca.crt
      - JWT_SECRET=librechat_jwt_secret_changeme123
      - JWT_REFRESH_SECRET=librechat_jwt_refresh_secret_changeme789
      - CREDS_KEY=librechat_creds_key_changeme456
      - CREDS_IV=librechat_creds_iv_changeme78
    depends_on:
      - librechat-mongo
      - localai
    volumes:
      - librechat_data:/app/client/public/images
      - ./librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./caddy-root-ca.crt:/app/caddy-root-ca.crt:ro
    labels:
      caddy: chat.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3080}}"
      # Remove forward auth - LibreChat handles its own auth via OIDC
    networks: [app_net]

  librechat-mongo:
    image: mongo:latest
    container_name: librechat-mongo
    restart: unless-stopped
    volumes:
      - librechat_mongo_data:/data/db
    networks: [app_net]

  benthos:
    image: jeffail/benthos:latest
    container_name: benthos
    restart: unless-stopped
    expose: ["4195"]
    volumes:
      - ./benthos/config.yaml:/benthos.yaml:ro
      - ./benthos/pipelines:/pipelines:ro
    command: -c /benthos.yaml
    labels:
      caddy: benthos.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 4195}}"
      caddy.import: auth
    networks: [app_net]

  browserless:
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped
    expose: ["3000"]
    environment:
      - MAX_CONCURRENT_SESSIONS=3  # TODO: abstract
      - CONNECTION_TIMEOUT=60000  # TODO: abstract
      - TOKEN=  # Disabled - using Authelia for auth
    labels:
      caddy: browser.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
      caddy.import: auth
    networks: [app_net]

  nextcloud:
    build: ./nextcloud
    container_name: nextcloud
    restart: unless-stopped
    expose: ["80"]
    environment:
      - MYSQL_HOST=mariadb
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloudpass123  # TODO: abstract (plaintext: nextcloudpass123)
      - NEXTCLOUD_ADMIN_USER=admin  # TODO: abstract (plaintext: admin)
      - NEXTCLOUD_ADMIN_PASSWORD=adminpass123  # TODO: abstract (plaintext: adminpass123)
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${BASE_DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.${BASE_DOMAIN}
      - OIDC_NEXTCLOUD_CLIENT_SECRET=nextcloud_oidc_secret_change_me
    depends_on:
      - mariadb
    volumes:
      - nextcloud_data:/var/www/html
      - ./nextcloud/config.php:/var/www/html/config/sso.config.php:ro
    extra_hosts:
      - "id.lab.localhost:host-gateway"
    labels:
      caddy: nextcloud.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    networks: [app_net]

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    expose: ["80"]
    environment:
      - SIGNUPS_ALLOWED=false
      - ADMIN_TOKEN=vaultwardentokenadmin123  # TODO: abstract (plaintext: vaultwardentokenadmin123)
      - DOMAIN=https://vault.${BASE_DOMAIN}
    volumes:
      - vaultwarden_data:/data
    labels:
      caddy: vault.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]

  jupyterhub:
    build: ./jupyterhub
    container_name: jupyterhub
    restart: unless-stopped
    expose: ["8000"]
    environment:
      - DOCKER_NETWORK_NAME=app_net
      - OIDC_JUPYTERHUB_CLIENT_SECRET=jupyterhub_oidc_secret_change_me
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    extra_hosts:
      - "id.lab.localhost:host-gateway"
    labels:
      caddy: jupyter.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8000}}"
    networks: [app_net]

  planka-db:
    image: postgres:16-alpine
    container_name: planka-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_USER=planka  # TODO: abstract (plaintext: planka)
      - POSTGRES_PASSWORD=plankapass123  # TODO: abstract (plaintext: plankapass123)
    volumes:
      - planka_db_data:/var/lib/postgresql/data
    networks: [app_net]

  planka:
    image: ghcr.io/plankanban/planka:latest
    container_name: planka
    restart: unless-stopped
    expose: ["1337"]
    environment:
      - BASE_URL=https://tasks.${BASE_DOMAIN}
      - DATABASE_URL=postgresql://planka:plankapass123@planka-db/planka  # TODO: abstract (plaintext: planka:plankapass123)
      - SECRET_KEY=plankaSecretKeyChangeMe123456  # TODO: abstract (plaintext: plankaSecretKeyChangeMe123456)
      - TRUST_PROXY=true
      # OIDC Configuration (Planka does not support forward auth headers)
      - OIDC_ISSUER=https://id.${BASE_DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=planka_oidc_secret_change_me
      - OIDC_SCOPES=openid email profile
      - OIDC_ADMIN_ROLES=admins
      - NODE_EXTRA_CA_CERTS=/app/caddy-root-ca.crt
    depends_on:
      - planka-db
    volumes:
      - planka_data:/app/public/user-avatars
      - planka_attachments:/app/private/attachments
      - ./caddy-root-ca.crt:/app/caddy-root-ca.crt:ro
    labels:
      caddy: tasks.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 1337}}"
      caddy.reverse_proxy.header_up: "Connection {http.request.header.Connection}"
      caddy.reverse_proxy.header_up_1: "Upgrade {http.request.header.Upgrade}"
    networks: [app_net]



volumes:
  caddy_data:
  caddy_config:
  authelia_data:
  prometheus_data:
  alertmanager_data:
  loki_data:
  grafana_data:
  mariadb_data:
  clickhouse_data:
  localai_models:
  localai_data:
  librechat_data:
  librechat_mongo_data:
  nextcloud_data:
  vaultwarden_data:
  jupyterhub_data:
  planka_db_data:
  planka_data:
  planka_attachments:


configs:
  authelia_config:
    file: ./authelia/configuration.yml
  authelia_users:
    file: ./authelia/users.yml
