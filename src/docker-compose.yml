# Step 1: Ingress skeleton
version: "3.9"

networks:
  app_net:
    name: app_net

services:
  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    restart: unless-stopped
    environment:
      # allow only what caddy-docker-proxy needs (read-only)
      - CONTAINERS=1
      - NETWORKS=1
      - EVENTS=1
      - INFO=1
      - POST=0
    volumes:
      # rootless socket path
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/docker.sock:/var/run/docker.sock:ro
    networks: [app_net]

  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.8-alpine
    container_name: caddy
    restart: unless-stopped
    user: "0:0"
    ports: ["8080:80", "8443:443"]
    environment:
      - CADDY_INGRESS_NETWORKS=app_net
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
    # ðŸ”’ No direct /var/run/docker.sock mount here
    networks: [app_net]
  whoami:
    image: traefik/whoami:latest
    container_name: whoami
    restart: unless-stopped
    labels:
      caddy: whoami.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
      caddy.import: auth
    networks: [app_net]



# Step 2: Authelia (forward-auth) and add an auth snippet for Caddy
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    expose: ["9091"]
    configs:
      - source: authelia_config
        target: /config/configuration.yml
      - source: authelia_users
        target: /config/users.yml
    volumes:
      - authelia_data:/data
    labels:
      caddy: id.${BASE_DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9091}}"
    networks: [app_net]

  # Defines reusable Caddy labels (auth) and a base-domain redirect.
  caddy-config:
    image: traefik/whoami:latest
    container_name: caddy-config
    restart: unless-stopped
    labels:
      caddy_1: (auth)
      caddy_1.forward_auth: authelia:9091
      caddy_1.forward_auth.uri: /api/authz/forward-auth
      caddy_1.forward_auth.copy_headers: Remote-User Remote-Groups Remote-Name Remote-Email
      caddy_2: ${BASE_DOMAIN}
      caddy_2.import: auth
      caddy_2.redir: "https://grafana.${BASE_DOMAIN}${GRAFANA_DEFAULT_VIEW:-/} permanent"
    networks: [app_net]



volumes:
  caddy_data:
  authelia_data:


configs:
  authelia_config:
    file: ./authelia/configuration.yml
  authelia_users:
    file: ./authelia/users.yml
