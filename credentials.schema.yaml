# Datamancy Credentials Schema
# This is the single source of truth for all credentials in the system
# The build script reads this to generate secrets, validate templates, and produce documentation

# Credential Types:
#   hex_secret: 64-char hex (openssl rand -hex 32)
#   laravel_key: base64:... format for Laravel APP_KEY
#   rsa_key: RSA 4096 private key, base64-encoded
#   oauth_secret: hex_secret + argon2id hash for Authelia
#   user_provided: Empty by default, user must fill
#   config_value: Non-secret configuration value

credentials:
  # ============================================================================
  # Domain & Admin Configuration (not secrets, but needed for templating)
  # ============================================================================
  - name: DOMAIN
    type: config_value
    description: "Primary domain for the stack"
    source: datamancy.config.yaml

  - name: MAIL_DOMAIN
    type: config_value
    description: "Mail server domain"
    source: datamancy.config.yaml

  - name: LDAP_DOMAIN
    type: config_value
    description: "LDAP domain"
    source: datamancy.config.yaml

  - name: LDAP_BASE_DN
    type: config_value
    description: "LDAP base DN"
    source: datamancy.config.yaml

  - name: STACK_ADMIN_EMAIL
    type: config_value
    description: "Administrator email address"
    source: datamancy.config.yaml

  - name: STACK_ADMIN_USER
    type: config_value
    description: "Administrator username"
    source: datamancy.config.yaml

  # ============================================================================
  # Core Infrastructure Passwords
  # ============================================================================
  - name: STACK_ADMIN_PASSWORD
    type: hex_secret
    description: "Primary administrator password"
    used_by:
      - homeassistant
      - kopia
      - filebrowser
      - ldap_bootstrap_sysadmin
    hash_variants:
      - algorithm: ssha
        variable: ADMIN_SSHA_PASSWORD
        used_in: [configs/infrastructure/ldap/bootstrap_ldap.ldif]

  - name: LDAP_ADMIN_PASSWORD
    type: hex_secret
    description: "LDAP admin bind password"
    used_by:
      - authelia
      - ldap
      - mailserver
      - synapse
      - lam
      - homeassistant
      - forgejo
    baked_in_configs:
      - configs/infrastructure/mailserver/ldap-domains.cf
      - configs/infrastructure/mailserver/dovecot-ldap.conf.ext

  # ============================================================================
  # Database Root Passwords
  # ============================================================================
  - name: POSTGRES_ROOT_PASSWORD
    type: hex_secret
    description: "PostgreSQL root password"
    used_by:
      - postgres
      - init_scripts
      - observers

  - name: MARIADB_ROOT_PASSWORD
    type: hex_secret
    description: "MariaDB root password"
    used_by:
      - mariadb
      - init_scripts
      - observers

  - name: CLICKHOUSE_ADMIN_PASSWORD
    type: hex_secret
    description: "ClickHouse admin password"
    used_by:
      - clickhouse
      - observers
    hash_variants:
      - algorithm: sha256
        variable: CLICKHOUSE_ADMIN_PASSWORD_HASH
        used_in: [configs/databases/clickhouse/users.xml]

  - name: DATAMANCY_SERVICE_PASSWORD
    type: hex_secret
    description: "ClickHouse service account password for pipelines"
    used_by:
      - clickhouse
      - datamancy_pipelines
    hash_variants:
      - algorithm: sha256
        variable: DATAMANCY_SERVICE_PASSWORD_HASH
        used_in: [configs/databases/clickhouse/users.xml]

  # ============================================================================
  # Per-Service Database Passwords
  # ============================================================================
  - name: AUTHELIA_DB_PASSWORD
    type: hex_secret
    description: "Authelia PostgreSQL password"

  - name: BOOKSTACK_DB_PASSWORD
    type: hex_secret
    description: "BookStack MariaDB password"

  - name: FORGEJO_DB_PASSWORD
    type: hex_secret
    description: "Forgejo PostgreSQL password"

  - name: GRAFANA_DB_PASSWORD
    type: hex_secret
    description: "Grafana PostgreSQL password"

  - name: HOMEASSISTANT_DB_PASSWORD
    type: hex_secret
    description: "Home Assistant PostgreSQL password"

  - name: MARIADB_SEAFILE_PASSWORD
    type: hex_secret
    description: "Seafile MariaDB password"

  - name: MASTODON_DB_PASSWORD
    type: hex_secret
    description: "Mastodon PostgreSQL password"

  - name: OPENWEBUI_DB_PASSWORD
    type: hex_secret
    description: "Open WebUI PostgreSQL password"

  - name: PLANKA_DB_PASSWORD
    type: hex_secret
    description: "Planka PostgreSQL password"

  - name: ROUNDCUBE_DB_PASSWORD
    type: hex_secret
    description: "Roundcube PostgreSQL password"

  - name: SYNAPSE_DB_PASSWORD
    type: hex_secret
    description: "Matrix Synapse PostgreSQL password"

  - name: VAULTWARDEN_DB_PASSWORD
    type: hex_secret
    description: "Vaultwarden PostgreSQL password"

  # ============================================================================
  # Observer Accounts (read-only database access for agents)
  # ============================================================================
  - name: AGENT_LDAP_OBSERVER_PASSWORD
    type: hex_secret
    description: "Read-only LDAP observer password"

  - name: AGENT_MARIADB_OBSERVER_PASSWORD
    type: hex_secret
    description: "Read-only MariaDB observer password"

  - name: AGENT_POSTGRES_OBSERVER_PASSWORD
    type: hex_secret
    description: "Read-only PostgreSQL observer password"

  - name: AGENT_QDRANT_API_KEY
    type: hex_secret
    description: "Agent access to Qdrant vector DB"

  # ============================================================================
  # OAuth OIDC Secrets (plaintext + argon2id hash)
  # ============================================================================
  - name: PGADMIN_OAUTH_SECRET
    type: oauth_secret
    description: "PgAdmin OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: PGADMIN_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: OPENWEBUI_OAUTH_SECRET
    type: oauth_secret
    description: "Open WebUI OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: OPENWEBUI_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: DIM_OAUTH_SECRET
    type: oauth_secret
    description: "DIM OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: DIM_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: PLANKA_OAUTH_SECRET
    type: oauth_secret
    description: "Planka OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: PLANKA_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: VAULTWARDEN_OAUTH_SECRET
    type: oauth_secret
    description: "Vaultwarden OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: VAULTWARDEN_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: MASTODON_OAUTH_SECRET
    type: oauth_secret
    description: "Mastodon OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: MASTODON_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: BOOKSTACK_OAUTH_SECRET
    type: oauth_secret
    description: "BookStack OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: BOOKSTACK_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: FORGEJO_OAUTH_SECRET
    type: oauth_secret
    description: "Forgejo OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: FORGEJO_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  - name: MATRIX_OAUTH_SECRET
    type: oauth_secret
    description: "Matrix Synapse OIDC client secret"
    hash_variants:
      - algorithm: argon2id
        variable: MATRIX_OAUTH_SECRET_HASH
        used_in: [configs/applications/authelia/configuration.yml]

  # ============================================================================
  # Authelia Core Secrets
  # ============================================================================
  - name: AUTHELIA_JWT_SECRET
    type: hex_secret
    description: "Authelia JWT signing secret"

  - name: AUTHELIA_SESSION_SECRET
    type: hex_secret
    description: "Authelia session encryption secret"

  - name: AUTHELIA_STORAGE_ENCRYPTION_KEY
    type: hex_secret
    description: "Authelia storage encryption key"

  - name: AUTHELIA_OIDC_HMAC_SECRET
    type: hex_secret
    description: "Authelia OIDC HMAC secret"

  - name: AUTHELIA_OIDC_PRIVATE_KEY
    type: rsa_key
    description: "Authelia OIDC RSA private key"
    special_handling: multiline_indented_yaml

  # ============================================================================
  # Application-Specific Secrets
  # ============================================================================
  - name: BOOKSTACK_APP_KEY
    type: laravel_key
    description: "BookStack Laravel application key"

  - name: JELLYFIN_OIDC_SECRET
    type: hex_secret
    description: "Jellyfin OIDC secret"

  - name: JUPYTERHUB_CRYPT_KEY
    type: hex_secret
    description: "JupyterHub encryption key"

  - name: LITELLM_MASTER_KEY
    type: hex_secret
    description: "LiteLLM master API key"

  - name: ONLYOFFICE_JWT_SECRET
    type: hex_secret
    description: "OnlyOffice JWT secret"

  - name: PLANKA_SECRET_KEY
    type: hex_secret
    description: "Planka secret key"

  - name: QDRANT_API_KEY
    type: hex_secret
    description: "Qdrant vector database API key"

  - name: SEAFILE_JWT_KEY
    type: hex_secret
    description: "Seafile JWT key"

  - name: SEAFILE_SECRET_KEY
    type: hex_secret
    description: "Seafile secret key"

  - name: SEAFILE_EMAIL_PASSWORD
    type: hex_secret
    description: "Seafile email notification password"

  - name: VAULTWARDEN_ADMIN_TOKEN
    type: hex_secret
    description: "Vaultwarden admin panel token"

  - name: VAULTWARDEN_SMTP_PASSWORD
    type: hex_secret
    description: "Vaultwarden SMTP password"

  # ============================================================================
  # Matrix Synapse Secrets
  # ============================================================================
  - name: SYNAPSE_REGISTRATION_SECRET
    type: hex_secret
    description: "Matrix Synapse registration secret"

  - name: SYNAPSE_MACAROON_SECRET
    type: hex_secret
    description: "Matrix Synapse macaroon secret"

  - name: SYNAPSE_FORM_SECRET
    type: hex_secret
    description: "Matrix Synapse form secret"

  # ============================================================================
  # Mastodon Secrets
  # ============================================================================
  - name: MASTODON_SECRET_KEY_BASE
    type: hex_secret
    description: "Mastodon secret key base"

  - name: MASTODON_OTP_SECRET
    type: hex_secret
    description: "Mastodon OTP secret"

  - name: MASTODON_VAPID_PRIVATE_KEY
    type: hex_secret
    description: "Mastodon VAPID private key"

  - name: MASTODON_VAPID_PUBLIC_KEY
    type: hex_secret
    description: "Mastodon VAPID public key"

  - name: MASTODON_OIDC_SECRET
    type: hex_secret
    description: "Mastodon OIDC secret"

  - name: MASTODON_ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
    type: hex_secret
    description: "Mastodon ActiveRecord encryption primary key"

  - name: MASTODON_ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY
    type: hex_secret
    description: "Mastodon ActiveRecord encryption deterministic key"

  - name: MASTODON_ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
    type: hex_secret
    description: "Mastodon ActiveRecord encryption salt"

  # ============================================================================
  # User-Provided / Optional Credentials
  # ============================================================================
  - name: HUGGINGFACEHUB_API_TOKEN
    type: user_provided
    description: "HuggingFace Hub API token (required for model downloads)"
    default: ""

  - name: FORGEJO_RUNNER_REGISTRATION_TOKEN
    type: user_provided
    description: "Forgejo CI runner registration token (generated post-deployment)"
    default: ""

  # ============================================================================
  # Configuration Values (not secrets)
  # ============================================================================
  - name: API_LITELLM_ALLOWLIST
    type: config_value
    description: "IP allowlist for LiteLLM API"
    default: "127.0.0.1 172.16.0.0/12 192.168.0.0/16"

  - name: VECTOR_EMBED_SIZE
    type: config_value
    description: "Vector embedding dimension (BAAI/bge-base-en-v1.5)"
    default: "768"

  - name: FORGEJO_RUNNER_NAME
    type: config_value
    description: "Forgejo runner instance name"
    default: "datamancy-runner"

  - name: FORGEJO_RUNNER_LABELS
    type: config_value
    description: "Forgejo runner labels"
    default: "ubuntu-latest:docker://node:20-bullseye,ubuntu-22.04:docker://node:20-bullseye"

# ============================================================================
# Template Processing Rules
# ============================================================================
template_rules:
  - name: clickhouse_users
    path_pattern: "databases/clickhouse/users.xml"
    substitutions:
      CLICKHOUSE_ADMIN_PASSWORD:
        transform: sha256
      DATAMANCY_SERVICE_PASSWORD:
        transform: sha256

  - name: ldap_bootstrap
    path_pattern: "infrastructure/ldap/bootstrap_ldap.ldif"
    substitutions:
      ADMIN_SSHA_PASSWORD:
        source: STACK_ADMIN_PASSWORD
        transform: ssha
      USER_SSHA_PASSWORD:
        source: STACK_ADMIN_PASSWORD  # Can be different if needed
        transform: ssha

  - name: mailserver_ldap
    path_pattern: "infrastructure/mailserver/(ldap-domains.cf|dovecot-ldap.conf.ext)"
    substitutions:
      LDAP_ADMIN_PASSWORD:
        transform: none  # Bake plaintext
    then_convert_remaining: true  # Convert {{VAR}} -> ${VAR}

  - name: authelia_oidc_key
    path_pattern: "applications/authelia/configuration.yml"
    substitutions:
      AUTHELIA_OIDC_PRIVATE_KEY:
        transform: multiline_yaml_indent
      # OAuth hashes handled automatically based on credential schema

  - name: default
    path_pattern: ".*"
    substitutions: {}
    then_convert_remaining: true  # Convert all {{VAR}} -> ${VAR}
