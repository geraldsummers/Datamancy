name: Freshness Check
# Provenance: Phase 0.5 - CI gate for stale docs/tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  check-freshness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build docs-indexer
        run: docker compose build docs-indexer

      - name: Run docs-indexer
        run: docker compose run --rm docs-indexer

      - name: Check for stale services
        run: |
          if jq -e '.[] | select(.status == "stale")' docs/_data/status.json > /dev/null 2>&1; then
            echo "❌ Stale services found:"
            jq '.[] | select(.status == "stale")' docs/_data/status.json
            echo ""
            echo "Services must be tested and documented after config changes."
            exit 1
          else
            echo "✓ No stale services (all tested or untested)"
          fi

      - name: Upload status.json artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: freshness-status
          path: docs/_data/status.json
