
networks:
  # Network Segmentation Strategy:
  # - frontend: Public-facing reverse proxy (Caddy only)
  # - backend: Application services (web apps, APIs)
  # - database: Database services only (isolated)
  # - auth: Authentication layer (Authelia, LDAP, Redis)
  # - admin: Admin tools (Dockge, Kopia, LAM)
  # - mail: Mail services (Mailu stack)
  # - test: Testing infrastructure

  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

  database:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24

  auth:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/24

  admin:
    driver: bridge
    ipam:
      config:
        - subnet: 172.24.0.0/24

  admin-dockge:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.26.0.0/24

  admin-jupyterhub:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.27.0.0/24

  mail:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24


  test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16

volumes:
  caddy_data:
  caddy_config:
  grafana_data:
  ldap_data:
  ldap_config:
  lam_config:
  authelia_data:
  mariadb_data:
  postgres_data:
  couchdb_data:
  clickhouse_data:
  dockge_data:
  localai_models:
  open_webui_data:
  kopia_data:
  kopia_cache:
  kopia_repository:
  redis_data:
  shared_media:
  planka_data:
  outline_data:
  benthos_data:
  jupyterhub_data:
  litellm_config:
  homepage_config:
  seafile_data:
  seafile_mysql_data:
  onlyoffice_data:
  synapse_data:
  mailu_data:
  mailu_filter:
  mailu_cert:
  mailu_dkim:
  sogo_data:
  mastodon_data:
  vaultwarden_data:
  homeassistant_config:

services:

  # ========================================
  # AUTHENTICATION & AUTHORIZATION GUIDE
  # ========================================
  #
  # ARCHITECTURE:
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ  User   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Caddy  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Authelia ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  LDAP   ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #                     ‚îÇ               ‚îÇ
  #                     ‚ñº               ‚ñº
  #              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  #              ‚îÇ   Apps     ‚îÇ   ‚îÇ  OIDC    ‚îÇ
  #              ‚îÇ (Forward   ‚îÇ   ‚îÇ  Clients ‚îÇ
  #              ‚îÇ   Auth)    ‚îÇ   ‚îÇ (Native) ‚îÇ
  #              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #
  # COMPONENTS:
  # - LDAP (OpenLDAP): Centralized user directory (users, groups, passwords)
  # - Authelia: OIDC Provider + SSO gateway + MFA enforcement + Forward-auth endpoint
  # - Caddy: Reverse proxy with forward_auth middleware
  # - Redis: Session storage for Authelia
  #
  # AUTHENTICATION METHODS (Priority Order):
  #
  # 1. ‚úÖ NATIVE OIDC/OAuth2 (PREFERRED)
  #    When: App has built-in OIDC/OAuth2 support
  #    How: Configure OIDC client in Authelia configuration.yml
  #    Pros: Native integration, role/group mapping, proper logout, token refresh
  #    Apps: Grafana, Open-WebUI, Planka, Outline, JupyterHub, LiteLLM, Vaultwarden
  #          Seafile, Synapse, Mailu (header-auth), Home Assistant, Akkoma
  #
  # 2. üîí FORWARD AUTH (Caddy ‚Üí Authelia)
  #    When: App lacks OIDC but trusts reverse proxy headers (X-Remote-User, X-Email)
  #    How: Caddy forward_auth block ‚Üí Authelia validates ‚Üí passes headers to app
  #    Pros: Simple setup, works with legacy apps, centralized policy enforcement
  #    Cons: App must trust proxy headers, no native role mapping, logout requires Authelia
  #    Apps: Dockge, Kopia, Homepage, LDAP Account Manager
  #
  # 3. üîê LDAP DIRECT (DEPRECATED)
  #    When: Legacy apps with LDAP auth module but no OIDC
  #    How: App binds directly to OpenLDAP for authentication
  #    Cons: No SSO, credentials sent to each app, no MFA enforcement, harder to audit
  #    Note: Prefer OIDC or forward-auth even for LDAP-capable apps
  #
  # 4. üîì SELF-CONTAINED AUTH (No SSO)
  #    When: App requires independent identity for federation/protocol reasons
  #    Why: Federation protocols (ActivityPub, Matrix), mail protocols (SMTP/IMAP)
  #    Apps: Synapse (Matrix), Akkoma (ActivityPub), Mailu (mail), SOGo (groupware)
  #    Note: Some support OIDC for web UI login but maintain separate identity layer
  #
  # 5. ‚õî NO AUTH (Internal Services)
  #    When: Backend service with no user-facing interface
  #    Security: Network isolation, not exposed via Caddy, credential-based API access
  #    Apps: postgres, mariadb, redis, couchdb, clickhouse, memcached, docker-proxy, benthos
  #
  # OIDC-ENABLED SERVICES (Register these in Authelia):
  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ Service          ‚îÇ Callback URL                           ‚îÇ Scopes                  ‚îÇ
  # ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  # ‚îÇ Grafana          ‚îÇ /login/generic_oauth                   ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Open-WebUI       ‚îÇ /oauth/oidc/callback                   ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Planka           ‚îÇ /oidc-callback                         ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Outline          ‚îÇ /auth/oidc.callback                    ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ JupyterHub       ‚îÇ /hub/oauth_callback                    ‚îÇ openid email groups     ‚îÇ
  # ‚îÇ LiteLLM          ‚îÇ /sso/callback                          ‚îÇ openid profile email    ‚îÇ
  # ‚îÇ Vaultwarden      ‚îÇ /identity/connect/oidc-signin          ‚îÇ openid email profile    ‚îÇ
  # ‚îÇ Seafile          ‚îÇ /oauth/callback/                       ‚îÇ openid email profile    ‚îÇ
  # ‚îÇ Synapse          ‚îÇ /_synapse/client/oidc/callback         ‚îÇ openid                  ‚îÇ
  # ‚îÇ Mailu            ‚îÇ N/A (header auth)                      ‚îÇ N/A                     ‚îÇ
  # ‚îÇ Home Assistant   ‚îÇ /auth/external/callback                ‚îÇ openid email profile    ‚îÇ
  # ‚îÇ Akkoma           ‚îÇ /oauth/local/callback                  ‚îÇ openid email profile    ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  #
  # FORWARD-AUTH SERVICES (Protect in Caddyfile):
  # - Dockge: Admin tool, restrict to 'admins' group
  # - Kopia: Backup admin, restrict to 'admins' group
  # - Homepage: Dashboard, allow 'users' + 'admins'
  # - LDAP Account Manager: User management, restrict to 'admins'
  #
  # LDAP STRUCTURE:
  # dc=stack,dc=local
  # ‚îú‚îÄ‚îÄ ou=users
  # ‚îÇ   ‚îú‚îÄ‚îÄ cn=admin (admin user)
  # ‚îÇ   ‚îú‚îÄ‚îÄ cn=user1
  # ‚îÇ   ‚îî‚îÄ‚îÄ cn=user2
  # ‚îî‚îÄ‚îÄ ou=groups
  #     ‚îú‚îÄ‚îÄ cn=admins (full access)
  #     ‚îî‚îÄ‚îÄ cn=users (standard access)
  #
  # SECURITY BEST PRACTICES:
  # ‚úÖ Enable MFA in Authelia for all users (especially admins)
  # ‚úÖ Use unique OIDC client secrets per app (generated, stored in .env)
  # ‚úÖ Configure Authelia ACL policies to restrict admin routes
  # ‚úÖ Never expose internal services (databases, redis) to Caddy
  # ‚úÖ Use PKCE for OIDC flows where supported
  # ‚úÖ Enable HTTPS-only cookies in Authelia session config
  # ‚úÖ Rotate OIDC secrets periodically
  # ‚úÖ Review Authelia audit logs for suspicious activity
  # ‚úÖ Use strong LDAP admin password
  # ‚úÖ Implement rate limiting in Authelia to prevent brute force
  #
  # TROUBLESHOOTING:
  # - OIDC redirect errors: Check callback URL in app config matches Authelia client
  # - Forward-auth 401: Verify Caddy forward_auth config points to authelia:9091
  # - Group mapping issues: Check LDAP groups membership and Authelia claims mapping
  # - MFA problems: Verify TOTP time sync, check Authelia logs
  # - Session timeout: Adjust session expiration in Authelia configuration.yml
  #
  # ========================================
  # Client UI (human-facing apps)
  # ========================================

  # ======================
  # Monitoring - Grafana
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia via Generic OAuth (GF_AUTH_GENERIC_OAUTH_*)
  #       Callback: https://grafana.${DOMAIN}/login/generic_oauth
  #       Scopes: openid email profile groups
  #       Role Mapping: groups claim ‚Üí Admin/Editor/Viewer based on LDAP groups
  #         - admins group ‚Üí Grafana Admin
  #         - users group ‚Üí Grafana Editor
  #         - Others ‚Üí Grafana Viewer
  #
  # Authelia Client Config Required:
  #   client_id: grafana
  #   client_secret: ${GRAFANA_OAUTH_SECRET}
  #   redirect_uris: https://grafana.${DOMAIN}/login/generic_oauth
  #   scopes: openid profile email groups
  grafana:
    image: grafana/grafana:11.6.7
    container_name: grafana
    restart: unless-stopped
    networks:
      - backend
      - database
    user: "472:472"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: grafana.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      authelia:
        condition: service_healthy
    environment:
      - GF_DEFAULT_LOCALE=en_US
      - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN}
      - GF_SERVER_DOMAIN=grafana.${DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${GRAFANA_OAUTH_SECRET}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.${DOMAIN}/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authelia:9091/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authelia:9091/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'users') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.${DOMAIN}/logout
      - GF_AUTH_GENERIC_OAUTH_SKIP_ORG_ROLE_SYNC=false
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # AI Services
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OAUTH_CLIENT_ID, OPENID_PROVIDER_URL)
  #       Callback: https://open-webui.${DOMAIN}/oauth/oidc/callback
  #       Scopes: openid email profile groups
  #       Role Mapping: OAUTH_ADMIN_ROLES + OAUTH_ALLOWED_ROLES
  #         - admins, openwebui-admin ‚Üí Admin access
  #         - users ‚Üí User access
  #
  # Authelia Client Config Required:
  #   client_id: open-webui
  #   client_secret: ${OPENWEBUI_OAUTH_SECRET}
  #   redirect_uris: https://open-webui.${DOMAIN}/oauth/oidc/callback
  #   scopes: openid email profile groups
  open-webui:
    image: ghcr.io/open-webui/open-webui:0.3.32
    container_name: open-webui
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    dns:
      - 8.8.8.8
      - 1.1.1.1
    labels:
      caddy: open-webui.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
    depends_on:
      authelia:
        condition: service_healthy
    environment:
      - WEBUI_URL=https://open-webui.${DOMAIN}
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - OAUTH_CLIENT_ID=open-webui
      - OAUTH_CLIENT_SECRET=${OPENWEBUI_OAUTH_SECRET}
      - OPENID_PROVIDER_URL=https://auth.${DOMAIN}/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=Authelia
      - OAUTH_SCOPES=openid email profile groups
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_GROUPS_CLAIM=groups
      - OAUTH_ADMIN_ROLES=admins,openwebui-admin
      - OAUTH_ALLOWED_ROLES=admins,users,openwebui-admin
      - DEFAULT_USER_ROLE=user
      # LiteLLM now runs on separate AI VM - access via public HTTPS endpoint
      - OLLAMA_BASE_URL=https://litellm.${DOMAIN}
      - ENABLE_OPENAI_API=true
      - OPENAI_API_BASE_URL=https://litellm.${DOMAIN}
      - OPENAI_API_KEY=${LITELLM_MASTER_KEY}
    volumes:
      - open_webui_data:/app/backend/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s


  # ======================
  # Password Manager - Vaultwarden
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (SSO_AUTHORITY, SSO_CLIENT_ID, SSO_CLIENT_SECRET)
  #       Callback: https://vaultwarden.${DOMAIN}/identity/connect/oidc-signin
  #       Scopes: openid email profile
  #       Role Mapping: N/A (Vaultwarden manages vault access internally)
  #
  # IMPORTANT: Master password still required for vault encryption (E2E security)
  #            SSO only handles authentication, not vault decryption
  #            SSO_ONLY=false allows local accounts as backup
  #
  # Authelia Client Config Required:
  #   client_id: vaultwarden
  #   client_secret: ${VAULTWARDEN_OAUTH_SECRET}
  #   redirect_uris: https://vaultwarden.${DOMAIN}/identity/connect/oidc-signin
  #   scopes: openid email profile
  vaultwarden:
    image: vaultwarden/server:1.34.3
    container_name: vaultwarden
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: vaultwarden.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    depends_on:
      authelia:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    environment:
      - DOMAIN=https://vaultwarden.${DOMAIN}
      - SIGNUPS_ALLOWED=false
      - SIGNUPS_VERIFY=true
      - SIGNUPS_DOMAINS_WHITELIST=${MAIL_DOMAIN}
      - INVITATIONS_ALLOWED=true
      - SHOW_PASSWORD_HINT=false
      - SSO_ENABLED=true
      - SSO_ONLY=false
      - SSO_SIGNUPS_MATCH_EMAIL=true
      - SSO_AUTHORITY=https://auth.${DOMAIN}
      - SSO_ISSUER=https://auth.${DOMAIN}
      - SSO_CLIENT_ID=vaultwarden
      - SSO_CLIENT_SECRET=${VAULTWARDEN_OAUTH_SECRET}
      - SSO_SCOPES=openid email profile
      - SSO_CALLBACK_PATH=/identity/connect/oidc-signin
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      - SMTP_HOST=mailu-smtp
      - SMTP_FROM=vaultwarden@${MAIL_DOMAIN}
      - SMTP_PORT=587
      - SMTP_SECURITY=starttls
      - SMTP_USERNAME=vaultwarden@${MAIL_DOMAIN}
      - SMTP_PASSWORD=${VAULTWARDEN_SMTP_PASSWORD}
    volumes:
      - vaultwarden_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Project Management
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OIDC_* envs)
  #       Callback: https://planka.${DOMAIN}/oidc-callback
  #       Scopes: openid profile email groups
  #       Role Mapping: OIDC_ADMIN_ROLES='planka-admin' ‚Üí Admin access
  #
  # Authelia Client Config Required:
  #   client_id: planka
  #   client_secret: ${PLANKA_OAUTH_SECRET}
  #   redirect_uris: https://planka.${DOMAIN}/oidc-callback
  #   scopes: openid profile email groups
  planka:
    image: ghcr.io/plankanban/planka:1.26.3
    container_name: planka
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      caddy: planka.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 1337}}"
    depends_on:
      postgres:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - BASE_URL=https://planka.${DOMAIN}
      - DATABASE_URL=postgresql://planka:${PLANKA_DB_PASSWORD}@postgres:5432/planka
      - SECRET_KEY=${PLANKA_SECRET_KEY}
      - OIDC_ISSUER=https://auth.${DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=${PLANKA_OAUTH_SECRET}
      - OIDC_SCOPES=openid profile email groups
      - OIDC_ADMIN_ROLES=planka-admin
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    volumes:
      - planka_data:/app/public/user-avatars
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1337/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Wiki / Docs - Outline
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia (OIDC_CLIENT_ID, OIDC_*_URI)
  #       Callback: https://outline.${DOMAIN}/auth/oidc.callback
  #       Scopes: openid profile email offline_access
  #       Role Mapping: First user becomes admin, subsequent users need invite/permission
  #
  # Authelia Client Config Required:
  #   client_id: outline
  #   client_secret: ${OUTLINE_OAUTH_SECRET}
  #   redirect_uris: https://outline.${DOMAIN}/auth/oidc.callback
  #   scopes: openid offline_access profile email
  outline:
    image: outlinewiki/outline:0.87.3
    container_name: outline
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: outline.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - SECRET_KEY=${OUTLINE_SECRET_KEY}
      - UTILS_SECRET=${OUTLINE_UTILS_SECRET}
      - DATABASE_URL=postgres://outline:${OUTLINE_DB_PASSWORD}@postgres:5432/outline
      - PGSSLMODE=disable
      - REDIS_URL=redis://redis:6379
      - URL=https://outline.${DOMAIN}
      - PORT=3000
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=${OUTLINE_OAUTH_SECRET}
      - OIDC_AUTH_URI=https://auth.${DOMAIN}/api/oidc/authorization
      - OIDC_TOKEN_URI=http://authelia:9091/api/oidc/token
      - OIDC_USERINFO_URI=http://authelia:9091/api/oidc/userinfo
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Authelia
      - OIDC_SCOPES=openid offline_access profile email
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
    volumes:
      - outline_data:/var/lib/outline/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Files - Seafile + OnlyOffice
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (SEAFILE) + JWT (ONLYOFFICE)
  #       Seafile OIDC: Configured via seahub_settings.py (OAUTH_* envs)
  #         Provider: Authelia
  #         Callback: https://seafile.${DOMAIN}/oauth/callback/
  #         Scopes: openid email profile
  #         Note: Mount seahub_settings.py with OAUTH config or use env vars
  #       OnlyOffice: JWT-based integration with Seafile, no direct user login
  #       Memcached: Cache service for Seafile, no authentication
  #       MariaDB-Seafile: Dedicated database, password-protected, network isolated
  #
  # Seafile OIDC Configuration (add to configs/seafile/seahub_settings.py):
  #   ENABLE_OAUTH = True
  #   OAUTH_ENABLE_INSECURE_TRANSPORT = False
  #   OAUTH_CLIENT_ID = "seafile"
  #   OAUTH_CLIENT_SECRET = "${SEAFILE_OAUTH_SECRET}"
  #   OAUTH_REDIRECT_URL = "https://seafile.${DOMAIN}/oauth/callback/"
  #   OAUTH_PROVIDER_DOMAIN = "auth.${DOMAIN}"
  #   OAUTH_AUTHORIZATION_URL = "https://auth.${DOMAIN}/api/oidc/authorization"
  #   OAUTH_TOKEN_URL = "https://auth.${DOMAIN}/api/oidc/token"
  #   OAUTH_USER_INFO_URL = "https://auth.${DOMAIN}/api/oidc/userinfo"
  #   OAUTH_SCOPE = ["openid", "email", "profile"]
  #   OAUTH_ATTRIBUTE_MAP = {
  #       "email": (True, "email"),
  #       "name": (False, "name"),
  #       "id": (False, "sub"),
  #   }
  #
  # Authelia Client Config Required:
  #   client_id: seafile
  #   client_secret: ${SEAFILE_OAUTH_SECRET}
  #   redirect_uris: https://seafile.${DOMAIN}/oauth/callback/
  #   scopes: openid email profile
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - Memcached: Backend cache, no user interface
  #   - MariaDB-Seafile: Database backend, network isolated
  #   - OnlyOffice: Document editor, accessed via Seafile JWT
  memcached:
    image: memcached:1.6.39-alpine
    container_name: seafile-memcached
    restart: unless-stopped
    user: "11211:11211"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc localhost 11211"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mariadb-seafile:
    image: mariadb:11.6.2
    container_name: mariadb-seafile
    restart: unless-stopped
    user: "999:999"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    environment:
      - MYSQL_ROOT_PASSWORD=${MARIADB_SEAFILE_ROOT_PASSWORD}
      - MYSQL_DATABASE=seafile
      - MYSQL_USER=seafile
      - MYSQL_PASSWORD=${MARIADB_SEAFILE_PASSWORD}
    volumes:
      - seafile_mysql_data:/var/lib/mysql
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_SEAFILE_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  seafile:
    image: seafileltd/seafile-mc:13.0.12
    container_name: seafile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: seafile.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    depends_on:
      memcached:
        condition: service_healthy
      mariadb-seafile:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      - TZ=UTC
      - DB_HOST=mariadb-seafile
      - DB_ROOT_PASSWD=${MARIADB_SEAFILE_ROOT_PASSWORD}
      - SEAFILE_SERVER_HOSTNAME=seafile.${DOMAIN}
      - SEAFILE_ADMIN_EMAIL=${SEAFILE_ADMIN_EMAIL}
      - SEAFILE_ADMIN_PASSWORD=${SEAFILE_ADMIN_PASSWORD}
      - TIME_ZONE=UTC
    volumes:
      - seafile_data:/shared
      - ./configs/seafile/seahub_settings.py:/opt/seafile/conf/seahub_settings.py:ro
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  onlyoffice:
    image: onlyoffice/documentserver:8.2.2
    container_name: onlyoffice
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    labels:
      caddy: onlyoffice.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    environment:
      - TZ=UTC
      - JWT_ENABLED=true
      - JWT_SECRET=${ONLYOFFICE_JWT_SECRET}
      - JWT_HEADER=Authorization
    volumes:
      - onlyoffice_data:/var/www/onlyoffice/Data
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/healthcheck"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 2m

  # ======================
  # Matrix (Synapse)
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (WEB LOGIN) + üîì SELF-CONTAINED (FEDERATION)
  #       OIDC: Optional for web/Element login via Authelia (oidc_providers in homeserver.yaml)
  #       Callback: https://matrix.${DOMAIN}/_synapse/client/oidc/callback
  #       Scopes: openid
  #       Federation: Matrix protocol requires local user accounts (@user:matrix.${DOMAIN})
  #       Note: OIDC authenticates web access, but Matrix ID remains on local server
  #       Redis-synapse: Session cache for Synapse, no authentication
  #
  # Synapse OIDC Configuration (add to configs/synapse/homeserver.yaml):
  #   oidc_providers:
  #     - idp_id: authelia
  #       idp_name: "Authelia SSO"
  #       issuer: "https://auth.${DOMAIN}"
  #       client_id: "synapse"
  #       client_secret: "${SYNAPSE_OAUTH_SECRET}"
  #       scopes: ["openid"]
  #       user_mapping_provider:
  #         config:
  #           localpart_template: "{{ user.preferred_username }}"
  #           display_name_template: "{{ user.name }}"
  #
  # Authelia Client Config Required:
  #   client_id: synapse
  #   client_secret: ${SYNAPSE_OAUTH_SECRET}
  #   redirect_uris: https://matrix.${DOMAIN}/_synapse/client/oidc/callback
  #   scopes: openid
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - Redis-synapse: Backend cache, no user interface
  redis-synapse:
    image: redis:7.4.7-alpine
    container_name: redis-synapse
    restart: unless-stopped
    user: "999:999"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  synapse:
    image: matrixdotorg/synapse:v1.141.0
    container_name: synapse
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: matrix.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8008}}"
    depends_on:
      redis-synapse:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - SYNAPSE_SERVER_NAME=matrix.${DOMAIN}
      - SYNAPSE_REPORT_STATS=yes
      - SYNAPSE_ENABLE_REGISTRATION=${MATRIX_ENABLE_REGISTRATION:-false}
      - SYNAPSE_TRUSTED_PROXIES=172.18.0.0/16,172.21.0.0/24
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=synapse
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=${SYNAPSE_DB_PASSWORD}
      - REDIS_HOST=redis-synapse
    volumes:
      - synapse_data:/data
      - ./configs/synapse/homeserver.yaml:/data/homeserver.yaml:ro
      - ./configs/synapse/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    networks:
      - backend
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ======================
  # Mail - Mailu stack
  # ======================
  # Auth: ‚úÖ OIDC HEADER AUTH (ADMIN UI) + üîì SELF-CONTAINED (MAIL PROTOCOLS)
  #       Admin UI: OIDC via reverse proxy header authentication (Mailu 2024.06+)
  #         Configure Caddy to inject authentication headers from Authelia
  #         Mailu reads X-Remote-User header for SSO authentication
  #       SMTP/IMAP/POP3: Direct username+password authentication (no SSO possible)
  #       Webmail (Roundcube): Authenticates against Mailu IMAP backend
  #       Redis: Internal cache for Mailu services
  #
  # Mailu Header Auth Configuration (mailu.env):
  #   PROXY_AUTH_HEADER=X-Remote-User
  #   PROXY_AUTH_CREATE=True
  #   PROXY_AUTH_WHITELIST=172.18.0.0/16
  #
  # Caddy Configuration (add forward_auth to mail.${DOMAIN} route):
  #   forward_auth authelia:9091 {
  #     uri /api/verify?rd=https://auth.${DOMAIN}
  #     copy_headers Remote-User Remote-Email
  #   }
  #
  # Note: Mail protocols (SMTP/IMAP) CANNOT use SSO due to protocol limitations
  #       Users must use traditional email+password for mail clients
  #       SSO only applies to web admin UI and webmail via browser
  #
  # Authelia ACL Policy Required:
  #   - domain: mail.${DOMAIN}
  #     policy: two_factor
  #     subject: group:admins
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - Mailu-redis: Backend cache, no user interface
  #   - Mailu-antivirus, antispam: Mail processing, no direct access
  mailu-front:
    image: ghcr.io/mailu/nginx:2024.06.45
    container_name: mailu-front
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    labels:
      caddy: mail.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 80}}"
    env_file:
      - configs/mailu/mailu.env
    ports:
      - "25:25"
      - "465:465"
      - "587:587"
      - "110:110"
      - "995:995"
      - "143:143"
      - "993:993"
    volumes:
      - mailu_cert:/certs
      - mailu_dkim:/dkim
    networks:
      - mail
      - test
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-redis:
    image: redis:7.4.7-alpine
    container_name: mailu-redis
    restart: unless-stopped
    user: "999:999"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      mail:
        aliases:
          - redis
          - mailu-redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  mailu-antispam:
    image: ghcr.io/mailu/rspamd:2024.06.45
    container_name: mailu-antispam
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_filter:/var/lib/rspamd
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "rspamc", "stat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-antivirus:
    image: ghcr.io/mailu/clamav:2.0.43
    container_name: mailu-antivirus
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
    env_file:
      - configs/mailu/mailu.env
    networks:
      - mail
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "1"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 5m

  mailu-imap:
    image: ghcr.io/mailu/dovecot:2024.06.45
    container_name: mailu-imap
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "doveadm", "director", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-smtp:
    image: ghcr.io/mailu/postfix:2024.06.45
    container_name: mailu-smtp
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
      - mailu_dkim:/dkim
    networks:
      - mail
      - backend
    depends_on:
      mailu-admin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "postfix", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mailu-admin:
    image: ghcr.io/mailu/admin:2024.06.45
    container_name: mailu-admin
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - mailu_data:/data
    networks:
      - mail
    depends_on:
      postgres:
        condition: service_healthy
      mailu-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "-L", "http://localhost:8080/admin/ui"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  mailu-webmail:
    image: ghcr.io/mailu/webmail:2024.06.45
    container_name: mailu-webmail
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    env_file:
      - configs/mailu/mailu.env
    volumes:
      - ./configs/mailu/nginx-override.conf:/overrides/nginx/roundcube.conf:ro
    networks:
      - mail
    depends_on:
      mailu-admin:
        condition: service_healthy
      mailu-imap:
        condition: service_healthy
      mailu-front:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Groupware - SOGo
  # ======================
  # Auth: üîì SELF-CONTAINED (IMAP/SMTP AUTH) - ‚ö†Ô∏è NO OIDC SUPPORT
  #       SOGo: Authenticates users against Mailu IMAP backend
  #       SOGO_MAIL_SERVER: mailu-imap (SOGo proxies login to mail server)
  #       No separate user database - uses Mailu user accounts
  #       SAML: SOGo supports SAML SSO (not OIDC), but complex config required
  #       Why not OIDC: SOGo does NOT support OpenID Connect (SAML only)
  #       User management: Create users in Mailu, SOGo recognizes them automatically
  #
  # Alternative: Could configure SOGo SAML with Authelia (requires authelia SAML support)
  #   But SAML config is complex and provides minimal benefit for groupware use case
  #   Prefer: Protect SOGo route with Caddy forward-auth for extra security layer
  #
  # Recommended Caddy Config (optional extra auth):
  #   forward_auth authelia:9091 {
  #     uri /api/verify?rd=https://auth.${DOMAIN}
  #   }
  #   Then SOGo still requires IMAP credentials after SSO gate
  #
  # ‚õî NO AUTH (Supporting Services):
  #   - SOGo data volume: File storage, no interface
  sogo:
    image: pmietlicki/sogo:v5
    container_name: sogo
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    labels:
      caddy: sogo.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 20000}}"
    environment:
      - SOGO_WORKERS=1
      - SOGO_SIEVE_SCRIPTS_ENABLED=YES
      - SOGO_DOMAIN=${MAIL_DOMAIN}
      - SOGO_WEB_LOGIN_ENABLE_EMAIL_LOGIN=YES
      - SOGO_MAIL_SERVER=mailu-imap
      - SOGO_SOGOIMAPSERVERS=mailu-imap:143
      - SOGO_SOGOSMTPSERVERS=mailu-smtp:587
      - SOGO_SOGoSMTPAuthenticationType=PLAIN
      - SOGO_SOGoIMAPServer=imap
      - TZ=UTC
    volumes:
      - sogo_data:/var/lib/sogo
    depends_on:
      mailu-imap:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    networks:
      - backend
      - mail
      - test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:20000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Microblog - Mastodon
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD) + üîì SELF-CONTAINED (FEDERATION)
  #       OIDC Provider: Authelia via OmniAuth OpenID Connect
  #       Callback: https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
  #       Scopes: openid profile email
  #       Federation: ActivityPub requires local user accounts (@user@mastodon.${DOMAIN})
  #       Note: OIDC authenticates web access, but Mastodon ID remains on local server
  #
  # Mastodon OIDC Configuration (via environment variables):
  #   OIDC_ENABLED=true
  #   OIDC_DISPLAY_NAME=Authelia
  #   OIDC_ISSUER=https://auth.${DOMAIN}
  #   OIDC_DISCOVERY=true
  #   OIDC_SCOPE=openid profile email
  #   OIDC_UID_FIELD=sub
  #   OIDC_CLIENT_ID=mastodon
  #   OIDC_CLIENT_SECRET=${MASTODON_OIDC_SECRET}
  #   OIDC_REDIRECT_URI=https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
  #
  # Authelia Client Config Required:
  #   client_id: mastodon
  #   client_secret: ${MASTODON_OIDC_SECRET}
  #   redirect_uris: https://mastodon.${DOMAIN}/auth/auth/openid_connect/callback
  #   scopes: openid profile email
  #
  # Architecture: 3-container stack (web, streaming, sidekiq)
  #   - mastodon-web: Rails web server (port 3000)
  #   - mastodon-streaming: Node.js WebSocket server
  #   - mastodon-sidekiq: Background job processor
  mastodon-web:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-web
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
      - backend
      - test
    labels:
      caddy: mastodon.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      authelia:
        condition: service_healthy
      mailu-smtp:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: bash -c "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000 -b 0.0.0.0"
    volumes:
      - mastodon_data:/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --proxy=off localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mastodon-streaming:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-streaming
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - backend
      - test
    depends_on:
      mastodon-web:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: node ./streaming
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --proxy=off localhost:4000/api/v1/streaming/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mastodon-sidekiq:
    image: ghcr.io/mastodon/mastodon:v4.3.3
    container_name: mastodon-sidekiq
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      - backend
    depends_on:
      mastodon-web:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - configs/mastodon/mastodon.env
    command: bundle exec sidekiq
    volumes:
      - mastodon_data:/mastodon/public/system
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[s]idekiq 6' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Mastodon Init - Auto-setup database and generate keys
  # ======================
  mastodon-init:
    image: docker:27-cli
    container_name: mastodon-init
    networks:
      - backend
    depends_on:
      mastodon-web:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts/init-mastodon.sh:/init-mastodon.sh:ro
    command: sh /init-mastodon.sh
    restart: "no"



  # ======================
  # Dashboard - Homepage
  # ======================
  # Auth: üîí FORWARD AUTH (NO NATIVE OIDC)
  #       Homepage: Does NOT support native OIDC (feature requested but not implemented)
  #       Solution: Caddy forward_auth ‚Üí Authelia protects entire route
  #       Access Control: Configure Authelia ACL policy to allow 'users' + 'admins' groups
  #
  # Caddy Configuration Required:
  #   homepage.${DOMAIN} {
  #     forward_auth authelia:9091 {
  #       uri /api/verify?rd=https://auth.${DOMAIN}
  #       copy_headers Remote-User Remote-Email
  #     }
  #     reverse_proxy homepage:3000
  #   }
  #
  # Authelia ACL Policy Required:
  #   - domain: homepage.${DOMAIN}
  #     policy: one_factor
  #     subject:
  #       - group:users
  #       - group:admins
  #
  # Note: Homepage has no concept of logged-in user, it's a dashboard
  #       Forward-auth simply gates access, doesn't provide personalization
  homepage:
    image: ghcr.io/gethomepage/homepage:v1.7.0
    container_name: homepage
    restart: unless-stopped
    networks:
      - backend
      - admin
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      caddy: homepage.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 3000}}"
    environment:
      - PUID=1000
      - PGID=1000
      - HOMEPAGE_ALLOWED_HOSTS=homepage.${DOMAIN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/homepage/services.yaml:/app/config/services.yaml:ro
      - ./configs/homepage/settings.yaml:/app/config/settings.yaml:ro
      - ./configs/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - ./configs/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ./configs/homepage/docker.yaml:/app/config/docker.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ======================
  # JupyterHub
  # ======================
  # Auth: ‚úÖ NATIVE OIDC (PREFERRED METHOD)
  #       OIDC Provider: Authelia via GenericOAuthenticator
  #       Callback: https://jupyterhub.${DOMAIN}/hub/oauth_callback
  #       Scopes: openid email groups
  #       Role Mapping: groups claim ‚Üí admin_users list in jupyterhub_config.py
  #         - admins group ‚Üí JupyterHub admin access
  #
  # Authelia Client Config Required:
  #   client_id: jupyterhub
  #   client_secret: ${JUPYTERHUB_OAUTH_SECRET}
  #   redirect_uris: https://jupyterhub.${DOMAIN}/hub/oauth_callback
  #   scopes: openid email groups
  jupyterhub:
    build:
      context: configs/jupyterhub
      dockerfile: configs/jupyterhub/Dockerfile
    container_name: jupyterhub
    restart: unless-stopped
    networks:
      - backend
      - admin
      - admin-jupyterhub
    labels:
      caddy: jupyterhub.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8000}}"
    depends_on:
      authelia:
        condition: service_healthy
      docker-proxy:
        condition: service_started
    environment:
      - DOMAIN=${DOMAIN}
      - JUPYTERHUB_OAUTH_SECRET=${JUPYTERHUB_OAUTH_SECRET}
      - DOCKER_HOST=tcp://docker-proxy:2375
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./configs/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/hub/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Container Management - Dockge
  # ======================
  # Auth: üîí FORWARD AUTH (NO NATIVE OIDC) - ADMIN ONLY
  #       Dockge: Does NOT support native OIDC authentication
  #       Solution: Caddy forward_auth ‚Üí Authelia protects route (admin access only)
  #       Dockge User: Still create local admin account (DOCKGE_ADMIN_USER)
  #         Forward-auth acts as outer security gate
  #         Dockge login acts as inner security confirmation
  #
  # Caddy Configuration Required:
  #   dockge.${DOMAIN} {
  #     forward_auth authelia:9091 {
  #       uri /api/verify?rd=https://auth.${DOMAIN}
  #       copy_headers Remote-User Remote-Email
  #     }
  #     reverse_proxy dockge:5001
  #   }
  #
  # Authelia ACL Policy Required (RESTRICT TO ADMINS):
  #   - domain: dockge.${DOMAIN}
  #     policy: two_factor
  #     subject: group:admins
  #
  # Security: Two-layer auth (Authelia SSO + Dockge local login)
  #           Prevents unauthorized container manipulation
  dockge:
    image: louislam/dockge:1
    container_name: dockge
    restart: unless-stopped
#    user: "1000:1000"
    networks:
      - admin
      - admin-dockge
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      caddy: dockge.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 5001}}"
    depends_on:
      - docker-proxy
    volumes:
      - dockge_data:/app/data
      - /home/gerald/Documents/IdeaProjects/Datamancy:/opt/stacks
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks
      - DOCKER_HOST=tcp://docker-proxy:2375
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 10s

  # ======================
  # Dockge Init - Auto-create admin account
  # ======================
  dockge-init:
    image: node:20.18.1-alpine
    container_name: dockge-init
    networks:
      - admin
    depends_on:
      dockge:
        condition: service_healthy
    volumes:
      - ./scripts/init-dockge.js:/init-dockge.js:ro
    environment:
      - DOCKGE_HOST=dockge
      - DOCKGE_PORT=5001
      - DOCKGE_ADMIN_USER=${STACK_ADMIN_USER}
      - DOCKGE_ADMIN_PASSWORD=${STACK_ADMIN_PASSWORD}
    command: node /init-dockge.js
    restart: "no"

  # ======================
  # Backup - Kopia
  # ======================
  # Auth: üîí FORWARD AUTH (NO NATIVE OIDC) - ADMIN ONLY
  #       Kopia: Does NOT support OIDC (uses HTTP Basic Auth by default)
  #       Solution: Caddy forward_auth ‚Üí Authelia protects route (admin access only)
  #       Kopia Server: Configure with --server-username/--server-password
  #         Forward-auth acts as outer SSO gate
  #         Kopia Basic Auth acts as inner security layer
  #
  # Caddy Configuration Required:
  #   kopia.${DOMAIN} {
  #     forward_auth authelia:9091 {
  #       uri /api/verify?rd=https://auth.${DOMAIN}
  #       copy_headers Remote-User Remote-Email
  #     }
  #     reverse_proxy kopia:51515
  #   }
  #
  # Authelia ACL Policy Required (RESTRICT TO ADMINS):
  #   - domain: kopia.${DOMAIN}
  #     policy: two_factor
  #     subject: group:admins
  #
  # Security: Backup access should be heavily restricted
  #           Two-factor auth + admin group required
  #           Consider disabling Kopia UI entirely for production
  kopia:
    image: kopia/kopia:0.18.2
    container_name: kopia
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - admin
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    labels:
      caddy: kopia.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 51515}}"
    volumes:
      - kopia_data:/app/config
      - kopia_cache:/app/cache
      - kopia_data:/data:ro
      - kopia_repository:/repository
      - ./scripts/init-kopia.sh:/init-kopia.sh:ro
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - KOPIA_REPO_PATH=/repository
      - USER=kopia
    entrypoint: /init-kopia.sh
    healthcheck:
      test: ["CMD", "kopia", "repository", "status"]
      interval: 5m
      timeout: 30s
      retries: 3
      start_period: 1m


  # ========================================
  # Public API / Edge (externally reachable programmatic endpoints)
  # ========================================

  # ======================
  # AI Gateway - LiteLLM (OpenAI-compatible API)
  # ======================
  # MOVED TO: docker-compose.ai.yml (runs on separate AI VM)
  #
  # Caddy still proxies litellm.${DOMAIN} ‚Üí AI_VM_IP:4000
  # Authelia still provides OIDC for litellm (via HTTPS endpoints)
  #
  # To route traffic to AI VM, configure Caddy with:
  #   litellm.${DOMAIN} {
  #     reverse_proxy http://${AI_VM_IP}:4000
  #   }
  # OR add label to external service if using docker-proxy pattern

  # ======================
  # SSO - Authelia (OIDC/OAuth endpoints; has a login UI)
  # ======================
  authelia:
    image: authelia/authelia:4.39.13
    container_name: authelia
    restart: unless-stopped
    user: "1000:1000"
    networks:
      - auth
      - backend
    labels:
      caddy: auth.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 9091}}"
    depends_on:
      ldap:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./volumes/authelia:/config
      - ./configs/authelia/configuration.yml:/config/configuration.yml:ro
      - ./configs/authelia/issuer.key:/config/issuer.key:ro
      - ./configs/authelia/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    command: ["--config", "/config/configuration.yml"]
    environment:
      - TZ=UTC
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET=${AUTHELIA_OIDC_HMAC_SECRET}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE=/config/issuer.key
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER=https://auth.${DOMAIN}
      - AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD=${LDAP_ADMIN_PASSWORD}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # Reverse Proxy - Caddy Docker Proxy (auto-generated config from labels)
  # ======================
  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.8
    container_name: caddy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    networks:
      frontend:
      backend:
        aliases:
          - grafana.${DOMAIN}
          - open-webui.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - outline.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - sogo.${DOMAIN}
          - homeassistant.${DOMAIN}
          - akkoma.${DOMAIN}
          - litellm.${DOMAIN}
      auth:
        aliases:
          - auth.${DOMAIN}
      admin:
        aliases:
          - kopia.${DOMAIN}
          - adminer.${DOMAIN}
          - pgadmin.${DOMAIN}
          - portainer.${DOMAIN}
      mail:
        aliases:
          - mail.${DOMAIN}
      test:
        aliases:
          - grafana.${DOMAIN}
          - auth.${DOMAIN}
          - adminer.${DOMAIN}
          - pgadmin.${DOMAIN}
          - portainer.${DOMAIN}
          - localai.${DOMAIN}
          - litellm.${DOMAIN}
          - open-webui.${DOMAIN}
          - browserless.${DOMAIN}
          - homeassistant.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - planka.${DOMAIN}
          - outline.${DOMAIN}
          - kopia.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
          - seafile.${DOMAIN}
          - onlyoffice.${DOMAIN}
          - matrix.${DOMAIN}
          - sogo.${DOMAIN}
          - mail.${DOMAIN}
          - akkoma.${DOMAIN}
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - CADDY_INGRESS_NETWORKS=frontend backend auth admin mail test
      - ACME_AGREE=true
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s


  # ========================================
  # Internal only (backing services, pipes, or test-only)
  # ========================================

  # ======================
  # LDAP Directory
  # ======================
  # Auth: N/A - Backend service, no user-facing UI
  #       Authelia binds as cn=admin to authenticate users
  #       LDAP Account Manager provides admin UI (protected by Caddy forward-auth)
  #       Direct LDAP binding by apps discouraged; use Authelia OIDC instead
  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - auth
    environment:
      - LDAP_ORGANISATION=Datamancy
      - LDAP_DOMAIN=stack.local
      - LDAP_BASE_DN=dc=stack,dc=local
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}
      - LDAP_TLS=false
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./configs/ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap.ldif:ro
    command: --copy-service --loglevel debug
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost:389", "-b", "dc=stack,dc=local", "-D", "cn=admin,dc=stack,dc=local", "-w", "${LDAP_ADMIN_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ======================
  # LDAP Account Manager
  # ======================
  # Auth: Caddy forward-auth to Authelia (restrict to 'admins' group)
  #       LAM_PASSWORD protects config pages (separate from user auth)
  #       Manages LDAP users/groups that Authelia uses for authentication
  ldap-account-manager:
    image: ghcr.io/ldapaccountmanager/lam:9.3
    container_name: ldap-account-manager
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - auth
      - admin
    labels:
      caddy: lam.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 80}}"
    depends_on:
      ldap:
        condition: service_healthy
    environment:
      - LDAP_DOMAIN=stack.local
      - LDAP_BASE_DN=dc=stack,dc=local
      - LDAP_USER=cn=admin,dc=stack,dc=local
      - LDAP_PASSWORD=${LDAP_ADMIN_PASSWORD}
      - LAM_PASSWORD=${LAM_PASSWORD:-lam}
      - LAM_LANG=en_US
    volumes:
      - lam_config:/var/lib/ldap-account-manager
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/lam/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ======================
  # Redis (Session Store)
  # ======================
  # Auth: N/A - Backend service, no user access
  #       Used by Authelia, Outline, Synapse for session/cache storage
  #       Network isolated, no authentication required
  redis:
    image: redis:7.4.7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - auth
      - backend
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ======================
  # Databases
  # ======================
  # Auth: ‚õî NO AUTH (BACKEND SERVICES)
  #       MariaDB, PostgreSQL: Database servers, no user interface
  #       Authentication: Username+password per database (set in .env)
  #       Network Security: Isolated to 'stack' network, not exposed via Caddy
  #       Access: Applications connect with service-specific credentials
  #       Admin Access: Use database clients (Adminer, pgAdmin) with credentials
  #       Data: May contain user accounts for self-contained apps (Seafile, Mailu, etc.)
  #
  # Security Notes:
  #   - Never expose database ports publicly
  #   - Use strong passwords for root/admin accounts
  #   - Regularly backup database volumes
  #   - Consider encryption at rest for sensitive data
  #
  # ‚õî NO AUTH (Supporting Databases):
  #   - CouchDB: Document store for internal use, admin credentials in .env
  #   - ClickHouse: Analytics database, password-protected but not SSO-enabled
  #   - Redis: In-memory cache/session store, no authentication (network isolated)

  mariadb:
    image: mariadb:11.6.2
    container_name: mariadb
    restart: unless-stopped
    networks:
      - database
    environment:
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_DATABASE=datamancy
      - MYSQL_USER=datamancy
      - MYSQL_PASSWORD=${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/mariadb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  postgres:
    image: postgres:16.11-alpine
    container_name: postgres
    restart: unless-stopped
    networks:
      database:
        aliases:
          - db
      backend:
      mail:
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - PLANKA_DB_PASSWORD=${PLANKA_DB_PASSWORD}
      - OUTLINE_DB_PASSWORD=${OUTLINE_DB_PASSWORD}
      - SYNAPSE_DB_PASSWORD=${SYNAPSE_DB_PASSWORD}
      - AKKOMA_DB_PASSWORD=${AKKOMA_DB_PASSWORD}
      - MAILU_DB_PASSWORD=${MAILU_DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./configs/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
      - ./configs/postgres/init-mailu-schema.sql:/docker-entrypoint-initdb.d/init-mailu-schema.sql:ro
    command: postgres -c 'max_connections=200'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  couchdb:
    image: couchdb:3.5.1
    container_name: couchdb
    restart: unless-stopped
    networks:
      - database
    labels:
      caddy: couchdb.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 5984}}"
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - ./configs/couchdb/init-wrapper.sh:/usr/local/bin/init-wrapper.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/init-wrapper.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:5984/_up | grep -q '\"status\":\"ok\"' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: clickhouse
    restart: unless-stopped
    networks:
      - database
    labels:
      caddy: clickhouse.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 8123}}"
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./configs/clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================
  # AI Services (Internal)
  # ======================
  # MOVED TO: docker-compose.ai.yml (runs on separate AI VM)
  #
  # LocalAI runs on AI VM, accessed by LiteLLM internally
  # For direct access (debugging), Caddy can proxy localai.${DOMAIN} ‚Üí AI_VM_IP:8080
  #
  # To route traffic to AI VM, configure Caddy with:
  #   localai.${DOMAIN} {
  #     forward_auth authelia:9091 {
  #       uri /api/authz/forward-auth
  #       copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
  #     }
  #     reverse_proxy http://${AI_VM_IP}:8080
  #   }

  # ======================
  # Data Processing
  # ======================
  # Auth: N/A - Internal data pipeline, no user interface
  #       Configuration-driven ETL, no authentication layer
  #       Not exposed externally, operates on internal events/streams

  benthos:
    image: jeffail/benthos:4.27.0
    container_name: benthos
    restart: unless-stopped
    networks:
      - backend
      - database
    labels:
      caddy: benthos.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 4195}}"
    volumes:
      - ./configs/benthos/benthos.yaml:/benthos.yaml:ro
      - benthos_data:/data
    command: -c /benthos.yaml
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4195/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ======================
  # Docker Socket Proxy
  # ======================
  # Auth: N/A - Internal service, network-level access control
  #       Provides limited Docker API access to Dockge/JupyterHub
  #       No authentication, relies on network isolation (stack network only)
  #       Environment variables restrict allowed operations (read-only where possible)
  # Docker Socket Proxy - provides controlled API access
  # Uses rootless socket in dev, standard socket in prod
  docker-proxy:
    image: tecnativa/docker-socket-proxy:v0.4.1
    container_name: docker-proxy
    restart: unless-stopped
    networks:
      - admin
      - admin-dockge
      - admin-jupyterhub
    environment:
      - CONTAINERS=1
      - IMAGES=1
      - NETWORKS=1
      - VOLUMES=1
      - POST=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - INFO=1
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VERSION=1
    volumes:
      # Rootless Docker (dev): /run/user/1000/docker.sock
      # Root Docker (prod): /var/run/docker.sock
      - ${DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:2375/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ======================
  # Test Runner Container
  # ======================
  # Isolated on test network - routes ALL traffic through Caddy like a real client
  # DNS resolution handled by Docker network aliases on Caddy
  test-runner:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-runner
    profiles:
      - testing
    networks:
      - test
      - backend
    depends_on:
      caddy:
        condition: service_healthy
    volumes:
      - ./tests:/tests:ro
      - ./screenshots:/screenshots:rw
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    environment:
      - NODE_ENV=test
      - CI=true
      - LANG=en_US.UTF-8
      - LC_ALL=en_US.UTF-8
      - NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/caddy-ca.crt
      - TEST_USERNAME=admin
      - TEST_PASSWORD=DatamancyTest2025!
      - SCREEN_DIR=/screenshots
    restart: "no"
    command: >
      sh -c 'set -eu &&
      update-ca-certificates 2>/dev/null || true &&
      printf "%s test-runner: starting webui.e2e\n" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" &&
      node /tests/webui.e2e.js'

  # ======================
  # Home Automation - Home Assistant
  # ======================
  # Auth: ‚úÖ NATIVE OIDC via hass-oidc-auth + Authelia (PREFERRED)
  #       Identity source: LDAP (via Authelia backend)
  #
  # Why this pattern (2025 best practice):
  #   - Home Assistant has no native OIDC, so we use the community
  #     "OpenID Connect for Home Assistant" integration (hass-oidc-auth, via HACS). :contentReference[oaicite:0]{index=0}
  #   - Authelia acts as OIDC provider backed by OpenLDAP, so HA logins
  #     inherit LDAP users, groups and MFA from Authelia. :contentReference[oaicite:1]{index=1}
  #   - No Caddy forward_auth here: HA talks OIDC directly to Authelia.
  #     This keeps mobile apps and WebSockets happy.
  #
  # OIDC callback URL (hass-oidc-auth):
  #   https://homeassistant.${DOMAIN}/auth/oidc/callback
  #
  # Authelia client (configuration.yml ‚Äì example):
  #   identity_providers:
  #     oidc:
  #       clients:
  #         - client_id: 'home-assistant'
  #           client_name: 'Home Assistant'
  #           client_secret: <hashed or env-derived secret>
  #           public: false
  #           require_pkce: true
  #           pkce_challenge_method: S256
  #           authorization_policy: two_factor
  #           redirect_uris:
  #             - https://homeassistant.${DOMAIN}/auth/oidc/callback
  #           scopes: [openid, profile, groups]
  #           grant_types: [authorization_code]
  #
  # HA configuration.yaml (minimal OIDC + proxy hardening):
  #   auth_oidc:
  #     client_id: "home-assistant"
  #     client_secret: !secret authelia_homeassistant_client_secret
  #     discovery_url: "https://auth.${DOMAIN}/.well-known/openid-configuration"
  #     display_name: "Authelia"
  #     roles:
  #       admin: "admins"   # LDAP 'admins' group ‚Üí HA admin role :contentReference[oaicite:2]{index=2}
  #
  #   http:
  #     use_x_forwarded_for: true
  #     trusted_proxies:
  #       - 172.21.0.0/24   # Caddy on backend network
  #
  #   homeassistant:
  #     external_url: "https://homeassistant.${DOMAIN}"
  #     internal_url: "http://homeassistant:8123"
  #
  # Security notes:
  #   - Admin access controlled by Authelia group mapping (admins/users).
  #   - Keep at least one local HA owner account as break-glass login.
  #   - Rely on Authelia for MFA; you can still enable HA‚Äôs own 2FA if you like.
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    networks:
      - backend
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    labels:
      caddy: homeassistant.${DOMAIN}
      caddy.forward_auth: "authelia:9091"
      caddy.forward_auth.uri: "/api/authz/forward-auth"
      caddy.forward_auth.copy_headers: "Remote-User Remote-Groups Remote-Name Remote-Email"
      caddy.reverse_proxy: "{{upstreams 8123}}"
    depends_on:
      authelia:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - TZ=UTC        # or your local TZ, e.g. Australia/Hobart
    volumes:
      - homeassistant_config:/config
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
