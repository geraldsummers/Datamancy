# Datamancy Stack â€” Phase 0.5 Complete
# Provenance: Caddy + docker-socket-proxy + multi-hostname no-DNS architecture
# Architecture: Caddy front door, local CA, rootless Docker, freshness automation
#
# Networks:
#   - frontend: Public-facing services (Caddy, exposed UIs)
#   - backend: Internal services (metrics, logs, datastores)
#   - socket: Restricted Docker socket access

networks:
  frontend:
    name: datamancy_frontend
  backend:
    name: datamancy_backend
  socket:
    name: datamancy_socket
    internal: true

volumes:
  caddy_data:
  caddy_config:

services:
  # --- Docker Socket Proxy (least privilege) ---
  # Provenance: Caddy needs container discovery; restrict socket access
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:0.1.2
    container_name: docker-socket-proxy
    restart: unless-stopped
    networks:
      - socket
    volumes:
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
    environment:
      # Only allow read operations needed by caddy-docker-proxy
      CONTAINERS: 1
      NETWORKS: 1
      SERVICES: 0
      TASKS: 0
      POST: 0
    profiles:
      - core

  # --- Caddy Reverse Proxy (front door) ---
  # Provenance: Multi-hostname *.stack.local, automatic label-based routing
  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.9
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      - frontend
      - backend
      - socket
    volumes:
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro  # Label discovery
      - caddy_data:/data
      - caddy_config:/config
      - ./certs:/certs:ro
    environment:
      CADDY_DOCKER_CADDYFILE_PATH: /etc/caddy/Caddyfile
      CADDY_DOCKER_LABEL_PREFIX: caddy
    labels:
      caddy: "*.${STACK_HOST:-stack.local}"
      caddy.tls: "/certs/wildcard.crt /certs/wildcard.key"
    profiles:
      - core

  # --- Docs Indexer (fingerprint tracker) ---
  # Provenance: Phase 0.5 freshness automation
  docs-indexer:
    build:
      context: ./tools/docs-indexer
      dockerfile: Dockerfile
    container_name: docs-indexer
    volumes:
      - ./docker-compose.yml:/app/docker-compose.yml:ro
      - ./configs:/app/configs:ro
      - ./docs:/app/docs:rw
      - ./data:/app/data:ro
      - ./.git:/app/.git:ro
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
    profiles:
      - tools

  # --- MkDocs Material Site Builder ---
  # Provenance: Phase 0.5 documentation site
  mkdocs:
    build:
      context: ./tools/mkdocs
      dockerfile: Dockerfile
    container_name: mkdocs
    volumes:
      - ./docs:/docs/docs:ro
      - ./mkdocs.yml:/docs/mkdocs.yml:ro
      - ./site:/docs/site:rw
    working_dir: /docs
    command: build
    profiles:
      - tools
