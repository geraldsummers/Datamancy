networks:
  stack:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16

volumes:
  caddy_data:
  caddy_config:
  grafana_data:
  ldap_data:
  ldap_config:
  authelia_data:
  mariadb_data:
  postgres_data:
  couchdb_data:
  clickhouse_data:
  portainer_data:
  localai_models:
  open_webui_data:
  kopia_data:
  kopia_cache:
  nextcloud_data:
  vaultwarden_data:
  redis_data:
  jellyfin_config:
  jellyfin_media:
  homeassistant_config:
  planka_data:
  outline_data:
  benthos_data:

services:

  # ======================
  # Reverse Proxy - Caddy
  # ======================
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    networks:
      stack:
        aliases:
          - grafana.stack.local
          - auth.stack.local
          - adminer.stack.local
          - pgadmin.stack.local
          - portainer.stack.local
          - localai.stack.local
          - open-webui.stack.local
          - browserless.stack.local
          - nextcloud.stack.local
          - vaultwarden.stack.local
          - jellyfin.stack.local
          - homeassistant.stack.local
          - planka.stack.local
          - outline.stack.local
          - kopia.stack.local
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - ACME_AGREE=true

  # ======================
  # LDAP Directory
  # ======================
  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    restart: unless-stopped
    networks:
      - stack
    environment:
      - LDAP_ORGANISATION=Datamancy
      - LDAP_DOMAIN=stack.local
      - LDAP_BASE_DN=dc=stack,dc=local
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}
      - LDAP_TLS=false
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./configs/ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap.ldif:ro
    command: --copy-service --loglevel debug

  # ======================
  # SSO - Authelia
  # ======================
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - ldap
      - redis
    volumes:
      - authelia_data:/config
      - ./configs/authelia/configuration.yml:/config/configuration.yml:ro
      - ./configs/authelia/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    command: ["--config", "/config/configuration.yml"]
    environment:
      - TZ=UTC
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET=${AUTHELIA_OIDC_HMAC_SECRET}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY=${AUTHELIA_OIDC_ISSUER_PRIVATE_KEY}
      - AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD=${LDAP_ADMIN_PASSWORD}

  # ======================
  # Redis (Session Store)
  # ======================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # ======================
  # Databases
  # ======================
  mariadb:
    image: mariadb:11
    container_name: mariadb
    restart: unless-stopped
    networks:
      - stack
    environment:
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_DATABASE=datamancy
      - MYSQL_USER=datamancy
      - MYSQL_PASSWORD=${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/mariadb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    networks:
      - stack
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: postgres -c 'max_connections=200'

  couchdb:
    image: couchdb:3
    container_name: couchdb
    restart: unless-stopped
    networks:
      - stack
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - ./configs/couchdb/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    networks:
      - stack
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./configs/clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144


  # ======================
  # Monitoring - Grafana
  # ======================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    networks:
      - stack
    environment:
      - GF_SERVER_ROOT_URL=https://grafana.stack.local
      - GF_SERVER_DOMAIN=grafana.stack.local
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${GRAFANA_OAUTH_SECRET}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.stack.local/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://auth.stack.local/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://auth.stack.local/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'users') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.stack.local/logout
      - GF_AUTH_GENERIC_OAUTH_SKIP_ORG_ROLE_SYNC=false
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/grafana.ini:/etc/grafana/grafana.ini:ro
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    command: sh -c "update-ca-certificates && /run.sh"

  # ======================
  # Browser Automation
  # ======================
  browserless:
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped
    networks:
      - stack
    dns:
      - 172.18.0.100
      - 8.8.8.8
    environment:
      - TOKEN=${BROWSERLESS_TOKEN}
      - MAX_CONCURRENT_SESSIONS=5
      - CONNECTION_TIMEOUT=60000

  # ======================
  # Container Management
  # ======================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - portainer_data:/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - PORTAINER_HTTP_ENABLED=true

  # ======================
  # AI Services
  # ======================
  localai:
    image: localai/localai:latest-aio-cpu
    container_name: localai
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - localai_models:/build/models
    environment:
      - THREADS=4
      - CONTEXT_SIZE=2048

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - localai
    environment:
      - WEBUI_URL=https://open-webui.stack.local
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - OAUTH_CLIENT_ID=open-webui
      - OAUTH_CLIENT_SECRET=${OPENWEBUI_OAUTH_SECRET}
      - OPENID_PROVIDER_URL=https://auth.stack.local/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=Authelia
      - OAUTH_SCOPES=openid email profile groups
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_ALLOWED_ROLES=openwebui,openwebui-admin
      - OAUTH_ADMIN_ROLES=openwebui-admin
      - OAUTH_ROLES_CLAIM=groups
      - OLLAMA_BASE_URL=http://localai:8080
    volumes:
      - open_webui_data:/app/backend/data

  # ======================
  # Backup - Kopia
  # ======================
  kopia:
    image: kopia/kopia:latest
    container_name: kopia
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - kopia_data:/app/config
      - kopia_cache:/app/cache
      - kopia_data:/data:ro
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - USER=kopia
    command: server start --insecure --address=0.0.0.0:51515

  # ======================
  # Cloud Storage
  # ======================
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
      - redis
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - REDIS_HOST=redis
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.stack.local
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.stack.local
    volumes:
      - nextcloud_data:/var/www/html

  # ======================
  # Password Manager
  # ======================
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    networks:
      - stack
    environment:
      - DOMAIN=https://vaultwarden.stack.local
      - SSO_ENABLED=true
      - SSO_ONLY=false
      - SSO_AUTHORITY=https://auth.stack.local
      - SSO_CLIENT_ID=vaultwarden
      - SSO_CLIENT_SECRET=${VAULTWARDEN_OAUTH_SECRET}
      - SSO_SCOPES=openid profile email offline_access
      - SSO_PKCE=true
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=true
    volumes:
      - vaultwarden_data:/data

  # ======================
  # Data Processing
  # ======================
  benthos:
    image: jeffail/benthos:latest
    container_name: benthos
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - ./configs/benthos/benthos.yaml:/benthos.yaml:ro
      - benthos_data:/data
    command: -c /benthos.yaml

  # ======================
  # Media Server
  # ======================
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    networks:
      - stack
    environment:
      - JELLYFIN_PublishedServerUrl=https://jellyfin.stack.local
    volumes:
      - jellyfin_config:/config
      - jellyfin_media:/media
      - ./configs/jellyfin/SSO-Auth.xml:/config/plugins/configurations/SSO-Auth.xml:ro

  # ======================
  # Home Automation
  # ======================
  homeassistant:
    image: homeassistant/home-assistant:latest
    container_name: homeassistant
    restart: unless-stopped
    networks:
      - stack
    privileged: true
    volumes:
      - homeassistant_config:/config
      - ./configs/homeassistant/configuration.yaml:/config/configuration.yaml:ro
      - /etc/localtime:/etc/localtime:ro

  # ======================
  # Project Management
  # ======================
  planka:
    image: ghcr.io/plankanban/planka:latest
    container_name: planka
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
    environment:
      - BASE_URL=https://planka.stack.local
      - DATABASE_URL=postgresql://planka:${PLANKA_DB_PASSWORD}@postgres:5432/planka
      - SECRET_KEY=${PLANKA_SECRET_KEY}
      - OIDC_ISSUER=https://auth.stack.local
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=${PLANKA_OAUTH_SECRET}
      - OIDC_SCOPES=openid profile email groups
      - OIDC_ADMIN_ROLES=planka-admin
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/caddy-ca.crt
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    volumes:
      - planka_data:/app/public/user-avatars
      - ./configs/grafana/caddy-ca.crt:/etc/ssl/certs/caddy-ca.crt:ro

  # ======================
  # Wiki / Docs
  # ======================
  outline:
    image: outlinewiki/outline:latest
    container_name: outline
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
      - redis
    environment:
      - NODE_ENV=production
      - SECRET_KEY=${OUTLINE_SECRET_KEY}
      - UTILS_SECRET=${OUTLINE_UTILS_SECRET}
      - DATABASE_URL=postgres://outline:${OUTLINE_DB_PASSWORD}@postgres:5432/outline
      - REDIS_URL=redis://redis:6379
      - URL=https://outline.stack.local
      - PORT=3000
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=${OUTLINE_OAUTH_SECRET}
      - OIDC_AUTH_URI=https://auth.stack.local/api/oidc/authorization
      - OIDC_TOKEN_URI=https://auth.stack.local/api/oidc/token
      - OIDC_USERINFO_URI=https://auth.stack.local/api/oidc/userinfo
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Authelia
      - OIDC_SCOPES=openid offline_access profile email
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
    volumes:
      - outline_data:/var/lib/outline/data


  # ======================
  # Test Runner
  # ======================
  test-runner:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-runner
    networks:
      - stack
    volumes:
      - ./tests:/tests
    environment:
      - BASE_URL=https://stack.local
      - HEADLESS=true
    profiles:
      - testing
    command: ["sleep", "infinity"]
