networks:
  stack:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
  test:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16

volumes:
  caddy_data:
  caddy_config:
  grafana_data:
  ldap_data:
  ldap_config:
  authelia_data:
  mariadb_data:
  postgres_data:
  couchdb_data:
  clickhouse_data:
  dockge_data:
  localai_models:
  open_webui_data:
  kopia_data:
  kopia_cache:
  nextcloud_data:
  vaultwarden_data:
  redis_data:
  filebrowser_config:
  filebrowser_database:
  shared_media:
  homeassistant_config:
  planka_data:
  outline_data:
  benthos_data:
  jupyterhub_data:
  litellm_config:
  homepage_config:

services:

  # ======================
  # Reverse Proxy - Caddy
  # ======================
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    networks:
      stack:
        aliases:
          - grafana.${DOMAIN}
          - auth.${DOMAIN}
          - adminer.${DOMAIN}
          - pgadmin.${DOMAIN}
          - portainer.${DOMAIN}
          - localai.${DOMAIN}
          - litellm.${DOMAIN}
          - open-webui.${DOMAIN}
          - browserless.${DOMAIN}
          - nextcloud.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - filebrowser.${DOMAIN}
          - homeassistant.${DOMAIN}
          - planka.${DOMAIN}
          - outline.${DOMAIN}
          - kopia.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
      test:
        aliases:
          - grafana.${DOMAIN}
          - auth.${DOMAIN}
          - adminer.${DOMAIN}
          - pgadmin.${DOMAIN}
          - portainer.${DOMAIN}
          - localai.${DOMAIN}
          - litellm.${DOMAIN}
          - open-webui.${DOMAIN}
          - browserless.${DOMAIN}
          - nextcloud.${DOMAIN}
          - vaultwarden.${DOMAIN}
          - filebrowser.${DOMAIN}
          - homeassistant.${DOMAIN}
          - planka.${DOMAIN}
          - outline.${DOMAIN}
          - kopia.${DOMAIN}
          - jupyterhub.${DOMAIN}
          - homepage.${DOMAIN}
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./configs/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - ACME_AGREE=true

  # ======================
  # LDAP Directory
  # ======================
  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    restart: unless-stopped
    networks:
      - stack
    environment:
      - LDAP_ORGANISATION=Datamancy
      - LDAP_DOMAIN=stack.local
      - LDAP_BASE_DN=dc=stack,dc=local
      - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
      - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}
      - LDAP_TLS=false
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./configs/ldap/bootstrap.ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom/bootstrap.ldif:ro
    command: --copy-service --loglevel debug
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost:389", "-b", "dc=stack,dc=local", "-D", "cn=admin,dc=stack,dc=local", "-w", "${LDAP_ADMIN_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ======================
  # SSO - Authelia
  # ======================
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      ldap:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - authelia_data:/config
      - ./configs/authelia/configuration.yml:/config/configuration.yml:ro
      - ./configs/authelia/entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/entrypoint.sh"]
    command: ["--config", "/config/configuration.yml"]
    environment:
      - TZ=UTC
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET=${AUTHELIA_OIDC_HMAC_SECRET}
      - AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY=${AUTHELIA_OIDC_ISSUER_PRIVATE_KEY}
      - AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD=${LDAP_ADMIN_PASSWORD}

  # ======================
  # Redis (Session Store)
  # ======================
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # ======================
  # Databases
  # ======================
  mariadb:
    image: mariadb:11
    container_name: mariadb
    restart: unless-stopped
    networks:
      - stack
    environment:
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_DATABASE=datamancy
      - MYSQL_USER=datamancy
      - MYSQL_PASSWORD=${MARIADB_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/mariadb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    networks:
      - stack
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - NEXTCLOUD_DB_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - PLANKA_DB_PASSWORD=${PLANKA_DB_PASSWORD}
      - OUTLINE_DB_PASSWORD=${OUTLINE_DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./configs/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    command: postgres -c 'max_connections=200'

  couchdb:
    image: couchdb:3
    container_name: couchdb
    restart: unless-stopped
    networks:
      - stack
    environment:
      - COUCHDB_USER=admin
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
    volumes:
      - couchdb_data:/opt/couchdb/data
      - ./configs/couchdb/init-wrapper.sh:/usr/local/bin/init-wrapper.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/init-wrapper.sh"]
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:5984/_up | grep -q '\"status\":\"ok\"' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    networks:
      - stack
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./configs/clickhouse/config.xml:/etc/clickhouse-server/config.d/config.xml:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144


  # ======================
  # Monitoring - Grafana
  # ======================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    networks:
      - stack
    environment:
      - GF_DEFAULT_LOCALE=en_US
      - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN}
      - GF_SERVER_DOMAIN=grafana.${DOMAIN}
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Authelia
      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=grafana
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${GRAFANA_OAUTH_SECRET}
      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email groups
      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://auth.${DOMAIN}/api/oidc/authorization
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=http://authelia:9091/api/oidc/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=http://authelia:9091/api/oidc/userinfo
      - GF_AUTH_GENERIC_OAUTH_LOGIN_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_EMAIL_ATTRIBUTE_PATH=email
      - GF_AUTH_GENERIC_OAUTH_GROUPS_ATTRIBUTE_PATH=groups
      - GF_AUTH_GENERIC_OAUTH_NAME_ATTRIBUTE_PATH=name
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'users') && 'Editor' || 'Viewer'
      - GF_AUTH_GENERIC_OAUTH_USE_PKCE=true
      - GF_AUTH_SIGNOUT_REDIRECT_URL=https://auth.${DOMAIN}/logout
      - GF_AUTH_GENERIC_OAUTH_SKIP_ORG_ROLE_SYNC=false
      - GF_AUTH_GENERIC_OAUTH_AUTO_LOGIN=false
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true
      - GF_USERS_ALLOW_SIGN_UP=true
      - GF_USERS_AUTO_ASSIGN_ORG=true
      - GF_USERS_AUTO_ASSIGN_ORG_ROLE=Viewer
      - GF_AUTH_DISABLE_LOGIN_FORM=false
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/grafana.ini:/etc/grafana/grafana.ini:ro

  # ======================
  # Container Management
  # ======================
  dockge:
    image: louislam/dockge:latest
    container_name: dockge
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - docker-proxy
    volumes:
      - dockge_data:/app/data
      - /home/gerald/Documents/IdeaProjects/Datamancy:/opt/stacks
    environment:
      - DOCKGE_STACKS_DIR=/opt/stacks
      - DOCKER_HOST=tcp://docker-proxy:2375

  # ======================
  # AI Services
  # ======================
  localai:
    image: localai/localai:latest-aio-cpu
    container_name: localai
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - localai_models:/build/models
    environment:
      - THREADS=4
      - CONTEXT_SIZE=2048

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - localai
      - postgres
      - authelia
    volumes:
      - litellm_config:/app/config
      - ./configs/litellm/config.yaml:/app/config.yaml:ro
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/litellm
      - LITELLM_SALT_KEY=${AUTHELIA_JWT_SECRET}
      - GENERIC_CLIENT_ID=litellm
      - GENERIC_CLIENT_SECRET=${LITELLM_OAUTH_SECRET}
      - GENERIC_AUTHORIZATION_ENDPOINT=https://auth.${DOMAIN}/api/oidc/authorization
      - GENERIC_TOKEN_ENDPOINT=http://authelia:9091/api/oidc/token
      - GENERIC_USERINFO_ENDPOINT=http://authelia:9091/api/oidc/userinfo
      - PROXY_BASE_URL=https://litellm.${DOMAIN}
      - GENERIC_SCOPE=openid profile email groups
      - GENERIC_USER_ID_ATTRIBUTE=preferred_username
      - GENERIC_USER_EMAIL_ATTRIBUTE=email
      - GENERIC_USER_ROLE_ATTRIBUTE=groups
      - GENERIC_USER_DISPLAY_NAME_ATTRIBUTE=name
      - UI_USERNAME=admin
      - UI_PASSWORD=${LITELLM_MASTER_KEY}
    command: --config /app/config.yaml --port 4000 --num_workers 4 --detailed_debug

  open-webui:
    build:
      context: ./configs/openwebui/docker-build
      dockerfile: Dockerfile
    image: datamancy/open-webui:latest
    container_name: open-webui
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - litellm
    environment:
      - WEBUI_URL=https://open-webui.${DOMAIN}
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
      - OAUTH_CLIENT_ID=open-webui
      - OAUTH_CLIENT_SECRET=${OPENWEBUI_OAUTH_SECRET}
      - OPENID_PROVIDER_URL=https://auth.${DOMAIN}/.well-known/openid-configuration
      - OAUTH_PROVIDER_NAME=Authelia
      - OAUTH_SCOPES=openid email profile groups
      - ENABLE_OAUTH_ROLE_MANAGEMENT=true
      - OAUTH_GROUPS_CLAIM=groups
      - OAUTH_ADMIN_ROLES=admins,openwebui-admin
      - OAUTH_ALLOWED_ROLES=admins,users,openwebui-admin
      - DEFAULT_USER_ROLE=user
      - OLLAMA_BASE_URL=http://litellm:4000
      - ENABLE_OPENAI_API=true
      - OPENAI_API_BASE_URL=http://litellm:4000
      - OPENAI_API_KEY=${LITELLM_MASTER_KEY}
    volumes:
      - open_webui_data:/app/backend/data

  # ======================
  # Backup - Kopia
  # ======================
  kopia:
    image: kopia/kopia:latest
    container_name: kopia
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - kopia_data:/app/config
      - kopia_cache:/app/cache
      - kopia_data:/data:ro
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - USER=kopia
    command: server start --insecure --address=0.0.0.0:51515


  # ======================
  # Password Manager
  # ======================
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    networks:
      - stack
    environment:
      - DOMAIN=https://vaultwarden.${DOMAIN}
      - SSO_ENABLED=true
      - SSO_ONLY=false
      - SSO_AUTHORITY=https://auth.${DOMAIN}
      - SSO_CLIENT_ID=vaultwarden
      - SSO_CLIENT_SECRET=${VAULTWARDEN_OAUTH_SECRET}
      - SSO_SCOPES=openid profile email offline_access
      - SSO_PKCE=true
      - SIGNUPS_ALLOWED=false
      - INVITATIONS_ALLOWED=true
    volumes:
      - vaultwarden_data:/data

  # ======================
  # Cloud Storage - Nextcloud
  # ======================
  nextcloud:
    build:
      context: ./configs/nextcloud/docker-build
      dockerfile: Dockerfile
    image: datamancy/nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
      - redis
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD=${NEXTCLOUD_DB_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.${DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=nextcloud.${DOMAIN}
      - OVERWRITECLIURL=https://nextcloud.${DOMAIN}
      - REDIS_HOST=redis
      - REDIS_HOST_PORT=6379
      - TRUSTED_PROXIES=172.18.0.0/16
    volumes:
      - nextcloud_data:/var/www/html
      - ./configs/nextcloud/oidc-setup.sh:/docker-entrypoint-hooks.d/pre-installation/oidc-setup.sh:ro
      - ./configs/nextcloud/post-installation-oidc.sh:/docker-entrypoint-hooks.d/post-installation/configure-oidc.sh:ro

  # ======================
  # Data Processing
  # ======================
  benthos:
    image: jeffail/benthos:latest
    container_name: benthos
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - ./configs/benthos/benthos.yaml:/benthos.yaml:ro
      - benthos_data:/data
    command: -c /benthos.yaml

  # ======================
  # File Server - FileBrowser
  # ======================
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    restart: unless-stopped
    networks:
      - stack
    volumes:
      - filebrowser_config:/config
      - filebrowser_database:/database
      - shared_media:/srv/media
      - ./configs/filebrowser/entrypoint.sh:/entrypoint.sh:ro
    environment:
      - FB_NOAUTH=false
      - FB_BASEURL=/
    entrypoint: ["/entrypoint.sh"]

  # ======================
  # Home Automation
  # ======================
  homeassistant:
    build:
      context: ./configs/homeassistant/docker-build
      dockerfile: Dockerfile
    image: datamancy/homeassistant:latest
    container_name: homeassistant
    restart: unless-stopped
    networks:
      - stack
    privileged: true
    volumes:
      - homeassistant_config:/config
      - ./configs/homeassistant/configuration.yaml:/config/configuration.yaml:ro
      - ./configs/homeassistant/automations.yaml:/config/automations.yaml:rw
      - ./configs/homeassistant/scripts.yaml:/config/scripts.yaml:rw
      - ./configs/homeassistant/scenes.yaml:/config/scenes.yaml:rw
      - ./configs/homeassistant/themes:/config/themes:ro
      - /etc/localtime:/etc/localtime:ro

  # ======================
  # Project Management
  # ======================
  planka:
    image: ghcr.io/plankanban/planka:latest
    container_name: planka
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
    environment:
      - BASE_URL=https://planka.${DOMAIN}
      - DATABASE_URL=postgresql://planka:${PLANKA_DB_PASSWORD}@postgres:5432/planka
      - SECRET_KEY=${PLANKA_SECRET_KEY}
      - OIDC_ISSUER=https://auth.${DOMAIN}
      - OIDC_CLIENT_ID=planka
      - OIDC_CLIENT_SECRET=${PLANKA_OAUTH_SECRET}
      - OIDC_SCOPES=openid profile email groups
      - OIDC_ADMIN_ROLES=planka-admin
      - OIDC_EMAIL_ATTRIBUTE=email
      - OIDC_NAME_ATTRIBUTE=name
      - OIDC_USERNAME_ATTRIBUTE=preferred_username
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    volumes:
      - planka_data:/app/public/user-avatars
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro

  # ======================
  # Wiki / Docs
  # ======================
  outline:
    image: outlinewiki/outline:latest
    container_name: outline
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - postgres
      - redis
    environment:
      - NODE_ENV=production
      - SECRET_KEY=${OUTLINE_SECRET_KEY}
      - UTILS_SECRET=${OUTLINE_UTILS_SECRET}
      - DATABASE_URL=postgres://outline:${OUTLINE_DB_PASSWORD}@postgres:5432/outline
      - PGSSLMODE=disable
      - REDIS_URL=redis://redis:6379
      - URL=https://outline.${DOMAIN}
      - PORT=3000
      - OIDC_CLIENT_ID=outline
      - OIDC_CLIENT_SECRET=${OUTLINE_OAUTH_SECRET}
      - OIDC_AUTH_URI=https://auth.${DOMAIN}/api/oidc/authorization
      - OIDC_TOKEN_URI=http://authelia:9091/api/oidc/token
      - OIDC_USERINFO_URI=http://authelia:9091/api/oidc/userinfo
      - OIDC_USERNAME_CLAIM=preferred_username
      - OIDC_DISPLAY_NAME=Authelia
      - OIDC_SCOPES=openid offline_access profile email
      - FILE_STORAGE=local
      - FILE_STORAGE_LOCAL_ROOT_DIR=/var/lib/outline/data
    volumes:
      - outline_data:/var/lib/outline/data

  # ======================
  # Docker Socket Proxy
  # ======================
  # Docker Socket Proxy - provides controlled API access
  # Uses rootless socket in dev, standard socket in prod
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: docker-proxy
    restart: unless-stopped
    networks:
      - stack
    environment:
      - CONTAINERS=1
      - IMAGES=1
      - NETWORKS=1
      - VOLUMES=1
      - POST=1
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - INFO=1
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VERSION=1
    volumes:
      # Rootless Docker (dev): /run/user/1000/docker.sock
      # Root Docker (prod): /var/run/docker.sock
      - ${DOCKER_SOCKET:-/run/user/1000/docker.sock}:/var/run/docker.sock:ro

  # ======================
  # JupyterHub
  # ======================
  jupyterhub:
    build:
      context: ./configs/jupyterhub
      dockerfile: Dockerfile
    container_name: jupyterhub
    restart: unless-stopped
    networks:
      - stack
    depends_on:
      - authelia
      - docker-proxy
    environment:
      - JUPYTERHUB_OAUTH_SECRET=${JUPYTERHUB_OAUTH_SECRET}
      - DOCKER_HOST=tcp://docker-proxy:2375
    volumes:
      - jupyterhub_data:/srv/jupyterhub
      - ./configs/jupyterhub/jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro

  # ======================
  # Dashboard - Homepage
  # ======================
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    networks:
      - stack
    environment:
      - PUID=1000
      - PGID=1000
      - HOMEPAGE_ALLOWED_HOSTS=homepage.${DOMAIN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/homepage/services.yaml:/app/config/services.yaml:ro
      - ./configs/homepage/settings.yaml:/app/config/settings.yaml:ro
      - ./configs/homepage/widgets.yaml:/app/config/widgets.yaml:ro
      - ./configs/homepage/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ./configs/homepage/docker.yaml:/app/config/docker.yaml:ro

  # ======================
  # Test Runner Container
  # ======================
  # Isolated on test network - routes ALL traffic through Caddy like a real client
  # DNS resolution handled by Docker network aliases on Caddy
  test-runner:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-runner
    profiles:
      - testing
    networks:
      - test
    depends_on:
      - caddy
    volumes:
      - ./tests/test_web_ui.js:/tests/webui.e2e.js:ro
      - ./tests/test_ai_services.js:/tests/test_ai_services.js:ro
      - ./screenshots:/screenshots:rw
      - ./configs/grafana/caddy-ca.crt:/usr/local/share/ca-certificates/caddy-ca.crt:ro
    environment:
      - NODE_ENV=test
      - CI=true
      - LANG=en_US.UTF-8
      - LC_ALL=en_US.UTF-8
      - NODE_EXTRA_CA_CERTS=/usr/local/share/ca-certificates/caddy-ca.crt
      - TEST_USERNAME=admin
      - TEST_PASSWORD=DatamancyTest2025!
      - SCREEN_DIR=/screenshots
    restart: "no"
    command: >
      sh -c 'set -eu &&
      update-ca-certificates 2>/dev/null || true &&
      printf "%s test-runner: starting webui.e2e\n" "$(date -u +%Y-%m-%dT%H:%M:%SZ)" &&
      node /tests/webui.e2e.js'