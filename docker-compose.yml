# Datamancy Stack â€” Phase 0.5 Complete
# Provenance: Caddy + docker-socket-proxy + multi-hostname no-DNS architecture
# Architecture: Caddy front door, local CA, rootless Docker, freshness automation
#
# Networks:
#   - frontend: Public-facing services (Caddy, exposed UIs)
#   - backend: Internal services (metrics, logs, datastores)
#   - socket: Restricted Docker socket access

networks:
  frontend:
    name: datamancy_frontend
  backend:
    name: datamancy_backend
  socket:
    name: datamancy_socket
    internal: true

volumes:
  caddy_data:
  caddy_config:
  grafana_data:
  prometheus_data:
  loki_data:
  ldap_data:
  ldap_config:
  authelia_data:
  mariadb_data:
  mongodb_data:
  clickhouse_data:
  portainer_data:

services:
  # --- Docker Socket Proxy (least privilege) ---
  # Provenance: Caddy needs container discovery; restrict socket access
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:0.1.2
    container_name: docker-socket-proxy
    restart: unless-stopped
    networks:
      - socket
    volumes:
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
    environment:
      # Only allow read operations needed by caddy-docker-proxy
      CONTAINERS: 1
      NETWORKS: 1
      SERVICES: 0
      TASKS: 0
      POST: 0
    profiles:
      - core

  # --- Caddy Reverse Proxy (front door) ---
  # Provenance: Multi-hostname *.stack.local, automatic label-based routing
  caddy:
    image: lucaslorentz/caddy-docker-proxy:2.9
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"  # Admin API for metrics
    networks:
      - frontend
      - backend
      - socket
    volumes:
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro  # Label discovery
      - caddy_data:/data
      - caddy_config:/config
      - ./certs:/certs:ro
    environment:
      CADDY_DOCKER_CADDYFILE_PATH: /etc/caddy/Caddyfile
      CADDY_DOCKER_LABEL_PREFIX: caddy
      CADDY_ADMIN: "0.0.0.0:2019"  # Enable admin API
    labels:
      caddy: "*.${STACK_HOST:-stack.local}"
      caddy.tls: "/certs/wildcard.crt /certs/wildcard.key"
    profiles:
      - core

  # --- Docs Indexer (fingerprint tracker) ---
  # Provenance: Phase 0.5 freshness automation
  docs-indexer:
    build:
      context: ./tools/docs-indexer
      dockerfile: Dockerfile
    container_name: docs-indexer
    volumes:
      - ./docker-compose.yml:/app/docker-compose.yml:ro
      - ./configs:/app/configs:ro
      - ./docs:/app/docs:rw
      - ./data:/app/data:ro
      - ./.git:/app/.git:ro
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
    environment:
      DOCKER_HOST: unix:///var/run/docker.sock
    profiles:
      - tools

  # --- MkDocs Material Site Builder ---
  # Provenance: Phase 0.5 documentation site
  mkdocs:
    build:
      context: ./tools/mkdocs
      dockerfile: Dockerfile
    container_name: mkdocs
    volumes:
      - ./docs:/docs/docs:ro
      - ./mkdocs.yml:/docs/mkdocs.yml:ro
      - ./site:/docs/site:rw
    working_dir: /docs
    command: build
    profiles:
      - tools

  # --- Grafana (observability UI) ---
  # Provenance: Phase 1 agent autonomy smoke test
  grafana:
    image: grafana/grafana:11.0.0
    container_name: grafana
    restart: unless-stopped
    user: "${UID:-1000}:${GID:-1000}"
    networks:
      - frontend
      - backend
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_SERVER_ROOT_URL: ${GF_SERVER_ROOT_URL}
      GF_SERVER_DOMAIN: ${GF_SERVER_DOMAIN}
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"
    labels:
      caddy: grafana.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    profiles:
      - observability

  # --- Browserless (headless browser service) ---
  # Provenance: Phase 1 agent autonomy smoke test
  browserless:
    image: browserless/chrome:1.61.0-puppeteer-21.4.1
    container_name: browserless
    restart: unless-stopped
    networks:
      - backend
    environment:
      TOKEN: ${BROWSERLESS_TOKEN}
      MAX_CONCURRENT_SESSIONS: 2
      CONNECTION_TIMEOUT: 60000
      ENABLE_CORS: "true"
      PREBOOT_CHROME: "true"
    volumes:
      - ./certs/ca.crt:/usr/local/share/ca-certificates/datamancy-ca.crt:ro
    labels:
      caddy: browserless.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 3000}}"
    profiles:
      - observability

  # --- Test Runner (Playwright browser tests) ---
  # Provenance: Phase 1 agent autonomy smoke test
  test-runner:
    build:
      context: ./tests
      dockerfile: Dockerfile
    container_name: test-runner
    networks:
      - frontend
      - backend
    volumes:
      - ./data/tests:/tests/artifacts:rw
      - ./certs/ca.crt:/usr/local/share/ca-certificates/datamancy-ca.crt:ro
    environment:
      BROWSERLESS_URL: http://browserless:3000
      BROWSERLESS_TOKEN: ${BROWSERLESS_TOKEN}
      GRAFANA_URL: https://grafana.stack.local
      GRAFANA_USER: ${GF_SECURITY_ADMIN_USER}
      GRAFANA_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      NODE_EXTRA_CA_CERTS: /usr/local/share/ca-certificates/datamancy-ca.crt
    # Note: Hostname resolution handled by entrypoint.sh dynamically
    profiles:
      - observability

  # --- Prometheus (metrics collection) ---
  # Provenance: Phase 2 - observability metrics
  prometheus:
    image: prom/prometheus:v3.0.1
    container_name: prometheus
    restart: unless-stopped
    networks:
      - frontend
      - backend
    volumes:
      - prometheus_data:/prometheus
      - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    labels:
      caddy: prometheus.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 9090}}"
    profiles:
      - observability

  # --- Loki (log aggregation) ---
  # Provenance: Phase 2 - observability logs
  loki:
    image: grafana/loki:3.2.1
    container_name: loki
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - loki_data:/loki
      - ./configs/loki/loki.yml:/etc/loki/loki.yml:ro
    command: -config.file=/etc/loki/loki.yml
    labels:
      caddy: loki.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 3100}}"
    profiles:
      - observability

  # --- Promtail (log collector with docker_sd) ---
  # Provenance: Phase 2 - docker service discovery log collection
  promtail:
    image: grafana/promtail:3.2.1
    container_name: promtail
    restart: unless-stopped
    networks:
      - backend
      - socket
    volumes:
      - ./configs/promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/promtail.yml
    profiles:
      - observability

  # --- OpenLDAP (user directory) ---
  # Provenance: Phase 3 - Access Control
  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    restart: unless-stopped
    networks:
      - backend
    environment:
      LDAP_ORGANISATION: "Datamancy"
      LDAP_DOMAIN: "datamancy.local"
      LDAP_ADMIN_PASSWORD: "admin_password_change_me"
      LDAP_CONFIG_PASSWORD: "config_password_change_me"
      LDAP_RFC2307BIS_SCHEMA: "true"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "true"
      LDAP_TLS: "false"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./configs/ldap:/container/service/slapd/assets/config/bootstrap/ldif/custom:ro
    command: --copy-service --loglevel info
    profiles:
      - auth

  # --- Authelia (SSO & authentication portal) ---
  # Provenance: Phase 3 - Access Control
  authelia:
    image: authelia/authelia:4.38
    container_name: authelia
    restart: unless-stopped
    networks:
      - frontend
      - backend
    volumes:
      - authelia_data:/config
      - ./configs/authelia:/config/authelia:ro
    environment:
      TZ: UTC
    command: --config /config/authelia/configuration.yml
    labels:
      caddy: auth.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 9091}}"
    profiles:
      - auth

  # --- MariaDB (relational database) ---
  # Provenance: Phase 4 - Datastores
  mariadb:
    image: mariadb:11.2
    container_name: mariadb
    restart: unless-stopped
    networks:
      - backend
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./configs/mariadb:/docker-entrypoint-initdb.d:ro
    environment:
      MYSQL_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-root_password_change_me}
      MYSQL_DATABASE: ${MARIADB_DATABASE:-datamancy}
      MYSQL_USER: ${MARIADB_USER:-datamancy}
      MYSQL_PASSWORD: ${MARIADB_PASSWORD:-datamancy_password_change_me}
    profiles:
      - datastores

  # --- MongoDB (document database) ---
  # Provenance: Phase 4 - Datastores
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    restart: unless-stopped
    networks:
      backend:
        aliases:
          - mongo
    volumes:
      - mongodb_data:/data/db
      - ./configs/mongodb:/docker-entrypoint-initdb.d:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_ROOT_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-root_password_change_me}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-datamancy}
    profiles:
      - datastores

  # --- ClickHouse (analytics database) ---
  # Provenance: Phase 4 - Datastores
  clickhouse:
    image: clickhouse/clickhouse-server:23.12
    container_name: clickhouse
    restart: unless-stopped
    networks:
      - backend
      - frontend
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./configs/clickhouse:/etc/clickhouse-server/config.d:ro
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-datamancy}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-datamancy}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-datamancy_password_change_me}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    labels:
      caddy: clickhouse.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 8123}}"
    profiles:
      - datastores

  # --- Adminer (database management UI) ---
  # Provenance: Phase 5 - Management Tools
  adminer:
    image: adminer:4.8.1
    container_name: adminer
    restart: unless-stopped
    networks:
      - frontend
      - backend
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
      ADMINER_DESIGN: dracula
    labels:
      caddy: adminer.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 8080}}"
    profiles:
      - management

  # --- Mongo Express (MongoDB management UI) ---
  # Provenance: Phase 5 - Management Tools
  mongo-express:
    image: mongo-express:1.0.2
    container_name: mongo-express
    restart: unless-stopped
    networks:
      - frontend
      - backend
    environment:
      ME_CONFIG_MONGODB_SERVER: mongodb
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGODB_ROOT_USER:-root}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGODB_ROOT_PASSWORD:-root_password_change_me}
      ME_CONFIG_BASICAUTH_USERNAME: ${MONGO_EXPRESS_USER:-admin}
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD:-admin_password_change_me}
      ME_CONFIG_SITE_BASEURL: /
      ME_CONFIG_MONGODB_URL: mongodb://root:root_password_change_me@mongodb:27017/
    labels:
      caddy: mongo-express.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 8081}}"
    profiles:
      - management

  # --- Portainer (Docker management UI) ---
  # Provenance: Phase 5 - Management Tools
  portainer:
    image: portainer/portainer-ce:2.19.4
    container_name: portainer
    restart: unless-stopped
    networks:
      - frontend
      - socket
    volumes:
      - /run/user/${UID:-1000}/docker.sock:/var/run/docker.sock:ro
      - portainer_data:/data
    labels:
      caddy: portainer.${STACK_HOST:-stack.local}
      caddy.reverse_proxy: "{{upstreams 9000}}"
    profiles:
      - management
