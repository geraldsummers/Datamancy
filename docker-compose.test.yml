# Minimal test stack - databases only, no data persistence
version: '3.8'

networks:
  test-network:
    driver: bridge

services:
  postgres-test:
    image: postgres:16-alpine
    container_name: postgres-test
    environment:
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpass
      - POSTGRES_DB=datamancy_test
    networks:
      - test-network
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data  # No persistence - in-memory only

  clickhouse-test:
    image: clickhouse/clickhouse-server:24.3-alpine
    container_name: clickhouse-test
    environment:
      - CLICKHOUSE_USER=testuser
      - CLICKHOUSE_PASSWORD=testpass
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    networks:
      - test-network
    ports:
      - "8124:8123"
      - "9001:9000"
    tmpfs:
      - /var/lib/clickhouse  # No persistence - in-memory only

  qdrant-test:
    image: qdrant/qdrant:v1.11.0
    container_name: qdrant-test
    networks:
      - test-network
    ports:
      - "6334:6333"
    tmpfs:
      - /qdrant/storage  # No persistence - in-memory only

  data-fetcher-test:
    build:
      dockerfile: ./src/data-fetcher/Dockerfile
      context: .
    container_name: data-fetcher-test
    networks:
      - test-network
    ports:
      - "8095:8095"
    environment:
      - DATAFETCHER_PORT=8095
      - POSTGRES_HOST=postgres-test
      - POSTGRES_PORT=5432
      - POSTGRES_DB=datamancy_test
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpass
      - CLICKHOUSE_HOST=clickhouse-test
      - CLICKHOUSE_PORT=8123
      - CLICKHOUSE_USER=testuser
      - CLICKHOUSE_PASSWORD=testpass
      - QDRANT_HOST=qdrant-test
      - QDRANT_PORT=6333
    depends_on:
      - postgres-test
      - clickhouse-test
      - qdrant-test
    # No volumes - data lives in container overlay, will be deleted on remove
